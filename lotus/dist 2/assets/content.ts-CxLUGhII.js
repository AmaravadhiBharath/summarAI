(function(){const C=[{name:"chatgpt",detect:t=>t.includes("chat.openai.com")||t.includes("chatgpt.com"),userSelector:'[data-message-author-role="user"]',aiSelector:'[data-message-author-role="assistant"]',shadowDOM:!1,minContentLength:10},{name:"claude",detect:t=>t.includes("claude.ai"),userSelector:".font-user-message",aiSelector:".font-claude-message",shadowDOM:!0,minContentLength:10},{name:"gemini",detect:t=>t.includes("gemini.google.com"),userSelector:'user-query, .user-query, [data-role="user"]',aiSelector:'model-response, .model-response, [data-role="model"]',shadowDOM:!0,minContentLength:10}],y=t=>{const n=C.find(o=>o.detect(t));return n?(console.log(`Lotus: Detected platform: ${n.name}`),n):(console.log("Lotus: Using generic platform"),{name:"generic",detect:()=>!0,userSelector:'[data-message-author-role="user"], .user-message, .human',aiSelector:'[data-message-author-role="assistant"], .ai-message, .bot',shadowDOM:!1,minContentLength:50})},L=(t,n=50)=>{const o=t.trim();if(!o||o.length<10)return{valid:!1,reason:"Content too short"};const e=[/^loading\.\.\.$/i,/^error \d+/i,/^sign in to continue/i,/^access denied/i,/^404 not found/i,/^please wait/i,/^forbidden/i],i=o.toLowerCase();if(e.some(s=>s.test(i)))return{valid:!1,reason:"Appears to be error or loading message"};if(o.length<n){const s=o.split(/\s+/).length;if(s<3)return{valid:!1,reason:"Not enough words"};if(!/[?!]|user:|ai:|assistant:|how|what|why|when|where/i.test(o)&&s<5)return{valid:!1,reason:"Content too vague"}}return{valid:!0}},v=async(t={})=>{console.log("Lotus: scrapePage called");const n=window.location.href,o=document.title,e=y(n),i=document.body.innerText||"",s=L(i,e.minContentLength);if(!s.valid)return console.log(`Lotus: Validation failed - ${s.reason}`),{code:"NO_CONTENT",message:"Unable to extract content from this page",suggestion:s.reason==="Content too short"?"Make sure the page is fully loaded before generating a summary":"This page may not contain conversation content",platform:e.name};const l=[],d=(a,r)=>{if(!a)return;const m=document.querySelectorAll(a);m.length>0&&(console.log(`Lotus: Found ${m.length} ${r} messages with selector: ${a}`),m.forEach(h=>{let g=h.textContent?.trim()||"";if(t.includeImages){const f=h.querySelectorAll("img");if(f.length>0){const u=[];f.forEach(p=>{const S=p.getAttribute("alt"),w=p.getAttribute("src");S?u.push(`[Image: ${S}]`):w&&u.push(`[Image: ${w.split("/").pop()?.split("?")[0]||"embedded"}]`)}),u.length>0&&(g+=`
`+u.join(`
`))}}g&&g.length>0&&l.push({role:r,content:g,position:h.getBoundingClientRect().top})}))};d(e.userSelector,"user"),d(e.aiSelector,"assistant"),l.sort((a,r)=>a.position-r.position),console.log("Lotus: Scraped Conversation:",JSON.stringify(l,null,2)),d(e.aiSelector,"assistant"),l.sort((a,r)=>a.position-r.position);const c=l.map(({position:a,...r})=>r);return e.shadowDOM&&c.length===0&&i.length<100?(console.log("Lotus: Shadow DOM platform with minimal content"),{code:"SHADOW_DOM",message:`${e.name.charAt(0).toUpperCase()+e.name.slice(1)} uses protected content`,suggestion:"Try selecting and copying the conversation manually, then paste it into a text field for summarization",platform:e.name}):(c.length===0&&(console.log("Lotus: No structured conversation, using raw text"),c.push({role:"user",content:i})),console.log(`Lotus: Successfully scraped ${c.length} messages from ${e.name}`),{url:n,title:o,platform:e.name,conversation:c,rawText:i,images:[]})};chrome.runtime.onMessage.addListener((t,n,o)=>{if(t.action==="ping")return o({pong:!0}),!0;if(t.action==="getPageContent"){try{console.log("Tiger: Starting scrape..."),v({includeImages:t.includeImages}).then(e=>{console.log("Tiger: Scrape complete",e),o(e)}).catch(e=>{console.error("Tiger: Scraping failed",e),o(null)})}catch(e){console.error("Tiger: Scraping failed",e),o(null)}return!0}});
})()
