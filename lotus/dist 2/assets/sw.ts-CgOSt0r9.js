chrome.runtime.onConnect.addListener(e=>{e.name});chrome.runtime.onMessage.addListener((e,r,a)=>{const c=r.tab?.url?new URL(r.tab.url).origin:"extension-internal";return console.log(`Service Worker received: ${e.type||e.action} from ${c}`),s(e,r,a),!0});const s=(e,r,a)=>{if(e.type==="TEST_CONNECTION"&&a({status:"Service Worker received your message!"}),e.action==="inject_content_script"&&r.tab?.id){const o=chrome.runtime.getManifest().content_scripts?.find(t=>t.matches?.includes("<all_urls>"))?.js?.[0];o?chrome.scripting.executeScript({target:{tabId:r.tab.id,allFrames:!0},files:[o]}).then(()=>{console.log("Content script injected programmatically"),a({success:!0})}).catch(t=>{console.error("Failed to inject:",t),a({success:!1,error:t.message})}):a({success:!1,error:"Content script not found in manifest"})}e.action==="scrapingComplete"&&console.log("Scraping completed:",e.data)};console.log("Summarai Service Worker Loaded");chrome.sidePanel&&chrome.sidePanel.setPanelBehavior&&chrome.sidePanel.setPanelBehavior({openPanelOnActionClick:!0}).catch(e=>console.error(e));const n=async()=>{try{const e=await fetch("https://tai-backend.amaravadhibharath.workers.dev/selectors");if(e.ok){const r=await e.json();await chrome.storage.local.set({scraping_config:r}),console.log("Updated scraping selectors")}}catch(e){console.error("Failed to update selectors:",e)}};chrome.runtime.onInstalled.addListener(async e=>{const{hasSeenWelcome:r}=await chrome.storage.local.get("hasSeenWelcome");(e.reason==="install"||!r)&&(chrome.tabs.create({url:"welcome.html"}),chrome.storage.local.set({hasSeenWelcome:!0})),n();const c=chrome.runtime.getManifest().content_scripts?.find(o=>o.matches?.includes("<all_urls>"))?.js?.[0];if(c){const o=await chrome.tabs.query({url:["http://*/*","https://*/*"]});for(const t of o)t.id&&!t.url?.startsWith("chrome://")&&!t.url?.startsWith("edge://")&&!t.url?.startsWith("about:")&&chrome.scripting.executeScript({target:{tabId:t.id,allFrames:!0},files:[c]}).catch(i=>console.log(`Failed to inject into tab ${t.id}:`,i))}});chrome.runtime.onStartup.addListener(()=>{n()});chrome.alarms&&(chrome.alarms.create("updateSelectors",{periodInMinutes:1440}),chrome.alarms.onAlarm.addListener(e=>{e.name==="updateSelectors"&&n()}));
