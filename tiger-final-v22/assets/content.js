chrome.runtime.onMessage.addListener((d,c,g)=>{if(d.action==="ping")return g({pong:!0}),!0;if(d.action==="getPageContent")try{const a=x(d.includeImages);g(a)}catch(a){g({error:a.message})}return!0});let E=null;chrome.storage.local.get("scraping_config",d=>{d.scraping_config&&(E=d.scraping_config)});function x(d=!1){const c=window.location.href,g=document.title;if(!c.startsWith("http://")&&!c.startsWith("https://"))throw new Error("Cannot summarize this page. Please use a valid website (http/https).");let a="generic",u=[],f=[];const h=t=>{if(!d)return;t.querySelectorAll("img").forEach(e=>{e.width>50&&e.height>50&&e.src&&(f.includes(e.src)||f.push(e.src))})};if(E){let t=null;if(c.includes("chatgpt.com")?t=E["chatgpt.com"]:c.includes("gemini.google.com")?t=E["gemini.google.com"]:c.includes("claude.ai")&&(t=E["claude.ai"]),t&&(a=t.platform,a==="chatgpt"&&t.selectors))for(const i of t.selectors){const e=document.querySelectorAll(i);if(e.length>0&&(e.forEach(l=>{let n="assistant";t.roleAttribute&&l.getAttribute(t.roleAttribute)===t.userRoleValue&&(n="user");const s=l.innerText;s&&u.push({role:n,text:s}),h(l)}),u.length>0))return{url:c,title:g,platform:a,conversation:u,rawText:u.map(l=>l.text).join(`

`),images:f}}}if(c.includes("chatgpt.com")){a="chatgpt";const t=["[data-message-author-role]",".text-message",".markdown"];let i=null;for(const e of t){const l=document.querySelectorAll(e);if(l.length>0){i=l;break}}i&&i.forEach(e=>{const l=e.getAttribute("data-message-author-role")||"assistant",n=e.innerText;n&&u.push({role:l,text:n}),h(e)})}else if(c.includes("gemini.google.com")){a="gemini";const t=[".message-content","[data-message-id]",".model-response-text",".user-query","message-content"];for(const i of t){const e=document.querySelectorAll(i);e.length>0&&e.forEach(l=>{const n=l.innerText;n&&n.length>5&&u.push({role:"assistant",text:n})})}if(u.length===0){let e=Array.from(document.querySelectorAll('[class*="scroll"], [style*="overflow"]')).sort((s,o)=>{const r=s.getBoundingClientRect(),m=o.getBoundingClientRect();return m.width*m.height-r.width*r.height})[0];e||(e=document.body);const l=document.createTreeWalker(e,NodeFilter.SHOW_TEXT,{acceptNode:s=>{const o=s.parentElement;if(!o||o.offsetParent===null||o.isContentEditable||o.getAttribute("role")==="textbox"||o.closest('[contenteditable="true"]'))return NodeFilter.FILTER_REJECT;const r=o.tagName.toLowerCase();return["script","style","noscript","button","nav","header","footer","input","textarea","select","option"].includes(r)?NodeFilter.FILTER_REJECT:NodeFilter.FILTER_ACCEPT}});let n;for(;n=l.nextNode();){const s=n.textContent?.trim();s&&s.length>10&&(["submit","cancel","regenerate","share","more_vert","edit","enter a prompt here"].includes(s.toLowerCase())||u.push({role:"assistant",text:s}))}}h(document.body)}else c.includes("claude.ai")&&(a="claude",document.querySelectorAll(".font-user-message, .font-claude-message").forEach(i=>{const e=i.classList.contains("font-user-message");u.push({role:e?"user":"assistant",text:i.innerText}),h(i)}));if(u.length===0){const i=["chatgpt.com","openai.com","gemini.google.com","labs.google.com","figma.com","visily.ai","uizard.io","uxmagic.ai","banani.co","app.emergent.sh","rocket.new","lovable.dev","bolt.new","base44.com","create.xyz","memex.tech","buildfire.com","glideapps.com","flatlogic.com","retool.com","uibakery.io","zoho.com","appypie.com"].some(n=>c.includes(n));let e="";const l=i?50:30;if(i){const n=document.createTreeWalker(document.body,NodeFilter.SHOW_TEXT,{acceptNode:o=>{const r=o.parentElement;if(!r||r.offsetParent===null||r.isContentEditable||r.getAttribute("role")==="textbox"||r.closest('[contenteditable="true"]'))return NodeFilter.FILTER_REJECT;const m=r.tagName.toLowerCase();return["script","style","noscript","iframe","svg","path","button","nav","footer","header","input","textarea","select"].includes(m)?NodeFilter.FILTER_REJECT:NodeFilter.FILTER_ACCEPT}});let s;for(;s=n.nextNode();){const o=s.textContent?.trim();o&&o.length>5&&(e+=o+`

`)}}else document.querySelectorAll("p, h1, h2, h3, h4, h5, li, span, div").forEach(o=>{if(["P","H1","H2","H3","H4","H5","LI"].includes(o.tagName)){const r=o.innerText;r&&r.length>20&&(e+=r+`

`)}});if(!e.trim()&&!i){const n=document.createTreeWalker(document.body,NodeFilter.SHOW_TEXT,{acceptNode:o=>{const r=o.parentElement;if(!r||r.isContentEditable||r.getAttribute("role")==="textbox"||r.closest('[contenteditable="true"]'))return NodeFilter.FILTER_REJECT;const m=r.tagName.toLowerCase();return["script","style","noscript","input","textarea","select","button"].includes(m)?NodeFilter.FILTER_REJECT:NodeFilter.FILTER_ACCEPT}});let s;for(;s=n.nextNode();){const o=s.textContent?.trim();o&&o.length>20&&(e+=o+`
`)}}if(!e||e.trim().length<l,h(document),e&&e.length>l)return{url:c,title:g,platform:a==="generic"&&i?"generic":a,conversation:[],rawText:e,images:f.slice(0,10)}}const p=u.length>0,T=u.map(t=>t.text).join("").length>20;if(!p||!T){const t=document.body.innerText;if(t.length>50)return{url:c,title:g,platform:a,conversation:[{role:"assistant",text:t}],rawText:t,images:f.slice(0,10)};throw new Error("No conversation found on this page. Start a chat first, then generate a summary.")}return{url:c,title:g,platform:a,conversation:u,rawText:u.map(t=>`${t.role.toUpperCase()}: ${t.text}`).join(`

`),images:f.slice(0,10)}}
