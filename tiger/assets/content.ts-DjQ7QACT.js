(function(){chrome.runtime.onMessage.addListener((h,a,u)=>{if(h.action==="ping")return u({pong:!0}),!0;if(h.action==="getPageContent")try{const s=T(h.includeImages);u(s)}catch(s){u({error:s.message})}return!0});function T(h=!1){const a=window.location.href,u=document.title;if(!a.startsWith("http://")&&!a.startsWith("https://"))throw new Error("Cannot summarize this page. Please use a valid website (http/https).");let s="generic",c=[],g=[];const f=o=>{if(!h)return;o.querySelectorAll("img").forEach(t=>{t.width>50&&t.height>50&&t.src&&(g.includes(t.src)||g.push(t.src))})};if(a.includes("chatgpt.com"))s="chatgpt",document.querySelectorAll("[data-message-author-role]").forEach(i=>{const t=i.getAttribute("data-message-author-role"),m=i.innerText;t&&m&&c.push({role:t,text:m}),f(i)});else if(a.includes("gemini.google.com")){s="gemini";let o=null;const i=Array.from(document.querySelectorAll('[class*="scroll"], [style*="overflow"]'));for(const e of i){const r=e.getBoundingClientRect();if(r.width>400&&r.height>300){o=e;break}}o||(o=document.querySelector("main")||document.body);const t=Array.from(o.querySelectorAll("div")),m=[];for(const e of t){const r=e.innerText?.trim()||"",n=e.querySelectorAll("div").length;if(r.length>20&&n<10&&e.offsetHeight>0){const p=e.parentElement?.innerText||"";r.length/(p.length||1)>.3&&m.push(e)}}const l=[];for(const e of m)l.some(n=>n.contains(e)||e.contains(n))||l.push(e);if(l.length>0){const e=[/create an image/i,/create a video/i,/write anything/i,/help me learn/i,/boost my day/i,/ask gemini/i,/^tools$/i,/^fast$/i];l.forEach(r=>{const n=r.innerText.trim();if(e.some(x=>x.test(n))||n.length<10)return;const p=n.length<200;c.push({role:p?"user":"assistant",text:n})})}else{const e=o.innerText.trim();e.length>50&&c.push({role:"assistant",text:e})}f(o)}else a.includes("claude.ai")&&(s="claude",document.querySelectorAll(".font-user-message, .font-claude-message").forEach(i=>{const t=i.classList.contains("font-user-message");c.push({role:t?"user":"assistant",text:i.innerText}),f(i)}));if(c.length===0){const i=["chatgpt.com","openai.com","gemini.google.com","labs.google.com","figma.com","visily.ai","uizard.io","uxmagic.ai","banani.co","app.emergent.sh","rocket.new","lovable.dev","bolt.new","base44.com","create.xyz","memex.tech","buildfire.com","glideapps.com","flatlogic.com","retool.com","uibakery.io","zoho.com","appypie.com"].some(l=>a.includes(l));let t="";const m=i?100:50;if(i){const l=document.createTreeWalker(document.body,NodeFilter.SHOW_TEXT,{acceptNode:r=>{const n=r.parentElement;if(!n||n.offsetParent===null)return NodeFilter.FILTER_REJECT;const d=n.tagName.toLowerCase();return["script","style","noscript","iframe","svg","path","button","nav","footer","header"].includes(d)?NodeFilter.FILTER_REJECT:NodeFilter.FILTER_ACCEPT}});let e;for(;e=l.nextNode();){const r=e.textContent?.trim();r&&r.length>15&&(t+=r+`

`)}}else document.querySelectorAll("p, h1, h2, h3, h4, h5, li").forEach(r=>{const n=r.innerText;n&&n.length>20&&(t+=n+`

`)});if(!t.trim()&&!i&&(t=document.body.innerText),!t||t.trim().length<m)throw new Error(`Right page, but I don't see anything! ðŸ¤·â€â™‚ï¸

Start a conversation firstâ€”summarizing nothing is not my specialty!`);return f(document),{url:a,title:u,platform:s==="generic"&&i?"generic":s,conversation:[],rawText:t,images:g.slice(0,10)}}const y=c.length>0,E=c.map(o=>o.text).join("").length>50;if((!y||!E)&&(s==="chatgpt"||s==="gemini"||s==="claude"))throw new Error("No conversation found on this page. Start a chat first, then generate a summary.");return{url:a,title:u,platform:s,conversation:c,rawText:c.map(o=>`${o.role.toUpperCase()}: ${o.text}`).join(`

`),images:g.slice(0,10)}}
})()
