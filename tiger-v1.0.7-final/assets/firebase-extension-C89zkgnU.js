import{c as Zo}from"./createLucideIcon-CfY4lJMg.js";const l_=[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]],Rw=Zo("arrow-left",l_);const c_=[["path",{d:"m22 7-8.991 5.727a2 2 0 0 1-2.009 0L2 7",key:"132q7q"}],["rect",{x:"2",y:"4",width:"20",height:"16",rx:"2",key:"izxlao"}]],Sw=Zo("mail",c_);const u_=[["path",{d:"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8",key:"v9h5vc"}],["path",{d:"M21 3v5h-5",key:"1q7to0"}],["path",{d:"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16",key:"3uifl3"}],["path",{d:"M8 16H3v5",key:"1cv678"}]],Pw=Zo("refresh-cw",u_),h_=()=>{};var mc={};const ah={NODE_ADMIN:!1,SDK_VERSION:"${JSCORE_VERSION}"};const D=function(n,e){if(!n)throw Ln(e)},Ln=function(n){return new Error("Firebase Database ("+ah.SDK_VERSION+") INTERNAL ASSERT FAILED: "+n)};const lh=function(n){const e=[];let t=0;for(let s=0;s<n.length;s++){let i=n.charCodeAt(s);i<128?e[t++]=i:i<2048?(e[t++]=i>>6|192,e[t++]=i&63|128):(i&64512)===55296&&s+1<n.length&&(n.charCodeAt(s+1)&64512)===56320?(i=65536+((i&1023)<<10)+(n.charCodeAt(++s)&1023),e[t++]=i>>18|240,e[t++]=i>>12&63|128,e[t++]=i>>6&63|128,e[t++]=i&63|128):(e[t++]=i>>12|224,e[t++]=i>>6&63|128,e[t++]=i&63|128)}return e},d_=function(n){const e=[];let t=0,s=0;for(;t<n.length;){const i=n[t++];if(i<128)e[s++]=String.fromCharCode(i);else if(i>191&&i<224){const r=n[t++];e[s++]=String.fromCharCode((i&31)<<6|r&63)}else if(i>239&&i<365){const r=n[t++],a=n[t++],l=n[t++],u=((i&7)<<18|(r&63)<<12|(a&63)<<6|l&63)-65536;e[s++]=String.fromCharCode(55296+(u>>10)),e[s++]=String.fromCharCode(56320+(u&1023))}else{const r=n[t++],a=n[t++];e[s++]=String.fromCharCode((i&15)<<12|(r&63)<<6|a&63)}}return e.join("")},ea={byteToCharMap_:null,charToByteMap_:null,byteToCharMapWebSafe_:null,charToByteMapWebSafe_:null,ENCODED_VALS_BASE:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",get ENCODED_VALS(){return this.ENCODED_VALS_BASE+"+/="},get ENCODED_VALS_WEBSAFE(){return this.ENCODED_VALS_BASE+"-_."},HAS_NATIVE_SUPPORT:typeof atob=="function",encodeByteArray(n,e){if(!Array.isArray(n))throw Error("encodeByteArray takes an array as a parameter");this.init_();const t=e?this.byteToCharMapWebSafe_:this.byteToCharMap_,s=[];for(let i=0;i<n.length;i+=3){const r=n[i],a=i+1<n.length,l=a?n[i+1]:0,u=i+2<n.length,h=u?n[i+2]:0,f=r>>2,p=(r&3)<<4|l>>4;let m=(l&15)<<2|h>>6,A=h&63;u||(A=64,a||(m=64)),s.push(t[f],t[p],t[m],t[A])}return s.join("")},encodeString(n,e){return this.HAS_NATIVE_SUPPORT&&!e?btoa(n):this.encodeByteArray(lh(n),e)},decodeString(n,e){return this.HAS_NATIVE_SUPPORT&&!e?atob(n):d_(this.decodeStringToByteArray(n,e))},decodeStringToByteArray(n,e){this.init_();const t=e?this.charToByteMapWebSafe_:this.charToByteMap_,s=[];for(let i=0;i<n.length;){const r=t[n.charAt(i++)],l=i<n.length?t[n.charAt(i)]:0;++i;const h=i<n.length?t[n.charAt(i)]:64;++i;const p=i<n.length?t[n.charAt(i)]:64;if(++i,r==null||l==null||h==null||p==null)throw new f_;const m=r<<2|l>>4;if(s.push(m),h!==64){const A=l<<4&240|h>>2;if(s.push(A),p!==64){const b=h<<6&192|p;s.push(b)}}}return s},init_(){if(!this.byteToCharMap_){this.byteToCharMap_={},this.charToByteMap_={},this.byteToCharMapWebSafe_={},this.charToByteMapWebSafe_={};for(let n=0;n<this.ENCODED_VALS.length;n++)this.byteToCharMap_[n]=this.ENCODED_VALS.charAt(n),this.charToByteMap_[this.byteToCharMap_[n]]=n,this.byteToCharMapWebSafe_[n]=this.ENCODED_VALS_WEBSAFE.charAt(n),this.charToByteMapWebSafe_[this.byteToCharMapWebSafe_[n]]=n,n>=this.ENCODED_VALS_BASE.length&&(this.charToByteMap_[this.ENCODED_VALS_WEBSAFE.charAt(n)]=n,this.charToByteMapWebSafe_[this.ENCODED_VALS.charAt(n)]=n)}}};class f_ extends Error{constructor(){super(...arguments),this.name="DecodeBase64StringError"}}const ch=function(n){const e=lh(n);return ea.encodeByteArray(e,!0)},Vi=function(n){return ch(n).replace(/\./g,"")},yo=function(n){try{return ea.decodeString(n,!0)}catch{}return null};function p_(n){return uh(void 0,n)}function uh(n,e){if(!(e instanceof Object))return e;switch(e.constructor){case Date:const t=e;return new Date(t.getTime());case Object:n===void 0&&(n={});break;case Array:n=[];break;default:return e}for(const t in e)!e.hasOwnProperty(t)||!__(t)||(n[t]=uh(n[t],e[t]));return n}function __(n){return n!=="__proto__"}function m_(){if(typeof self<"u")return self;if(typeof window<"u")return window;if(typeof global<"u")return global;throw new Error("Unable to locate global object.")}const g_=()=>m_().__FIREBASE_DEFAULTS__,y_=()=>{if(typeof process>"u"||typeof mc>"u")return;const n=mc.__FIREBASE_DEFAULTS__;if(n)return JSON.parse(n)},E_=()=>{if(typeof document>"u")return;let n;try{n=document.cookie.match(/__FIREBASE_DEFAULTS__=([^;]+)/)}catch{return}const e=n&&yo(n[1]);return e&&JSON.parse(e)},ta=()=>{try{return h_()||g_()||y_()||E_()}catch{return}},v_=n=>ta()?.emulatorHosts?.[n],hh=n=>{const e=v_(n);if(!e)return;const t=e.lastIndexOf(":");if(t<=0||t+1===e.length)throw new Error(`Invalid host ${e} with no separate hostname and port!`);const s=parseInt(e.substring(t+1),10);return e[0]==="["?[e.substring(1,t-1),s]:[e.substring(0,t),s]},dh=()=>ta()?.config;class na{constructor(){this.reject=()=>{},this.resolve=()=>{},this.promise=new Promise((e,t)=>{this.resolve=e,this.reject=t})}wrapCallback(e){return(t,s)=>{t?this.reject(t):this.resolve(s),typeof e=="function"&&(this.promise.catch(()=>{}),e.length===1?e(t):e(t,s))}}}function $s(n){try{return(n.startsWith("http://")||n.startsWith("https://")?new URL(n).hostname:n).endsWith(".cloudworkstations.dev")}catch{return!1}}async function fh(n){return(await fetch(n,{credentials:"include"})).ok}function ph(n,e){if(n.uid)throw new Error('The "uid" field is no longer supported by mockUserToken. Please use "sub" instead for Firebase Auth User ID.');const t={alg:"none",type:"JWT"},s=e||"demo-project",i=n.iat||0,r=n.sub||n.user_id;if(!r)throw new Error("mockUserToken must contain 'sub' or 'user_id' field!");const a={iss:`https://securetoken.google.com/${s}`,aud:s,iat:i,exp:i+3600,auth_time:i,sub:r,user_id:r,firebase:{sign_in_provider:"custom",identities:{}},...n};return[Vi(JSON.stringify(t)),Vi(JSON.stringify(a)),""].join(".")}const _s={};function T_(){const n={prod:[],emulator:[]};for(const e of Object.keys(_s))_s[e]?n.emulator.push(e):n.prod.push(e);return n}function I_(n){let e=document.getElementById(n),t=!1;return e||(e=document.createElement("div"),e.setAttribute("id",n),t=!0),{created:t,element:e}}let gc=!1;function _h(n,e){if(typeof window>"u"||typeof document>"u"||!$s(window.location.host)||_s[n]===e||_s[n]||gc)return;_s[n]=e;function t(m){return`__firebase__banner__${m}`}const s="__firebase__banner",r=T_().prod.length>0;function a(){const m=document.getElementById(s);m&&m.remove()}function l(m){m.style.display="flex",m.style.background="#7faaf0",m.style.position="fixed",m.style.bottom="5px",m.style.left="5px",m.style.padding=".5em",m.style.borderRadius="5px",m.style.alignItems="center"}function u(m,A){m.setAttribute("width","24"),m.setAttribute("id",A),m.setAttribute("height","24"),m.setAttribute("viewBox","0 0 24 24"),m.setAttribute("fill","none"),m.style.marginLeft="-6px"}function h(){const m=document.createElement("span");return m.style.cursor="pointer",m.style.marginLeft="16px",m.style.fontSize="24px",m.innerHTML=" &times;",m.onclick=()=>{gc=!0,a()},m}function f(m,A){m.setAttribute("id",A),m.innerText="Learn more",m.href="https://firebase.google.com/docs/studio/preview-apps#preview-backend",m.setAttribute("target","__blank"),m.style.paddingLeft="5px",m.style.textDecoration="underline"}function p(){const m=I_(s),A=t("text"),b=document.getElementById(A)||document.createElement("span"),V=t("learnmore"),N=document.getElementById(V)||document.createElement("a"),j=t("preprendIcon"),G=document.getElementById(j)||document.createElementNS("http://www.w3.org/2000/svg","svg");if(m.created){const Y=m.element;l(Y),f(N,V);const Ce=h();u(G,j),Y.append(G,b,N,Ce),document.body.appendChild(Y)}r?(b.innerText="Preview backend disconnected.",G.innerHTML=`<g clip-path="url(#clip0_6013_33858)">
<path d="M4.8 17.6L12 5.6L19.2 17.6H4.8ZM6.91667 16.4H17.0833L12 7.93333L6.91667 16.4ZM12 15.6C12.1667 15.6 12.3056 15.5444 12.4167 15.4333C12.5389 15.3111 12.6 15.1667 12.6 15C12.6 14.8333 12.5389 14.6944 12.4167 14.5833C12.3056 14.4611 12.1667 14.4 12 14.4C11.8333 14.4 11.6889 14.4611 11.5667 14.5833C11.4556 14.6944 11.4 14.8333 11.4 15C11.4 15.1667 11.4556 15.3111 11.5667 15.4333C11.6889 15.5444 11.8333 15.6 12 15.6ZM11.4 13.6H12.6V10.4H11.4V13.6Z" fill="#212121"/>
</g>
<defs>
<clipPath id="clip0_6013_33858">
<rect width="24" height="24" fill="white"/>
</clipPath>
</defs>`):(G.innerHTML=`<g clip-path="url(#clip0_6083_34804)">
<path d="M11.4 15.2H12.6V11.2H11.4V15.2ZM12 10C12.1667 10 12.3056 9.94444 12.4167 9.83333C12.5389 9.71111 12.6 9.56667 12.6 9.4C12.6 9.23333 12.5389 9.09444 12.4167 8.98333C12.3056 8.86111 12.1667 8.8 12 8.8C11.8333 8.8 11.6889 8.86111 11.5667 8.98333C11.4556 9.09444 11.4 9.23333 11.4 9.4C11.4 9.56667 11.4556 9.71111 11.5667 9.83333C11.6889 9.94444 11.8333 10 12 10ZM12 18.4C11.1222 18.4 10.2944 18.2333 9.51667 17.9C8.73889 17.5667 8.05556 17.1111 7.46667 16.5333C6.88889 15.9444 6.43333 15.2611 6.1 14.4833C5.76667 13.7056 5.6 12.8778 5.6 12C5.6 11.1111 5.76667 10.2833 6.1 9.51667C6.43333 8.73889 6.88889 8.06111 7.46667 7.48333C8.05556 6.89444 8.73889 6.43333 9.51667 6.1C10.2944 5.76667 11.1222 5.6 12 5.6C12.8889 5.6 13.7167 5.76667 14.4833 6.1C15.2611 6.43333 15.9389 6.89444 16.5167 7.48333C17.1056 8.06111 17.5667 8.73889 17.9 9.51667C18.2333 10.2833 18.4 11.1111 18.4 12C18.4 12.8778 18.2333 13.7056 17.9 14.4833C17.5667 15.2611 17.1056 15.9444 16.5167 16.5333C15.9389 17.1111 15.2611 17.5667 14.4833 17.9C13.7167 18.2333 12.8889 18.4 12 18.4ZM12 17.2C13.4444 17.2 14.6722 16.6944 15.6833 15.6833C16.6944 14.6722 17.2 13.4444 17.2 12C17.2 10.5556 16.6944 9.32778 15.6833 8.31667C14.6722 7.30555 13.4444 6.8 12 6.8C10.5556 6.8 9.32778 7.30555 8.31667 8.31667C7.30556 9.32778 6.8 10.5556 6.8 12C6.8 13.4444 7.30556 14.6722 8.31667 15.6833C9.32778 16.6944 10.5556 17.2 12 17.2Z" fill="#212121"/>
</g>
<defs>
<clipPath id="clip0_6083_34804">
<rect width="24" height="24" fill="white"/>
</clipPath>
</defs>`,b.innerText="Preview backend running in this workspace."),b.setAttribute("id",A)}document.readyState==="loading"?window.addEventListener("DOMContentLoaded",p):p()}function mh(){return typeof navigator<"u"&&typeof navigator.userAgent=="string"?navigator.userAgent:""}function gh(){return typeof window<"u"&&!!(window.cordova||window.phonegap||window.PhoneGap)&&/ios|iphone|ipod|ipad|android|blackberry|iemobile/i.test(mh())}function w_(){const n=ta()?.forceEnvironment;if(n==="node")return!0;if(n==="browser")return!1;try{return Object.prototype.toString.call(global.process)==="[object process]"}catch{return!1}}function C_(){return typeof navigator=="object"&&navigator.product==="ReactNative"}function A_(){return ah.NODE_ADMIN===!0}function R_(){return!w_()&&!!navigator.userAgent&&navigator.userAgent.includes("Safari")&&!navigator.userAgent.includes("Chrome")}function S_(){try{return typeof indexedDB=="object"}catch{return!1}}function P_(){return new Promise((n,e)=>{try{let t=!0;const s="validate-browser-context-for-indexeddb-analytics-module",i=self.indexedDB.open(s);i.onsuccess=()=>{i.result.close(),t||self.indexedDB.deleteDatabase(s),n(!0)},i.onupgradeneeded=()=>{t=!1},i.onerror=()=>{e(i.error?.message||"")}}catch(t){e(t)}})}const b_="FirebaseError";class Fn extends Error{constructor(e,t,s){super(t),this.code=e,this.customData=s,this.name=b_,Object.setPrototypeOf(this,Fn.prototype),Error.captureStackTrace&&Error.captureStackTrace(this,yh.prototype.create)}}class yh{constructor(e,t,s){this.service=e,this.serviceName=t,this.errors=s}create(e,...t){const s=t[0]||{},i=`${this.service}/${e}`,r=this.errors[e],a=r?N_(r,s):"Error",l=`${this.serviceName}: ${a} (${i}).`;return new Fn(i,l,s)}}function N_(n,e){return n.replace(D_,(t,s)=>{const i=e[s];return i!=null?String(i):`<${s}?>`})}const D_=/\{\$([^}]+)}/g;function As(n){return JSON.parse(n)}function _e(n){return JSON.stringify(n)}const Eh=function(n){let e={},t={},s={},i="";try{const r=n.split(".");e=As(yo(r[0])||""),t=As(yo(r[1])||""),i=r[2],s=t.d||{},delete t.d}catch{}return{header:e,claims:t,data:s,signature:i}},k_=function(n){const e=Eh(n),t=e.claims;return!!t&&typeof t=="object"&&t.hasOwnProperty("iat")},V_=function(n){const e=Eh(n).claims;return typeof e=="object"&&e.admin===!0};function pt(n,e){return Object.prototype.hasOwnProperty.call(n,e)}function An(n,e){if(Object.prototype.hasOwnProperty.call(n,e))return n[e]}function yc(n){for(const e in n)if(Object.prototype.hasOwnProperty.call(n,e))return!1;return!0}function xi(n,e,t){const s={};for(const i in n)Object.prototype.hasOwnProperty.call(n,i)&&(s[i]=e.call(t,n[i],i,n));return s}function Rs(n,e){if(n===e)return!0;const t=Object.keys(n),s=Object.keys(e);for(const i of t){if(!s.includes(i))return!1;const r=n[i],a=e[i];if(Ec(r)&&Ec(a)){if(!Rs(r,a))return!1}else if(r!==a)return!1}for(const i of s)if(!t.includes(i))return!1;return!0}function Ec(n){return n!==null&&typeof n=="object"}function x_(n){const e=[];for(const[t,s]of Object.entries(n))Array.isArray(s)?s.forEach(i=>{e.push(encodeURIComponent(t)+"="+encodeURIComponent(i))}):e.push(encodeURIComponent(t)+"="+encodeURIComponent(s));return e.length?"&"+e.join("&"):""}class O_{constructor(){this.chain_=[],this.buf_=[],this.W_=[],this.pad_=[],this.inbuf_=0,this.total_=0,this.blockSize=512/8,this.pad_[0]=128;for(let e=1;e<this.blockSize;++e)this.pad_[e]=0;this.reset()}reset(){this.chain_[0]=1732584193,this.chain_[1]=4023233417,this.chain_[2]=2562383102,this.chain_[3]=271733878,this.chain_[4]=3285377520,this.inbuf_=0,this.total_=0}compress_(e,t){t||(t=0);const s=this.W_;if(typeof e=="string")for(let p=0;p<16;p++)s[p]=e.charCodeAt(t)<<24|e.charCodeAt(t+1)<<16|e.charCodeAt(t+2)<<8|e.charCodeAt(t+3),t+=4;else for(let p=0;p<16;p++)s[p]=e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3],t+=4;for(let p=16;p<80;p++){const m=s[p-3]^s[p-8]^s[p-14]^s[p-16];s[p]=(m<<1|m>>>31)&4294967295}let i=this.chain_[0],r=this.chain_[1],a=this.chain_[2],l=this.chain_[3],u=this.chain_[4],h,f;for(let p=0;p<80;p++){p<40?p<20?(h=l^r&(a^l),f=1518500249):(h=r^a^l,f=1859775393):p<60?(h=r&a|l&(r|a),f=2400959708):(h=r^a^l,f=3395469782);const m=(i<<5|i>>>27)+h+u+f+s[p]&4294967295;u=l,l=a,a=(r<<30|r>>>2)&4294967295,r=i,i=m}this.chain_[0]=this.chain_[0]+i&4294967295,this.chain_[1]=this.chain_[1]+r&4294967295,this.chain_[2]=this.chain_[2]+a&4294967295,this.chain_[3]=this.chain_[3]+l&4294967295,this.chain_[4]=this.chain_[4]+u&4294967295}update(e,t){if(e==null)return;t===void 0&&(t=e.length);const s=t-this.blockSize;let i=0;const r=this.buf_;let a=this.inbuf_;for(;i<t;){if(a===0)for(;i<=s;)this.compress_(e,i),i+=this.blockSize;if(typeof e=="string"){for(;i<t;)if(r[a]=e.charCodeAt(i),++a,++i,a===this.blockSize){this.compress_(r),a=0;break}}else for(;i<t;)if(r[a]=e[i],++a,++i,a===this.blockSize){this.compress_(r),a=0;break}}this.inbuf_=a,this.total_+=t}digest(){const e=[];let t=this.total_*8;this.inbuf_<56?this.update(this.pad_,56-this.inbuf_):this.update(this.pad_,this.blockSize-(this.inbuf_-56));for(let i=this.blockSize-1;i>=56;i--)this.buf_[i]=t&255,t/=256;this.compress_(this.buf_);let s=0;for(let i=0;i<5;i++)for(let r=24;r>=0;r-=8)e[s]=this.chain_[i]>>r&255,++s;return e}}function vh(n,e){return`${n} failed: ${e} argument `}const M_=function(n){const e=[];let t=0;for(let s=0;s<n.length;s++){let i=n.charCodeAt(s);if(i>=55296&&i<=56319){const r=i-55296;s++,D(s<n.length,"Surrogate pair missing trail surrogate.");const a=n.charCodeAt(s)-56320;i=65536+(r<<10)+a}i<128?e[t++]=i:i<2048?(e[t++]=i>>6|192,e[t++]=i&63|128):i<65536?(e[t++]=i>>12|224,e[t++]=i>>6&63|128,e[t++]=i&63|128):(e[t++]=i>>18|240,e[t++]=i>>12&63|128,e[t++]=i>>6&63|128,e[t++]=i&63|128)}return e},ar=function(n){let e=0;for(let t=0;t<n.length;t++){const s=n.charCodeAt(t);s<128?e++:s<2048?e+=2:s>=55296&&s<=56319?(e+=4,t++):e+=3}return e};function Ye(n){return n&&n._delegate?n._delegate:n}class Rn{constructor(e,t,s){this.name=e,this.instanceFactory=t,this.type=s,this.multipleInstances=!1,this.serviceProps={},this.instantiationMode="LAZY",this.onInstanceCreated=null}setInstantiationMode(e){return this.instantiationMode=e,this}setMultipleInstances(e){return this.multipleInstances=e,this}setServiceProps(e){return this.serviceProps=e,this}setInstanceCreatedCallback(e){return this.onInstanceCreated=e,this}}const Qt="[DEFAULT]";class L_{constructor(e,t){this.name=e,this.container=t,this.component=null,this.instances=new Map,this.instancesDeferred=new Map,this.instancesOptions=new Map,this.onInitCallbacks=new Map}get(e){const t=this.normalizeInstanceIdentifier(e);if(!this.instancesDeferred.has(t)){const s=new na;if(this.instancesDeferred.set(t,s),this.isInitialized(t)||this.shouldAutoInitialize())try{const i=this.getOrInitializeService({instanceIdentifier:t});i&&s.resolve(i)}catch{}}return this.instancesDeferred.get(t).promise}getImmediate(e){const t=this.normalizeInstanceIdentifier(e?.identifier),s=e?.optional??!1;if(this.isInitialized(t)||this.shouldAutoInitialize())try{return this.getOrInitializeService({instanceIdentifier:t})}catch(i){if(s)return null;throw i}else{if(s)return null;throw Error(`Service ${this.name} is not available`)}}getComponent(){return this.component}setComponent(e){if(e.name!==this.name)throw Error(`Mismatching Component ${e.name} for Provider ${this.name}.`);if(this.component)throw Error(`Component for ${this.name} has already been provided`);if(this.component=e,!!this.shouldAutoInitialize()){if(U_(e))try{this.getOrInitializeService({instanceIdentifier:Qt})}catch{}for(const[t,s]of this.instancesDeferred.entries()){const i=this.normalizeInstanceIdentifier(t);try{const r=this.getOrInitializeService({instanceIdentifier:i});s.resolve(r)}catch{}}}}clearInstance(e=Qt){this.instancesDeferred.delete(e),this.instancesOptions.delete(e),this.instances.delete(e)}async delete(){const e=Array.from(this.instances.values());await Promise.all([...e.filter(t=>"INTERNAL"in t).map(t=>t.INTERNAL.delete()),...e.filter(t=>"_delete"in t).map(t=>t._delete())])}isComponentSet(){return this.component!=null}isInitialized(e=Qt){return this.instances.has(e)}getOptions(e=Qt){return this.instancesOptions.get(e)||{}}initialize(e={}){const{options:t={}}=e,s=this.normalizeInstanceIdentifier(e.instanceIdentifier);if(this.isInitialized(s))throw Error(`${this.name}(${s}) has already been initialized`);if(!this.isComponentSet())throw Error(`Component ${this.name} has not been registered yet`);const i=this.getOrInitializeService({instanceIdentifier:s,options:t});for(const[r,a]of this.instancesDeferred.entries()){const l=this.normalizeInstanceIdentifier(r);s===l&&a.resolve(i)}return i}onInit(e,t){const s=this.normalizeInstanceIdentifier(t),i=this.onInitCallbacks.get(s)??new Set;i.add(e),this.onInitCallbacks.set(s,i);const r=this.instances.get(s);return r&&e(r,s),()=>{i.delete(e)}}invokeOnInitCallbacks(e,t){const s=this.onInitCallbacks.get(t);if(s)for(const i of s)try{i(e,t)}catch{}}getOrInitializeService({instanceIdentifier:e,options:t={}}){let s=this.instances.get(e);if(!s&&this.component&&(s=this.component.instanceFactory(this.container,{instanceIdentifier:F_(e),options:t}),this.instances.set(e,s),this.instancesOptions.set(e,t),this.invokeOnInitCallbacks(s,e),this.component.onInstanceCreated))try{this.component.onInstanceCreated(this.container,e,s)}catch{}return s||null}normalizeInstanceIdentifier(e=Qt){return this.component?this.component.multipleInstances?e:Qt:e}shouldAutoInitialize(){return!!this.component&&this.component.instantiationMode!=="EXPLICIT"}}function F_(n){return n===Qt?void 0:n}function U_(n){return n.instantiationMode==="EAGER"}class B_{constructor(e){this.name=e,this.providers=new Map}addComponent(e){const t=this.getProvider(e.name);if(t.isComponentSet())throw new Error(`Component ${e.name} has already been registered with ${this.name}`);t.setComponent(e)}addOrOverwriteComponent(e){this.getProvider(e.name).isComponentSet()&&this.providers.delete(e.name),this.addComponent(e)}getProvider(e){if(this.providers.has(e))return this.providers.get(e);const t=new L_(e,this);return this.providers.set(e,t),t}getProviders(){return Array.from(this.providers.values())}}var Q;(function(n){n[n.DEBUG=0]="DEBUG",n[n.VERBOSE=1]="VERBOSE",n[n.INFO=2]="INFO",n[n.WARN=3]="WARN",n[n.ERROR=4]="ERROR",n[n.SILENT=5]="SILENT"})(Q||(Q={}));const q_={debug:Q.DEBUG,verbose:Q.VERBOSE,info:Q.INFO,warn:Q.WARN,error:Q.ERROR,silent:Q.SILENT},j_=Q.INFO,W_={[Q.DEBUG]:"log",[Q.VERBOSE]:"log",[Q.INFO]:"info",[Q.WARN]:"warn",[Q.ERROR]:"error"},$_=(n,e,...t)=>{if(e<n.logLevel)return;const s=new Date().toISOString(),i=W_[e];if(!i)throw new Error(`Attempted to log a message with an invalid logType (value: ${e})`)};class sa{constructor(e){this.name=e,this._logLevel=j_,this._logHandler=$_,this._userLogHandler=null}get logLevel(){return this._logLevel}set logLevel(e){if(!(e in Q))throw new TypeError(`Invalid value "${e}" assigned to \`logLevel\``);this._logLevel=e}setLogLevel(e){this._logLevel=typeof e=="string"?q_[e]:e}get logHandler(){return this._logHandler}set logHandler(e){if(typeof e!="function")throw new TypeError("Value assigned to `logHandler` must be a function");this._logHandler=e}get userLogHandler(){return this._userLogHandler}set userLogHandler(e){this._userLogHandler=e}debug(...e){this._userLogHandler&&this._userLogHandler(this,Q.DEBUG,...e),this._logHandler(this,Q.DEBUG,...e)}log(...e){this._userLogHandler&&this._userLogHandler(this,Q.VERBOSE,...e),this._logHandler(this,Q.VERBOSE,...e)}info(...e){this._userLogHandler&&this._userLogHandler(this,Q.INFO,...e),this._logHandler(this,Q.INFO,...e)}warn(...e){this._userLogHandler&&this._userLogHandler(this,Q.WARN,...e),this._logHandler(this,Q.WARN,...e)}error(...e){this._userLogHandler&&this._userLogHandler(this,Q.ERROR,...e),this._logHandler(this,Q.ERROR,...e)}}const z_=(n,e)=>e.some(t=>n instanceof t);let vc,Tc;function G_(){return vc||(vc=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function H_(){return Tc||(Tc=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const Th=new WeakMap,Eo=new WeakMap,Ih=new WeakMap,to=new WeakMap,ia=new WeakMap;function K_(n){const e=new Promise((t,s)=>{const i=()=>{n.removeEventListener("success",r),n.removeEventListener("error",a)},r=()=>{t(wt(n.result)),i()},a=()=>{s(n.error),i()};n.addEventListener("success",r),n.addEventListener("error",a)});return e.then(t=>{t instanceof IDBCursor&&Th.set(t,n)}).catch(()=>{}),ia.set(e,n),e}function Q_(n){if(Eo.has(n))return;const e=new Promise((t,s)=>{const i=()=>{n.removeEventListener("complete",r),n.removeEventListener("error",a),n.removeEventListener("abort",a)},r=()=>{t(),i()},a=()=>{s(n.error||new DOMException("AbortError","AbortError")),i()};n.addEventListener("complete",r),n.addEventListener("error",a),n.addEventListener("abort",a)});Eo.set(n,e)}let vo={get(n,e,t){if(n instanceof IDBTransaction){if(e==="done")return Eo.get(n);if(e==="objectStoreNames")return n.objectStoreNames||Ih.get(n);if(e==="store")return t.objectStoreNames[1]?void 0:t.objectStore(t.objectStoreNames[0])}return wt(n[e])},set(n,e,t){return n[e]=t,!0},has(n,e){return n instanceof IDBTransaction&&(e==="done"||e==="store")?!0:e in n}};function Y_(n){vo=n(vo)}function X_(n){return n===IDBDatabase.prototype.transaction&&!("objectStoreNames"in IDBTransaction.prototype)?function(e,...t){const s=n.call(no(this),e,...t);return Ih.set(s,e.sort?e.sort():[e]),wt(s)}:H_().includes(n)?function(...e){return n.apply(no(this),e),wt(Th.get(this))}:function(...e){return wt(n.apply(no(this),e))}}function J_(n){return typeof n=="function"?X_(n):(n instanceof IDBTransaction&&Q_(n),z_(n,G_())?new Proxy(n,vo):n)}function wt(n){if(n instanceof IDBRequest)return K_(n);if(to.has(n))return to.get(n);const e=J_(n);return e!==n&&(to.set(n,e),ia.set(e,n)),e}const no=n=>ia.get(n);function Z_(n,e,{blocked:t,upgrade:s,blocking:i,terminated:r}={}){const a=indexedDB.open(n,e),l=wt(a);return s&&a.addEventListener("upgradeneeded",u=>{s(wt(a.result),u.oldVersion,u.newVersion,wt(a.transaction),u)}),t&&a.addEventListener("blocked",u=>t(u.oldVersion,u.newVersion,u)),l.then(u=>{r&&u.addEventListener("close",()=>r()),i&&u.addEventListener("versionchange",h=>i(h.oldVersion,h.newVersion,h))}).catch(()=>{}),l}const em=["get","getKey","getAll","getAllKeys","count"],tm=["put","add","delete","clear"],so=new Map;function Ic(n,e){if(!(n instanceof IDBDatabase&&!(e in n)&&typeof e=="string"))return;if(so.get(e))return so.get(e);const t=e.replace(/FromIndex$/,""),s=e!==t,i=tm.includes(t);if(!(t in(s?IDBIndex:IDBObjectStore).prototype)||!(i||em.includes(t)))return;const r=async function(a,...l){const u=this.transaction(a,i?"readwrite":"readonly");let h=u.store;return s&&(h=h.index(l.shift())),(await Promise.all([h[t](...l),i&&u.done]))[0]};return so.set(e,r),r}Y_(n=>({...n,get:(e,t,s)=>Ic(e,t)||n.get(e,t,s),has:(e,t)=>!!Ic(e,t)||n.has(e,t)}));class nm{constructor(e){this.container=e}getPlatformInfoString(){return this.container.getProviders().map(t=>{if(sm(t)){const s=t.getImmediate();return`${s.library}/${s.version}`}else return null}).filter(t=>t).join(" ")}}function sm(n){return n.getComponent()?.type==="VERSION"}const To="@firebase/app",wc="0.14.6";const ut=new sa("@firebase/app"),im="@firebase/app-compat",rm="@firebase/analytics-compat",om="@firebase/analytics",am="@firebase/app-check-compat",lm="@firebase/app-check",cm="@firebase/auth",um="@firebase/auth-compat",hm="@firebase/database",dm="@firebase/data-connect",fm="@firebase/database-compat",pm="@firebase/functions",_m="@firebase/functions-compat",mm="@firebase/installations",gm="@firebase/installations-compat",ym="@firebase/messaging",Em="@firebase/messaging-compat",vm="@firebase/performance",Tm="@firebase/performance-compat",Im="@firebase/remote-config",wm="@firebase/remote-config-compat",Cm="@firebase/storage",Am="@firebase/storage-compat",Rm="@firebase/firestore",Sm="@firebase/ai",Pm="@firebase/firestore-compat",bm="firebase",Nm="12.6.0";const Io="[DEFAULT]",Dm={[To]:"fire-core",[im]:"fire-core-compat",[om]:"fire-analytics",[rm]:"fire-analytics-compat",[lm]:"fire-app-check",[am]:"fire-app-check-compat",[cm]:"fire-auth",[um]:"fire-auth-compat",[hm]:"fire-rtdb",[dm]:"fire-data-connect",[fm]:"fire-rtdb-compat",[pm]:"fire-fn",[_m]:"fire-fn-compat",[mm]:"fire-iid",[gm]:"fire-iid-compat",[ym]:"fire-fcm",[Em]:"fire-fcm-compat",[vm]:"fire-perf",[Tm]:"fire-perf-compat",[Im]:"fire-rc",[wm]:"fire-rc-compat",[Cm]:"fire-gcs",[Am]:"fire-gcs-compat",[Rm]:"fire-fst",[Pm]:"fire-fst-compat",[Sm]:"fire-vertex","fire-js":"fire-js",[bm]:"fire-js-all"};const Oi=new Map,km=new Map,wo=new Map;function Cc(n,e){try{n.container.addComponent(e)}catch(t){ut.debug(`Component ${e.name} failed to register with FirebaseApp ${n.name}`,t)}}function Ss(n){const e=n.name;if(wo.has(e))return ut.debug(`There were multiple attempts to register component ${e}.`),!1;wo.set(e,n);for(const t of Oi.values())Cc(t,n);for(const t of km.values())Cc(t,n);return!0}function wh(n,e){const t=n.container.getProvider("heartbeat").getImmediate({optional:!0});return t&&t.triggerHeartbeat(),n.container.getProvider(e)}function Ch(n){return n==null?!1:n.settings!==void 0}const Vm={"no-app":"No Firebase App '{$appName}' has been created - call initializeApp() first","bad-app-name":"Illegal App name: '{$appName}'","duplicate-app":"Firebase App named '{$appName}' already exists with different options or config","app-deleted":"Firebase App named '{$appName}' already deleted","server-app-deleted":"Firebase Server App has been deleted","no-options":"Need to provide options, when not being deployed to hosting via source.","invalid-app-argument":"firebase.{$appName}() takes either no argument or a Firebase App instance.","invalid-log-argument":"First argument to `onLog` must be null or a function.","idb-open":"Error thrown when opening IndexedDB. Original error: {$originalErrorMessage}.","idb-get":"Error thrown when reading from IndexedDB. Original error: {$originalErrorMessage}.","idb-set":"Error thrown when writing to IndexedDB. Original error: {$originalErrorMessage}.","idb-delete":"Error thrown when deleting from IndexedDB. Original error: {$originalErrorMessage}.","finalization-registry-not-supported":"FirebaseServerApp deleteOnDeref field defined but the JS runtime does not support FinalizationRegistry.","invalid-server-app-environment":"FirebaseServerApp is not for use in browser environments."},Ct=new yh("app","Firebase",Vm);class xm{constructor(e,t,s){this._isDeleted=!1,this._options={...e},this._config={...t},this._name=t.name,this._automaticDataCollectionEnabled=t.automaticDataCollectionEnabled,this._container=s,this.container.addComponent(new Rn("app",()=>this,"PUBLIC"))}get automaticDataCollectionEnabled(){return this.checkDestroyed(),this._automaticDataCollectionEnabled}set automaticDataCollectionEnabled(e){this.checkDestroyed(),this._automaticDataCollectionEnabled=e}get name(){return this.checkDestroyed(),this._name}get options(){return this.checkDestroyed(),this._options}get config(){return this.checkDestroyed(),this._config}get container(){return this._container}get isDeleted(){return this._isDeleted}set isDeleted(e){this._isDeleted=e}checkDestroyed(){if(this.isDeleted)throw Ct.create("app-deleted",{appName:this._name})}}const Ah=Nm;function Rh(n,e={}){let t=n;typeof e!="object"&&(e={name:e});const s={name:Io,automaticDataCollectionEnabled:!0,...e},i=s.name;if(typeof i!="string"||!i)throw Ct.create("bad-app-name",{appName:String(i)});if(t||(t=dh()),!t)throw Ct.create("no-options");const r=Oi.get(i);if(r){if(Rs(t,r.options)&&Rs(s,r.config))return r;throw Ct.create("duplicate-app",{appName:i})}const a=new B_(i);for(const u of wo.values())a.addComponent(u);const l=new xm(t,s,a);return Oi.set(i,l),l}function Sh(n=Io){const e=Oi.get(n);if(!e&&n===Io&&dh())return Rh();if(!e)throw Ct.create("no-app",{appName:n});return e}function At(n,e,t){let s=Dm[n]??n;t&&(s+=`-${t}`);const i=s.match(/\s|\//),r=e.match(/\s|\//);if(i||r){const a=[`Unable to register library "${s}" with version "${e}":`];i&&a.push(`library name "${s}" contains illegal characters (whitespace or "/")`),i&&r&&a.push("and"),r&&a.push(`version name "${e}" contains illegal characters (whitespace or "/")`),ut.warn(a.join(" "));return}Ss(new Rn(`${s}-version`,()=>({library:s,version:e}),"VERSION"))}const Om="firebase-heartbeat-database",Mm=1,Ps="firebase-heartbeat-store";let io=null;function Ph(){return io||(io=Z_(Om,Mm,{upgrade:(n,e)=>{switch(e){case 0:try{n.createObjectStore(Ps)}catch{}}}}).catch(n=>{throw Ct.create("idb-open",{originalErrorMessage:n.message})})),io}async function Lm(n){try{const t=(await Ph()).transaction(Ps),s=await t.objectStore(Ps).get(bh(n));return await t.done,s}catch(e){if(e instanceof Fn)ut.warn(e.message);else{const t=Ct.create("idb-get",{originalErrorMessage:e?.message});ut.warn(t.message)}}}async function Ac(n,e){try{const s=(await Ph()).transaction(Ps,"readwrite");await s.objectStore(Ps).put(e,bh(n)),await s.done}catch(t){if(t instanceof Fn)ut.warn(t.message);else{const s=Ct.create("idb-set",{originalErrorMessage:t?.message});ut.warn(s.message)}}}function bh(n){return`${n.name}!${n.options.appId}`}const Fm=1024,Um=30;class Bm{constructor(e){this.container=e,this._heartbeatsCache=null;const t=this.container.getProvider("app").getImmediate();this._storage=new jm(t),this._heartbeatsCachePromise=this._storage.read().then(s=>(this._heartbeatsCache=s,s))}async triggerHeartbeat(){try{const t=this.container.getProvider("platform-logger").getImmediate().getPlatformInfoString(),s=Rc();if(this._heartbeatsCache?.heartbeats==null&&(this._heartbeatsCache=await this._heartbeatsCachePromise,this._heartbeatsCache?.heartbeats==null)||this._heartbeatsCache.lastSentHeartbeatDate===s||this._heartbeatsCache.heartbeats.some(i=>i.date===s))return;if(this._heartbeatsCache.heartbeats.push({date:s,agent:t}),this._heartbeatsCache.heartbeats.length>Um){const i=Wm(this._heartbeatsCache.heartbeats);this._heartbeatsCache.heartbeats.splice(i,1)}return this._storage.overwrite(this._heartbeatsCache)}catch(e){ut.warn(e)}}async getHeartbeatsHeader(){try{if(this._heartbeatsCache===null&&await this._heartbeatsCachePromise,this._heartbeatsCache?.heartbeats==null||this._heartbeatsCache.heartbeats.length===0)return"";const e=Rc(),{heartbeatsToSend:t,unsentEntries:s}=qm(this._heartbeatsCache.heartbeats),i=Vi(JSON.stringify({version:2,heartbeats:t}));return this._heartbeatsCache.lastSentHeartbeatDate=e,s.length>0?(this._heartbeatsCache.heartbeats=s,await this._storage.overwrite(this._heartbeatsCache)):(this._heartbeatsCache.heartbeats=[],this._storage.overwrite(this._heartbeatsCache)),i}catch(e){return ut.warn(e),""}}}function Rc(){return new Date().toISOString().substring(0,10)}function qm(n,e=Fm){const t=[];let s=n.slice();for(const i of n){const r=t.find(a=>a.agent===i.agent);if(r){if(r.dates.push(i.date),Sc(t)>e){r.dates.pop();break}}else if(t.push({agent:i.agent,dates:[i.date]}),Sc(t)>e){t.pop();break}s=s.slice(1)}return{heartbeatsToSend:t,unsentEntries:s}}class jm{constructor(e){this.app=e,this._canUseIndexedDBPromise=this.runIndexedDBEnvironmentCheck()}async runIndexedDBEnvironmentCheck(){return S_()?P_().then(()=>!0).catch(()=>!1):!1}async read(){if(await this._canUseIndexedDBPromise){const t=await Lm(this.app);return t?.heartbeats?t:{heartbeats:[]}}else return{heartbeats:[]}}async overwrite(e){if(await this._canUseIndexedDBPromise){const s=await this.read();return Ac(this.app,{lastSentHeartbeatDate:e.lastSentHeartbeatDate??s.lastSentHeartbeatDate,heartbeats:e.heartbeats})}else return}async add(e){if(await this._canUseIndexedDBPromise){const s=await this.read();return Ac(this.app,{lastSentHeartbeatDate:e.lastSentHeartbeatDate??s.lastSentHeartbeatDate,heartbeats:[...s.heartbeats,...e.heartbeats]})}else return}}function Sc(n){return Vi(JSON.stringify({version:2,heartbeats:n})).length}function Wm(n){if(n.length===0)return-1;let e=0,t=n[0].date;for(let s=1;s<n.length;s++)n[s].date<t&&(t=n[s].date,e=s);return e}function $m(n){Ss(new Rn("platform-logger",e=>new nm(e),"PRIVATE")),Ss(new Rn("heartbeat",e=>new Bm(e),"PRIVATE")),At(To,wc,n),At(To,wc,"esm2020"),At("fire-js","")}$m("");var zm="firebase",Gm="12.6.0";At(zm,Gm,"app");var Pc=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};var Rt,Nh;(function(){var n;function e(T,g){function E(){}E.prototype=g.prototype,T.F=g.prototype,T.prototype=new E,T.prototype.constructor=T,T.D=function(I,v,C){for(var y=Array(arguments.length-2),Le=2;Le<arguments.length;Le++)y[Le-2]=arguments[Le];return g.prototype[v].apply(I,y)}}function t(){this.blockSize=-1}function s(){this.blockSize=-1,this.blockSize=64,this.g=Array(4),this.C=Array(this.blockSize),this.o=this.h=0,this.u()}e(s,t),s.prototype.u=function(){this.g[0]=1732584193,this.g[1]=4023233417,this.g[2]=2562383102,this.g[3]=271733878,this.o=this.h=0};function i(T,g,E){E||(E=0);const I=Array(16);if(typeof g=="string")for(var v=0;v<16;++v)I[v]=g.charCodeAt(E++)|g.charCodeAt(E++)<<8|g.charCodeAt(E++)<<16|g.charCodeAt(E++)<<24;else for(v=0;v<16;++v)I[v]=g[E++]|g[E++]<<8|g[E++]<<16|g[E++]<<24;g=T.g[0],E=T.g[1],v=T.g[2];let C=T.g[3],y;y=g+(C^E&(v^C))+I[0]+3614090360&4294967295,g=E+(y<<7&4294967295|y>>>25),y=C+(v^g&(E^v))+I[1]+3905402710&4294967295,C=g+(y<<12&4294967295|y>>>20),y=v+(E^C&(g^E))+I[2]+606105819&4294967295,v=C+(y<<17&4294967295|y>>>15),y=E+(g^v&(C^g))+I[3]+3250441966&4294967295,E=v+(y<<22&4294967295|y>>>10),y=g+(C^E&(v^C))+I[4]+4118548399&4294967295,g=E+(y<<7&4294967295|y>>>25),y=C+(v^g&(E^v))+I[5]+1200080426&4294967295,C=g+(y<<12&4294967295|y>>>20),y=v+(E^C&(g^E))+I[6]+2821735955&4294967295,v=C+(y<<17&4294967295|y>>>15),y=E+(g^v&(C^g))+I[7]+4249261313&4294967295,E=v+(y<<22&4294967295|y>>>10),y=g+(C^E&(v^C))+I[8]+1770035416&4294967295,g=E+(y<<7&4294967295|y>>>25),y=C+(v^g&(E^v))+I[9]+2336552879&4294967295,C=g+(y<<12&4294967295|y>>>20),y=v+(E^C&(g^E))+I[10]+4294925233&4294967295,v=C+(y<<17&4294967295|y>>>15),y=E+(g^v&(C^g))+I[11]+2304563134&4294967295,E=v+(y<<22&4294967295|y>>>10),y=g+(C^E&(v^C))+I[12]+1804603682&4294967295,g=E+(y<<7&4294967295|y>>>25),y=C+(v^g&(E^v))+I[13]+4254626195&4294967295,C=g+(y<<12&4294967295|y>>>20),y=v+(E^C&(g^E))+I[14]+2792965006&4294967295,v=C+(y<<17&4294967295|y>>>15),y=E+(g^v&(C^g))+I[15]+1236535329&4294967295,E=v+(y<<22&4294967295|y>>>10),y=g+(v^C&(E^v))+I[1]+4129170786&4294967295,g=E+(y<<5&4294967295|y>>>27),y=C+(E^v&(g^E))+I[6]+3225465664&4294967295,C=g+(y<<9&4294967295|y>>>23),y=v+(g^E&(C^g))+I[11]+643717713&4294967295,v=C+(y<<14&4294967295|y>>>18),y=E+(C^g&(v^C))+I[0]+3921069994&4294967295,E=v+(y<<20&4294967295|y>>>12),y=g+(v^C&(E^v))+I[5]+3593408605&4294967295,g=E+(y<<5&4294967295|y>>>27),y=C+(E^v&(g^E))+I[10]+38016083&4294967295,C=g+(y<<9&4294967295|y>>>23),y=v+(g^E&(C^g))+I[15]+3634488961&4294967295,v=C+(y<<14&4294967295|y>>>18),y=E+(C^g&(v^C))+I[4]+3889429448&4294967295,E=v+(y<<20&4294967295|y>>>12),y=g+(v^C&(E^v))+I[9]+568446438&4294967295,g=E+(y<<5&4294967295|y>>>27),y=C+(E^v&(g^E))+I[14]+3275163606&4294967295,C=g+(y<<9&4294967295|y>>>23),y=v+(g^E&(C^g))+I[3]+4107603335&4294967295,v=C+(y<<14&4294967295|y>>>18),y=E+(C^g&(v^C))+I[8]+1163531501&4294967295,E=v+(y<<20&4294967295|y>>>12),y=g+(v^C&(E^v))+I[13]+2850285829&4294967295,g=E+(y<<5&4294967295|y>>>27),y=C+(E^v&(g^E))+I[2]+4243563512&4294967295,C=g+(y<<9&4294967295|y>>>23),y=v+(g^E&(C^g))+I[7]+1735328473&4294967295,v=C+(y<<14&4294967295|y>>>18),y=E+(C^g&(v^C))+I[12]+2368359562&4294967295,E=v+(y<<20&4294967295|y>>>12),y=g+(E^v^C)+I[5]+4294588738&4294967295,g=E+(y<<4&4294967295|y>>>28),y=C+(g^E^v)+I[8]+2272392833&4294967295,C=g+(y<<11&4294967295|y>>>21),y=v+(C^g^E)+I[11]+1839030562&4294967295,v=C+(y<<16&4294967295|y>>>16),y=E+(v^C^g)+I[14]+4259657740&4294967295,E=v+(y<<23&4294967295|y>>>9),y=g+(E^v^C)+I[1]+2763975236&4294967295,g=E+(y<<4&4294967295|y>>>28),y=C+(g^E^v)+I[4]+1272893353&4294967295,C=g+(y<<11&4294967295|y>>>21),y=v+(C^g^E)+I[7]+4139469664&4294967295,v=C+(y<<16&4294967295|y>>>16),y=E+(v^C^g)+I[10]+3200236656&4294967295,E=v+(y<<23&4294967295|y>>>9),y=g+(E^v^C)+I[13]+681279174&4294967295,g=E+(y<<4&4294967295|y>>>28),y=C+(g^E^v)+I[0]+3936430074&4294967295,C=g+(y<<11&4294967295|y>>>21),y=v+(C^g^E)+I[3]+3572445317&4294967295,v=C+(y<<16&4294967295|y>>>16),y=E+(v^C^g)+I[6]+76029189&4294967295,E=v+(y<<23&4294967295|y>>>9),y=g+(E^v^C)+I[9]+3654602809&4294967295,g=E+(y<<4&4294967295|y>>>28),y=C+(g^E^v)+I[12]+3873151461&4294967295,C=g+(y<<11&4294967295|y>>>21),y=v+(C^g^E)+I[15]+530742520&4294967295,v=C+(y<<16&4294967295|y>>>16),y=E+(v^C^g)+I[2]+3299628645&4294967295,E=v+(y<<23&4294967295|y>>>9),y=g+(v^(E|~C))+I[0]+4096336452&4294967295,g=E+(y<<6&4294967295|y>>>26),y=C+(E^(g|~v))+I[7]+1126891415&4294967295,C=g+(y<<10&4294967295|y>>>22),y=v+(g^(C|~E))+I[14]+2878612391&4294967295,v=C+(y<<15&4294967295|y>>>17),y=E+(C^(v|~g))+I[5]+4237533241&4294967295,E=v+(y<<21&4294967295|y>>>11),y=g+(v^(E|~C))+I[12]+1700485571&4294967295,g=E+(y<<6&4294967295|y>>>26),y=C+(E^(g|~v))+I[3]+2399980690&4294967295,C=g+(y<<10&4294967295|y>>>22),y=v+(g^(C|~E))+I[10]+4293915773&4294967295,v=C+(y<<15&4294967295|y>>>17),y=E+(C^(v|~g))+I[1]+2240044497&4294967295,E=v+(y<<21&4294967295|y>>>11),y=g+(v^(E|~C))+I[8]+1873313359&4294967295,g=E+(y<<6&4294967295|y>>>26),y=C+(E^(g|~v))+I[15]+4264355552&4294967295,C=g+(y<<10&4294967295|y>>>22),y=v+(g^(C|~E))+I[6]+2734768916&4294967295,v=C+(y<<15&4294967295|y>>>17),y=E+(C^(v|~g))+I[13]+1309151649&4294967295,E=v+(y<<21&4294967295|y>>>11),y=g+(v^(E|~C))+I[4]+4149444226&4294967295,g=E+(y<<6&4294967295|y>>>26),y=C+(E^(g|~v))+I[11]+3174756917&4294967295,C=g+(y<<10&4294967295|y>>>22),y=v+(g^(C|~E))+I[2]+718787259&4294967295,v=C+(y<<15&4294967295|y>>>17),y=E+(C^(v|~g))+I[9]+3951481745&4294967295,T.g[0]=T.g[0]+g&4294967295,T.g[1]=T.g[1]+(v+(y<<21&4294967295|y>>>11))&4294967295,T.g[2]=T.g[2]+v&4294967295,T.g[3]=T.g[3]+C&4294967295}s.prototype.v=function(T,g){g===void 0&&(g=T.length);const E=g-this.blockSize,I=this.C;let v=this.h,C=0;for(;C<g;){if(v==0)for(;C<=E;)i(this,T,C),C+=this.blockSize;if(typeof T=="string"){for(;C<g;)if(I[v++]=T.charCodeAt(C++),v==this.blockSize){i(this,I),v=0;break}}else for(;C<g;)if(I[v++]=T[C++],v==this.blockSize){i(this,I),v=0;break}}this.h=v,this.o+=g},s.prototype.A=function(){var T=Array((this.h<56?this.blockSize:this.blockSize*2)-this.h);T[0]=128;for(var g=1;g<T.length-8;++g)T[g]=0;g=this.o*8;for(var E=T.length-8;E<T.length;++E)T[E]=g&255,g/=256;for(this.v(T),T=Array(16),g=0,E=0;E<4;++E)for(let I=0;I<32;I+=8)T[g++]=this.g[E]>>>I&255;return T};function r(T,g){var E=l;return Object.prototype.hasOwnProperty.call(E,T)?E[T]:E[T]=g(T)}function a(T,g){this.h=g;const E=[];let I=!0;for(let v=T.length-1;v>=0;v--){const C=T[v]|0;I&&C==g||(E[v]=C,I=!1)}this.g=E}var l={};function u(T){return-128<=T&&T<128?r(T,function(g){return new a([g|0],g<0?-1:0)}):new a([T|0],T<0?-1:0)}function h(T){if(isNaN(T)||!isFinite(T))return p;if(T<0)return N(h(-T));const g=[];let E=1;for(let I=0;T>=E;I++)g[I]=T/E|0,E*=4294967296;return new a(g,0)}function f(T,g){if(T.length==0)throw Error("number format error: empty string");if(g=g||10,g<2||36<g)throw Error("radix out of range: "+g);if(T.charAt(0)=="-")return N(f(T.substring(1),g));if(T.indexOf("-")>=0)throw Error('number format error: interior "-" character');const E=h(Math.pow(g,8));let I=p;for(let C=0;C<T.length;C+=8){var v=Math.min(8,T.length-C);const y=parseInt(T.substring(C,C+v),g);v<8?(v=h(Math.pow(g,v)),I=I.j(v).add(h(y))):(I=I.j(E),I=I.add(h(y)))}return I}var p=u(0),m=u(1),A=u(16777216);n=a.prototype,n.m=function(){if(V(this))return-N(this).m();let T=0,g=1;for(let E=0;E<this.g.length;E++){const I=this.i(E);T+=(I>=0?I:4294967296+I)*g,g*=4294967296}return T},n.toString=function(T){if(T=T||10,T<2||36<T)throw Error("radix out of range: "+T);if(b(this))return"0";if(V(this))return"-"+N(this).toString(T);const g=h(Math.pow(T,6));var E=this;let I="";for(;;){const v=Ce(E,g).g;E=j(E,v.j(g));let C=((E.g.length>0?E.g[0]:E.h)>>>0).toString(T);if(E=v,b(E))return C+I;for(;C.length<6;)C="0"+C;I=C+I}},n.i=function(T){return T<0?0:T<this.g.length?this.g[T]:this.h};function b(T){if(T.h!=0)return!1;for(let g=0;g<T.g.length;g++)if(T.g[g]!=0)return!1;return!0}function V(T){return T.h==-1}n.l=function(T){return T=j(this,T),V(T)?-1:b(T)?0:1};function N(T){const g=T.g.length,E=[];for(let I=0;I<g;I++)E[I]=~T.g[I];return new a(E,~T.h).add(m)}n.abs=function(){return V(this)?N(this):this},n.add=function(T){const g=Math.max(this.g.length,T.g.length),E=[];let I=0;for(let v=0;v<=g;v++){let C=I+(this.i(v)&65535)+(T.i(v)&65535),y=(C>>>16)+(this.i(v)>>>16)+(T.i(v)>>>16);I=y>>>16,C&=65535,y&=65535,E[v]=y<<16|C}return new a(E,E[E.length-1]&-2147483648?-1:0)};function j(T,g){return T.add(N(g))}n.j=function(T){if(b(this)||b(T))return p;if(V(this))return V(T)?N(this).j(N(T)):N(N(this).j(T));if(V(T))return N(this.j(N(T)));if(this.l(A)<0&&T.l(A)<0)return h(this.m()*T.m());const g=this.g.length+T.g.length,E=[];for(var I=0;I<2*g;I++)E[I]=0;for(I=0;I<this.g.length;I++)for(let v=0;v<T.g.length;v++){const C=this.i(I)>>>16,y=this.i(I)&65535,Le=T.i(v)>>>16,Wt=T.i(v)&65535;E[2*I+2*v]+=y*Wt,G(E,2*I+2*v),E[2*I+2*v+1]+=C*Wt,G(E,2*I+2*v+1),E[2*I+2*v+1]+=y*Le,G(E,2*I+2*v+1),E[2*I+2*v+2]+=C*Le,G(E,2*I+2*v+2)}for(T=0;T<g;T++)E[T]=E[2*T+1]<<16|E[2*T];for(T=g;T<2*g;T++)E[T]=0;return new a(E,0)};function G(T,g){for(;(T[g]&65535)!=T[g];)T[g+1]+=T[g]>>>16,T[g]&=65535,g++}function Y(T,g){this.g=T,this.h=g}function Ce(T,g){if(b(g))throw Error("division by zero");if(b(T))return new Y(p,p);if(V(T))return g=Ce(N(T),g),new Y(N(g.g),N(g.h));if(V(g))return g=Ce(T,N(g)),new Y(N(g.g),g.h);if(T.g.length>30){if(V(T)||V(g))throw Error("slowDivide_ only works with positive integers.");for(var E=m,I=g;I.l(T)<=0;)E=Me(E),I=Me(I);var v=Ee(E,1),C=Ee(I,1);for(I=Ee(I,2),E=Ee(E,2);!b(I);){var y=C.add(I);y.l(T)<=0&&(v=v.add(E),C=y),I=Ee(I,1),E=Ee(E,1)}return g=j(T,v.j(g)),new Y(v,g)}for(v=p;T.l(g)>=0;){for(E=Math.max(1,Math.floor(T.m()/g.m())),I=Math.ceil(Math.log(E)/Math.LN2),I=I<=48?1:Math.pow(2,I-48),C=h(E),y=C.j(g);V(y)||y.l(T)>0;)E-=I,C=h(E),y=C.j(g);b(C)&&(C=m),v=v.add(C),T=j(T,y)}return new Y(v,T)}n.B=function(T){return Ce(this,T).h},n.and=function(T){const g=Math.max(this.g.length,T.g.length),E=[];for(let I=0;I<g;I++)E[I]=this.i(I)&T.i(I);return new a(E,this.h&T.h)},n.or=function(T){const g=Math.max(this.g.length,T.g.length),E=[];for(let I=0;I<g;I++)E[I]=this.i(I)|T.i(I);return new a(E,this.h|T.h)},n.xor=function(T){const g=Math.max(this.g.length,T.g.length),E=[];for(let I=0;I<g;I++)E[I]=this.i(I)^T.i(I);return new a(E,this.h^T.h)};function Me(T){const g=T.g.length+1,E=[];for(let I=0;I<g;I++)E[I]=T.i(I)<<1|T.i(I-1)>>>31;return new a(E,T.h)}function Ee(T,g){const E=g>>5;g%=32;const I=T.g.length-E,v=[];for(let C=0;C<I;C++)v[C]=g>0?T.i(C+E)>>>g|T.i(C+E+1)<<32-g:T.i(C+E);return new a(v,T.h)}s.prototype.digest=s.prototype.A,s.prototype.reset=s.prototype.u,s.prototype.update=s.prototype.v,Nh=s,a.prototype.add=a.prototype.add,a.prototype.multiply=a.prototype.j,a.prototype.modulo=a.prototype.B,a.prototype.compare=a.prototype.l,a.prototype.toNumber=a.prototype.m,a.prototype.toString=a.prototype.toString,a.prototype.getBits=a.prototype.i,a.fromNumber=h,a.fromString=f,Rt=a}).apply(typeof Pc<"u"?Pc:typeof self<"u"?self:typeof window<"u"?window:{});var yi=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};var Dh,ds,kh,Ri,Co,Vh,xh,Oh;(function(){var n,e=Object.defineProperty;function t(o){o=[typeof globalThis=="object"&&globalThis,o,typeof window=="object"&&window,typeof self=="object"&&self,typeof yi=="object"&&yi];for(var c=0;c<o.length;++c){var d=o[c];if(d&&d.Math==Math)return d}throw Error("Cannot find global object")}var s=t(this);function i(o,c){if(c)e:{var d=s;o=o.split(".");for(var _=0;_<o.length-1;_++){var w=o[_];if(!(w in d))break e;d=d[w]}o=o[o.length-1],_=d[o],c=c(_),c!=_&&c!=null&&e(d,o,{configurable:!0,writable:!0,value:c})}}i("Symbol.dispose",function(o){return o||Symbol("Symbol.dispose")}),i("Array.prototype.values",function(o){return o||function(){return this[Symbol.iterator]()}}),i("Object.entries",function(o){return o||function(c){var d=[],_;for(_ in c)Object.prototype.hasOwnProperty.call(c,_)&&d.push([_,c[_]]);return d}});var r=r||{},a=this||self;function l(o){var c=typeof o;return c=="object"&&o!=null||c=="function"}function u(o,c,d){return o.call.apply(o.bind,arguments)}function h(o,c,d){return h=u,h.apply(null,arguments)}function f(o,c){var d=Array.prototype.slice.call(arguments,1);return function(){var _=d.slice();return _.push.apply(_,arguments),o.apply(this,_)}}function p(o,c){function d(){}d.prototype=c.prototype,o.Z=c.prototype,o.prototype=new d,o.prototype.constructor=o,o.Ob=function(_,w,R){for(var k=Array(arguments.length-2),q=2;q<arguments.length;q++)k[q-2]=arguments[q];return c.prototype[w].apply(_,k)}}var m=typeof AsyncContext<"u"&&typeof AsyncContext.Snapshot=="function"?o=>o&&AsyncContext.Snapshot.wrap(o):o=>o;function A(o){const c=o.length;if(c>0){const d=Array(c);for(let _=0;_<c;_++)d[_]=o[_];return d}return[]}function b(o,c){for(let _=1;_<arguments.length;_++){const w=arguments[_];var d=typeof w;if(d=d!="object"?d:w?Array.isArray(w)?"array":d:"null",d=="array"||d=="object"&&typeof w.length=="number"){d=o.length||0;const R=w.length||0;o.length=d+R;for(let k=0;k<R;k++)o[d+k]=w[k]}else o.push(w)}}class V{constructor(c,d){this.i=c,this.j=d,this.h=0,this.g=null}get(){let c;return this.h>0?(this.h--,c=this.g,this.g=c.next,c.next=null):c=this.i(),c}}function N(o){a.setTimeout(()=>{throw o},0)}function j(){var o=T;let c=null;return o.g&&(c=o.g,o.g=o.g.next,o.g||(o.h=null),c.next=null),c}class G{constructor(){this.h=this.g=null}add(c,d){const _=Y.get();_.set(c,d),this.h?this.h.next=_:this.g=_,this.h=_}}var Y=new V(()=>new Ce,o=>o.reset());class Ce{constructor(){this.next=this.g=this.h=null}set(c,d){this.h=c,this.g=d,this.next=null}reset(){this.next=this.g=this.h=null}}let Me,Ee=!1,T=new G,g=()=>{const o=Promise.resolve(void 0);Me=()=>{o.then(E)}};function E(){for(var o;o=j();){try{o.h.call(o.g)}catch(d){N(d)}var c=Y;c.j(o),c.h<100&&(c.h++,o.next=c.g,c.g=o)}Ee=!1}function I(){this.u=this.u,this.C=this.C}I.prototype.u=!1,I.prototype.dispose=function(){this.u||(this.u=!0,this.N())},I.prototype[Symbol.dispose]=function(){this.dispose()},I.prototype.N=function(){if(this.C)for(;this.C.length;)this.C.shift()()};function v(o,c){this.type=o,this.g=this.target=c,this.defaultPrevented=!1}v.prototype.h=function(){this.defaultPrevented=!0};var C=(function(){if(!a.addEventListener||!Object.defineProperty)return!1;var o=!1,c=Object.defineProperty({},"passive",{get:function(){o=!0}});try{const d=()=>{};a.addEventListener("test",d,c),a.removeEventListener("test",d,c)}catch{}return o})();function y(o){return/^[\s\xa0]*$/.test(o)}function Le(o,c){v.call(this,o?o.type:""),this.relatedTarget=this.g=this.target=null,this.button=this.screenY=this.screenX=this.clientY=this.clientX=0,this.key="",this.metaKey=this.shiftKey=this.altKey=this.ctrlKey=!1,this.state=null,this.pointerId=0,this.pointerType="",this.i=null,o&&this.init(o,c)}p(Le,v),Le.prototype.init=function(o,c){const d=this.type=o.type,_=o.changedTouches&&o.changedTouches.length?o.changedTouches[0]:null;this.target=o.target||o.srcElement,this.g=c,c=o.relatedTarget,c||(d=="mouseover"?c=o.fromElement:d=="mouseout"&&(c=o.toElement)),this.relatedTarget=c,_?(this.clientX=_.clientX!==void 0?_.clientX:_.pageX,this.clientY=_.clientY!==void 0?_.clientY:_.pageY,this.screenX=_.screenX||0,this.screenY=_.screenY||0):(this.clientX=o.clientX!==void 0?o.clientX:o.pageX,this.clientY=o.clientY!==void 0?o.clientY:o.pageY,this.screenX=o.screenX||0,this.screenY=o.screenY||0),this.button=o.button,this.key=o.key||"",this.ctrlKey=o.ctrlKey,this.altKey=o.altKey,this.shiftKey=o.shiftKey,this.metaKey=o.metaKey,this.pointerId=o.pointerId||0,this.pointerType=o.pointerType,this.state=o.state,this.i=o,o.defaultPrevented&&Le.Z.h.call(this)},Le.prototype.h=function(){Le.Z.h.call(this);const o=this.i;o.preventDefault?o.preventDefault():o.returnValue=!1};var Wt="closure_listenable_"+(Math.random()*1e6|0),Np=0;function Dp(o,c,d,_,w){this.listener=o,this.proxy=null,this.src=c,this.type=d,this.capture=!!_,this.ha=w,this.key=++Np,this.da=this.fa=!1}function si(o){o.da=!0,o.listener=null,o.proxy=null,o.src=null,o.ha=null}function ii(o,c,d){for(const _ in o)c.call(d,o[_],_,o)}function kp(o,c){for(const d in o)c.call(void 0,o[d],d,o)}function _l(o){const c={};for(const d in o)c[d]=o[d];return c}const ml="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" ");function gl(o,c){let d,_;for(let w=1;w<arguments.length;w++){_=arguments[w];for(d in _)o[d]=_[d];for(let R=0;R<ml.length;R++)d=ml[R],Object.prototype.hasOwnProperty.call(_,d)&&(o[d]=_[d])}}function ri(o){this.src=o,this.g={},this.h=0}ri.prototype.add=function(o,c,d,_,w){const R=o.toString();o=this.g[R],o||(o=this.g[R]=[],this.h++);const k=kr(o,c,_,w);return k>-1?(c=o[k],d||(c.fa=!1)):(c=new Dp(c,this.src,R,!!_,w),c.fa=d,o.push(c)),c};function Dr(o,c){const d=c.type;if(d in o.g){var _=o.g[d],w=Array.prototype.indexOf.call(_,c,void 0),R;(R=w>=0)&&Array.prototype.splice.call(_,w,1),R&&(si(c),o.g[d].length==0&&(delete o.g[d],o.h--))}}function kr(o,c,d,_){for(let w=0;w<o.length;++w){const R=o[w];if(!R.da&&R.listener==c&&R.capture==!!d&&R.ha==_)return w}return-1}var Vr="closure_lm_"+(Math.random()*1e6|0),xr={};function yl(o,c,d,_,w){if(Array.isArray(c)){for(let R=0;R<c.length;R++)yl(o,c[R],d,_,w);return null}return d=Tl(d),o&&o[Wt]?o.J(c,d,l(_)?!!_.capture:!1,w):Vp(o,c,d,!1,_,w)}function Vp(o,c,d,_,w,R){if(!c)throw Error("Invalid event type");const k=l(w)?!!w.capture:!!w;let q=Mr(o);if(q||(o[Vr]=q=new ri(o)),d=q.add(c,d,_,k,R),d.proxy)return d;if(_=xp(),d.proxy=_,_.src=o,_.listener=d,o.addEventListener)C||(w=k),w===void 0&&(w=!1),o.addEventListener(c.toString(),_,w);else if(o.attachEvent)o.attachEvent(vl(c.toString()),_);else if(o.addListener&&o.removeListener)o.addListener(_);else throw Error("addEventListener and attachEvent are unavailable.");return d}function xp(){function o(d){return c.call(o.src,o.listener,d)}const c=Op;return o}function El(o,c,d,_,w){if(Array.isArray(c))for(var R=0;R<c.length;R++)El(o,c[R],d,_,w);else _=l(_)?!!_.capture:!!_,d=Tl(d),o&&o[Wt]?(o=o.i,R=String(c).toString(),R in o.g&&(c=o.g[R],d=kr(c,d,_,w),d>-1&&(si(c[d]),Array.prototype.splice.call(c,d,1),c.length==0&&(delete o.g[R],o.h--)))):o&&(o=Mr(o))&&(c=o.g[c.toString()],o=-1,c&&(o=kr(c,d,_,w)),(d=o>-1?c[o]:null)&&Or(d))}function Or(o){if(typeof o!="number"&&o&&!o.da){var c=o.src;if(c&&c[Wt])Dr(c.i,o);else{var d=o.type,_=o.proxy;c.removeEventListener?c.removeEventListener(d,_,o.capture):c.detachEvent?c.detachEvent(vl(d),_):c.addListener&&c.removeListener&&c.removeListener(_),(d=Mr(c))?(Dr(d,o),d.h==0&&(d.src=null,c[Vr]=null)):si(o)}}}function vl(o){return o in xr?xr[o]:xr[o]="on"+o}function Op(o,c){if(o.da)o=!0;else{c=new Le(c,this);const d=o.listener,_=o.ha||o.src;o.fa&&Or(o),o=d.call(_,c)}return o}function Mr(o){return o=o[Vr],o instanceof ri?o:null}var Lr="__closure_events_fn_"+(Math.random()*1e9>>>0);function Tl(o){return typeof o=="function"?o:(o[Lr]||(o[Lr]=function(c){return o.handleEvent(c)}),o[Lr])}function Pe(){I.call(this),this.i=new ri(this),this.M=this,this.G=null}p(Pe,I),Pe.prototype[Wt]=!0,Pe.prototype.removeEventListener=function(o,c,d,_){El(this,o,c,d,_)};function Ve(o,c){var d,_=o.G;if(_)for(d=[];_;_=_.G)d.push(_);if(o=o.M,_=c.type||c,typeof c=="string")c=new v(c,o);else if(c instanceof v)c.target=c.target||o;else{var w=c;c=new v(_,o),gl(c,w)}w=!0;let R,k;if(d)for(k=d.length-1;k>=0;k--)R=c.g=d[k],w=oi(R,_,!0,c)&&w;if(R=c.g=o,w=oi(R,_,!0,c)&&w,w=oi(R,_,!1,c)&&w,d)for(k=0;k<d.length;k++)R=c.g=d[k],w=oi(R,_,!1,c)&&w}Pe.prototype.N=function(){if(Pe.Z.N.call(this),this.i){var o=this.i;for(const c in o.g){const d=o.g[c];for(let _=0;_<d.length;_++)si(d[_]);delete o.g[c],o.h--}}this.G=null},Pe.prototype.J=function(o,c,d,_){return this.i.add(String(o),c,!1,d,_)},Pe.prototype.K=function(o,c,d,_){return this.i.add(String(o),c,!0,d,_)};function oi(o,c,d,_){if(c=o.i.g[String(c)],!c)return!0;c=c.concat();let w=!0;for(let R=0;R<c.length;++R){const k=c[R];if(k&&!k.da&&k.capture==d){const q=k.listener,pe=k.ha||k.src;k.fa&&Dr(o.i,k),w=q.call(pe,_)!==!1&&w}}return w&&!_.defaultPrevented}function Mp(o,c){if(typeof o!="function")if(o&&typeof o.handleEvent=="function")o=h(o.handleEvent,o);else throw Error("Invalid listener argument");return Number(c)>2147483647?-1:a.setTimeout(o,c||0)}function Il(o){o.g=Mp(()=>{o.g=null,o.i&&(o.i=!1,Il(o))},o.l);const c=o.h;o.h=null,o.m.apply(null,c)}class Lp extends I{constructor(c,d){super(),this.m=c,this.l=d,this.h=null,this.i=!1,this.g=null}j(c){this.h=arguments,this.g?this.i=!0:Il(this)}N(){super.N(),this.g&&(a.clearTimeout(this.g),this.g=null,this.i=!1,this.h=null)}}function Gn(o){I.call(this),this.h=o,this.g={}}p(Gn,I);var wl=[];function Cl(o){ii(o.g,function(c,d){this.g.hasOwnProperty(d)&&Or(c)},o),o.g={}}Gn.prototype.N=function(){Gn.Z.N.call(this),Cl(this)},Gn.prototype.handleEvent=function(){throw Error("EventHandler.handleEvent not implemented")};var Fr=a.JSON.stringify,Fp=a.JSON.parse,Up=class{stringify(o){return a.JSON.stringify(o,void 0)}parse(o){return a.JSON.parse(o,void 0)}};function Al(){}function Rl(){}var Hn={OPEN:"a",hb:"b",ERROR:"c",tb:"d"};function Ur(){v.call(this,"d")}p(Ur,v);function Br(){v.call(this,"c")}p(Br,v);var $t={},Sl=null;function ai(){return Sl=Sl||new Pe}$t.Ia="serverreachability";function Pl(o){v.call(this,$t.Ia,o)}p(Pl,v);function Kn(o){const c=ai();Ve(c,new Pl(c))}$t.STAT_EVENT="statevent";function bl(o,c){v.call(this,$t.STAT_EVENT,o),this.stat=c}p(bl,v);function xe(o){const c=ai();Ve(c,new bl(c,o))}$t.Ja="timingevent";function Nl(o,c){v.call(this,$t.Ja,o),this.size=c}p(Nl,v);function Qn(o,c){if(typeof o!="function")throw Error("Fn must not be null and must be a function");return a.setTimeout(function(){o()},c)}function Yn(){this.g=!0}Yn.prototype.ua=function(){this.g=!1};function Bp(o,c,d,_,w,R){o.info(function(){if(o.g)if(R){var k="",q=R.split("&");for(let ee=0;ee<q.length;ee++){var pe=q[ee].split("=");if(pe.length>1){const ve=pe[0];pe=pe[1];const Ze=ve.split("_");k=Ze.length>=2&&Ze[1]=="type"?k+(ve+"="+pe+"&"):k+(ve+"=redacted&")}}}else k=null;else k=R;return"XMLHTTP REQ ("+_+") [attempt "+w+"]: "+c+`
`+d+`
`+k})}function qp(o,c,d,_,w,R,k){o.info(function(){return"XMLHTTP RESP ("+_+") [ attempt "+w+"]: "+c+`
`+d+`
`+R+" "+k})}function un(o,c,d,_){o.info(function(){return"XMLHTTP TEXT ("+c+"): "+Wp(o,d)+(_?" "+_:"")})}function jp(o,c){o.info(function(){return"TIMEOUT: "+c})}Yn.prototype.info=function(){};function Wp(o,c){if(!o.g)return c;if(!c)return null;try{const R=JSON.parse(c);if(R){for(o=0;o<R.length;o++)if(Array.isArray(R[o])){var d=R[o];if(!(d.length<2)){var _=d[1];if(Array.isArray(_)&&!(_.length<1)){var w=_[0];if(w!="noop"&&w!="stop"&&w!="close")for(let k=1;k<_.length;k++)_[k]=""}}}}return Fr(R)}catch{return c}}var li={NO_ERROR:0,cb:1,qb:2,pb:3,kb:4,ob:5,rb:6,Ga:7,TIMEOUT:8,ub:9},Dl={ib:"complete",Fb:"success",ERROR:"error",Ga:"abort",xb:"ready",yb:"readystatechange",TIMEOUT:"timeout",sb:"incrementaldata",wb:"progress",lb:"downloadprogress",Nb:"uploadprogress"},kl;function qr(){}p(qr,Al),qr.prototype.g=function(){return new XMLHttpRequest},kl=new qr;function Xn(o){return encodeURIComponent(String(o))}function $p(o){var c=1;o=o.split(":");const d=[];for(;c>0&&o.length;)d.push(o.shift()),c--;return o.length&&d.push(o.join(":")),d}function mt(o,c,d,_){this.j=o,this.i=c,this.l=d,this.S=_||1,this.V=new Gn(this),this.H=45e3,this.J=null,this.o=!1,this.u=this.B=this.A=this.M=this.F=this.T=this.D=null,this.G=[],this.g=null,this.C=0,this.m=this.v=null,this.X=-1,this.K=!1,this.P=0,this.O=null,this.W=this.L=this.U=this.R=!1,this.h=new Vl}function Vl(){this.i=null,this.g="",this.h=!1}var xl={},jr={};function Wr(o,c,d){o.M=1,o.A=ui(Je(c)),o.u=d,o.R=!0,Ol(o,null)}function Ol(o,c){o.F=Date.now(),ci(o),o.B=Je(o.A);var d=o.B,_=o.S;Array.isArray(_)||(_=[String(_)]),Kl(d.i,"t",_),o.C=0,d=o.j.L,o.h=new Vl,o.g=dc(o.j,d?c:null,!o.u),o.P>0&&(o.O=new Lp(h(o.Y,o,o.g),o.P)),c=o.V,d=o.g,_=o.ba;var w="readystatechange";Array.isArray(w)||(w&&(wl[0]=w.toString()),w=wl);for(let R=0;R<w.length;R++){const k=yl(d,w[R],_||c.handleEvent,!1,c.h||c);if(!k)break;c.g[k.key]=k}c=o.J?_l(o.J):{},o.u?(o.v||(o.v="POST"),c["Content-Type"]="application/x-www-form-urlencoded",o.g.ea(o.B,o.v,o.u,c)):(o.v="GET",o.g.ea(o.B,o.v,null,c)),Kn(),Bp(o.i,o.v,o.B,o.l,o.S,o.u)}mt.prototype.ba=function(o){o=o.target;const c=this.O;c&&Et(o)==3?c.j():this.Y(o)},mt.prototype.Y=function(o){try{if(o==this.g)e:{const q=Et(this.g),pe=this.g.ya(),ee=this.g.ca();if(!(q<3)&&(q!=3||this.g&&(this.h.h||this.g.la()||tc(this.g)))){this.K||q!=4||pe==7||(pe==8||ee<=0?Kn(3):Kn(2)),$r(this);var c=this.g.ca();this.X=c;var d=zp(this);if(this.o=c==200,qp(this.i,this.v,this.B,this.l,this.S,q,c),this.o){if(this.U&&!this.L){t:{if(this.g){var _,w=this.g;if((_=w.g?w.g.getResponseHeader("X-HTTP-Initial-Response"):null)&&!y(_)){var R=_;break t}}R=null}if(o=R)un(this.i,this.l,o,"Initial handshake response via X-HTTP-Initial-Response"),this.L=!0,zr(this,o);else{this.o=!1,this.m=3,xe(12),zt(this),Jn(this);break e}}if(this.R){o=!0;let ve;for(;!this.K&&this.C<d.length;)if(ve=Gp(this,d),ve==jr){q==4&&(this.m=4,xe(14),o=!1),un(this.i,this.l,null,"[Incomplete Response]");break}else if(ve==xl){this.m=4,xe(15),un(this.i,this.l,d,"[Invalid Chunk]"),o=!1;break}else un(this.i,this.l,ve,null),zr(this,ve);if(Ml(this)&&this.C!=0&&(this.h.g=this.h.g.slice(this.C),this.C=0),q!=4||d.length!=0||this.h.h||(this.m=1,xe(16),o=!1),this.o=this.o&&o,!o)un(this.i,this.l,d,"[Invalid Chunked Response]"),zt(this),Jn(this);else if(d.length>0&&!this.W){this.W=!0;var k=this.j;k.g==this&&k.aa&&!k.P&&(k.j.info("Great, no buffering proxy detected. Bytes received: "+d.length),Zr(k),k.P=!0,xe(11))}}else un(this.i,this.l,d,null),zr(this,d);q==4&&zt(this),this.o&&!this.K&&(q==4?lc(this.j,this):(this.o=!1,ci(this)))}else o_(this.g),c==400&&d.indexOf("Unknown SID")>0?(this.m=3,xe(12)):(this.m=0,xe(13)),zt(this),Jn(this)}}}catch{}};function zp(o){if(!Ml(o))return o.g.la();const c=tc(o.g);if(c==="")return"";let d="";const _=c.length,w=Et(o.g)==4;if(!o.h.i){if(typeof TextDecoder>"u")return zt(o),Jn(o),"";o.h.i=new a.TextDecoder}for(let R=0;R<_;R++)o.h.h=!0,d+=o.h.i.decode(c[R],{stream:!(w&&R==_-1)});return c.length=0,o.h.g+=d,o.C=0,o.h.g}function Ml(o){return o.g?o.v=="GET"&&o.M!=2&&o.j.Aa:!1}function Gp(o,c){var d=o.C,_=c.indexOf(`
`,d);return _==-1?jr:(d=Number(c.substring(d,_)),isNaN(d)?xl:(_+=1,_+d>c.length?jr:(c=c.slice(_,_+d),o.C=_+d,c)))}mt.prototype.cancel=function(){this.K=!0,zt(this)};function ci(o){o.T=Date.now()+o.H,Ll(o,o.H)}function Ll(o,c){if(o.D!=null)throw Error("WatchDog timer not null");o.D=Qn(h(o.aa,o),c)}function $r(o){o.D&&(a.clearTimeout(o.D),o.D=null)}mt.prototype.aa=function(){this.D=null;const o=Date.now();o-this.T>=0?(jp(this.i,this.B),this.M!=2&&(Kn(),xe(17)),zt(this),this.m=2,Jn(this)):Ll(this,this.T-o)};function Jn(o){o.j.I==0||o.K||lc(o.j,o)}function zt(o){$r(o);var c=o.O;c&&typeof c.dispose=="function"&&c.dispose(),o.O=null,Cl(o.V),o.g&&(c=o.g,o.g=null,c.abort(),c.dispose())}function zr(o,c){try{var d=o.j;if(d.I!=0&&(d.g==o||Gr(d.h,o))){if(!o.L&&Gr(d.h,o)&&d.I==3){try{var _=d.Ba.g.parse(c)}catch{_=null}if(Array.isArray(_)&&_.length==3){var w=_;if(w[0]==0){e:if(!d.v){if(d.g)if(d.g.F+3e3<o.F)_i(d),fi(d);else break e;Jr(d),xe(18)}}else d.xa=w[1],0<d.xa-d.K&&w[2]<37500&&d.F&&d.A==0&&!d.C&&(d.C=Qn(h(d.Va,d),6e3));Bl(d.h)<=1&&d.ta&&(d.ta=void 0)}else Ht(d,11)}else if((o.L||d.g==o)&&_i(d),!y(c))for(w=d.Ba.g.parse(c),c=0;c<w.length;c++){let ee=w[c];const ve=ee[0];if(!(ve<=d.K))if(d.K=ve,ee=ee[1],d.I==2)if(ee[0]=="c"){d.M=ee[1],d.ba=ee[2];const Ze=ee[3];Ze!=null&&(d.ka=Ze,d.j.info("VER="+d.ka));const Kt=ee[4];Kt!=null&&(d.za=Kt,d.j.info("SVER="+d.za));const vt=ee[5];vt!=null&&typeof vt=="number"&&vt>0&&(_=1.5*vt,d.O=_,d.j.info("backChannelRequestTimeoutMs_="+_)),_=d;const Tt=o.g;if(Tt){const gi=Tt.g?Tt.g.getResponseHeader("X-Client-Wire-Protocol"):null;if(gi){var R=_.h;R.g||gi.indexOf("spdy")==-1&&gi.indexOf("quic")==-1&&gi.indexOf("h2")==-1||(R.j=R.l,R.g=new Set,R.h&&(Hr(R,R.h),R.h=null))}if(_.G){const eo=Tt.g?Tt.g.getResponseHeader("X-HTTP-Session-Id"):null;eo&&(_.wa=eo,ie(_.J,_.G,eo))}}d.I=3,d.l&&d.l.ra(),d.aa&&(d.T=Date.now()-o.F,d.j.info("Handshake RTT: "+d.T+"ms")),_=d;var k=o;if(_.na=hc(_,_.L?_.ba:null,_.W),k.L){ql(_.h,k);var q=k,pe=_.O;pe&&(q.H=pe),q.D&&($r(q),ci(q)),_.g=k}else oc(_);d.i.length>0&&pi(d)}else ee[0]!="stop"&&ee[0]!="close"||Ht(d,7);else d.I==3&&(ee[0]=="stop"||ee[0]=="close"?ee[0]=="stop"?Ht(d,7):Xr(d):ee[0]!="noop"&&d.l&&d.l.qa(ee),d.A=0)}}Kn(4)}catch{}}var Hp=class{constructor(o,c){this.g=o,this.map=c}};function Fl(o){this.l=o||10,a.PerformanceNavigationTiming?(o=a.performance.getEntriesByType("navigation"),o=o.length>0&&(o[0].nextHopProtocol=="hq"||o[0].nextHopProtocol=="h2")):o=!!(a.chrome&&a.chrome.loadTimes&&a.chrome.loadTimes()&&a.chrome.loadTimes().wasFetchedViaSpdy),this.j=o?this.l:1,this.g=null,this.j>1&&(this.g=new Set),this.h=null,this.i=[]}function Ul(o){return o.h?!0:o.g?o.g.size>=o.j:!1}function Bl(o){return o.h?1:o.g?o.g.size:0}function Gr(o,c){return o.h?o.h==c:o.g?o.g.has(c):!1}function Hr(o,c){o.g?o.g.add(c):o.h=c}function ql(o,c){o.h&&o.h==c?o.h=null:o.g&&o.g.has(c)&&o.g.delete(c)}Fl.prototype.cancel=function(){if(this.i=jl(this),this.h)this.h.cancel(),this.h=null;else if(this.g&&this.g.size!==0){for(const o of this.g.values())o.cancel();this.g.clear()}};function jl(o){if(o.h!=null)return o.i.concat(o.h.G);if(o.g!=null&&o.g.size!==0){let c=o.i;for(const d of o.g.values())c=c.concat(d.G);return c}return A(o.i)}var Wl=RegExp("^(?:([^:/?#.]+):)?(?://(?:([^\\\\/?#]*)@)?([^\\\\/?#]*?)(?::([0-9]+))?(?=[\\\\/?#]|$))?([^?#]+)?(?:\\?([^#]*))?(?:#([\\s\\S]*))?$");function Kp(o,c){if(o){o=o.split("&");for(let d=0;d<o.length;d++){const _=o[d].indexOf("=");let w,R=null;_>=0?(w=o[d].substring(0,_),R=o[d].substring(_+1)):w=o[d],c(w,R?decodeURIComponent(R.replace(/\+/g," ")):"")}}}function gt(o){this.g=this.o=this.j="",this.u=null,this.m=this.h="",this.l=!1;let c;o instanceof gt?(this.l=o.l,Zn(this,o.j),this.o=o.o,this.g=o.g,es(this,o.u),this.h=o.h,Kr(this,Ql(o.i)),this.m=o.m):o&&(c=String(o).match(Wl))?(this.l=!1,Zn(this,c[1]||"",!0),this.o=ts(c[2]||""),this.g=ts(c[3]||"",!0),es(this,c[4]),this.h=ts(c[5]||"",!0),Kr(this,c[6]||"",!0),this.m=ts(c[7]||"")):(this.l=!1,this.i=new ss(null,this.l))}gt.prototype.toString=function(){const o=[];var c=this.j;c&&o.push(ns(c,$l,!0),":");var d=this.g;return(d||c=="file")&&(o.push("//"),(c=this.o)&&o.push(ns(c,$l,!0),"@"),o.push(Xn(d).replace(/%25([0-9a-fA-F]{2})/g,"%$1")),d=this.u,d!=null&&o.push(":",String(d))),(d=this.h)&&(this.g&&d.charAt(0)!="/"&&o.push("/"),o.push(ns(d,d.charAt(0)=="/"?Xp:Yp,!0))),(d=this.i.toString())&&o.push("?",d),(d=this.m)&&o.push("#",ns(d,Zp)),o.join("")},gt.prototype.resolve=function(o){const c=Je(this);let d=!!o.j;d?Zn(c,o.j):d=!!o.o,d?c.o=o.o:d=!!o.g,d?c.g=o.g:d=o.u!=null;var _=o.h;if(d)es(c,o.u);else if(d=!!o.h){if(_.charAt(0)!="/")if(this.g&&!this.h)_="/"+_;else{var w=c.h.lastIndexOf("/");w!=-1&&(_=c.h.slice(0,w+1)+_)}if(w=_,w==".."||w==".")_="";else if(w.indexOf("./")!=-1||w.indexOf("/.")!=-1){_=w.lastIndexOf("/",0)==0,w=w.split("/");const R=[];for(let k=0;k<w.length;){const q=w[k++];q=="."?_&&k==w.length&&R.push(""):q==".."?((R.length>1||R.length==1&&R[0]!="")&&R.pop(),_&&k==w.length&&R.push("")):(R.push(q),_=!0)}_=R.join("/")}else _=w}return d?c.h=_:d=o.i.toString()!=="",d?Kr(c,Ql(o.i)):d=!!o.m,d&&(c.m=o.m),c};function Je(o){return new gt(o)}function Zn(o,c,d){o.j=d?ts(c,!0):c,o.j&&(o.j=o.j.replace(/:$/,""))}function es(o,c){if(c){if(c=Number(c),isNaN(c)||c<0)throw Error("Bad port number "+c);o.u=c}else o.u=null}function Kr(o,c,d){c instanceof ss?(o.i=c,e_(o.i,o.l)):(d||(c=ns(c,Jp)),o.i=new ss(c,o.l))}function ie(o,c,d){o.i.set(c,d)}function ui(o){return ie(o,"zx",Math.floor(Math.random()*2147483648).toString(36)+Math.abs(Math.floor(Math.random()*2147483648)^Date.now()).toString(36)),o}function ts(o,c){return o?c?decodeURI(o.replace(/%25/g,"%2525")):decodeURIComponent(o):""}function ns(o,c,d){return typeof o=="string"?(o=encodeURI(o).replace(c,Qp),d&&(o=o.replace(/%25([0-9a-fA-F]{2})/g,"%$1")),o):null}function Qp(o){return o=o.charCodeAt(0),"%"+(o>>4&15).toString(16)+(o&15).toString(16)}var $l=/[#\/\?@]/g,Yp=/[#\?:]/g,Xp=/[#\?]/g,Jp=/[#\?@]/g,Zp=/#/g;function ss(o,c){this.h=this.g=null,this.i=o||null,this.j=!!c}function Gt(o){o.g||(o.g=new Map,o.h=0,o.i&&Kp(o.i,function(c,d){o.add(decodeURIComponent(c.replace(/\+/g," ")),d)}))}n=ss.prototype,n.add=function(o,c){Gt(this),this.i=null,o=hn(this,o);let d=this.g.get(o);return d||this.g.set(o,d=[]),d.push(c),this.h+=1,this};function zl(o,c){Gt(o),c=hn(o,c),o.g.has(c)&&(o.i=null,o.h-=o.g.get(c).length,o.g.delete(c))}function Gl(o,c){return Gt(o),c=hn(o,c),o.g.has(c)}n.forEach=function(o,c){Gt(this),this.g.forEach(function(d,_){d.forEach(function(w){o.call(c,w,_,this)},this)},this)};function Hl(o,c){Gt(o);let d=[];if(typeof c=="string")Gl(o,c)&&(d=d.concat(o.g.get(hn(o,c))));else for(o=Array.from(o.g.values()),c=0;c<o.length;c++)d=d.concat(o[c]);return d}n.set=function(o,c){return Gt(this),this.i=null,o=hn(this,o),Gl(this,o)&&(this.h-=this.g.get(o).length),this.g.set(o,[c]),this.h+=1,this},n.get=function(o,c){return o?(o=Hl(this,o),o.length>0?String(o[0]):c):c};function Kl(o,c,d){zl(o,c),d.length>0&&(o.i=null,o.g.set(hn(o,c),A(d)),o.h+=d.length)}n.toString=function(){if(this.i)return this.i;if(!this.g)return"";const o=[],c=Array.from(this.g.keys());for(let _=0;_<c.length;_++){var d=c[_];const w=Xn(d);d=Hl(this,d);for(let R=0;R<d.length;R++){let k=w;d[R]!==""&&(k+="="+Xn(d[R])),o.push(k)}}return this.i=o.join("&")};function Ql(o){const c=new ss;return c.i=o.i,o.g&&(c.g=new Map(o.g),c.h=o.h),c}function hn(o,c){return c=String(c),o.j&&(c=c.toLowerCase()),c}function e_(o,c){c&&!o.j&&(Gt(o),o.i=null,o.g.forEach(function(d,_){const w=_.toLowerCase();_!=w&&(zl(this,_),Kl(this,w,d))},o)),o.j=c}function t_(o,c){const d=new Yn;if(a.Image){const _=new Image;_.onload=f(yt,d,"TestLoadImage: loaded",!0,c,_),_.onerror=f(yt,d,"TestLoadImage: error",!1,c,_),_.onabort=f(yt,d,"TestLoadImage: abort",!1,c,_),_.ontimeout=f(yt,d,"TestLoadImage: timeout",!1,c,_),a.setTimeout(function(){_.ontimeout&&_.ontimeout()},1e4),_.src=o}else c(!1)}function n_(o,c){const d=new Yn,_=new AbortController,w=setTimeout(()=>{_.abort(),yt(d,"TestPingServer: timeout",!1,c)},1e4);fetch(o,{signal:_.signal}).then(R=>{clearTimeout(w),R.ok?yt(d,"TestPingServer: ok",!0,c):yt(d,"TestPingServer: server error",!1,c)}).catch(()=>{clearTimeout(w),yt(d,"TestPingServer: error",!1,c)})}function yt(o,c,d,_,w){try{w&&(w.onload=null,w.onerror=null,w.onabort=null,w.ontimeout=null),_(d)}catch{}}function s_(){this.g=new Up}function Qr(o){this.i=o.Sb||null,this.h=o.ab||!1}p(Qr,Al),Qr.prototype.g=function(){return new hi(this.i,this.h)};function hi(o,c){Pe.call(this),this.H=o,this.o=c,this.m=void 0,this.status=this.readyState=0,this.responseType=this.responseText=this.response=this.statusText="",this.onreadystatechange=null,this.A=new Headers,this.h=null,this.F="GET",this.D="",this.g=!1,this.B=this.j=this.l=null,this.v=new AbortController}p(hi,Pe),n=hi.prototype,n.open=function(o,c){if(this.readyState!=0)throw this.abort(),Error("Error reopening a connection");this.F=o,this.D=c,this.readyState=1,rs(this)},n.send=function(o){if(this.readyState!=1)throw this.abort(),Error("need to call open() first. ");if(this.v.signal.aborted)throw this.abort(),Error("Request was aborted.");this.g=!0;const c={headers:this.A,method:this.F,credentials:this.m,cache:void 0,signal:this.v.signal};o&&(c.body=o),(this.H||a).fetch(new Request(this.D,c)).then(this.Pa.bind(this),this.ga.bind(this))},n.abort=function(){this.response=this.responseText="",this.A=new Headers,this.status=0,this.v.abort(),this.j&&this.j.cancel("Request was aborted.").catch(()=>{}),this.readyState>=1&&this.g&&this.readyState!=4&&(this.g=!1,is(this)),this.readyState=0},n.Pa=function(o){if(this.g&&(this.l=o,this.h||(this.status=this.l.status,this.statusText=this.l.statusText,this.h=o.headers,this.readyState=2,rs(this)),this.g&&(this.readyState=3,rs(this),this.g)))if(this.responseType==="arraybuffer")o.arrayBuffer().then(this.Na.bind(this),this.ga.bind(this));else if(typeof a.ReadableStream<"u"&&"body"in o){if(this.j=o.body.getReader(),this.o){if(this.responseType)throw Error('responseType must be empty for "streamBinaryChunks" mode responses.');this.response=[]}else this.response=this.responseText="",this.B=new TextDecoder;Yl(this)}else o.text().then(this.Oa.bind(this),this.ga.bind(this))};function Yl(o){o.j.read().then(o.Ma.bind(o)).catch(o.ga.bind(o))}n.Ma=function(o){if(this.g){if(this.o&&o.value)this.response.push(o.value);else if(!this.o){var c=o.value?o.value:new Uint8Array(0);(c=this.B.decode(c,{stream:!o.done}))&&(this.response=this.responseText+=c)}o.done?is(this):rs(this),this.readyState==3&&Yl(this)}},n.Oa=function(o){this.g&&(this.response=this.responseText=o,is(this))},n.Na=function(o){this.g&&(this.response=o,is(this))},n.ga=function(){this.g&&is(this)};function is(o){o.readyState=4,o.l=null,o.j=null,o.B=null,rs(o)}n.setRequestHeader=function(o,c){this.A.append(o,c)},n.getResponseHeader=function(o){return this.h&&this.h.get(o.toLowerCase())||""},n.getAllResponseHeaders=function(){if(!this.h)return"";const o=[],c=this.h.entries();for(var d=c.next();!d.done;)d=d.value,o.push(d[0]+": "+d[1]),d=c.next();return o.join(`\r
`)};function rs(o){o.onreadystatechange&&o.onreadystatechange.call(o)}Object.defineProperty(hi.prototype,"withCredentials",{get:function(){return this.m==="include"},set:function(o){this.m=o?"include":"same-origin"}});function Xl(o){let c="";return ii(o,function(d,_){c+=_,c+=":",c+=d,c+=`\r
`}),c}function Yr(o,c,d){e:{for(_ in d){var _=!1;break e}_=!0}_||(d=Xl(d),typeof o=="string"?d!=null&&Xn(d):ie(o,c,d))}function ae(o){Pe.call(this),this.headers=new Map,this.L=o||null,this.h=!1,this.g=null,this.D="",this.o=0,this.l="",this.j=this.B=this.v=this.A=!1,this.m=null,this.F="",this.H=!1}p(ae,Pe);var i_=/^https?$/i,r_=["POST","PUT"];n=ae.prototype,n.Fa=function(o){this.H=o},n.ea=function(o,c,d,_){if(this.g)throw Error("[goog.net.XhrIo] Object is active with another request="+this.D+"; newUri="+o);c=c?c.toUpperCase():"GET",this.D=o,this.l="",this.o=0,this.A=!1,this.h=!0,this.g=this.L?this.L.g():kl.g(),this.g.onreadystatechange=m(h(this.Ca,this));try{this.B=!0,this.g.open(c,String(o),!0),this.B=!1}catch(R){Jl(this,R);return}if(o=d||"",d=new Map(this.headers),_)if(Object.getPrototypeOf(_)===Object.prototype)for(var w in _)d.set(w,_[w]);else if(typeof _.keys=="function"&&typeof _.get=="function")for(const R of _.keys())d.set(R,_.get(R));else throw Error("Unknown input type for opt_headers: "+String(_));_=Array.from(d.keys()).find(R=>R.toLowerCase()=="content-type"),w=a.FormData&&o instanceof a.FormData,!(Array.prototype.indexOf.call(r_,c,void 0)>=0)||_||w||d.set("Content-Type","application/x-www-form-urlencoded;charset=utf-8");for(const[R,k]of d)this.g.setRequestHeader(R,k);this.F&&(this.g.responseType=this.F),"withCredentials"in this.g&&this.g.withCredentials!==this.H&&(this.g.withCredentials=this.H);try{this.m&&(clearTimeout(this.m),this.m=null),this.v=!0,this.g.send(o),this.v=!1}catch(R){Jl(this,R)}};function Jl(o,c){o.h=!1,o.g&&(o.j=!0,o.g.abort(),o.j=!1),o.l=c,o.o=5,Zl(o),di(o)}function Zl(o){o.A||(o.A=!0,Ve(o,"complete"),Ve(o,"error"))}n.abort=function(o){this.g&&this.h&&(this.h=!1,this.j=!0,this.g.abort(),this.j=!1,this.o=o||7,Ve(this,"complete"),Ve(this,"abort"),di(this))},n.N=function(){this.g&&(this.h&&(this.h=!1,this.j=!0,this.g.abort(),this.j=!1),di(this,!0)),ae.Z.N.call(this)},n.Ca=function(){this.u||(this.B||this.v||this.j?ec(this):this.Xa())},n.Xa=function(){ec(this)};function ec(o){if(o.h&&typeof r<"u"){if(o.v&&Et(o)==4)setTimeout(o.Ca.bind(o),0);else if(Ve(o,"readystatechange"),Et(o)==4){o.h=!1;try{const R=o.ca();e:switch(R){case 200:case 201:case 202:case 204:case 206:case 304:case 1223:var c=!0;break e;default:c=!1}var d;if(!(d=c)){var _;if(_=R===0){let k=String(o.D).match(Wl)[1]||null;!k&&a.self&&a.self.location&&(k=a.self.location.protocol.slice(0,-1)),_=!i_.test(k?k.toLowerCase():"")}d=_}if(d)Ve(o,"complete"),Ve(o,"success");else{o.o=6;try{var w=Et(o)>2?o.g.statusText:""}catch{w=""}o.l=w+" ["+o.ca()+"]",Zl(o)}}finally{di(o)}}}}function di(o,c){if(o.g){o.m&&(clearTimeout(o.m),o.m=null);const d=o.g;o.g=null,c||Ve(o,"ready");try{d.onreadystatechange=null}catch{}}}n.isActive=function(){return!!this.g};function Et(o){return o.g?o.g.readyState:0}n.ca=function(){try{return Et(this)>2?this.g.status:-1}catch{return-1}},n.la=function(){try{return this.g?this.g.responseText:""}catch{return""}},n.La=function(o){if(this.g){var c=this.g.responseText;return o&&c.indexOf(o)==0&&(c=c.substring(o.length)),Fp(c)}};function tc(o){try{if(!o.g)return null;if("response"in o.g)return o.g.response;switch(o.F){case"":case"text":return o.g.responseText;case"arraybuffer":if("mozResponseArrayBuffer"in o.g)return o.g.mozResponseArrayBuffer}return null}catch{return null}}function o_(o){const c={};o=(o.g&&Et(o)>=2&&o.g.getAllResponseHeaders()||"").split(`\r
`);for(let _=0;_<o.length;_++){if(y(o[_]))continue;var d=$p(o[_]);const w=d[0];if(d=d[1],typeof d!="string")continue;d=d.trim();const R=c[w]||[];c[w]=R,R.push(d)}kp(c,function(_){return _.join(", ")})}n.ya=function(){return this.o},n.Ha=function(){return typeof this.l=="string"?this.l:String(this.l)};function os(o,c,d){return d&&d.internalChannelParams&&d.internalChannelParams[o]||c}function nc(o){this.za=0,this.i=[],this.j=new Yn,this.ba=this.na=this.J=this.W=this.g=this.wa=this.G=this.H=this.u=this.U=this.o=null,this.Ya=this.V=0,this.Sa=os("failFast",!1,o),this.F=this.C=this.v=this.m=this.l=null,this.X=!0,this.xa=this.K=-1,this.Y=this.A=this.D=0,this.Qa=os("baseRetryDelayMs",5e3,o),this.Za=os("retryDelaySeedMs",1e4,o),this.Ta=os("forwardChannelMaxRetries",2,o),this.va=os("forwardChannelRequestTimeoutMs",2e4,o),this.ma=o&&o.xmlHttpFactory||void 0,this.Ua=o&&o.Rb||void 0,this.Aa=o&&o.useFetchStreams||!1,this.O=void 0,this.L=o&&o.supportsCrossDomainXhr||!1,this.M="",this.h=new Fl(o&&o.concurrentRequestLimit),this.Ba=new s_,this.S=o&&o.fastHandshake||!1,this.R=o&&o.encodeInitMessageHeaders||!1,this.S&&this.R&&(this.R=!1),this.Ra=o&&o.Pb||!1,o&&o.ua&&this.j.ua(),o&&o.forceLongPolling&&(this.X=!1),this.aa=!this.S&&this.X&&o&&o.detectBufferingProxy||!1,this.ia=void 0,o&&o.longPollingTimeout&&o.longPollingTimeout>0&&(this.ia=o.longPollingTimeout),this.ta=void 0,this.T=0,this.P=!1,this.ja=this.B=null}n=nc.prototype,n.ka=8,n.I=1,n.connect=function(o,c,d,_){xe(0),this.W=o,this.H=c||{},d&&_!==void 0&&(this.H.OSID=d,this.H.OAID=_),this.F=this.X,this.J=hc(this,null,this.W),pi(this)};function Xr(o){if(sc(o),o.I==3){var c=o.V++,d=Je(o.J);if(ie(d,"SID",o.M),ie(d,"RID",c),ie(d,"TYPE","terminate"),as(o,d),c=new mt(o,o.j,c),c.M=2,c.A=ui(Je(d)),d=!1,a.navigator&&a.navigator.sendBeacon)try{d=a.navigator.sendBeacon(c.A.toString(),"")}catch{}!d&&a.Image&&(new Image().src=c.A,d=!0),d||(c.g=dc(c.j,null),c.g.ea(c.A)),c.F=Date.now(),ci(c)}uc(o)}function fi(o){o.g&&(Zr(o),o.g.cancel(),o.g=null)}function sc(o){fi(o),o.v&&(a.clearTimeout(o.v),o.v=null),_i(o),o.h.cancel(),o.m&&(typeof o.m=="number"&&a.clearTimeout(o.m),o.m=null)}function pi(o){if(!Ul(o.h)&&!o.m){o.m=!0;var c=o.Ea;Me||g(),Ee||(Me(),Ee=!0),T.add(c,o),o.D=0}}function a_(o,c){return Bl(o.h)>=o.h.j-(o.m?1:0)?!1:o.m?(o.i=c.G.concat(o.i),!0):o.I==1||o.I==2||o.D>=(o.Sa?0:o.Ta)?!1:(o.m=Qn(h(o.Ea,o,c),cc(o,o.D)),o.D++,!0)}n.Ea=function(o){if(this.m)if(this.m=null,this.I==1){if(!o){this.V=Math.floor(Math.random()*1e5),o=this.V++;const w=new mt(this,this.j,o);let R=this.o;if(this.U&&(R?(R=_l(R),gl(R,this.U)):R=this.U),this.u!==null||this.R||(w.J=R,R=null),this.S)e:{for(var c=0,d=0;d<this.i.length;d++){t:{var _=this.i[d];if("__data__"in _.map&&(_=_.map.__data__,typeof _=="string")){_=_.length;break t}_=void 0}if(_===void 0)break;if(c+=_,c>4096){c=d;break e}if(c===4096||d===this.i.length-1){c=d+1;break e}}c=1e3}else c=1e3;c=rc(this,w,c),d=Je(this.J),ie(d,"RID",o),ie(d,"CVER",22),this.G&&ie(d,"X-HTTP-Session-Id",this.G),as(this,d),R&&(this.R?c="headers="+Xn(Xl(R))+"&"+c:this.u&&Yr(d,this.u,R)),Hr(this.h,w),this.Ra&&ie(d,"TYPE","init"),this.S?(ie(d,"$req",c),ie(d,"SID","null"),w.U=!0,Wr(w,d,null)):Wr(w,d,c),this.I=2}}else this.I==3&&(o?ic(this,o):this.i.length==0||Ul(this.h)||ic(this))};function ic(o,c){var d;c?d=c.l:d=o.V++;const _=Je(o.J);ie(_,"SID",o.M),ie(_,"RID",d),ie(_,"AID",o.K),as(o,_),o.u&&o.o&&Yr(_,o.u,o.o),d=new mt(o,o.j,d,o.D+1),o.u===null&&(d.J=o.o),c&&(o.i=c.G.concat(o.i)),c=rc(o,d,1e3),d.H=Math.round(o.va*.5)+Math.round(o.va*.5*Math.random()),Hr(o.h,d),Wr(d,_,c)}function as(o,c){o.H&&ii(o.H,function(d,_){ie(c,_,d)}),o.l&&ii({},function(d,_){ie(c,_,d)})}function rc(o,c,d){d=Math.min(o.i.length,d);const _=o.l?h(o.l.Ka,o.l,o):null;e:{var w=o.i;let q=-1;for(;;){const pe=["count="+d];q==-1?d>0?(q=w[0].g,pe.push("ofs="+q)):q=0:pe.push("ofs="+q);let ee=!0;for(let ve=0;ve<d;ve++){var R=w[ve].g;const Ze=w[ve].map;if(R-=q,R<0)q=Math.max(0,w[ve].g-100),ee=!1;else try{R="req"+R+"_"||"";try{var k=Ze instanceof Map?Ze:Object.entries(Ze);for(const[Kt,vt]of k){let Tt=vt;l(vt)&&(Tt=Fr(vt)),pe.push(R+Kt+"="+encodeURIComponent(Tt))}}catch(Kt){throw pe.push(R+"type="+encodeURIComponent("_badmap")),Kt}}catch{_&&_(Ze)}}if(ee){k=pe.join("&");break e}}k=void 0}return o=o.i.splice(0,d),c.G=o,k}function oc(o){if(!o.g&&!o.v){o.Y=1;var c=o.Da;Me||g(),Ee||(Me(),Ee=!0),T.add(c,o),o.A=0}}function Jr(o){return o.g||o.v||o.A>=3?!1:(o.Y++,o.v=Qn(h(o.Da,o),cc(o,o.A)),o.A++,!0)}n.Da=function(){if(this.v=null,ac(this),this.aa&&!(this.P||this.g==null||this.T<=0)){var o=4*this.T;this.j.info("BP detection timer enabled: "+o),this.B=Qn(h(this.Wa,this),o)}},n.Wa=function(){this.B&&(this.B=null,this.j.info("BP detection timeout reached."),this.j.info("Buffering proxy detected and switch to long-polling!"),this.F=!1,this.P=!0,xe(10),fi(this),ac(this))};function Zr(o){o.B!=null&&(a.clearTimeout(o.B),o.B=null)}function ac(o){o.g=new mt(o,o.j,"rpc",o.Y),o.u===null&&(o.g.J=o.o),o.g.P=0;var c=Je(o.na);ie(c,"RID","rpc"),ie(c,"SID",o.M),ie(c,"AID",o.K),ie(c,"CI",o.F?"0":"1"),!o.F&&o.ia&&ie(c,"TO",o.ia),ie(c,"TYPE","xmlhttp"),as(o,c),o.u&&o.o&&Yr(c,o.u,o.o),o.O&&(o.g.H=o.O);var d=o.g;o=o.ba,d.M=1,d.A=ui(Je(c)),d.u=null,d.R=!0,Ol(d,o)}n.Va=function(){this.C!=null&&(this.C=null,fi(this),Jr(this),xe(19))};function _i(o){o.C!=null&&(a.clearTimeout(o.C),o.C=null)}function lc(o,c){var d=null;if(o.g==c){_i(o),Zr(o),o.g=null;var _=2}else if(Gr(o.h,c))d=c.G,ql(o.h,c),_=1;else return;if(o.I!=0){if(c.o)if(_==1){d=c.u?c.u.length:0,c=Date.now()-c.F;var w=o.D;_=ai(),Ve(_,new Nl(_,d)),pi(o)}else oc(o);else if(w=c.m,w==3||w==0&&c.X>0||!(_==1&&a_(o,c)||_==2&&Jr(o)))switch(d&&d.length>0&&(c=o.h,c.i=c.i.concat(d)),w){case 1:Ht(o,5);break;case 4:Ht(o,10);break;case 3:Ht(o,6);break;default:Ht(o,2)}}}function cc(o,c){let d=o.Qa+Math.floor(Math.random()*o.Za);return o.isActive()||(d*=2),d*c}function Ht(o,c){if(o.j.info("Error code "+c),c==2){var d=h(o.bb,o),_=o.Ua;const w=!_;_=new gt(_||"//www.google.com/images/cleardot.gif"),a.location&&a.location.protocol=="http"||Zn(_,"https"),ui(_),w?t_(_.toString(),d):n_(_.toString(),d)}else xe(2);o.I=0,o.l&&o.l.pa(c),uc(o),sc(o)}n.bb=function(o){o?(this.j.info("Successfully pinged google.com"),xe(2)):(this.j.info("Failed to ping google.com"),xe(1))};function uc(o){if(o.I=0,o.ja=[],o.l){const c=jl(o.h);(c.length!=0||o.i.length!=0)&&(b(o.ja,c),b(o.ja,o.i),o.h.i.length=0,A(o.i),o.i.length=0),o.l.oa()}}function hc(o,c,d){var _=d instanceof gt?Je(d):new gt(d);if(_.g!="")c&&(_.g=c+"."+_.g),es(_,_.u);else{var w=a.location;_=w.protocol,c=c?c+"."+w.hostname:w.hostname,w=+w.port;const R=new gt(null);_&&Zn(R,_),c&&(R.g=c),w&&es(R,w),d&&(R.h=d),_=R}return d=o.G,c=o.wa,d&&c&&ie(_,d,c),ie(_,"VER",o.ka),as(o,_),_}function dc(o,c,d){if(c&&!o.L)throw Error("Can't create secondary domain capable XhrIo object.");return c=o.Aa&&!o.ma?new ae(new Qr({ab:d})):new ae(o.ma),c.Fa(o.L),c}n.isActive=function(){return!!this.l&&this.l.isActive(this)};function fc(){}n=fc.prototype,n.ra=function(){},n.qa=function(){},n.pa=function(){},n.oa=function(){},n.isActive=function(){return!0},n.Ka=function(){};function mi(){}mi.prototype.g=function(o,c){return new qe(o,c)};function qe(o,c){Pe.call(this),this.g=new nc(c),this.l=o,this.h=c&&c.messageUrlParams||null,o=c&&c.messageHeaders||null,c&&c.clientProtocolHeaderRequired&&(o?o["X-Client-Protocol"]="webchannel":o={"X-Client-Protocol":"webchannel"}),this.g.o=o,o=c&&c.initMessageHeaders||null,c&&c.messageContentType&&(o?o["X-WebChannel-Content-Type"]=c.messageContentType:o={"X-WebChannel-Content-Type":c.messageContentType}),c&&c.sa&&(o?o["X-WebChannel-Client-Profile"]=c.sa:o={"X-WebChannel-Client-Profile":c.sa}),this.g.U=o,(o=c&&c.Qb)&&!y(o)&&(this.g.u=o),this.A=c&&c.supportsCrossDomainXhr||!1,this.v=c&&c.sendRawJson||!1,(c=c&&c.httpSessionIdParam)&&!y(c)&&(this.g.G=c,o=this.h,o!==null&&c in o&&(o=this.h,c in o&&delete o[c])),this.j=new dn(this)}p(qe,Pe),qe.prototype.m=function(){this.g.l=this.j,this.A&&(this.g.L=!0),this.g.connect(this.l,this.h||void 0)},qe.prototype.close=function(){Xr(this.g)},qe.prototype.o=function(o){var c=this.g;if(typeof o=="string"){var d={};d.__data__=o,o=d}else this.v&&(d={},d.__data__=Fr(o),o=d);c.i.push(new Hp(c.Ya++,o)),c.I==3&&pi(c)},qe.prototype.N=function(){this.g.l=null,delete this.j,Xr(this.g),delete this.g,qe.Z.N.call(this)};function pc(o){Ur.call(this),o.__headers__&&(this.headers=o.__headers__,this.statusCode=o.__status__,delete o.__headers__,delete o.__status__);var c=o.__sm__;if(c){e:{for(const d in c){o=d;break e}o=void 0}(this.i=o)&&(o=this.i,c=c!==null&&o in c?c[o]:void 0),this.data=c}else this.data=o}p(pc,Ur);function _c(){Br.call(this),this.status=1}p(_c,Br);function dn(o){this.g=o}p(dn,fc),dn.prototype.ra=function(){Ve(this.g,"a")},dn.prototype.qa=function(o){Ve(this.g,new pc(o))},dn.prototype.pa=function(o){Ve(this.g,new _c)},dn.prototype.oa=function(){Ve(this.g,"b")},mi.prototype.createWebChannel=mi.prototype.g,qe.prototype.send=qe.prototype.o,qe.prototype.open=qe.prototype.m,qe.prototype.close=qe.prototype.close,Oh=function(){return new mi},xh=function(){return ai()},Vh=$t,Co={jb:0,mb:1,nb:2,Hb:3,Mb:4,Jb:5,Kb:6,Ib:7,Gb:8,Lb:9,PROXY:10,NOPROXY:11,Eb:12,Ab:13,Bb:14,zb:15,Cb:16,Db:17,fb:18,eb:19,gb:20},li.NO_ERROR=0,li.TIMEOUT=8,li.HTTP_ERROR=6,Ri=li,Dl.COMPLETE="complete",kh=Dl,Rl.EventType=Hn,Hn.OPEN="a",Hn.CLOSE="b",Hn.ERROR="c",Hn.MESSAGE="d",Pe.prototype.listen=Pe.prototype.J,ds=Rl,ae.prototype.listenOnce=ae.prototype.K,ae.prototype.getLastError=ae.prototype.Ha,ae.prototype.getLastErrorCode=ae.prototype.ya,ae.prototype.getStatus=ae.prototype.ca,ae.prototype.getResponseJson=ae.prototype.La,ae.prototype.getResponseText=ae.prototype.la,ae.prototype.send=ae.prototype.ea,ae.prototype.setWithCredentials=ae.prototype.Fa,Dh=ae}).apply(typeof yi<"u"?yi:typeof self<"u"?self:typeof window<"u"?window:{});const bc="@firebase/firestore",Nc="4.9.2";class Ne{constructor(e){this.uid=e}isAuthenticated(){return this.uid!=null}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(e){return e.uid===this.uid}}Ne.UNAUTHENTICATED=new Ne(null),Ne.GOOGLE_CREDENTIALS=new Ne("google-credentials-uid"),Ne.FIRST_PARTY=new Ne("first-party-uid"),Ne.MOCK_USER=new Ne("mock-user");let Un="12.3.0";const Zt=new sa("@firebase/firestore");function pn(){return Zt.logLevel}function O(n,...e){if(Zt.logLevel<=Q.DEBUG){const t=e.map(ra);Zt.debug(`Firestore (${Un}): ${n}`,...t)}}function ht(n,...e){if(Zt.logLevel<=Q.ERROR){const t=e.map(ra);Zt.error(`Firestore (${Un}): ${n}`,...t)}}function Sn(n,...e){if(Zt.logLevel<=Q.WARN){const t=e.map(ra);Zt.warn(`Firestore (${Un}): ${n}`,...t)}}function ra(n){if(typeof n=="string")return n;try{return(function(t){return JSON.stringify(t)})(n)}catch{return n}}function F(n,e,t){let s="Unexpected state";typeof e=="string"?s=e:t=e,Mh(n,s,t)}function Mh(n,e,t){let s=`FIRESTORE (${Un}) INTERNAL ASSERTION FAILED: ${e} (ID: ${n.toString(16)})`;if(t!==void 0)try{s+=" CONTEXT: "+JSON.stringify(t)}catch{s+=" CONTEXT: "+t}throw ht(s),new Error(s)}function Z(n,e,t,s){let i="Unexpected state";typeof t=="string"?i=t:s=t,n||Mh(e,i,s)}function B(n,e){return n}const S={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};class x extends Fn{constructor(e,t){super(e,t),this.code=e,this.message=t,this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}}class St{constructor(){this.promise=new Promise(((e,t)=>{this.resolve=e,this.reject=t}))}}class Lh{constructor(e,t){this.user=t,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization",`Bearer ${e}`)}}class Hm{getToken(){return Promise.resolve(null)}invalidateToken(){}start(e,t){e.enqueueRetryable((()=>t(Ne.UNAUTHENTICATED)))}shutdown(){}}class Km{constructor(e){this.token=e,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(e,t){this.changeListener=t,e.enqueueRetryable((()=>t(this.token.user)))}shutdown(){this.changeListener=null}}class Qm{constructor(e){this.t=e,this.currentUser=Ne.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(e,t){Z(this.o===void 0,42304);let s=this.i;const i=u=>this.i!==s?(s=this.i,t(u)):Promise.resolve();let r=new St;this.o=()=>{this.i++,this.currentUser=this.u(),r.resolve(),r=new St,e.enqueueRetryable((()=>i(this.currentUser)))};const a=()=>{const u=r;e.enqueueRetryable((async()=>{await u.promise,await i(this.currentUser)}))},l=u=>{O("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=u,this.o&&(this.auth.addAuthTokenListener(this.o),a())};this.t.onInit((u=>l(u))),setTimeout((()=>{if(!this.auth){const u=this.t.getImmediate({optional:!0});u?l(u):(O("FirebaseAuthCredentialsProvider","Auth not yet detected"),r.resolve(),r=new St)}}),0),a()}getToken(){const e=this.i,t=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(t).then((s=>this.i!==e?(O("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):s?(Z(typeof s.accessToken=="string",31837,{l:s}),new Lh(s.accessToken,this.currentUser)):null)):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.o&&this.auth.removeAuthTokenListener(this.o),this.o=void 0}u(){const e=this.auth&&this.auth.getUid();return Z(e===null||typeof e=="string",2055,{h:e}),new Ne(e)}}class Ym{constructor(e,t,s){this.P=e,this.T=t,this.I=s,this.type="FirstParty",this.user=Ne.FIRST_PARTY,this.A=new Map}R(){return this.I?this.I():null}get headers(){this.A.set("X-Goog-AuthUser",this.P);const e=this.R();return e&&this.A.set("Authorization",e),this.T&&this.A.set("X-Goog-Iam-Authorization-Token",this.T),this.A}}class Xm{constructor(e,t,s){this.P=e,this.T=t,this.I=s}getToken(){return Promise.resolve(new Ym(this.P,this.T,this.I))}start(e,t){e.enqueueRetryable((()=>t(Ne.FIRST_PARTY)))}shutdown(){}invalidateToken(){}}class Dc{constructor(e){this.value=e,this.type="AppCheck",this.headers=new Map,e&&e.length>0&&this.headers.set("x-firebase-appcheck",this.value)}}class Jm{constructor(e,t){this.V=t,this.forceRefresh=!1,this.appCheck=null,this.m=null,this.p=null,Ch(e)&&e.settings.appCheckToken&&(this.p=e.settings.appCheckToken)}start(e,t){Z(this.o===void 0,3512);const s=r=>{r.error!=null&&O("FirebaseAppCheckTokenProvider",`Error getting App Check token; using placeholder token instead. Error: ${r.error.message}`);const a=r.token!==this.m;return this.m=r.token,O("FirebaseAppCheckTokenProvider",`Received ${a?"new":"existing"} token.`),a?t(r.token):Promise.resolve()};this.o=r=>{e.enqueueRetryable((()=>s(r)))};const i=r=>{O("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=r,this.o&&this.appCheck.addTokenListener(this.o)};this.V.onInit((r=>i(r))),setTimeout((()=>{if(!this.appCheck){const r=this.V.getImmediate({optional:!0});r?i(r):O("FirebaseAppCheckTokenProvider","AppCheck not yet detected")}}),0)}getToken(){if(this.p)return Promise.resolve(new Dc(this.p));const e=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(e).then((t=>t?(Z(typeof t.token=="string",44558,{tokenResult:t}),this.m=t.token,new Dc(t.token)):null)):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.o&&this.appCheck.removeTokenListener(this.o),this.o=void 0}}function Zm(n){const e=typeof self<"u"&&(self.crypto||self.msCrypto),t=new Uint8Array(n);if(e&&typeof e.getRandomValues=="function")e.getRandomValues(t);else for(let s=0;s<n;s++)t[s]=Math.floor(256*Math.random());return t}class oa{static newId(){const e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",t=62*Math.floor(4.129032258064516);let s="";for(;s.length<20;){const i=Zm(40);for(let r=0;r<i.length;++r)s.length<20&&i[r]<t&&(s+=e.charAt(i[r]%62))}return s}}function H(n,e){return n<e?-1:n>e?1:0}function Ao(n,e){const t=Math.min(n.length,e.length);for(let s=0;s<t;s++){const i=n.charAt(s),r=e.charAt(s);if(i!==r)return ro(i)===ro(r)?H(i,r):ro(i)?1:-1}return H(n.length,e.length)}const eg=55296,tg=57343;function ro(n){const e=n.charCodeAt(0);return e>=eg&&e<=tg}function Pn(n,e,t){return n.length===e.length&&n.every(((s,i)=>t(s,e[i])))}const kc="__name__";class et{constructor(e,t,s){t===void 0?t=0:t>e.length&&F(637,{offset:t,range:e.length}),s===void 0?s=e.length-t:s>e.length-t&&F(1746,{length:s,range:e.length-t}),this.segments=e,this.offset=t,this.len=s}get length(){return this.len}isEqual(e){return et.comparator(this,e)===0}child(e){const t=this.segments.slice(this.offset,this.limit());return e instanceof et?e.forEach((s=>{t.push(s)})):t.push(e),this.construct(t)}limit(){return this.offset+this.length}popFirst(e){return e=e===void 0?1:e,this.construct(this.segments,this.offset+e,this.length-e)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(e){return this.segments[this.offset+e]}isEmpty(){return this.length===0}isPrefixOf(e){if(e.length<this.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}isImmediateParentOf(e){if(this.length+1!==e.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}forEach(e){for(let t=this.offset,s=this.limit();t<s;t++)e(this.segments[t])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(e,t){const s=Math.min(e.length,t.length);for(let i=0;i<s;i++){const r=et.compareSegments(e.get(i),t.get(i));if(r!==0)return r}return H(e.length,t.length)}static compareSegments(e,t){const s=et.isNumericId(e),i=et.isNumericId(t);return s&&!i?-1:!s&&i?1:s&&i?et.extractNumericId(e).compare(et.extractNumericId(t)):Ao(e,t)}static isNumericId(e){return e.startsWith("__id")&&e.endsWith("__")}static extractNumericId(e){return Rt.fromString(e.substring(4,e.length-2))}}class se extends et{construct(e,t,s){return new se(e,t,s)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}toUriEncodedString(){return this.toArray().map(encodeURIComponent).join("/")}static fromString(...e){const t=[];for(const s of e){if(s.indexOf("//")>=0)throw new x(S.INVALID_ARGUMENT,`Invalid segment (${s}). Paths must not contain // in them.`);t.push(...s.split("/").filter((i=>i.length>0)))}return new se(t)}static emptyPath(){return new se([])}}const ng=/^[_a-zA-Z][_a-zA-Z0-9]*$/;class Re extends et{construct(e,t,s){return new Re(e,t,s)}static isValidIdentifier(e){return ng.test(e)}canonicalString(){return this.toArray().map((e=>(e=e.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),Re.isValidIdentifier(e)||(e="`"+e+"`"),e))).join(".")}toString(){return this.canonicalString()}isKeyField(){return this.length===1&&this.get(0)===kc}static keyField(){return new Re([kc])}static fromServerFormat(e){const t=[];let s="",i=0;const r=()=>{if(s.length===0)throw new x(S.INVALID_ARGUMENT,`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);t.push(s),s=""};let a=!1;for(;i<e.length;){const l=e[i];if(l==="\\"){if(i+1===e.length)throw new x(S.INVALID_ARGUMENT,"Path has trailing escape character: "+e);const u=e[i+1];if(u!=="\\"&&u!=="."&&u!=="`")throw new x(S.INVALID_ARGUMENT,"Path has invalid escape sequence: "+e);s+=u,i+=2}else l==="`"?(a=!a,i++):l!=="."||a?(s+=l,i++):(r(),i++)}if(r(),a)throw new x(S.INVALID_ARGUMENT,"Unterminated ` in path: "+e);return new Re(t)}static emptyPath(){return new Re([])}}class M{constructor(e){this.path=e}static fromPath(e){return new M(se.fromString(e))}static fromName(e){return new M(se.fromString(e).popFirst(5))}static empty(){return new M(se.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(e){return this.path.length>=2&&this.path.get(this.path.length-2)===e}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(e){return e!==null&&se.comparator(this.path,e.path)===0}toString(){return this.path.toString()}static comparator(e,t){return se.comparator(e.path,t.path)}static isDocumentKey(e){return e.length%2==0}static fromSegments(e){return new M(new se(e.slice()))}}function Fh(n,e,t){if(!t)throw new x(S.INVALID_ARGUMENT,`Function ${n}() cannot be called with an empty ${e}.`)}function sg(n,e,t,s){if(e===!0&&s===!0)throw new x(S.INVALID_ARGUMENT,`${n} and ${t} cannot be used together.`)}function Vc(n){if(!M.isDocumentKey(n))throw new x(S.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${n} has ${n.length}.`)}function xc(n){if(M.isDocumentKey(n))throw new x(S.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${n} has ${n.length}.`)}function Uh(n){return typeof n=="object"&&n!==null&&(Object.getPrototypeOf(n)===Object.prototype||Object.getPrototypeOf(n)===null)}function lr(n){if(n===void 0)return"undefined";if(n===null)return"null";if(typeof n=="string")return n.length>20&&(n=`${n.substring(0,20)}...`),JSON.stringify(n);if(typeof n=="number"||typeof n=="boolean")return""+n;if(typeof n=="object"){if(n instanceof Array)return"an array";{const e=(function(s){return s.constructor?s.constructor.name:null})(n);return e?`a custom ${e} object`:"an object"}}return typeof n=="function"?"a function":F(12329,{type:typeof n})}function bn(n,e){if("_delegate"in n&&(n=n._delegate),!(n instanceof e)){if(e.name===n.constructor.name)throw new x(S.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");{const t=lr(n);throw new x(S.INVALID_ARGUMENT,`Expected type '${e.name}', but it was: ${t}`)}}return n}function de(n,e){const t={typeString:n};return e&&(t.value=e),t}function zs(n,e){if(!Uh(n))throw new x(S.INVALID_ARGUMENT,"JSON must be an object");let t;for(const s in e)if(e[s]){const i=e[s].typeString,r="value"in e[s]?{value:e[s].value}:void 0;if(!(s in n)){t=`JSON missing required field: '${s}'`;break}const a=n[s];if(i&&typeof a!==i){t=`JSON field '${s}' must be a ${i}.`;break}if(r!==void 0&&a!==r.value){t=`Expected '${s}' field to equal '${r.value}'`;break}}if(t)throw new x(S.INVALID_ARGUMENT,t);return!0}const Oc=-62135596800,Mc=1e6;class oe{static now(){return oe.fromMillis(Date.now())}static fromDate(e){return oe.fromMillis(e.getTime())}static fromMillis(e){const t=Math.floor(e/1e3),s=Math.floor((e-1e3*t)*Mc);return new oe(t,s)}constructor(e,t){if(this.seconds=e,this.nanoseconds=t,t<0)throw new x(S.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(t>=1e9)throw new x(S.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(e<Oc)throw new x(S.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e);if(e>=253402300800)throw new x(S.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/Mc}_compareTo(e){return this.seconds===e.seconds?H(this.nanoseconds,e.nanoseconds):H(this.seconds,e.seconds)}isEqual(e){return e.seconds===this.seconds&&e.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{type:oe._jsonSchemaVersion,seconds:this.seconds,nanoseconds:this.nanoseconds}}static fromJSON(e){if(zs(e,oe._jsonSchema))return new oe(e.seconds,e.nanoseconds)}valueOf(){const e=this.seconds-Oc;return String(e).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}oe._jsonSchemaVersion="firestore/timestamp/1.0",oe._jsonSchema={type:de("string",oe._jsonSchemaVersion),seconds:de("number"),nanoseconds:de("number")};class U{static fromTimestamp(e){return new U(e)}static min(){return new U(new oe(0,0))}static max(){return new U(new oe(253402300799,999999999))}constructor(e){this.timestamp=e}compareTo(e){return this.timestamp._compareTo(e.timestamp)}isEqual(e){return this.timestamp.isEqual(e.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}}const bs=-1;function ig(n,e){const t=n.toTimestamp().seconds,s=n.toTimestamp().nanoseconds+1,i=U.fromTimestamp(s===1e9?new oe(t+1,0):new oe(t,s));return new kt(i,M.empty(),e)}function rg(n){return new kt(n.readTime,n.key,bs)}class kt{constructor(e,t,s){this.readTime=e,this.documentKey=t,this.largestBatchId=s}static min(){return new kt(U.min(),M.empty(),bs)}static max(){return new kt(U.max(),M.empty(),bs)}}function og(n,e){let t=n.readTime.compareTo(e.readTime);return t!==0?t:(t=M.comparator(n.documentKey,e.documentKey),t!==0?t:H(n.largestBatchId,e.largestBatchId))}const ag="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.";class lg{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(e){this.onCommittedListeners.push(e)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach((e=>e()))}}async function Bn(n){if(n.code!==S.FAILED_PRECONDITION||n.message!==ag)throw n;O("LocalStore","Unexpectedly lost primary lease")}class P{constructor(e){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,e((t=>{this.isDone=!0,this.result=t,this.nextCallback&&this.nextCallback(t)}),(t=>{this.isDone=!0,this.error=t,this.catchCallback&&this.catchCallback(t)}))}catch(e){return this.next(void 0,e)}next(e,t){return this.callbackAttached&&F(59440),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(t,this.error):this.wrapSuccess(e,this.result):new P(((s,i)=>{this.nextCallback=r=>{this.wrapSuccess(e,r).next(s,i)},this.catchCallback=r=>{this.wrapFailure(t,r).next(s,i)}}))}toPromise(){return new Promise(((e,t)=>{this.next(e,t)}))}wrapUserFunction(e){try{const t=e();return t instanceof P?t:P.resolve(t)}catch(t){return P.reject(t)}}wrapSuccess(e,t){return e?this.wrapUserFunction((()=>e(t))):P.resolve(t)}wrapFailure(e,t){return e?this.wrapUserFunction((()=>e(t))):P.reject(t)}static resolve(e){return new P(((t,s)=>{t(e)}))}static reject(e){return new P(((t,s)=>{s(e)}))}static waitFor(e){return new P(((t,s)=>{let i=0,r=0,a=!1;e.forEach((l=>{++i,l.next((()=>{++r,a&&r===i&&t()}),(u=>s(u)))})),a=!0,r===i&&t()}))}static or(e){let t=P.resolve(!1);for(const s of e)t=t.next((i=>i?P.resolve(i):s()));return t}static forEach(e,t){const s=[];return e.forEach(((i,r)=>{s.push(t.call(this,i,r))})),this.waitFor(s)}static mapArray(e,t){return new P(((s,i)=>{const r=e.length,a=new Array(r);let l=0;for(let u=0;u<r;u++){const h=u;t(e[h]).next((f=>{a[h]=f,++l,l===r&&s(a)}),(f=>i(f)))}}))}static doWhile(e,t){return new P(((s,i)=>{const r=()=>{e()===!0?t().next((()=>{r()}),i):s()};r()}))}}function cg(n){const e=n.match(/Android ([\d.]+)/i),t=e?e[1].split(".").slice(0,2).join("."):"-1";return Number(t)}function qn(n){return n.name==="IndexedDbTransactionError"}class cr{constructor(e,t){this.previousValue=e,t&&(t.sequenceNumberHandler=s=>this.ae(s),this.ue=s=>t.writeSequenceNumber(s))}ae(e){return this.previousValue=Math.max(e,this.previousValue),this.previousValue}next(){const e=++this.previousValue;return this.ue&&this.ue(e),e}}cr.ce=-1;const aa=-1;function ur(n){return n==null}function Mi(n){return n===0&&1/n==-1/0}function ug(n){return typeof n=="number"&&Number.isInteger(n)&&!Mi(n)&&n<=Number.MAX_SAFE_INTEGER&&n>=Number.MIN_SAFE_INTEGER}const Bh="";function hg(n){let e="";for(let t=0;t<n.length;t++)e.length>0&&(e=Lc(e)),e=dg(n.get(t),e);return Lc(e)}function dg(n,e){let t=e;const s=n.length;for(let i=0;i<s;i++){const r=n.charAt(i);switch(r){case"\0":t+="";break;case Bh:t+="";break;default:t+=r}}return t}function Lc(n){return n+Bh+""}function Fc(n){let e=0;for(const t in n)Object.prototype.hasOwnProperty.call(n,t)&&e++;return e}function rn(n,e){for(const t in n)Object.prototype.hasOwnProperty.call(n,t)&&e(t,n[t])}function qh(n){for(const e in n)if(Object.prototype.hasOwnProperty.call(n,e))return!1;return!0}let fe=class Ro{constructor(e,t){this.comparator=e,this.root=t||Pt.EMPTY}insert(e,t){return new Ro(this.comparator,this.root.insert(e,t,this.comparator).copy(null,null,Pt.BLACK,null,null))}remove(e){return new Ro(this.comparator,this.root.remove(e,this.comparator).copy(null,null,Pt.BLACK,null,null))}get(e){let t=this.root;for(;!t.isEmpty();){const s=this.comparator(e,t.key);if(s===0)return t.value;s<0?t=t.left:s>0&&(t=t.right)}return null}indexOf(e){let t=0,s=this.root;for(;!s.isEmpty();){const i=this.comparator(e,s.key);if(i===0)return t+s.left.size;i<0?s=s.left:(t+=s.left.size+1,s=s.right)}return-1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(e){return this.root.inorderTraversal(e)}forEach(e){this.inorderTraversal(((t,s)=>(e(t,s),!1)))}toString(){const e=[];return this.inorderTraversal(((t,s)=>(e.push(`${t}:${s}`),!1))),`{${e.join(", ")}}`}reverseTraversal(e){return this.root.reverseTraversal(e)}getIterator(){return new Ei(this.root,null,this.comparator,!1)}getIteratorFrom(e){return new Ei(this.root,e,this.comparator,!1)}getReverseIterator(){return new Ei(this.root,null,this.comparator,!0)}getReverseIteratorFrom(e){return new Ei(this.root,e,this.comparator,!0)}},Ei=class{constructor(e,t,s,i){this.isReverse=i,this.nodeStack=[];let r=1;for(;!e.isEmpty();)if(r=t?s(e.key,t):1,t&&i&&(r*=-1),r<0)e=this.isReverse?e.left:e.right;else{if(r===0){this.nodeStack.push(e);break}this.nodeStack.push(e),e=this.isReverse?e.right:e.left}}getNext(){let e=this.nodeStack.pop();const t={key:e.key,value:e.value};if(this.isReverse)for(e=e.left;!e.isEmpty();)this.nodeStack.push(e),e=e.right;else for(e=e.right;!e.isEmpty();)this.nodeStack.push(e),e=e.left;return t}hasNext(){return this.nodeStack.length>0}peek(){if(this.nodeStack.length===0)return null;const e=this.nodeStack[this.nodeStack.length-1];return{key:e.key,value:e.value}}},Pt=class at{constructor(e,t,s,i,r){this.key=e,this.value=t,this.color=s??at.RED,this.left=i??at.EMPTY,this.right=r??at.EMPTY,this.size=this.left.size+1+this.right.size}copy(e,t,s,i,r){return new at(e??this.key,t??this.value,s??this.color,i??this.left,r??this.right)}isEmpty(){return!1}inorderTraversal(e){return this.left.inorderTraversal(e)||e(this.key,this.value)||this.right.inorderTraversal(e)}reverseTraversal(e){return this.right.reverseTraversal(e)||e(this.key,this.value)||this.left.reverseTraversal(e)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(e,t,s){let i=this;const r=s(e,i.key);return i=r<0?i.copy(null,null,null,i.left.insert(e,t,s),null):r===0?i.copy(null,t,null,null,null):i.copy(null,null,null,null,i.right.insert(e,t,s)),i.fixUp()}removeMin(){if(this.left.isEmpty())return at.EMPTY;let e=this;return e.left.isRed()||e.left.left.isRed()||(e=e.moveRedLeft()),e=e.copy(null,null,null,e.left.removeMin(),null),e.fixUp()}remove(e,t){let s,i=this;if(t(e,i.key)<0)i.left.isEmpty()||i.left.isRed()||i.left.left.isRed()||(i=i.moveRedLeft()),i=i.copy(null,null,null,i.left.remove(e,t),null);else{if(i.left.isRed()&&(i=i.rotateRight()),i.right.isEmpty()||i.right.isRed()||i.right.left.isRed()||(i=i.moveRedRight()),t(e,i.key)===0){if(i.right.isEmpty())return at.EMPTY;s=i.right.min(),i=i.copy(s.key,s.value,null,null,i.right.removeMin())}i=i.copy(null,null,null,null,i.right.remove(e,t))}return i.fixUp()}isRed(){return this.color}fixUp(){let e=this;return e.right.isRed()&&!e.left.isRed()&&(e=e.rotateLeft()),e.left.isRed()&&e.left.left.isRed()&&(e=e.rotateRight()),e.left.isRed()&&e.right.isRed()&&(e=e.colorFlip()),e}moveRedLeft(){let e=this.colorFlip();return e.right.left.isRed()&&(e=e.copy(null,null,null,null,e.right.rotateRight()),e=e.rotateLeft(),e=e.colorFlip()),e}moveRedRight(){let e=this.colorFlip();return e.left.left.isRed()&&(e=e.rotateRight(),e=e.colorFlip()),e}rotateLeft(){const e=this.copy(null,null,at.RED,null,this.right.left);return this.right.copy(null,null,this.color,e,null)}rotateRight(){const e=this.copy(null,null,at.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,e)}colorFlip(){const e=this.left.copy(null,null,!this.left.color,null,null),t=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,e,t)}checkMaxDepth(){const e=this.check();return Math.pow(2,e)<=this.size+1}check(){if(this.isRed()&&this.left.isRed())throw F(43730,{key:this.key,value:this.value});if(this.right.isRed())throw F(14113,{key:this.key,value:this.value});const e=this.left.check();if(e!==this.right.check())throw F(27949);return e+(this.isRed()?0:1)}};Pt.EMPTY=null,Pt.RED=!0,Pt.BLACK=!1;Pt.EMPTY=new class{constructor(){this.size=0}get key(){throw F(57766)}get value(){throw F(16141)}get color(){throw F(16727)}get left(){throw F(29726)}get right(){throw F(36894)}copy(e,t,s,i,r){return this}insert(e,t,s){return new Pt(e,t)}remove(e,t){return this}isEmpty(){return!0}inorderTraversal(e){return!1}reverseTraversal(e){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};class ye{constructor(e){this.comparator=e,this.data=new fe(this.comparator)}has(e){return this.data.get(e)!==null}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(e){return this.data.indexOf(e)}forEach(e){this.data.inorderTraversal(((t,s)=>(e(t),!1)))}forEachInRange(e,t){const s=this.data.getIteratorFrom(e[0]);for(;s.hasNext();){const i=s.getNext();if(this.comparator(i.key,e[1])>=0)return;t(i.key)}}forEachWhile(e,t){let s;for(s=t!==void 0?this.data.getIteratorFrom(t):this.data.getIterator();s.hasNext();)if(!e(s.getNext().key))return}firstAfterOrEqual(e){const t=this.data.getIteratorFrom(e);return t.hasNext()?t.getNext().key:null}getIterator(){return new Uc(this.data.getIterator())}getIteratorFrom(e){return new Uc(this.data.getIteratorFrom(e))}add(e){return this.copy(this.data.remove(e).insert(e,!0))}delete(e){return this.has(e)?this.copy(this.data.remove(e)):this}isEmpty(){return this.data.isEmpty()}unionWith(e){let t=this;return t.size<e.size&&(t=e,e=this),e.forEach((s=>{t=t.add(s)})),t}isEqual(e){if(!(e instanceof ye)||this.size!==e.size)return!1;const t=this.data.getIterator(),s=e.data.getIterator();for(;t.hasNext();){const i=t.getNext().key,r=s.getNext().key;if(this.comparator(i,r)!==0)return!1}return!0}toArray(){const e=[];return this.forEach((t=>{e.push(t)})),e}toString(){const e=[];return this.forEach((t=>e.push(t))),"SortedSet("+e.toString()+")"}copy(e){const t=new ye(this.comparator);return t.data=e,t}}class Uc{constructor(e){this.iter=e}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}}class Ge{constructor(e){this.fields=e,e.sort(Re.comparator)}static empty(){return new Ge([])}unionWith(e){let t=new ye(Re.comparator);for(const s of this.fields)t=t.add(s);for(const s of e)t=t.add(s);return new Ge(t.toArray())}covers(e){for(const t of this.fields)if(t.isPrefixOf(e))return!0;return!1}isEqual(e){return Pn(this.fields,e.fields,((t,s)=>t.isEqual(s)))}}class jh extends Error{constructor(){super(...arguments),this.name="Base64DecodeError"}}class Se{constructor(e){this.binaryString=e}static fromBase64String(e){const t=(function(i){try{return atob(i)}catch(r){throw typeof DOMException<"u"&&r instanceof DOMException?new jh("Invalid base64 string: "+r):r}})(e);return new Se(t)}static fromUint8Array(e){const t=(function(i){let r="";for(let a=0;a<i.length;++a)r+=String.fromCharCode(i[a]);return r})(e);return new Se(t)}[Symbol.iterator](){let e=0;return{next:()=>e<this.binaryString.length?{value:this.binaryString.charCodeAt(e++),done:!1}:{value:void 0,done:!0}}}toBase64(){return(function(t){return btoa(t)})(this.binaryString)}toUint8Array(){return(function(t){const s=new Uint8Array(t.length);for(let i=0;i<t.length;i++)s[i]=t.charCodeAt(i);return s})(this.binaryString)}approximateByteSize(){return 2*this.binaryString.length}compareTo(e){return H(this.binaryString,e.binaryString)}isEqual(e){return this.binaryString===e.binaryString}}Se.EMPTY_BYTE_STRING=new Se("");const fg=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function Vt(n){if(Z(!!n,39018),typeof n=="string"){let e=0;const t=fg.exec(n);if(Z(!!t,46558,{timestamp:n}),t[1]){let i=t[1];i=(i+"000000000").substr(0,9),e=Number(i)}const s=new Date(n);return{seconds:Math.floor(s.getTime()/1e3),nanos:e}}return{seconds:ce(n.seconds),nanos:ce(n.nanos)}}function ce(n){return typeof n=="number"?n:typeof n=="string"?Number(n):0}function xt(n){return typeof n=="string"?Se.fromBase64String(n):Se.fromUint8Array(n)}const Wh="server_timestamp",$h="__type__",zh="__previous_value__",Gh="__local_write_time__";function la(n){return(n?.mapValue?.fields||{})[$h]?.stringValue===Wh}function hr(n){const e=n.mapValue.fields[zh];return la(e)?hr(e):e}function Ns(n){const e=Vt(n.mapValue.fields[Gh].timestampValue);return new oe(e.seconds,e.nanos)}class pg{constructor(e,t,s,i,r,a,l,u,h,f){this.databaseId=e,this.appId=t,this.persistenceKey=s,this.host=i,this.ssl=r,this.forceLongPolling=a,this.autoDetectLongPolling=l,this.longPollingOptions=u,this.useFetchStreams=h,this.isUsingEmulator=f}}const Li="(default)";class Ds{constructor(e,t){this.projectId=e,this.database=t||Li}static empty(){return new Ds("","")}get isDefaultDatabase(){return this.database===Li}isEqual(e){return e instanceof Ds&&e.projectId===this.projectId&&e.database===this.database}}const Hh="__type__",_g="__max__",vi={mapValue:{}},Kh="__vector__",Fi="value";function Ot(n){return"nullValue"in n?0:"booleanValue"in n?1:"integerValue"in n||"doubleValue"in n?2:"timestampValue"in n?3:"stringValue"in n?5:"bytesValue"in n?6:"referenceValue"in n?7:"geoPointValue"in n?8:"arrayValue"in n?9:"mapValue"in n?la(n)?4:gg(n)?9007199254740991:mg(n)?10:11:F(28295,{value:n})}function ot(n,e){if(n===e)return!0;const t=Ot(n);if(t!==Ot(e))return!1;switch(t){case 0:case 9007199254740991:return!0;case 1:return n.booleanValue===e.booleanValue;case 4:return Ns(n).isEqual(Ns(e));case 3:return(function(i,r){if(typeof i.timestampValue=="string"&&typeof r.timestampValue=="string"&&i.timestampValue.length===r.timestampValue.length)return i.timestampValue===r.timestampValue;const a=Vt(i.timestampValue),l=Vt(r.timestampValue);return a.seconds===l.seconds&&a.nanos===l.nanos})(n,e);case 5:return n.stringValue===e.stringValue;case 6:return(function(i,r){return xt(i.bytesValue).isEqual(xt(r.bytesValue))})(n,e);case 7:return n.referenceValue===e.referenceValue;case 8:return(function(i,r){return ce(i.geoPointValue.latitude)===ce(r.geoPointValue.latitude)&&ce(i.geoPointValue.longitude)===ce(r.geoPointValue.longitude)})(n,e);case 2:return(function(i,r){if("integerValue"in i&&"integerValue"in r)return ce(i.integerValue)===ce(r.integerValue);if("doubleValue"in i&&"doubleValue"in r){const a=ce(i.doubleValue),l=ce(r.doubleValue);return a===l?Mi(a)===Mi(l):isNaN(a)&&isNaN(l)}return!1})(n,e);case 9:return Pn(n.arrayValue.values||[],e.arrayValue.values||[],ot);case 10:case 11:return(function(i,r){const a=i.mapValue.fields||{},l=r.mapValue.fields||{};if(Fc(a)!==Fc(l))return!1;for(const u in a)if(a.hasOwnProperty(u)&&(l[u]===void 0||!ot(a[u],l[u])))return!1;return!0})(n,e);default:return F(52216,{left:n})}}function ks(n,e){return(n.values||[]).find((t=>ot(t,e)))!==void 0}function Nn(n,e){if(n===e)return 0;const t=Ot(n),s=Ot(e);if(t!==s)return H(t,s);switch(t){case 0:case 9007199254740991:return 0;case 1:return H(n.booleanValue,e.booleanValue);case 2:return(function(r,a){const l=ce(r.integerValue||r.doubleValue),u=ce(a.integerValue||a.doubleValue);return l<u?-1:l>u?1:l===u?0:isNaN(l)?isNaN(u)?0:-1:1})(n,e);case 3:return Bc(n.timestampValue,e.timestampValue);case 4:return Bc(Ns(n),Ns(e));case 5:return Ao(n.stringValue,e.stringValue);case 6:return(function(r,a){const l=xt(r),u=xt(a);return l.compareTo(u)})(n.bytesValue,e.bytesValue);case 7:return(function(r,a){const l=r.split("/"),u=a.split("/");for(let h=0;h<l.length&&h<u.length;h++){const f=H(l[h],u[h]);if(f!==0)return f}return H(l.length,u.length)})(n.referenceValue,e.referenceValue);case 8:return(function(r,a){const l=H(ce(r.latitude),ce(a.latitude));return l!==0?l:H(ce(r.longitude),ce(a.longitude))})(n.geoPointValue,e.geoPointValue);case 9:return qc(n.arrayValue,e.arrayValue);case 10:return(function(r,a){const l=r.fields||{},u=a.fields||{},h=l[Fi]?.arrayValue,f=u[Fi]?.arrayValue,p=H(h?.values?.length||0,f?.values?.length||0);return p!==0?p:qc(h,f)})(n.mapValue,e.mapValue);case 11:return(function(r,a){if(r===vi.mapValue&&a===vi.mapValue)return 0;if(r===vi.mapValue)return 1;if(a===vi.mapValue)return-1;const l=r.fields||{},u=Object.keys(l),h=a.fields||{},f=Object.keys(h);u.sort(),f.sort();for(let p=0;p<u.length&&p<f.length;++p){const m=Ao(u[p],f[p]);if(m!==0)return m;const A=Nn(l[u[p]],h[f[p]]);if(A!==0)return A}return H(u.length,f.length)})(n.mapValue,e.mapValue);default:throw F(23264,{he:t})}}function Bc(n,e){if(typeof n=="string"&&typeof e=="string"&&n.length===e.length)return H(n,e);const t=Vt(n),s=Vt(e),i=H(t.seconds,s.seconds);return i!==0?i:H(t.nanos,s.nanos)}function qc(n,e){const t=n.values||[],s=e.values||[];for(let i=0;i<t.length&&i<s.length;++i){const r=Nn(t[i],s[i]);if(r)return r}return H(t.length,s.length)}function Dn(n){return So(n)}function So(n){return"nullValue"in n?"null":"booleanValue"in n?""+n.booleanValue:"integerValue"in n?""+n.integerValue:"doubleValue"in n?""+n.doubleValue:"timestampValue"in n?(function(t){const s=Vt(t);return`time(${s.seconds},${s.nanos})`})(n.timestampValue):"stringValue"in n?n.stringValue:"bytesValue"in n?(function(t){return xt(t).toBase64()})(n.bytesValue):"referenceValue"in n?(function(t){return M.fromName(t).toString()})(n.referenceValue):"geoPointValue"in n?(function(t){return`geo(${t.latitude},${t.longitude})`})(n.geoPointValue):"arrayValue"in n?(function(t){let s="[",i=!0;for(const r of t.values||[])i?i=!1:s+=",",s+=So(r);return s+"]"})(n.arrayValue):"mapValue"in n?(function(t){const s=Object.keys(t.fields||{}).sort();let i="{",r=!0;for(const a of s)r?r=!1:i+=",",i+=`${a}:${So(t.fields[a])}`;return i+"}"})(n.mapValue):F(61005,{value:n})}function Si(n){switch(Ot(n)){case 0:case 1:return 4;case 2:return 8;case 3:case 8:return 16;case 4:const e=hr(n);return e?16+Si(e):16;case 5:return 2*n.stringValue.length;case 6:return xt(n.bytesValue).approximateByteSize();case 7:return n.referenceValue.length;case 9:return(function(s){return(s.values||[]).reduce(((i,r)=>i+Si(r)),0)})(n.arrayValue);case 10:case 11:return(function(s){let i=0;return rn(s.fields,((r,a)=>{i+=r.length+Si(a)})),i})(n.mapValue);default:throw F(13486,{value:n})}}function jc(n,e){return{referenceValue:`projects/${n.projectId}/databases/${n.database}/documents/${e.path.canonicalString()}`}}function Po(n){return!!n&&"integerValue"in n}function ca(n){return!!n&&"arrayValue"in n}function Wc(n){return!!n&&"nullValue"in n}function $c(n){return!!n&&"doubleValue"in n&&isNaN(Number(n.doubleValue))}function Pi(n){return!!n&&"mapValue"in n}function mg(n){return(n?.mapValue?.fields||{})[Hh]?.stringValue===Kh}function ms(n){if(n.geoPointValue)return{geoPointValue:{...n.geoPointValue}};if(n.timestampValue&&typeof n.timestampValue=="object")return{timestampValue:{...n.timestampValue}};if(n.mapValue){const e={mapValue:{fields:{}}};return rn(n.mapValue.fields,((t,s)=>e.mapValue.fields[t]=ms(s))),e}if(n.arrayValue){const e={arrayValue:{values:[]}};for(let t=0;t<(n.arrayValue.values||[]).length;++t)e.arrayValue.values[t]=ms(n.arrayValue.values[t]);return e}return{...n}}function gg(n){return(((n.mapValue||{}).fields||{}).__type__||{}).stringValue===_g}class We{constructor(e){this.value=e}static empty(){return new We({mapValue:{}})}field(e){if(e.isEmpty())return this.value;{let t=this.value;for(let s=0;s<e.length-1;++s)if(t=(t.mapValue.fields||{})[e.get(s)],!Pi(t))return null;return t=(t.mapValue.fields||{})[e.lastSegment()],t||null}}set(e,t){this.getFieldsMap(e.popLast())[e.lastSegment()]=ms(t)}setAll(e){let t=Re.emptyPath(),s={},i=[];e.forEach(((a,l)=>{if(!t.isImmediateParentOf(l)){const u=this.getFieldsMap(t);this.applyChanges(u,s,i),s={},i=[],t=l.popLast()}a?s[l.lastSegment()]=ms(a):i.push(l.lastSegment())}));const r=this.getFieldsMap(t);this.applyChanges(r,s,i)}delete(e){const t=this.field(e.popLast());Pi(t)&&t.mapValue.fields&&delete t.mapValue.fields[e.lastSegment()]}isEqual(e){return ot(this.value,e.value)}getFieldsMap(e){let t=this.value;t.mapValue.fields||(t.mapValue={fields:{}});for(let s=0;s<e.length;++s){let i=t.mapValue.fields[e.get(s)];Pi(i)&&i.mapValue.fields||(i={mapValue:{fields:{}}},t.mapValue.fields[e.get(s)]=i),t=i}return t.mapValue.fields}applyChanges(e,t,s){rn(t,((i,r)=>e[i]=r));for(const i of s)delete e[i]}clone(){return new We(ms(this.value))}}function Qh(n){const e=[];return rn(n.fields,((t,s)=>{const i=new Re([t]);if(Pi(s)){const r=Qh(s.mapValue).fields;if(r.length===0)e.push(i);else for(const a of r)e.push(i.child(a))}else e.push(i)})),new Ge(e)}class De{constructor(e,t,s,i,r,a,l){this.key=e,this.documentType=t,this.version=s,this.readTime=i,this.createTime=r,this.data=a,this.documentState=l}static newInvalidDocument(e){return new De(e,0,U.min(),U.min(),U.min(),We.empty(),0)}static newFoundDocument(e,t,s,i){return new De(e,1,t,U.min(),s,i,0)}static newNoDocument(e,t){return new De(e,2,t,U.min(),U.min(),We.empty(),0)}static newUnknownDocument(e,t){return new De(e,3,t,U.min(),U.min(),We.empty(),2)}convertToFoundDocument(e,t){return!this.createTime.isEqual(U.min())||this.documentType!==2&&this.documentType!==0||(this.createTime=e),this.version=e,this.documentType=1,this.data=t,this.documentState=0,this}convertToNoDocument(e){return this.version=e,this.documentType=2,this.data=We.empty(),this.documentState=0,this}convertToUnknownDocument(e){return this.version=e,this.documentType=3,this.data=We.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this.version=U.min(),this}setReadTime(e){return this.readTime=e,this}get hasLocalMutations(){return this.documentState===1}get hasCommittedMutations(){return this.documentState===2}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return this.documentType!==0}isFoundDocument(){return this.documentType===1}isNoDocument(){return this.documentType===2}isUnknownDocument(){return this.documentType===3}isEqual(e){return e instanceof De&&this.key.isEqual(e.key)&&this.version.isEqual(e.version)&&this.documentType===e.documentType&&this.documentState===e.documentState&&this.data.isEqual(e.data)}mutableCopy(){return new De(this.key,this.documentType,this.version,this.readTime,this.createTime,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {createTime: ${this.createTime}}), {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}}class Ui{constructor(e,t){this.position=e,this.inclusive=t}}function zc(n,e,t){let s=0;for(let i=0;i<n.position.length;i++){const r=e[i],a=n.position[i];if(r.field.isKeyField()?s=M.comparator(M.fromName(a.referenceValue),t.key):s=Nn(a,t.data.field(r.field)),r.dir==="desc"&&(s*=-1),s!==0)break}return s}function Gc(n,e){if(n===null)return e===null;if(e===null||n.inclusive!==e.inclusive||n.position.length!==e.position.length)return!1;for(let t=0;t<n.position.length;t++)if(!ot(n.position[t],e.position[t]))return!1;return!0}class Vs{constructor(e,t="asc"){this.field=e,this.dir=t}}function yg(n,e){return n.dir===e.dir&&n.field.isEqual(e.field)}class Yh{}class he extends Yh{constructor(e,t,s){super(),this.field=e,this.op=t,this.value=s}static create(e,t,s){return e.isKeyField()?t==="in"||t==="not-in"?this.createKeyFieldInFilter(e,t,s):new vg(e,t,s):t==="array-contains"?new wg(e,s):t==="in"?new Cg(e,s):t==="not-in"?new Ag(e,s):t==="array-contains-any"?new Rg(e,s):new he(e,t,s)}static createKeyFieldInFilter(e,t,s){return t==="in"?new Tg(e,s):new Ig(e,s)}matches(e){const t=e.data.field(this.field);return this.op==="!="?t!==null&&t.nullValue===void 0&&this.matchesComparison(Nn(t,this.value)):t!==null&&Ot(this.value)===Ot(t)&&this.matchesComparison(Nn(t,this.value))}matchesComparison(e){switch(this.op){case"<":return e<0;case"<=":return e<=0;case"==":return e===0;case"!=":return e!==0;case">":return e>0;case">=":return e>=0;default:return F(47266,{operator:this.op})}}isInequality(){return["<","<=",">",">=","!=","not-in"].indexOf(this.op)>=0}getFlattenedFilters(){return[this]}getFilters(){return[this]}}class Xe extends Yh{constructor(e,t){super(),this.filters=e,this.op=t,this.Pe=null}static create(e,t){return new Xe(e,t)}matches(e){return Xh(this)?this.filters.find((t=>!t.matches(e)))===void 0:this.filters.find((t=>t.matches(e)))!==void 0}getFlattenedFilters(){return this.Pe!==null||(this.Pe=this.filters.reduce(((e,t)=>e.concat(t.getFlattenedFilters())),[])),this.Pe}getFilters(){return Object.assign([],this.filters)}}function Xh(n){return n.op==="and"}function Jh(n){return Eg(n)&&Xh(n)}function Eg(n){for(const e of n.filters)if(e instanceof Xe)return!1;return!0}function bo(n){if(n instanceof he)return n.field.canonicalString()+n.op.toString()+Dn(n.value);if(Jh(n))return n.filters.map((e=>bo(e))).join(",");{const e=n.filters.map((t=>bo(t))).join(",");return`${n.op}(${e})`}}function Zh(n,e){return n instanceof he?(function(s,i){return i instanceof he&&s.op===i.op&&s.field.isEqual(i.field)&&ot(s.value,i.value)})(n,e):n instanceof Xe?(function(s,i){return i instanceof Xe&&s.op===i.op&&s.filters.length===i.filters.length?s.filters.reduce(((r,a,l)=>r&&Zh(a,i.filters[l])),!0):!1})(n,e):void F(19439)}function ed(n){return n instanceof he?(function(t){return`${t.field.canonicalString()} ${t.op} ${Dn(t.value)}`})(n):n instanceof Xe?(function(t){return t.op.toString()+" {"+t.getFilters().map(ed).join(" ,")+"}"})(n):"Filter"}class vg extends he{constructor(e,t,s){super(e,t,s),this.key=M.fromName(s.referenceValue)}matches(e){const t=M.comparator(e.key,this.key);return this.matchesComparison(t)}}class Tg extends he{constructor(e,t){super(e,"in",t),this.keys=td("in",t)}matches(e){return this.keys.some((t=>t.isEqual(e.key)))}}class Ig extends he{constructor(e,t){super(e,"not-in",t),this.keys=td("not-in",t)}matches(e){return!this.keys.some((t=>t.isEqual(e.key)))}}function td(n,e){return(e.arrayValue?.values||[]).map((t=>M.fromName(t.referenceValue)))}class wg extends he{constructor(e,t){super(e,"array-contains",t)}matches(e){const t=e.data.field(this.field);return ca(t)&&ks(t.arrayValue,this.value)}}class Cg extends he{constructor(e,t){super(e,"in",t)}matches(e){const t=e.data.field(this.field);return t!==null&&ks(this.value.arrayValue,t)}}class Ag extends he{constructor(e,t){super(e,"not-in",t)}matches(e){if(ks(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;const t=e.data.field(this.field);return t!==null&&t.nullValue===void 0&&!ks(this.value.arrayValue,t)}}class Rg extends he{constructor(e,t){super(e,"array-contains-any",t)}matches(e){const t=e.data.field(this.field);return!(!ca(t)||!t.arrayValue.values)&&t.arrayValue.values.some((s=>ks(this.value.arrayValue,s)))}}class Sg{constructor(e,t=null,s=[],i=[],r=null,a=null,l=null){this.path=e,this.collectionGroup=t,this.orderBy=s,this.filters=i,this.limit=r,this.startAt=a,this.endAt=l,this.Te=null}}function Hc(n,e=null,t=[],s=[],i=null,r=null,a=null){return new Sg(n,e,t,s,i,r,a)}function ua(n){const e=B(n);if(e.Te===null){let t=e.path.canonicalString();e.collectionGroup!==null&&(t+="|cg:"+e.collectionGroup),t+="|f:",t+=e.filters.map((s=>bo(s))).join(","),t+="|ob:",t+=e.orderBy.map((s=>(function(r){return r.field.canonicalString()+r.dir})(s))).join(","),ur(e.limit)||(t+="|l:",t+=e.limit),e.startAt&&(t+="|lb:",t+=e.startAt.inclusive?"b:":"a:",t+=e.startAt.position.map((s=>Dn(s))).join(",")),e.endAt&&(t+="|ub:",t+=e.endAt.inclusive?"a:":"b:",t+=e.endAt.position.map((s=>Dn(s))).join(",")),e.Te=t}return e.Te}function ha(n,e){if(n.limit!==e.limit||n.orderBy.length!==e.orderBy.length)return!1;for(let t=0;t<n.orderBy.length;t++)if(!yg(n.orderBy[t],e.orderBy[t]))return!1;if(n.filters.length!==e.filters.length)return!1;for(let t=0;t<n.filters.length;t++)if(!Zh(n.filters[t],e.filters[t]))return!1;return n.collectionGroup===e.collectionGroup&&!!n.path.isEqual(e.path)&&!!Gc(n.startAt,e.startAt)&&Gc(n.endAt,e.endAt)}function No(n){return M.isDocumentKey(n.path)&&n.collectionGroup===null&&n.filters.length===0}class jn{constructor(e,t=null,s=[],i=[],r=null,a="F",l=null,u=null){this.path=e,this.collectionGroup=t,this.explicitOrderBy=s,this.filters=i,this.limit=r,this.limitType=a,this.startAt=l,this.endAt=u,this.Ie=null,this.Ee=null,this.de=null,this.startAt,this.endAt}}function Pg(n,e,t,s,i,r,a,l){return new jn(n,e,t,s,i,r,a,l)}function nd(n){return new jn(n)}function Kc(n){return n.filters.length===0&&n.limit===null&&n.startAt==null&&n.endAt==null&&(n.explicitOrderBy.length===0||n.explicitOrderBy.length===1&&n.explicitOrderBy[0].field.isKeyField())}function sd(n){return n.collectionGroup!==null}function gs(n){const e=B(n);if(e.Ie===null){e.Ie=[];const t=new Set;for(const r of e.explicitOrderBy)e.Ie.push(r),t.add(r.field.canonicalString());const s=e.explicitOrderBy.length>0?e.explicitOrderBy[e.explicitOrderBy.length-1].dir:"asc";(function(a){let l=new ye(Re.comparator);return a.filters.forEach((u=>{u.getFlattenedFilters().forEach((h=>{h.isInequality()&&(l=l.add(h.field))}))})),l})(e).forEach((r=>{t.has(r.canonicalString())||r.isKeyField()||e.Ie.push(new Vs(r,s))})),t.has(Re.keyField().canonicalString())||e.Ie.push(new Vs(Re.keyField(),s))}return e.Ie}function tt(n){const e=B(n);return e.Ee||(e.Ee=bg(e,gs(n))),e.Ee}function bg(n,e){if(n.limitType==="F")return Hc(n.path,n.collectionGroup,e,n.filters,n.limit,n.startAt,n.endAt);{e=e.map((i=>{const r=i.dir==="desc"?"asc":"desc";return new Vs(i.field,r)}));const t=n.endAt?new Ui(n.endAt.position,n.endAt.inclusive):null,s=n.startAt?new Ui(n.startAt.position,n.startAt.inclusive):null;return Hc(n.path,n.collectionGroup,e,n.filters,n.limit,t,s)}}function Do(n,e){const t=n.filters.concat([e]);return new jn(n.path,n.collectionGroup,n.explicitOrderBy.slice(),t,n.limit,n.limitType,n.startAt,n.endAt)}function Bi(n,e,t){return new jn(n.path,n.collectionGroup,n.explicitOrderBy.slice(),n.filters.slice(),e,t,n.startAt,n.endAt)}function dr(n,e){return ha(tt(n),tt(e))&&n.limitType===e.limitType}function id(n){return`${ua(tt(n))}|lt:${n.limitType}`}function _n(n){return`Query(target=${(function(t){let s=t.path.canonicalString();return t.collectionGroup!==null&&(s+=" collectionGroup="+t.collectionGroup),t.filters.length>0&&(s+=`, filters: [${t.filters.map((i=>ed(i))).join(", ")}]`),ur(t.limit)||(s+=", limit: "+t.limit),t.orderBy.length>0&&(s+=`, orderBy: [${t.orderBy.map((i=>(function(a){return`${a.field.canonicalString()} (${a.dir})`})(i))).join(", ")}]`),t.startAt&&(s+=", startAt: ",s+=t.startAt.inclusive?"b:":"a:",s+=t.startAt.position.map((i=>Dn(i))).join(",")),t.endAt&&(s+=", endAt: ",s+=t.endAt.inclusive?"a:":"b:",s+=t.endAt.position.map((i=>Dn(i))).join(",")),`Target(${s})`})(tt(n))}; limitType=${n.limitType})`}function fr(n,e){return e.isFoundDocument()&&(function(s,i){const r=i.key.path;return s.collectionGroup!==null?i.key.hasCollectionId(s.collectionGroup)&&s.path.isPrefixOf(r):M.isDocumentKey(s.path)?s.path.isEqual(r):s.path.isImmediateParentOf(r)})(n,e)&&(function(s,i){for(const r of gs(s))if(!r.field.isKeyField()&&i.data.field(r.field)===null)return!1;return!0})(n,e)&&(function(s,i){for(const r of s.filters)if(!r.matches(i))return!1;return!0})(n,e)&&(function(s,i){return!(s.startAt&&!(function(a,l,u){const h=zc(a,l,u);return a.inclusive?h<=0:h<0})(s.startAt,gs(s),i)||s.endAt&&!(function(a,l,u){const h=zc(a,l,u);return a.inclusive?h>=0:h>0})(s.endAt,gs(s),i))})(n,e)}function Ng(n){return n.collectionGroup||(n.path.length%2==1?n.path.lastSegment():n.path.get(n.path.length-2))}function rd(n){return(e,t)=>{let s=!1;for(const i of gs(n)){const r=Dg(i,e,t);if(r!==0)return r;s=s||i.field.isKeyField()}return 0}}function Dg(n,e,t){const s=n.field.isKeyField()?M.comparator(e.key,t.key):(function(r,a,l){const u=a.data.field(r),h=l.data.field(r);return u!==null&&h!==null?Nn(u,h):F(42886)})(n.field,e,t);switch(n.dir){case"asc":return s;case"desc":return-1*s;default:return F(19790,{direction:n.dir})}}class on{constructor(e,t){this.mapKeyFn=e,this.equalsFn=t,this.inner={},this.innerSize=0}get(e){const t=this.mapKeyFn(e),s=this.inner[t];if(s!==void 0){for(const[i,r]of s)if(this.equalsFn(i,e))return r}}has(e){return this.get(e)!==void 0}set(e,t){const s=this.mapKeyFn(e),i=this.inner[s];if(i===void 0)return this.inner[s]=[[e,t]],void this.innerSize++;for(let r=0;r<i.length;r++)if(this.equalsFn(i[r][0],e))return void(i[r]=[e,t]);i.push([e,t]),this.innerSize++}delete(e){const t=this.mapKeyFn(e),s=this.inner[t];if(s===void 0)return!1;for(let i=0;i<s.length;i++)if(this.equalsFn(s[i][0],e))return s.length===1?delete this.inner[t]:s.splice(i,1),this.innerSize--,!0;return!1}forEach(e){rn(this.inner,((t,s)=>{for(const[i,r]of s)e(i,r)}))}isEmpty(){return qh(this.inner)}size(){return this.innerSize}}const kg=new fe(M.comparator);function dt(){return kg}const od=new fe(M.comparator);function fs(...n){let e=od;for(const t of n)e=e.insert(t.key,t);return e}function ad(n){let e=od;return n.forEach(((t,s)=>e=e.insert(t,s.overlayedDocument))),e}function Xt(){return ys()}function ld(){return ys()}function ys(){return new on((n=>n.toString()),((n,e)=>n.isEqual(e)))}const Vg=new fe(M.comparator),xg=new ye(M.comparator);function K(...n){let e=xg;for(const t of n)e=e.add(t);return e}const Og=new ye(H);function Mg(){return Og}function da(n,e){if(n.useProto3Json){if(isNaN(e))return{doubleValue:"NaN"};if(e===1/0)return{doubleValue:"Infinity"};if(e===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:Mi(e)?"-0":e}}function cd(n){return{integerValue:""+n}}function Lg(n,e){return ug(e)?cd(e):da(n,e)}class pr{constructor(){this._=void 0}}function Fg(n,e,t){return n instanceof qi?(function(i,r){const a={fields:{[$h]:{stringValue:Wh},[Gh]:{timestampValue:{seconds:i.seconds,nanos:i.nanoseconds}}}};return r&&la(r)&&(r=hr(r)),r&&(a.fields[zh]=r),{mapValue:a}})(t,e):n instanceof xs?hd(n,e):n instanceof Os?dd(n,e):(function(i,r){const a=ud(i,r),l=Qc(a)+Qc(i.Ae);return Po(a)&&Po(i.Ae)?cd(l):da(i.serializer,l)})(n,e)}function Ug(n,e,t){return n instanceof xs?hd(n,e):n instanceof Os?dd(n,e):t}function ud(n,e){return n instanceof ji?(function(s){return Po(s)||(function(r){return!!r&&"doubleValue"in r})(s)})(e)?e:{integerValue:0}:null}class qi extends pr{}class xs extends pr{constructor(e){super(),this.elements=e}}function hd(n,e){const t=fd(e);for(const s of n.elements)t.some((i=>ot(i,s)))||t.push(s);return{arrayValue:{values:t}}}class Os extends pr{constructor(e){super(),this.elements=e}}function dd(n,e){let t=fd(e);for(const s of n.elements)t=t.filter((i=>!ot(i,s)));return{arrayValue:{values:t}}}class ji extends pr{constructor(e,t){super(),this.serializer=e,this.Ae=t}}function Qc(n){return ce(n.integerValue||n.doubleValue)}function fd(n){return ca(n)&&n.arrayValue.values?n.arrayValue.values.slice():[]}function Bg(n,e){return n.field.isEqual(e.field)&&(function(s,i){return s instanceof xs&&i instanceof xs||s instanceof Os&&i instanceof Os?Pn(s.elements,i.elements,ot):s instanceof ji&&i instanceof ji?ot(s.Ae,i.Ae):s instanceof qi&&i instanceof qi})(n.transform,e.transform)}class qg{constructor(e,t){this.version=e,this.transformResults=t}}class nt{constructor(e,t){this.updateTime=e,this.exists=t}static none(){return new nt}static exists(e){return new nt(void 0,e)}static updateTime(e){return new nt(e)}get isNone(){return this.updateTime===void 0&&this.exists===void 0}isEqual(e){return this.exists===e.exists&&(this.updateTime?!!e.updateTime&&this.updateTime.isEqual(e.updateTime):!e.updateTime)}}function bi(n,e){return n.updateTime!==void 0?e.isFoundDocument()&&e.version.isEqual(n.updateTime):n.exists===void 0||n.exists===e.isFoundDocument()}class _r{}function pd(n,e){if(!n.hasLocalMutations||e&&e.fields.length===0)return null;if(e===null)return n.isNoDocument()?new fa(n.key,nt.none()):new Gs(n.key,n.data,nt.none());{const t=n.data,s=We.empty();let i=new ye(Re.comparator);for(let r of e.fields)if(!i.has(r)){let a=t.field(r);a===null&&r.length>1&&(r=r.popLast(),a=t.field(r)),a===null?s.delete(r):s.set(r,a),i=i.add(r)}return new an(n.key,s,new Ge(i.toArray()),nt.none())}}function jg(n,e,t){n instanceof Gs?(function(i,r,a){const l=i.value.clone(),u=Xc(i.fieldTransforms,r,a.transformResults);l.setAll(u),r.convertToFoundDocument(a.version,l).setHasCommittedMutations()})(n,e,t):n instanceof an?(function(i,r,a){if(!bi(i.precondition,r))return void r.convertToUnknownDocument(a.version);const l=Xc(i.fieldTransforms,r,a.transformResults),u=r.data;u.setAll(_d(i)),u.setAll(l),r.convertToFoundDocument(a.version,u).setHasCommittedMutations()})(n,e,t):(function(i,r,a){r.convertToNoDocument(a.version).setHasCommittedMutations()})(0,e,t)}function Es(n,e,t,s){return n instanceof Gs?(function(r,a,l,u){if(!bi(r.precondition,a))return l;const h=r.value.clone(),f=Jc(r.fieldTransforms,u,a);return h.setAll(f),a.convertToFoundDocument(a.version,h).setHasLocalMutations(),null})(n,e,t,s):n instanceof an?(function(r,a,l,u){if(!bi(r.precondition,a))return l;const h=Jc(r.fieldTransforms,u,a),f=a.data;return f.setAll(_d(r)),f.setAll(h),a.convertToFoundDocument(a.version,f).setHasLocalMutations(),l===null?null:l.unionWith(r.fieldMask.fields).unionWith(r.fieldTransforms.map((p=>p.field)))})(n,e,t,s):(function(r,a,l){return bi(r.precondition,a)?(a.convertToNoDocument(a.version).setHasLocalMutations(),null):l})(n,e,t)}function Wg(n,e){let t=null;for(const s of n.fieldTransforms){const i=e.data.field(s.field),r=ud(s.transform,i||null);r!=null&&(t===null&&(t=We.empty()),t.set(s.field,r))}return t||null}function Yc(n,e){return n.type===e.type&&!!n.key.isEqual(e.key)&&!!n.precondition.isEqual(e.precondition)&&!!(function(s,i){return s===void 0&&i===void 0||!(!s||!i)&&Pn(s,i,((r,a)=>Bg(r,a)))})(n.fieldTransforms,e.fieldTransforms)&&(n.type===0?n.value.isEqual(e.value):n.type!==1||n.data.isEqual(e.data)&&n.fieldMask.isEqual(e.fieldMask))}class Gs extends _r{constructor(e,t,s,i=[]){super(),this.key=e,this.value=t,this.precondition=s,this.fieldTransforms=i,this.type=0}getFieldMask(){return null}}class an extends _r{constructor(e,t,s,i,r=[]){super(),this.key=e,this.data=t,this.fieldMask=s,this.precondition=i,this.fieldTransforms=r,this.type=1}getFieldMask(){return this.fieldMask}}function _d(n){const e=new Map;return n.fieldMask.fields.forEach((t=>{if(!t.isEmpty()){const s=n.data.field(t);e.set(t,s)}})),e}function Xc(n,e,t){const s=new Map;Z(n.length===t.length,32656,{Re:t.length,Ve:n.length});for(let i=0;i<t.length;i++){const r=n[i],a=r.transform,l=e.data.field(r.field);s.set(r.field,Ug(a,l,t[i]))}return s}function Jc(n,e,t){const s=new Map;for(const i of n){const r=i.transform,a=t.data.field(i.field);s.set(i.field,Fg(r,a,e))}return s}class fa extends _r{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=2,this.fieldTransforms=[]}getFieldMask(){return null}}class $g extends _r{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=3,this.fieldTransforms=[]}getFieldMask(){return null}}class zg{constructor(e,t,s,i){this.batchId=e,this.localWriteTime=t,this.baseMutations=s,this.mutations=i}applyToRemoteDocument(e,t){const s=t.mutationResults;for(let i=0;i<this.mutations.length;i++){const r=this.mutations[i];r.key.isEqual(e.key)&&jg(r,e,s[i])}}applyToLocalView(e,t){for(const s of this.baseMutations)s.key.isEqual(e.key)&&(t=Es(s,e,t,this.localWriteTime));for(const s of this.mutations)s.key.isEqual(e.key)&&(t=Es(s,e,t,this.localWriteTime));return t}applyToLocalDocumentSet(e,t){const s=ld();return this.mutations.forEach((i=>{const r=e.get(i.key),a=r.overlayedDocument;let l=this.applyToLocalView(a,r.mutatedFields);l=t.has(i.key)?null:l;const u=pd(a,l);u!==null&&s.set(i.key,u),a.isValidDocument()||a.convertToNoDocument(U.min())})),s}keys(){return this.mutations.reduce(((e,t)=>e.add(t.key)),K())}isEqual(e){return this.batchId===e.batchId&&Pn(this.mutations,e.mutations,((t,s)=>Yc(t,s)))&&Pn(this.baseMutations,e.baseMutations,((t,s)=>Yc(t,s)))}}class pa{constructor(e,t,s,i){this.batch=e,this.commitVersion=t,this.mutationResults=s,this.docVersions=i}static from(e,t,s){Z(e.mutations.length===s.length,58842,{me:e.mutations.length,fe:s.length});let i=(function(){return Vg})();const r=e.mutations;for(let a=0;a<r.length;a++)i=i.insert(r[a].key,s[a].version);return new pa(e,t,s,i)}}class Gg{constructor(e,t){this.largestBatchId=e,this.mutation=t}getKey(){return this.mutation.key}isEqual(e){return e!==null&&this.mutation===e.mutation}toString(){return`Overlay{
      largestBatchId: ${this.largestBatchId},
      mutation: ${this.mutation.toString()}
    }`}}class Hg{constructor(e,t){this.count=e,this.unchangedNames=t}}var ue,X;function Kg(n){switch(n){case S.OK:return F(64938);case S.CANCELLED:case S.UNKNOWN:case S.DEADLINE_EXCEEDED:case S.RESOURCE_EXHAUSTED:case S.INTERNAL:case S.UNAVAILABLE:case S.UNAUTHENTICATED:return!1;case S.INVALID_ARGUMENT:case S.NOT_FOUND:case S.ALREADY_EXISTS:case S.PERMISSION_DENIED:case S.FAILED_PRECONDITION:case S.ABORTED:case S.OUT_OF_RANGE:case S.UNIMPLEMENTED:case S.DATA_LOSS:return!0;default:return F(15467,{code:n})}}function md(n){if(n===void 0)return ht("GRPC error has no .code"),S.UNKNOWN;switch(n){case ue.OK:return S.OK;case ue.CANCELLED:return S.CANCELLED;case ue.UNKNOWN:return S.UNKNOWN;case ue.DEADLINE_EXCEEDED:return S.DEADLINE_EXCEEDED;case ue.RESOURCE_EXHAUSTED:return S.RESOURCE_EXHAUSTED;case ue.INTERNAL:return S.INTERNAL;case ue.UNAVAILABLE:return S.UNAVAILABLE;case ue.UNAUTHENTICATED:return S.UNAUTHENTICATED;case ue.INVALID_ARGUMENT:return S.INVALID_ARGUMENT;case ue.NOT_FOUND:return S.NOT_FOUND;case ue.ALREADY_EXISTS:return S.ALREADY_EXISTS;case ue.PERMISSION_DENIED:return S.PERMISSION_DENIED;case ue.FAILED_PRECONDITION:return S.FAILED_PRECONDITION;case ue.ABORTED:return S.ABORTED;case ue.OUT_OF_RANGE:return S.OUT_OF_RANGE;case ue.UNIMPLEMENTED:return S.UNIMPLEMENTED;case ue.DATA_LOSS:return S.DATA_LOSS;default:return F(39323,{code:n})}}(X=ue||(ue={}))[X.OK=0]="OK",X[X.CANCELLED=1]="CANCELLED",X[X.UNKNOWN=2]="UNKNOWN",X[X.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",X[X.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",X[X.NOT_FOUND=5]="NOT_FOUND",X[X.ALREADY_EXISTS=6]="ALREADY_EXISTS",X[X.PERMISSION_DENIED=7]="PERMISSION_DENIED",X[X.UNAUTHENTICATED=16]="UNAUTHENTICATED",X[X.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",X[X.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",X[X.ABORTED=10]="ABORTED",X[X.OUT_OF_RANGE=11]="OUT_OF_RANGE",X[X.UNIMPLEMENTED=12]="UNIMPLEMENTED",X[X.INTERNAL=13]="INTERNAL",X[X.UNAVAILABLE=14]="UNAVAILABLE",X[X.DATA_LOSS=15]="DATA_LOSS";function Qg(){return new TextEncoder}const Yg=new Rt([4294967295,4294967295],0);function Zc(n){const e=Qg().encode(n),t=new Nh;return t.update(e),new Uint8Array(t.digest())}function eu(n){const e=new DataView(n.buffer),t=e.getUint32(0,!0),s=e.getUint32(4,!0),i=e.getUint32(8,!0),r=e.getUint32(12,!0);return[new Rt([t,s],0),new Rt([i,r],0)]}class _a{constructor(e,t,s){if(this.bitmap=e,this.padding=t,this.hashCount=s,t<0||t>=8)throw new ps(`Invalid padding: ${t}`);if(s<0)throw new ps(`Invalid hash count: ${s}`);if(e.length>0&&this.hashCount===0)throw new ps(`Invalid hash count: ${s}`);if(e.length===0&&t!==0)throw new ps(`Invalid padding when bitmap length is 0: ${t}`);this.ge=8*e.length-t,this.pe=Rt.fromNumber(this.ge)}ye(e,t,s){let i=e.add(t.multiply(Rt.fromNumber(s)));return i.compare(Yg)===1&&(i=new Rt([i.getBits(0),i.getBits(1)],0)),i.modulo(this.pe).toNumber()}we(e){return!!(this.bitmap[Math.floor(e/8)]&1<<e%8)}mightContain(e){if(this.ge===0)return!1;const t=Zc(e),[s,i]=eu(t);for(let r=0;r<this.hashCount;r++){const a=this.ye(s,i,r);if(!this.we(a))return!1}return!0}static create(e,t,s){const i=e%8==0?0:8-e%8,r=new Uint8Array(Math.ceil(e/8)),a=new _a(r,i,t);return s.forEach((l=>a.insert(l))),a}insert(e){if(this.ge===0)return;const t=Zc(e),[s,i]=eu(t);for(let r=0;r<this.hashCount;r++){const a=this.ye(s,i,r);this.Se(a)}}Se(e){const t=Math.floor(e/8),s=e%8;this.bitmap[t]|=1<<s}}class ps extends Error{constructor(){super(...arguments),this.name="BloomFilterError"}}class mr{constructor(e,t,s,i,r){this.snapshotVersion=e,this.targetChanges=t,this.targetMismatches=s,this.documentUpdates=i,this.resolvedLimboDocuments=r}static createSynthesizedRemoteEventForCurrentChange(e,t,s){const i=new Map;return i.set(e,Hs.createSynthesizedTargetChangeForCurrentChange(e,t,s)),new mr(U.min(),i,new fe(H),dt(),K())}}class Hs{constructor(e,t,s,i,r){this.resumeToken=e,this.current=t,this.addedDocuments=s,this.modifiedDocuments=i,this.removedDocuments=r}static createSynthesizedTargetChangeForCurrentChange(e,t,s){return new Hs(s,t,K(),K(),K())}}class Ni{constructor(e,t,s,i){this.be=e,this.removedTargetIds=t,this.key=s,this.De=i}}class gd{constructor(e,t){this.targetId=e,this.Ce=t}}class yd{constructor(e,t,s=Se.EMPTY_BYTE_STRING,i=null){this.state=e,this.targetIds=t,this.resumeToken=s,this.cause=i}}class tu{constructor(){this.ve=0,this.Fe=nu(),this.Me=Se.EMPTY_BYTE_STRING,this.xe=!1,this.Oe=!0}get current(){return this.xe}get resumeToken(){return this.Me}get Ne(){return this.ve!==0}get Be(){return this.Oe}Le(e){e.approximateByteSize()>0&&(this.Oe=!0,this.Me=e)}ke(){let e=K(),t=K(),s=K();return this.Fe.forEach(((i,r)=>{switch(r){case 0:e=e.add(i);break;case 2:t=t.add(i);break;case 1:s=s.add(i);break;default:F(38017,{changeType:r})}})),new Hs(this.Me,this.xe,e,t,s)}qe(){this.Oe=!1,this.Fe=nu()}Qe(e,t){this.Oe=!0,this.Fe=this.Fe.insert(e,t)}$e(e){this.Oe=!0,this.Fe=this.Fe.remove(e)}Ue(){this.ve+=1}Ke(){this.ve-=1,Z(this.ve>=0,3241,{ve:this.ve})}We(){this.Oe=!0,this.xe=!0}}class Xg{constructor(e){this.Ge=e,this.ze=new Map,this.je=dt(),this.Je=Ti(),this.He=Ti(),this.Ye=new fe(H)}Ze(e){for(const t of e.be)e.De&&e.De.isFoundDocument()?this.Xe(t,e.De):this.et(t,e.key,e.De);for(const t of e.removedTargetIds)this.et(t,e.key,e.De)}tt(e){this.forEachTarget(e,(t=>{const s=this.nt(t);switch(e.state){case 0:this.rt(t)&&s.Le(e.resumeToken);break;case 1:s.Ke(),s.Ne||s.qe(),s.Le(e.resumeToken);break;case 2:s.Ke(),s.Ne||this.removeTarget(t);break;case 3:this.rt(t)&&(s.We(),s.Le(e.resumeToken));break;case 4:this.rt(t)&&(this.it(t),s.Le(e.resumeToken));break;default:F(56790,{state:e.state})}}))}forEachTarget(e,t){e.targetIds.length>0?e.targetIds.forEach(t):this.ze.forEach(((s,i)=>{this.rt(i)&&t(i)}))}st(e){const t=e.targetId,s=e.Ce.count,i=this.ot(t);if(i){const r=i.target;if(No(r))if(s===0){const a=new M(r.path);this.et(t,a,De.newNoDocument(a,U.min()))}else Z(s===1,20013,{expectedCount:s});else{const a=this._t(t);if(a!==s){const l=this.ut(e),u=l?this.ct(l,e,a):1;if(u!==0){this.it(t);const h=u===2?"TargetPurposeExistenceFilterMismatchBloom":"TargetPurposeExistenceFilterMismatch";this.Ye=this.Ye.insert(t,h)}}}}}ut(e){const t=e.Ce.unchangedNames;if(!t||!t.bits)return null;const{bits:{bitmap:s="",padding:i=0},hashCount:r=0}=t;let a,l;try{a=xt(s).toUint8Array()}catch(u){if(u instanceof jh)return Sn("Decoding the base64 bloom filter in existence filter failed ("+u.message+"); ignoring the bloom filter and falling back to full re-query."),null;throw u}try{l=new _a(a,i,r)}catch(u){return Sn(u instanceof ps?"BloomFilter error: ":"Applying bloom filter failed: ",u),null}return l.ge===0?null:l}ct(e,t,s){return t.Ce.count===s-this.Pt(e,t.targetId)?0:2}Pt(e,t){const s=this.Ge.getRemoteKeysForTarget(t);let i=0;return s.forEach((r=>{const a=this.Ge.ht(),l=`projects/${a.projectId}/databases/${a.database}/documents/${r.path.canonicalString()}`;e.mightContain(l)||(this.et(t,r,null),i++)})),i}Tt(e){const t=new Map;this.ze.forEach(((r,a)=>{const l=this.ot(a);if(l){if(r.current&&No(l.target)){const u=new M(l.target.path);this.It(u).has(a)||this.Et(a,u)||this.et(a,u,De.newNoDocument(u,e))}r.Be&&(t.set(a,r.ke()),r.qe())}}));let s=K();this.He.forEach(((r,a)=>{let l=!0;a.forEachWhile((u=>{const h=this.ot(u);return!h||h.purpose==="TargetPurposeLimboResolution"||(l=!1,!1)})),l&&(s=s.add(r))})),this.je.forEach(((r,a)=>a.setReadTime(e)));const i=new mr(e,t,this.Ye,this.je,s);return this.je=dt(),this.Je=Ti(),this.He=Ti(),this.Ye=new fe(H),i}Xe(e,t){if(!this.rt(e))return;const s=this.Et(e,t.key)?2:0;this.nt(e).Qe(t.key,s),this.je=this.je.insert(t.key,t),this.Je=this.Je.insert(t.key,this.It(t.key).add(e)),this.He=this.He.insert(t.key,this.dt(t.key).add(e))}et(e,t,s){if(!this.rt(e))return;const i=this.nt(e);this.Et(e,t)?i.Qe(t,1):i.$e(t),this.He=this.He.insert(t,this.dt(t).delete(e)),this.He=this.He.insert(t,this.dt(t).add(e)),s&&(this.je=this.je.insert(t,s))}removeTarget(e){this.ze.delete(e)}_t(e){const t=this.nt(e).ke();return this.Ge.getRemoteKeysForTarget(e).size+t.addedDocuments.size-t.removedDocuments.size}Ue(e){this.nt(e).Ue()}nt(e){let t=this.ze.get(e);return t||(t=new tu,this.ze.set(e,t)),t}dt(e){let t=this.He.get(e);return t||(t=new ye(H),this.He=this.He.insert(e,t)),t}It(e){let t=this.Je.get(e);return t||(t=new ye(H),this.Je=this.Je.insert(e,t)),t}rt(e){const t=this.ot(e)!==null;return t||O("WatchChangeAggregator","Detected inactive target",e),t}ot(e){const t=this.ze.get(e);return t&&t.Ne?null:this.Ge.At(e)}it(e){this.ze.set(e,new tu),this.Ge.getRemoteKeysForTarget(e).forEach((t=>{this.et(e,t,null)}))}Et(e,t){return this.Ge.getRemoteKeysForTarget(e).has(t)}}function Ti(){return new fe(M.comparator)}function nu(){return new fe(M.comparator)}const Jg={asc:"ASCENDING",desc:"DESCENDING"},Zg={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"},ey={and:"AND",or:"OR"};class ty{constructor(e,t){this.databaseId=e,this.useProto3Json=t}}function ko(n,e){return n.useProto3Json||ur(e)?e:{value:e}}function Wi(n,e){return n.useProto3Json?`${new Date(1e3*e.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+e.nanoseconds).slice(-9)}Z`:{seconds:""+e.seconds,nanos:e.nanoseconds}}function Ed(n,e){return n.useProto3Json?e.toBase64():e.toUint8Array()}function ny(n,e){return Wi(n,e.toTimestamp())}function st(n){return Z(!!n,49232),U.fromTimestamp((function(t){const s=Vt(t);return new oe(s.seconds,s.nanos)})(n))}function ma(n,e){return Vo(n,e).canonicalString()}function Vo(n,e){const t=(function(i){return new se(["projects",i.projectId,"databases",i.database])})(n).child("documents");return e===void 0?t:t.child(e)}function vd(n){const e=se.fromString(n);return Z(Ad(e),10190,{key:e.toString()}),e}function xo(n,e){return ma(n.databaseId,e.path)}function oo(n,e){const t=vd(e);if(t.get(1)!==n.databaseId.projectId)throw new x(S.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+t.get(1)+" vs "+n.databaseId.projectId);if(t.get(3)!==n.databaseId.database)throw new x(S.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+t.get(3)+" vs "+n.databaseId.database);return new M(Id(t))}function Td(n,e){return ma(n.databaseId,e)}function sy(n){const e=vd(n);return e.length===4?se.emptyPath():Id(e)}function Oo(n){return new se(["projects",n.databaseId.projectId,"databases",n.databaseId.database]).canonicalString()}function Id(n){return Z(n.length>4&&n.get(4)==="documents",29091,{key:n.toString()}),n.popFirst(5)}function su(n,e,t){return{name:xo(n,e),fields:t.value.mapValue.fields}}function iy(n,e){let t;if("targetChange"in e){e.targetChange;const s=(function(h){return h==="NO_CHANGE"?0:h==="ADD"?1:h==="REMOVE"?2:h==="CURRENT"?3:h==="RESET"?4:F(39313,{state:h})})(e.targetChange.targetChangeType||"NO_CHANGE"),i=e.targetChange.targetIds||[],r=(function(h,f){return h.useProto3Json?(Z(f===void 0||typeof f=="string",58123),Se.fromBase64String(f||"")):(Z(f===void 0||f instanceof Buffer||f instanceof Uint8Array,16193),Se.fromUint8Array(f||new Uint8Array))})(n,e.targetChange.resumeToken),a=e.targetChange.cause,l=a&&(function(h){const f=h.code===void 0?S.UNKNOWN:md(h.code);return new x(f,h.message||"")})(a);t=new yd(s,i,r,l||null)}else if("documentChange"in e){e.documentChange;const s=e.documentChange;s.document,s.document.name,s.document.updateTime;const i=oo(n,s.document.name),r=st(s.document.updateTime),a=s.document.createTime?st(s.document.createTime):U.min(),l=new We({mapValue:{fields:s.document.fields}}),u=De.newFoundDocument(i,r,a,l),h=s.targetIds||[],f=s.removedTargetIds||[];t=new Ni(h,f,u.key,u)}else if("documentDelete"in e){e.documentDelete;const s=e.documentDelete;s.document;const i=oo(n,s.document),r=s.readTime?st(s.readTime):U.min(),a=De.newNoDocument(i,r),l=s.removedTargetIds||[];t=new Ni([],l,a.key,a)}else if("documentRemove"in e){e.documentRemove;const s=e.documentRemove;s.document;const i=oo(n,s.document),r=s.removedTargetIds||[];t=new Ni([],r,i,null)}else{if(!("filter"in e))return F(11601,{Rt:e});{e.filter;const s=e.filter;s.targetId;const{count:i=0,unchangedNames:r}=s,a=new Hg(i,r),l=s.targetId;t=new gd(l,a)}}return t}function ry(n,e){let t;if(e instanceof Gs)t={update:su(n,e.key,e.value)};else if(e instanceof fa)t={delete:xo(n,e.key)};else if(e instanceof an)t={update:su(n,e.key,e.data),updateMask:py(e.fieldMask)};else{if(!(e instanceof $g))return F(16599,{Vt:e.type});t={verify:xo(n,e.key)}}return e.fieldTransforms.length>0&&(t.updateTransforms=e.fieldTransforms.map((s=>(function(r,a){const l=a.transform;if(l instanceof qi)return{fieldPath:a.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(l instanceof xs)return{fieldPath:a.field.canonicalString(),appendMissingElements:{values:l.elements}};if(l instanceof Os)return{fieldPath:a.field.canonicalString(),removeAllFromArray:{values:l.elements}};if(l instanceof ji)return{fieldPath:a.field.canonicalString(),increment:l.Ae};throw F(20930,{transform:a.transform})})(0,s)))),e.precondition.isNone||(t.currentDocument=(function(i,r){return r.updateTime!==void 0?{updateTime:ny(i,r.updateTime)}:r.exists!==void 0?{exists:r.exists}:F(27497)})(n,e.precondition)),t}function oy(n,e){return n&&n.length>0?(Z(e!==void 0,14353),n.map((t=>(function(i,r){let a=i.updateTime?st(i.updateTime):st(r);return a.isEqual(U.min())&&(a=st(r)),new qg(a,i.transformResults||[])})(t,e)))):[]}function ay(n,e){return{documents:[Td(n,e.path)]}}function ly(n,e){const t={structuredQuery:{}},s=e.path;let i;e.collectionGroup!==null?(i=s,t.structuredQuery.from=[{collectionId:e.collectionGroup,allDescendants:!0}]):(i=s.popLast(),t.structuredQuery.from=[{collectionId:s.lastSegment()}]),t.parent=Td(n,i);const r=(function(h){if(h.length!==0)return Cd(Xe.create(h,"and"))})(e.filters);r&&(t.structuredQuery.where=r);const a=(function(h){if(h.length!==0)return h.map((f=>(function(m){return{field:mn(m.field),direction:hy(m.dir)}})(f)))})(e.orderBy);a&&(t.structuredQuery.orderBy=a);const l=ko(n,e.limit);return l!==null&&(t.structuredQuery.limit=l),e.startAt&&(t.structuredQuery.startAt=(function(h){return{before:h.inclusive,values:h.position}})(e.startAt)),e.endAt&&(t.structuredQuery.endAt=(function(h){return{before:!h.inclusive,values:h.position}})(e.endAt)),{ft:t,parent:i}}function cy(n){let e=sy(n.parent);const t=n.structuredQuery,s=t.from?t.from.length:0;let i=null;if(s>0){Z(s===1,65062);const f=t.from[0];f.allDescendants?i=f.collectionId:e=e.child(f.collectionId)}let r=[];t.where&&(r=(function(p){const m=wd(p);return m instanceof Xe&&Jh(m)?m.getFilters():[m]})(t.where));let a=[];t.orderBy&&(a=(function(p){return p.map((m=>(function(b){return new Vs(gn(b.field),(function(N){switch(N){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}})(b.direction))})(m)))})(t.orderBy));let l=null;t.limit&&(l=(function(p){let m;return m=typeof p=="object"?p.value:p,ur(m)?null:m})(t.limit));let u=null;t.startAt&&(u=(function(p){const m=!!p.before,A=p.values||[];return new Ui(A,m)})(t.startAt));let h=null;return t.endAt&&(h=(function(p){const m=!p.before,A=p.values||[];return new Ui(A,m)})(t.endAt)),Pg(e,i,a,r,l,"F",u,h)}function uy(n,e){const t=(function(i){switch(i){case"TargetPurposeListen":return null;case"TargetPurposeExistenceFilterMismatch":return"existence-filter-mismatch";case"TargetPurposeExistenceFilterMismatchBloom":return"existence-filter-mismatch-bloom";case"TargetPurposeLimboResolution":return"limbo-document";default:return F(28987,{purpose:i})}})(e.purpose);return t==null?null:{"goog-listen-tags":t}}function wd(n){return n.unaryFilter!==void 0?(function(t){switch(t.unaryFilter.op){case"IS_NAN":const s=gn(t.unaryFilter.field);return he.create(s,"==",{doubleValue:NaN});case"IS_NULL":const i=gn(t.unaryFilter.field);return he.create(i,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":const r=gn(t.unaryFilter.field);return he.create(r,"!=",{doubleValue:NaN});case"IS_NOT_NULL":const a=gn(t.unaryFilter.field);return he.create(a,"!=",{nullValue:"NULL_VALUE"});case"OPERATOR_UNSPECIFIED":return F(61313);default:return F(60726)}})(n):n.fieldFilter!==void 0?(function(t){return he.create(gn(t.fieldFilter.field),(function(i){switch(i){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";case"OPERATOR_UNSPECIFIED":return F(58110);default:return F(50506)}})(t.fieldFilter.op),t.fieldFilter.value)})(n):n.compositeFilter!==void 0?(function(t){return Xe.create(t.compositeFilter.filters.map((s=>wd(s))),(function(i){switch(i){case"AND":return"and";case"OR":return"or";default:return F(1026)}})(t.compositeFilter.op))})(n):F(30097,{filter:n})}function hy(n){return Jg[n]}function dy(n){return Zg[n]}function fy(n){return ey[n]}function mn(n){return{fieldPath:n.canonicalString()}}function gn(n){return Re.fromServerFormat(n.fieldPath)}function Cd(n){return n instanceof he?(function(t){if(t.op==="=="){if($c(t.value))return{unaryFilter:{field:mn(t.field),op:"IS_NAN"}};if(Wc(t.value))return{unaryFilter:{field:mn(t.field),op:"IS_NULL"}}}else if(t.op==="!="){if($c(t.value))return{unaryFilter:{field:mn(t.field),op:"IS_NOT_NAN"}};if(Wc(t.value))return{unaryFilter:{field:mn(t.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:mn(t.field),op:dy(t.op),value:t.value}}})(n):n instanceof Xe?(function(t){const s=t.getFilters().map((i=>Cd(i)));return s.length===1?s[0]:{compositeFilter:{op:fy(t.op),filters:s}}})(n):F(54877,{filter:n})}function py(n){const e=[];return n.fields.forEach((t=>e.push(t.canonicalString()))),{fieldPaths:e}}function Ad(n){return n.length>=4&&n.get(0)==="projects"&&n.get(2)==="databases"}class It{constructor(e,t,s,i,r=U.min(),a=U.min(),l=Se.EMPTY_BYTE_STRING,u=null){this.target=e,this.targetId=t,this.purpose=s,this.sequenceNumber=i,this.snapshotVersion=r,this.lastLimboFreeSnapshotVersion=a,this.resumeToken=l,this.expectedCount=u}withSequenceNumber(e){return new It(this.target,this.targetId,this.purpose,e,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,this.expectedCount)}withResumeToken(e,t){return new It(this.target,this.targetId,this.purpose,this.sequenceNumber,t,this.lastLimboFreeSnapshotVersion,e,null)}withExpectedCount(e){return new It(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,e)}withLastLimboFreeSnapshotVersion(e){return new It(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,e,this.resumeToken,this.expectedCount)}}class _y{constructor(e){this.yt=e}}function my(n){const e=cy({parent:n.parent,structuredQuery:n.structuredQuery});return n.limitType==="LAST"?Bi(e,e.limit,"L"):e}class gy{constructor(){this.Cn=new yy}addToCollectionParentIndex(e,t){return this.Cn.add(t),P.resolve()}getCollectionParents(e,t){return P.resolve(this.Cn.getEntries(t))}addFieldIndex(e,t){return P.resolve()}deleteFieldIndex(e,t){return P.resolve()}deleteAllFieldIndexes(e){return P.resolve()}createTargetIndexes(e,t){return P.resolve()}getDocumentsMatchingTarget(e,t){return P.resolve(null)}getIndexType(e,t){return P.resolve(0)}getFieldIndexes(e,t){return P.resolve([])}getNextCollectionGroupToUpdate(e){return P.resolve(null)}getMinOffset(e,t){return P.resolve(kt.min())}getMinOffsetFromCollectionGroup(e,t){return P.resolve(kt.min())}updateCollectionGroup(e,t,s){return P.resolve()}updateIndexEntries(e,t){return P.resolve()}}class yy{constructor(){this.index={}}add(e){const t=e.lastSegment(),s=e.popLast(),i=this.index[t]||new ye(se.comparator),r=!i.has(s);return this.index[t]=i.add(s),r}has(e){const t=e.lastSegment(),s=e.popLast(),i=this.index[t];return i&&i.has(s)}getEntries(e){return(this.index[e]||new ye(se.comparator)).toArray()}}const iu={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0},Rd=41943040;class Fe{static withCacheSize(e){return new Fe(e,Fe.DEFAULT_COLLECTION_PERCENTILE,Fe.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}constructor(e,t,s){this.cacheSizeCollectionThreshold=e,this.percentileToCollect=t,this.maximumSequenceNumbersToCollect=s}}Fe.DEFAULT_COLLECTION_PERCENTILE=10,Fe.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,Fe.DEFAULT=new Fe(Rd,Fe.DEFAULT_COLLECTION_PERCENTILE,Fe.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),Fe.DISABLED=new Fe(-1,0,0);class kn{constructor(e){this.ar=e}next(){return this.ar+=2,this.ar}static ur(){return new kn(0)}static cr(){return new kn(-1)}}const ru="LruGarbageCollector",Ey=1048576;function ou([n,e],[t,s]){const i=H(n,t);return i===0?H(e,s):i}class vy{constructor(e){this.Ir=e,this.buffer=new ye(ou),this.Er=0}dr(){return++this.Er}Ar(e){const t=[e,this.dr()];if(this.buffer.size<this.Ir)this.buffer=this.buffer.add(t);else{const s=this.buffer.last();ou(t,s)<0&&(this.buffer=this.buffer.delete(s).add(t))}}get maxValue(){return this.buffer.last()[0]}}class Ty{constructor(e,t,s){this.garbageCollector=e,this.asyncQueue=t,this.localStore=s,this.Rr=null}start(){this.garbageCollector.params.cacheSizeCollectionThreshold!==-1&&this.Vr(6e4)}stop(){this.Rr&&(this.Rr.cancel(),this.Rr=null)}get started(){return this.Rr!==null}Vr(e){O(ru,`Garbage collection scheduled in ${e}ms`),this.Rr=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",e,(async()=>{this.Rr=null;try{await this.localStore.collectGarbage(this.garbageCollector)}catch(t){qn(t)?O(ru,"Ignoring IndexedDB error during garbage collection: ",t):await Bn(t)}await this.Vr(3e5)}))}}class Iy{constructor(e,t){this.mr=e,this.params=t}calculateTargetCount(e,t){return this.mr.gr(e).next((s=>Math.floor(t/100*s)))}nthSequenceNumber(e,t){if(t===0)return P.resolve(cr.ce);const s=new vy(t);return this.mr.forEachTarget(e,(i=>s.Ar(i.sequenceNumber))).next((()=>this.mr.pr(e,(i=>s.Ar(i))))).next((()=>s.maxValue))}removeTargets(e,t,s){return this.mr.removeTargets(e,t,s)}removeOrphanedDocuments(e,t){return this.mr.removeOrphanedDocuments(e,t)}collect(e,t){return this.params.cacheSizeCollectionThreshold===-1?(O("LruGarbageCollector","Garbage collection skipped; disabled"),P.resolve(iu)):this.getCacheSize(e).next((s=>s<this.params.cacheSizeCollectionThreshold?(O("LruGarbageCollector",`Garbage collection skipped; Cache size ${s} is lower than threshold ${this.params.cacheSizeCollectionThreshold}`),iu):this.yr(e,t)))}getCacheSize(e){return this.mr.getCacheSize(e)}yr(e,t){let s,i,r,a,l,u,h;const f=Date.now();return this.calculateTargetCount(e,this.params.percentileToCollect).next((p=>(p>this.params.maximumSequenceNumbersToCollect?(O("LruGarbageCollector",`Capping sequence numbers to collect down to the maximum of ${this.params.maximumSequenceNumbersToCollect} from ${p}`),i=this.params.maximumSequenceNumbersToCollect):i=p,a=Date.now(),this.nthSequenceNumber(e,i)))).next((p=>(s=p,l=Date.now(),this.removeTargets(e,s,t)))).next((p=>(r=p,u=Date.now(),this.removeOrphanedDocuments(e,s)))).next((p=>(h=Date.now(),pn()<=Q.DEBUG&&O("LruGarbageCollector",`LRU Garbage Collection
	Counted targets in ${a-f}ms
	Determined least recently used ${i} in `+(l-a)+`ms
	Removed ${r} targets in `+(u-l)+`ms
	Removed ${p} documents in `+(h-u)+`ms
Total Duration: ${h-f}ms`),P.resolve({didRun:!0,sequenceNumbersCollected:i,targetsRemoved:r,documentsRemoved:p}))))}}function wy(n,e){return new Iy(n,e)}class Cy{constructor(){this.changes=new on((e=>e.toString()),((e,t)=>e.isEqual(t))),this.changesApplied=!1}addEntry(e){this.assertNotApplied(),this.changes.set(e.key,e)}removeEntry(e,t){this.assertNotApplied(),this.changes.set(e,De.newInvalidDocument(e).setReadTime(t))}getEntry(e,t){this.assertNotApplied();const s=this.changes.get(t);return s!==void 0?P.resolve(s):this.getFromCache(e,t)}getEntries(e,t){return this.getAllFromCache(e,t)}apply(e){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(e)}assertNotApplied(){}}class Ay{constructor(e,t){this.overlayedDocument=e,this.mutatedFields=t}}class Ry{constructor(e,t,s,i){this.remoteDocumentCache=e,this.mutationQueue=t,this.documentOverlayCache=s,this.indexManager=i}getDocument(e,t){let s=null;return this.documentOverlayCache.getOverlay(e,t).next((i=>(s=i,this.remoteDocumentCache.getEntry(e,t)))).next((i=>(s!==null&&Es(s.mutation,i,Ge.empty(),oe.now()),i)))}getDocuments(e,t){return this.remoteDocumentCache.getEntries(e,t).next((s=>this.getLocalViewOfDocuments(e,s,K()).next((()=>s))))}getLocalViewOfDocuments(e,t,s=K()){const i=Xt();return this.populateOverlays(e,i,t).next((()=>this.computeViews(e,t,i,s).next((r=>{let a=fs();return r.forEach(((l,u)=>{a=a.insert(l,u.overlayedDocument)})),a}))))}getOverlayedDocuments(e,t){const s=Xt();return this.populateOverlays(e,s,t).next((()=>this.computeViews(e,t,s,K())))}populateOverlays(e,t,s){const i=[];return s.forEach((r=>{t.has(r)||i.push(r)})),this.documentOverlayCache.getOverlays(e,i).next((r=>{r.forEach(((a,l)=>{t.set(a,l)}))}))}computeViews(e,t,s,i){let r=dt();const a=ys(),l=(function(){return ys()})();return t.forEach(((u,h)=>{const f=s.get(h.key);i.has(h.key)&&(f===void 0||f.mutation instanceof an)?r=r.insert(h.key,h):f!==void 0?(a.set(h.key,f.mutation.getFieldMask()),Es(f.mutation,h,f.mutation.getFieldMask(),oe.now())):a.set(h.key,Ge.empty())})),this.recalculateAndSaveOverlays(e,r).next((u=>(u.forEach(((h,f)=>a.set(h,f))),t.forEach(((h,f)=>l.set(h,new Ay(f,a.get(h)??null)))),l)))}recalculateAndSaveOverlays(e,t){const s=ys();let i=new fe(((a,l)=>a-l)),r=K();return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(e,t).next((a=>{for(const l of a)l.keys().forEach((u=>{const h=t.get(u);if(h===null)return;let f=s.get(u)||Ge.empty();f=l.applyToLocalView(h,f),s.set(u,f);const p=(i.get(l.batchId)||K()).add(u);i=i.insert(l.batchId,p)}))})).next((()=>{const a=[],l=i.getReverseIterator();for(;l.hasNext();){const u=l.getNext(),h=u.key,f=u.value,p=ld();f.forEach((m=>{if(!r.has(m)){const A=pd(t.get(m),s.get(m));A!==null&&p.set(m,A),r=r.add(m)}})),a.push(this.documentOverlayCache.saveOverlays(e,h,p))}return P.waitFor(a)})).next((()=>s))}recalculateAndSaveOverlaysForDocumentKeys(e,t){return this.remoteDocumentCache.getEntries(e,t).next((s=>this.recalculateAndSaveOverlays(e,s)))}getDocumentsMatchingQuery(e,t,s,i){return(function(a){return M.isDocumentKey(a.path)&&a.collectionGroup===null&&a.filters.length===0})(t)?this.getDocumentsMatchingDocumentQuery(e,t.path):sd(t)?this.getDocumentsMatchingCollectionGroupQuery(e,t,s,i):this.getDocumentsMatchingCollectionQuery(e,t,s,i)}getNextDocuments(e,t,s,i){return this.remoteDocumentCache.getAllFromCollectionGroup(e,t,s,i).next((r=>{const a=i-r.size>0?this.documentOverlayCache.getOverlaysForCollectionGroup(e,t,s.largestBatchId,i-r.size):P.resolve(Xt());let l=bs,u=r;return a.next((h=>P.forEach(h,((f,p)=>(l<p.largestBatchId&&(l=p.largestBatchId),r.get(f)?P.resolve():this.remoteDocumentCache.getEntry(e,f).next((m=>{u=u.insert(f,m)}))))).next((()=>this.populateOverlays(e,h,r))).next((()=>this.computeViews(e,u,h,K()))).next((f=>({batchId:l,changes:ad(f)})))))}))}getDocumentsMatchingDocumentQuery(e,t){return this.getDocument(e,new M(t)).next((s=>{let i=fs();return s.isFoundDocument()&&(i=i.insert(s.key,s)),i}))}getDocumentsMatchingCollectionGroupQuery(e,t,s,i){const r=t.collectionGroup;let a=fs();return this.indexManager.getCollectionParents(e,r).next((l=>P.forEach(l,(u=>{const h=(function(p,m){return new jn(m,null,p.explicitOrderBy.slice(),p.filters.slice(),p.limit,p.limitType,p.startAt,p.endAt)})(t,u.child(r));return this.getDocumentsMatchingCollectionQuery(e,h,s,i).next((f=>{f.forEach(((p,m)=>{a=a.insert(p,m)}))}))})).next((()=>a))))}getDocumentsMatchingCollectionQuery(e,t,s,i){let r;return this.documentOverlayCache.getOverlaysForCollection(e,t.path,s.largestBatchId).next((a=>(r=a,this.remoteDocumentCache.getDocumentsMatchingQuery(e,t,s,r,i)))).next((a=>{r.forEach(((u,h)=>{const f=h.getKey();a.get(f)===null&&(a=a.insert(f,De.newInvalidDocument(f)))}));let l=fs();return a.forEach(((u,h)=>{const f=r.get(u);f!==void 0&&Es(f.mutation,h,Ge.empty(),oe.now()),fr(t,h)&&(l=l.insert(u,h))})),l}))}}class Sy{constructor(e){this.serializer=e,this.Lr=new Map,this.kr=new Map}getBundleMetadata(e,t){return P.resolve(this.Lr.get(t))}saveBundleMetadata(e,t){return this.Lr.set(t.id,(function(i){return{id:i.id,version:i.version,createTime:st(i.createTime)}})(t)),P.resolve()}getNamedQuery(e,t){return P.resolve(this.kr.get(t))}saveNamedQuery(e,t){return this.kr.set(t.name,(function(i){return{name:i.name,query:my(i.bundledQuery),readTime:st(i.readTime)}})(t)),P.resolve()}}class Py{constructor(){this.overlays=new fe(M.comparator),this.qr=new Map}getOverlay(e,t){return P.resolve(this.overlays.get(t))}getOverlays(e,t){const s=Xt();return P.forEach(t,(i=>this.getOverlay(e,i).next((r=>{r!==null&&s.set(i,r)})))).next((()=>s))}saveOverlays(e,t,s){return s.forEach(((i,r)=>{this.St(e,t,r)})),P.resolve()}removeOverlaysForBatchId(e,t,s){const i=this.qr.get(s);return i!==void 0&&(i.forEach((r=>this.overlays=this.overlays.remove(r))),this.qr.delete(s)),P.resolve()}getOverlaysForCollection(e,t,s){const i=Xt(),r=t.length+1,a=new M(t.child("")),l=this.overlays.getIteratorFrom(a);for(;l.hasNext();){const u=l.getNext().value,h=u.getKey();if(!t.isPrefixOf(h.path))break;h.path.length===r&&u.largestBatchId>s&&i.set(u.getKey(),u)}return P.resolve(i)}getOverlaysForCollectionGroup(e,t,s,i){let r=new fe(((h,f)=>h-f));const a=this.overlays.getIterator();for(;a.hasNext();){const h=a.getNext().value;if(h.getKey().getCollectionGroup()===t&&h.largestBatchId>s){let f=r.get(h.largestBatchId);f===null&&(f=Xt(),r=r.insert(h.largestBatchId,f)),f.set(h.getKey(),h)}}const l=Xt(),u=r.getIterator();for(;u.hasNext()&&(u.getNext().value.forEach(((h,f)=>l.set(h,f))),!(l.size()>=i)););return P.resolve(l)}St(e,t,s){const i=this.overlays.get(s.key);if(i!==null){const a=this.qr.get(i.largestBatchId).delete(s.key);this.qr.set(i.largestBatchId,a)}this.overlays=this.overlays.insert(s.key,new Gg(t,s));let r=this.qr.get(t);r===void 0&&(r=K(),this.qr.set(t,r)),this.qr.set(t,r.add(s.key))}}class by{constructor(){this.sessionToken=Se.EMPTY_BYTE_STRING}getSessionToken(e){return P.resolve(this.sessionToken)}setSessionToken(e,t){return this.sessionToken=t,P.resolve()}}class ga{constructor(){this.Qr=new ye(Ie.$r),this.Ur=new ye(Ie.Kr)}isEmpty(){return this.Qr.isEmpty()}addReference(e,t){const s=new Ie(e,t);this.Qr=this.Qr.add(s),this.Ur=this.Ur.add(s)}Wr(e,t){e.forEach((s=>this.addReference(s,t)))}removeReference(e,t){this.Gr(new Ie(e,t))}zr(e,t){e.forEach((s=>this.removeReference(s,t)))}jr(e){const t=new M(new se([])),s=new Ie(t,e),i=new Ie(t,e+1),r=[];return this.Ur.forEachInRange([s,i],(a=>{this.Gr(a),r.push(a.key)})),r}Jr(){this.Qr.forEach((e=>this.Gr(e)))}Gr(e){this.Qr=this.Qr.delete(e),this.Ur=this.Ur.delete(e)}Hr(e){const t=new M(new se([])),s=new Ie(t,e),i=new Ie(t,e+1);let r=K();return this.Ur.forEachInRange([s,i],(a=>{r=r.add(a.key)})),r}containsKey(e){const t=new Ie(e,0),s=this.Qr.firstAfterOrEqual(t);return s!==null&&e.isEqual(s.key)}}class Ie{constructor(e,t){this.key=e,this.Yr=t}static $r(e,t){return M.comparator(e.key,t.key)||H(e.Yr,t.Yr)}static Kr(e,t){return H(e.Yr,t.Yr)||M.comparator(e.key,t.key)}}class Ny{constructor(e,t){this.indexManager=e,this.referenceDelegate=t,this.mutationQueue=[],this.tr=1,this.Zr=new ye(Ie.$r)}checkEmpty(e){return P.resolve(this.mutationQueue.length===0)}addMutationBatch(e,t,s,i){const r=this.tr;this.tr++,this.mutationQueue.length>0&&this.mutationQueue[this.mutationQueue.length-1];const a=new zg(r,t,s,i);this.mutationQueue.push(a);for(const l of i)this.Zr=this.Zr.add(new Ie(l.key,r)),this.indexManager.addToCollectionParentIndex(e,l.key.path.popLast());return P.resolve(a)}lookupMutationBatch(e,t){return P.resolve(this.Xr(t))}getNextMutationBatchAfterBatchId(e,t){const s=t+1,i=this.ei(s),r=i<0?0:i;return P.resolve(this.mutationQueue.length>r?this.mutationQueue[r]:null)}getHighestUnacknowledgedBatchId(){return P.resolve(this.mutationQueue.length===0?aa:this.tr-1)}getAllMutationBatches(e){return P.resolve(this.mutationQueue.slice())}getAllMutationBatchesAffectingDocumentKey(e,t){const s=new Ie(t,0),i=new Ie(t,Number.POSITIVE_INFINITY),r=[];return this.Zr.forEachInRange([s,i],(a=>{const l=this.Xr(a.Yr);r.push(l)})),P.resolve(r)}getAllMutationBatchesAffectingDocumentKeys(e,t){let s=new ye(H);return t.forEach((i=>{const r=new Ie(i,0),a=new Ie(i,Number.POSITIVE_INFINITY);this.Zr.forEachInRange([r,a],(l=>{s=s.add(l.Yr)}))})),P.resolve(this.ti(s))}getAllMutationBatchesAffectingQuery(e,t){const s=t.path,i=s.length+1;let r=s;M.isDocumentKey(r)||(r=r.child(""));const a=new Ie(new M(r),0);let l=new ye(H);return this.Zr.forEachWhile((u=>{const h=u.key.path;return!!s.isPrefixOf(h)&&(h.length===i&&(l=l.add(u.Yr)),!0)}),a),P.resolve(this.ti(l))}ti(e){const t=[];return e.forEach((s=>{const i=this.Xr(s);i!==null&&t.push(i)})),t}removeMutationBatch(e,t){Z(this.ni(t.batchId,"removed")===0,55003),this.mutationQueue.shift();let s=this.Zr;return P.forEach(t.mutations,(i=>{const r=new Ie(i.key,t.batchId);return s=s.delete(r),this.referenceDelegate.markPotentiallyOrphaned(e,i.key)})).next((()=>{this.Zr=s}))}ir(e){}containsKey(e,t){const s=new Ie(t,0),i=this.Zr.firstAfterOrEqual(s);return P.resolve(t.isEqual(i&&i.key))}performConsistencyCheck(e){return this.mutationQueue.length,P.resolve()}ni(e,t){return this.ei(e)}ei(e){return this.mutationQueue.length===0?0:e-this.mutationQueue[0].batchId}Xr(e){const t=this.ei(e);return t<0||t>=this.mutationQueue.length?null:this.mutationQueue[t]}}class Dy{constructor(e){this.ri=e,this.docs=(function(){return new fe(M.comparator)})(),this.size=0}setIndexManager(e){this.indexManager=e}addEntry(e,t){const s=t.key,i=this.docs.get(s),r=i?i.size:0,a=this.ri(t);return this.docs=this.docs.insert(s,{document:t.mutableCopy(),size:a}),this.size+=a-r,this.indexManager.addToCollectionParentIndex(e,s.path.popLast())}removeEntry(e){const t=this.docs.get(e);t&&(this.docs=this.docs.remove(e),this.size-=t.size)}getEntry(e,t){const s=this.docs.get(t);return P.resolve(s?s.document.mutableCopy():De.newInvalidDocument(t))}getEntries(e,t){let s=dt();return t.forEach((i=>{const r=this.docs.get(i);s=s.insert(i,r?r.document.mutableCopy():De.newInvalidDocument(i))})),P.resolve(s)}getDocumentsMatchingQuery(e,t,s,i){let r=dt();const a=t.path,l=new M(a.child("__id-9223372036854775808__")),u=this.docs.getIteratorFrom(l);for(;u.hasNext();){const{key:h,value:{document:f}}=u.getNext();if(!a.isPrefixOf(h.path))break;h.path.length>a.length+1||og(rg(f),s)<=0||(i.has(f.key)||fr(t,f))&&(r=r.insert(f.key,f.mutableCopy()))}return P.resolve(r)}getAllFromCollectionGroup(e,t,s,i){F(9500)}ii(e,t){return P.forEach(this.docs,(s=>t(s)))}newChangeBuffer(e){return new ky(this)}getSize(e){return P.resolve(this.size)}}class ky extends Cy{constructor(e){super(),this.Nr=e}applyChanges(e){const t=[];return this.changes.forEach(((s,i)=>{i.isValidDocument()?t.push(this.Nr.addEntry(e,i)):this.Nr.removeEntry(s)})),P.waitFor(t)}getFromCache(e,t){return this.Nr.getEntry(e,t)}getAllFromCache(e,t){return this.Nr.getEntries(e,t)}}class Vy{constructor(e){this.persistence=e,this.si=new on((t=>ua(t)),ha),this.lastRemoteSnapshotVersion=U.min(),this.highestTargetId=0,this.oi=0,this._i=new ga,this.targetCount=0,this.ai=kn.ur()}forEachTarget(e,t){return this.si.forEach(((s,i)=>t(i))),P.resolve()}getLastRemoteSnapshotVersion(e){return P.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(e){return P.resolve(this.oi)}allocateTargetId(e){return this.highestTargetId=this.ai.next(),P.resolve(this.highestTargetId)}setTargetsMetadata(e,t,s){return s&&(this.lastRemoteSnapshotVersion=s),t>this.oi&&(this.oi=t),P.resolve()}Pr(e){this.si.set(e.target,e);const t=e.targetId;t>this.highestTargetId&&(this.ai=new kn(t),this.highestTargetId=t),e.sequenceNumber>this.oi&&(this.oi=e.sequenceNumber)}addTargetData(e,t){return this.Pr(t),this.targetCount+=1,P.resolve()}updateTargetData(e,t){return this.Pr(t),P.resolve()}removeTargetData(e,t){return this.si.delete(t.target),this._i.jr(t.targetId),this.targetCount-=1,P.resolve()}removeTargets(e,t,s){let i=0;const r=[];return this.si.forEach(((a,l)=>{l.sequenceNumber<=t&&s.get(l.targetId)===null&&(this.si.delete(a),r.push(this.removeMatchingKeysForTargetId(e,l.targetId)),i++)})),P.waitFor(r).next((()=>i))}getTargetCount(e){return P.resolve(this.targetCount)}getTargetData(e,t){const s=this.si.get(t)||null;return P.resolve(s)}addMatchingKeys(e,t,s){return this._i.Wr(t,s),P.resolve()}removeMatchingKeys(e,t,s){this._i.zr(t,s);const i=this.persistence.referenceDelegate,r=[];return i&&t.forEach((a=>{r.push(i.markPotentiallyOrphaned(e,a))})),P.waitFor(r)}removeMatchingKeysForTargetId(e,t){return this._i.jr(t),P.resolve()}getMatchingKeysForTargetId(e,t){const s=this._i.Hr(t);return P.resolve(s)}containsKey(e,t){return P.resolve(this._i.containsKey(t))}}class Sd{constructor(e,t){this.ui={},this.overlays={},this.ci=new cr(0),this.li=!1,this.li=!0,this.hi=new by,this.referenceDelegate=e(this),this.Pi=new Vy(this),this.indexManager=new gy,this.remoteDocumentCache=(function(i){return new Dy(i)})((s=>this.referenceDelegate.Ti(s))),this.serializer=new _y(t),this.Ii=new Sy(this.serializer)}start(){return Promise.resolve()}shutdown(){return this.li=!1,Promise.resolve()}get started(){return this.li}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(e){return this.indexManager}getDocumentOverlayCache(e){let t=this.overlays[e.toKey()];return t||(t=new Py,this.overlays[e.toKey()]=t),t}getMutationQueue(e,t){let s=this.ui[e.toKey()];return s||(s=new Ny(t,this.referenceDelegate),this.ui[e.toKey()]=s),s}getGlobalsCache(){return this.hi}getTargetCache(){return this.Pi}getRemoteDocumentCache(){return this.remoteDocumentCache}getBundleCache(){return this.Ii}runTransaction(e,t,s){O("MemoryPersistence","Starting transaction:",e);const i=new xy(this.ci.next());return this.referenceDelegate.Ei(),s(i).next((r=>this.referenceDelegate.di(i).next((()=>r)))).toPromise().then((r=>(i.raiseOnCommittedEvent(),r)))}Ai(e,t){return P.or(Object.values(this.ui).map((s=>()=>s.containsKey(e,t))))}}class xy extends lg{constructor(e){super(),this.currentSequenceNumber=e}}class ya{constructor(e){this.persistence=e,this.Ri=new ga,this.Vi=null}static mi(e){return new ya(e)}get fi(){if(this.Vi)return this.Vi;throw F(60996)}addReference(e,t,s){return this.Ri.addReference(s,t),this.fi.delete(s.toString()),P.resolve()}removeReference(e,t,s){return this.Ri.removeReference(s,t),this.fi.add(s.toString()),P.resolve()}markPotentiallyOrphaned(e,t){return this.fi.add(t.toString()),P.resolve()}removeTarget(e,t){this.Ri.jr(t.targetId).forEach((i=>this.fi.add(i.toString())));const s=this.persistence.getTargetCache();return s.getMatchingKeysForTargetId(e,t.targetId).next((i=>{i.forEach((r=>this.fi.add(r.toString())))})).next((()=>s.removeTargetData(e,t)))}Ei(){this.Vi=new Set}di(e){const t=this.persistence.getRemoteDocumentCache().newChangeBuffer();return P.forEach(this.fi,(s=>{const i=M.fromPath(s);return this.gi(e,i).next((r=>{r||t.removeEntry(i,U.min())}))})).next((()=>(this.Vi=null,t.apply(e))))}updateLimboDocument(e,t){return this.gi(e,t).next((s=>{s?this.fi.delete(t.toString()):this.fi.add(t.toString())}))}Ti(e){return 0}gi(e,t){return P.or([()=>P.resolve(this.Ri.containsKey(t)),()=>this.persistence.getTargetCache().containsKey(e,t),()=>this.persistence.Ai(e,t)])}}class $i{constructor(e,t){this.persistence=e,this.pi=new on((s=>hg(s.path)),((s,i)=>s.isEqual(i))),this.garbageCollector=wy(this,t)}static mi(e,t){return new $i(e,t)}Ei(){}di(e){return P.resolve()}forEachTarget(e,t){return this.persistence.getTargetCache().forEachTarget(e,t)}gr(e){const t=this.wr(e);return this.persistence.getTargetCache().getTargetCount(e).next((s=>t.next((i=>s+i))))}wr(e){let t=0;return this.pr(e,(s=>{t++})).next((()=>t))}pr(e,t){return P.forEach(this.pi,((s,i)=>this.br(e,s,i).next((r=>r?P.resolve():t(i)))))}removeTargets(e,t,s){return this.persistence.getTargetCache().removeTargets(e,t,s)}removeOrphanedDocuments(e,t){let s=0;const i=this.persistence.getRemoteDocumentCache(),r=i.newChangeBuffer();return i.ii(e,(a=>this.br(e,a,t).next((l=>{l||(s++,r.removeEntry(a,U.min()))})))).next((()=>r.apply(e))).next((()=>s))}markPotentiallyOrphaned(e,t){return this.pi.set(t,e.currentSequenceNumber),P.resolve()}removeTarget(e,t){const s=t.withSequenceNumber(e.currentSequenceNumber);return this.persistence.getTargetCache().updateTargetData(e,s)}addReference(e,t,s){return this.pi.set(s,e.currentSequenceNumber),P.resolve()}removeReference(e,t,s){return this.pi.set(s,e.currentSequenceNumber),P.resolve()}updateLimboDocument(e,t){return this.pi.set(t,e.currentSequenceNumber),P.resolve()}Ti(e){let t=e.key.toString().length;return e.isFoundDocument()&&(t+=Si(e.data.value)),t}br(e,t,s){return P.or([()=>this.persistence.Ai(e,t),()=>this.persistence.getTargetCache().containsKey(e,t),()=>{const i=this.pi.get(t);return P.resolve(i!==void 0&&i>s)}])}getCacheSize(e){return this.persistence.getRemoteDocumentCache().getSize(e)}}class Ea{constructor(e,t,s,i){this.targetId=e,this.fromCache=t,this.Es=s,this.ds=i}static As(e,t){let s=K(),i=K();for(const r of t.docChanges)switch(r.type){case 0:s=s.add(r.doc.key);break;case 1:i=i.add(r.doc.key)}return new Ea(e,t.fromCache,s,i)}}class Oy{constructor(){this._documentReadCount=0}get documentReadCount(){return this._documentReadCount}incrementDocumentReadCount(e){this._documentReadCount+=e}}class My{constructor(){this.Rs=!1,this.Vs=!1,this.fs=100,this.gs=(function(){return R_()?8:cg(mh())>0?6:4})()}initialize(e,t){this.ps=e,this.indexManager=t,this.Rs=!0}getDocumentsMatchingQuery(e,t,s,i){const r={result:null};return this.ys(e,t).next((a=>{r.result=a})).next((()=>{if(!r.result)return this.ws(e,t,i,s).next((a=>{r.result=a}))})).next((()=>{if(r.result)return;const a=new Oy;return this.Ss(e,t,a).next((l=>{if(r.result=l,this.Vs)return this.bs(e,t,a,l.size)}))})).next((()=>r.result))}bs(e,t,s,i){return s.documentReadCount<this.fs?(pn()<=Q.DEBUG&&O("QueryEngine","SDK will not create cache indexes for query:",_n(t),"since it only creates cache indexes for collection contains","more than or equal to",this.fs,"documents"),P.resolve()):(pn()<=Q.DEBUG&&O("QueryEngine","Query:",_n(t),"scans",s.documentReadCount,"local documents and returns",i,"documents as results."),s.documentReadCount>this.gs*i?(pn()<=Q.DEBUG&&O("QueryEngine","The SDK decides to create cache indexes for query:",_n(t),"as using cache indexes may help improve performance."),this.indexManager.createTargetIndexes(e,tt(t))):P.resolve())}ys(e,t){if(Kc(t))return P.resolve(null);let s=tt(t);return this.indexManager.getIndexType(e,s).next((i=>i===0?null:(t.limit!==null&&i===1&&(t=Bi(t,null,"F"),s=tt(t)),this.indexManager.getDocumentsMatchingTarget(e,s).next((r=>{const a=K(...r);return this.ps.getDocuments(e,a).next((l=>this.indexManager.getMinOffset(e,s).next((u=>{const h=this.Ds(t,l);return this.Cs(t,h,a,u.readTime)?this.ys(e,Bi(t,null,"F")):this.vs(e,h,t,u)}))))})))))}ws(e,t,s,i){return Kc(t)||i.isEqual(U.min())?P.resolve(null):this.ps.getDocuments(e,s).next((r=>{const a=this.Ds(t,r);return this.Cs(t,a,s,i)?P.resolve(null):(pn()<=Q.DEBUG&&O("QueryEngine","Re-using previous result from %s to execute query: %s",i.toString(),_n(t)),this.vs(e,a,t,ig(i,bs)).next((l=>l)))}))}Ds(e,t){let s=new ye(rd(e));return t.forEach(((i,r)=>{fr(e,r)&&(s=s.add(r))})),s}Cs(e,t,s,i){if(e.limit===null)return!1;if(s.size!==t.size)return!0;const r=e.limitType==="F"?t.last():t.first();return!!r&&(r.hasPendingWrites||r.version.compareTo(i)>0)}Ss(e,t,s){return pn()<=Q.DEBUG&&O("QueryEngine","Using full collection scan to execute query:",_n(t)),this.ps.getDocumentsMatchingQuery(e,t,kt.min(),s)}vs(e,t,s,i){return this.ps.getDocumentsMatchingQuery(e,s,i).next((r=>(t.forEach((a=>{r=r.insert(a.key,a)})),r)))}}const va="LocalStore",Ly=3e8;class Fy{constructor(e,t,s,i){this.persistence=e,this.Fs=t,this.serializer=i,this.Ms=new fe(H),this.xs=new on((r=>ua(r)),ha),this.Os=new Map,this.Ns=e.getRemoteDocumentCache(),this.Pi=e.getTargetCache(),this.Ii=e.getBundleCache(),this.Bs(s)}Bs(e){this.documentOverlayCache=this.persistence.getDocumentOverlayCache(e),this.indexManager=this.persistence.getIndexManager(e),this.mutationQueue=this.persistence.getMutationQueue(e,this.indexManager),this.localDocuments=new Ry(this.Ns,this.mutationQueue,this.documentOverlayCache,this.indexManager),this.Ns.setIndexManager(this.indexManager),this.Fs.initialize(this.localDocuments,this.indexManager)}collectGarbage(e){return this.persistence.runTransaction("Collect garbage","readwrite-primary",(t=>e.collect(t,this.Ms)))}}function Uy(n,e,t,s){return new Fy(n,e,t,s)}async function Pd(n,e){const t=B(n);return await t.persistence.runTransaction("Handle user change","readonly",(s=>{let i;return t.mutationQueue.getAllMutationBatches(s).next((r=>(i=r,t.Bs(e),t.mutationQueue.getAllMutationBatches(s)))).next((r=>{const a=[],l=[];let u=K();for(const h of i){a.push(h.batchId);for(const f of h.mutations)u=u.add(f.key)}for(const h of r){l.push(h.batchId);for(const f of h.mutations)u=u.add(f.key)}return t.localDocuments.getDocuments(s,u).next((h=>({Ls:h,removedBatchIds:a,addedBatchIds:l})))}))}))}function By(n,e){const t=B(n);return t.persistence.runTransaction("Acknowledge batch","readwrite-primary",(s=>{const i=e.batch.keys(),r=t.Ns.newChangeBuffer({trackRemovals:!0});return(function(l,u,h,f){const p=h.batch,m=p.keys();let A=P.resolve();return m.forEach((b=>{A=A.next((()=>f.getEntry(u,b))).next((V=>{const N=h.docVersions.get(b);Z(N!==null,48541),V.version.compareTo(N)<0&&(p.applyToRemoteDocument(V,h),V.isValidDocument()&&(V.setReadTime(h.commitVersion),f.addEntry(V)))}))})),A.next((()=>l.mutationQueue.removeMutationBatch(u,p)))})(t,s,e,r).next((()=>r.apply(s))).next((()=>t.mutationQueue.performConsistencyCheck(s))).next((()=>t.documentOverlayCache.removeOverlaysForBatchId(s,i,e.batch.batchId))).next((()=>t.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(s,(function(l){let u=K();for(let h=0;h<l.mutationResults.length;++h)l.mutationResults[h].transformResults.length>0&&(u=u.add(l.batch.mutations[h].key));return u})(e)))).next((()=>t.localDocuments.getDocuments(s,i)))}))}function bd(n){const e=B(n);return e.persistence.runTransaction("Get last remote snapshot version","readonly",(t=>e.Pi.getLastRemoteSnapshotVersion(t)))}function qy(n,e){const t=B(n),s=e.snapshotVersion;let i=t.Ms;return t.persistence.runTransaction("Apply remote event","readwrite-primary",(r=>{const a=t.Ns.newChangeBuffer({trackRemovals:!0});i=t.Ms;const l=[];e.targetChanges.forEach(((f,p)=>{const m=i.get(p);if(!m)return;l.push(t.Pi.removeMatchingKeys(r,f.removedDocuments,p).next((()=>t.Pi.addMatchingKeys(r,f.addedDocuments,p))));let A=m.withSequenceNumber(r.currentSequenceNumber);e.targetMismatches.get(p)!==null?A=A.withResumeToken(Se.EMPTY_BYTE_STRING,U.min()).withLastLimboFreeSnapshotVersion(U.min()):f.resumeToken.approximateByteSize()>0&&(A=A.withResumeToken(f.resumeToken,s)),i=i.insert(p,A),(function(V,N,j){return V.resumeToken.approximateByteSize()===0||N.snapshotVersion.toMicroseconds()-V.snapshotVersion.toMicroseconds()>=Ly?!0:j.addedDocuments.size+j.modifiedDocuments.size+j.removedDocuments.size>0})(m,A,f)&&l.push(t.Pi.updateTargetData(r,A))}));let u=dt(),h=K();if(e.documentUpdates.forEach((f=>{e.resolvedLimboDocuments.has(f)&&l.push(t.persistence.referenceDelegate.updateLimboDocument(r,f))})),l.push(jy(r,a,e.documentUpdates).next((f=>{u=f.ks,h=f.qs}))),!s.isEqual(U.min())){const f=t.Pi.getLastRemoteSnapshotVersion(r).next((p=>t.Pi.setTargetsMetadata(r,r.currentSequenceNumber,s)));l.push(f)}return P.waitFor(l).next((()=>a.apply(r))).next((()=>t.localDocuments.getLocalViewOfDocuments(r,u,h))).next((()=>u))})).then((r=>(t.Ms=i,r)))}function jy(n,e,t){let s=K(),i=K();return t.forEach((r=>s=s.add(r))),e.getEntries(n,s).next((r=>{let a=dt();return t.forEach(((l,u)=>{const h=r.get(l);u.isFoundDocument()!==h.isFoundDocument()&&(i=i.add(l)),u.isNoDocument()&&u.version.isEqual(U.min())?(e.removeEntry(l,u.readTime),a=a.insert(l,u)):!h.isValidDocument()||u.version.compareTo(h.version)>0||u.version.compareTo(h.version)===0&&h.hasPendingWrites?(e.addEntry(u),a=a.insert(l,u)):O(va,"Ignoring outdated watch update for ",l,". Current version:",h.version," Watch version:",u.version)})),{ks:a,qs:i}}))}function Wy(n,e){const t=B(n);return t.persistence.runTransaction("Get next mutation batch","readonly",(s=>(e===void 0&&(e=aa),t.mutationQueue.getNextMutationBatchAfterBatchId(s,e))))}function $y(n,e){const t=B(n);return t.persistence.runTransaction("Allocate target","readwrite",(s=>{let i;return t.Pi.getTargetData(s,e).next((r=>r?(i=r,P.resolve(i)):t.Pi.allocateTargetId(s).next((a=>(i=new It(e,a,"TargetPurposeListen",s.currentSequenceNumber),t.Pi.addTargetData(s,i).next((()=>i)))))))})).then((s=>{const i=t.Ms.get(s.targetId);return(i===null||s.snapshotVersion.compareTo(i.snapshotVersion)>0)&&(t.Ms=t.Ms.insert(s.targetId,s),t.xs.set(e,s.targetId)),s}))}async function Mo(n,e,t){const s=B(n),i=s.Ms.get(e),r=t?"readwrite":"readwrite-primary";try{t||await s.persistence.runTransaction("Release target",r,(a=>s.persistence.referenceDelegate.removeTarget(a,i)))}catch(a){if(!qn(a))throw a;O(va,`Failed to update sequence numbers for target ${e}: ${a}`)}s.Ms=s.Ms.remove(e),s.xs.delete(i.target)}function au(n,e,t){const s=B(n);let i=U.min(),r=K();return s.persistence.runTransaction("Execute query","readwrite",(a=>(function(u,h,f){const p=B(u),m=p.xs.get(f);return m!==void 0?P.resolve(p.Ms.get(m)):p.Pi.getTargetData(h,f)})(s,a,tt(e)).next((l=>{if(l)return i=l.lastLimboFreeSnapshotVersion,s.Pi.getMatchingKeysForTargetId(a,l.targetId).next((u=>{r=u}))})).next((()=>s.Fs.getDocumentsMatchingQuery(a,e,t?i:U.min(),t?r:K()))).next((l=>(zy(s,Ng(e),l),{documents:l,Qs:r})))))}function zy(n,e,t){let s=n.Os.get(e)||U.min();t.forEach(((i,r)=>{r.readTime.compareTo(s)>0&&(s=r.readTime)})),n.Os.set(e,s)}class lu{constructor(){this.activeTargetIds=Mg()}zs(e){this.activeTargetIds=this.activeTargetIds.add(e)}js(e){this.activeTargetIds=this.activeTargetIds.delete(e)}Gs(){const e={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(e)}}class Gy{constructor(){this.Mo=new lu,this.xo={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(e){}updateMutationState(e,t,s){}addLocalQueryTarget(e,t=!0){return t&&this.Mo.zs(e),this.xo[e]||"not-current"}updateQueryState(e,t,s){this.xo[e]=t}removeLocalQueryTarget(e){this.Mo.js(e)}isLocalQueryTarget(e){return this.Mo.activeTargetIds.has(e)}clearQueryState(e){delete this.xo[e]}getAllActiveQueryTargets(){return this.Mo.activeTargetIds}isActiveQueryTarget(e){return this.Mo.activeTargetIds.has(e)}start(){return this.Mo=new lu,Promise.resolve()}handleUserChange(e,t,s){}setOnlineState(e){}shutdown(){}writeSequenceNumber(e){}notifyBundleLoaded(e){}}class Hy{Oo(e){}shutdown(){}}const cu="ConnectivityMonitor";class uu{constructor(){this.No=()=>this.Bo(),this.Lo=()=>this.ko(),this.qo=[],this.Qo()}Oo(e){this.qo.push(e)}shutdown(){window.removeEventListener("online",this.No),window.removeEventListener("offline",this.Lo)}Qo(){window.addEventListener("online",this.No),window.addEventListener("offline",this.Lo)}Bo(){O(cu,"Network connectivity changed: AVAILABLE");for(const e of this.qo)e(0)}ko(){O(cu,"Network connectivity changed: UNAVAILABLE");for(const e of this.qo)e(1)}static v(){return typeof window<"u"&&window.addEventListener!==void 0&&window.removeEventListener!==void 0}}let Ii=null;function Lo(){return Ii===null?Ii=(function(){return 268435456+Math.round(2147483648*Math.random())})():Ii++,"0x"+Ii.toString(16)}const ao="RestConnection",Ky={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery",RunAggregationQuery:"runAggregationQuery"};class Qy{get $o(){return!1}constructor(e){this.databaseInfo=e,this.databaseId=e.databaseId;const t=e.ssl?"https":"http",s=encodeURIComponent(this.databaseId.projectId),i=encodeURIComponent(this.databaseId.database);this.Uo=t+"://"+e.host,this.Ko=`projects/${s}/databases/${i}`,this.Wo=this.databaseId.database===Li?`project_id=${s}`:`project_id=${s}&database_id=${i}`}Go(e,t,s,i,r){const a=Lo(),l=this.zo(e,t.toUriEncodedString());O(ao,`Sending RPC '${e}' ${a}:`,l,s);const u={"google-cloud-resource-prefix":this.Ko,"x-goog-request-params":this.Wo};this.jo(u,i,r);const{host:h}=new URL(l),f=$s(h);return this.Jo(e,l,u,s,f).then((p=>(O(ao,`Received RPC '${e}' ${a}: `,p),p)),(p=>{throw Sn(ao,`RPC '${e}' ${a} failed with error: `,p,"url: ",l,"request:",s),p}))}Ho(e,t,s,i,r,a){return this.Go(e,t,s,i,r)}jo(e,t,s){e["X-Goog-Api-Client"]=(function(){return"gl-js/ fire/"+Un})(),e["Content-Type"]="text/plain",this.databaseInfo.appId&&(e["X-Firebase-GMPID"]=this.databaseInfo.appId),t&&t.headers.forEach(((i,r)=>e[r]=i)),s&&s.headers.forEach(((i,r)=>e[r]=i))}zo(e,t){const s=Ky[e];return`${this.Uo}/v1/${t}:${s}`}terminate(){}}class Yy{constructor(e){this.Yo=e.Yo,this.Zo=e.Zo}Xo(e){this.e_=e}t_(e){this.n_=e}r_(e){this.i_=e}onMessage(e){this.s_=e}close(){this.Zo()}send(e){this.Yo(e)}o_(){this.e_()}__(){this.n_()}a_(e){this.i_(e)}u_(e){this.s_(e)}}const be="WebChannelConnection";class Xy extends Qy{constructor(e){super(e),this.c_=[],this.forceLongPolling=e.forceLongPolling,this.autoDetectLongPolling=e.autoDetectLongPolling,this.useFetchStreams=e.useFetchStreams,this.longPollingOptions=e.longPollingOptions}Jo(e,t,s,i,r){const a=Lo();return new Promise(((l,u)=>{const h=new Dh;h.setWithCredentials(!0),h.listenOnce(kh.COMPLETE,(()=>{try{switch(h.getLastErrorCode()){case Ri.NO_ERROR:const p=h.getResponseJson();O(be,`XHR for RPC '${e}' ${a} received:`,JSON.stringify(p)),l(p);break;case Ri.TIMEOUT:O(be,`RPC '${e}' ${a} timed out`),u(new x(S.DEADLINE_EXCEEDED,"Request time out"));break;case Ri.HTTP_ERROR:const m=h.getStatus();if(O(be,`RPC '${e}' ${a} failed with status:`,m,"response text:",h.getResponseText()),m>0){let A=h.getResponseJson();Array.isArray(A)&&(A=A[0]);const b=A?.error;if(b&&b.status&&b.message){const V=(function(j){const G=j.toLowerCase().replace(/_/g,"-");return Object.values(S).indexOf(G)>=0?G:S.UNKNOWN})(b.status);u(new x(V,b.message))}else u(new x(S.UNKNOWN,"Server responded with status "+h.getStatus()))}else u(new x(S.UNAVAILABLE,"Connection failed."));break;default:F(9055,{l_:e,streamId:a,h_:h.getLastErrorCode(),P_:h.getLastError()})}}finally{O(be,`RPC '${e}' ${a} completed.`)}}));const f=JSON.stringify(i);O(be,`RPC '${e}' ${a} sending request:`,i),h.send(t,"POST",f,s,15)}))}T_(e,t,s){const i=Lo(),r=[this.Uo,"/","google.firestore.v1.Firestore","/",e,"/channel"],a=Oh(),l=xh(),u={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling},h=this.longPollingOptions.timeoutSeconds;h!==void 0&&(u.longPollingTimeout=Math.round(1e3*h)),this.useFetchStreams&&(u.useFetchStreams=!0),this.jo(u.initMessageHeaders,t,s),u.encodeInitMessageHeaders=!0;const f=r.join("");O(be,`Creating RPC '${e}' stream ${i}: ${f}`,u);const p=a.createWebChannel(f,u);this.I_(p);let m=!1,A=!1;const b=new Yy({Yo:N=>{A?O(be,`Not sending because RPC '${e}' stream ${i} is closed:`,N):(m||(O(be,`Opening RPC '${e}' stream ${i} transport.`),p.open(),m=!0),O(be,`RPC '${e}' stream ${i} sending:`,N),p.send(N))},Zo:()=>p.close()}),V=(N,j,G)=>{N.listen(j,(Y=>{try{G(Y)}catch(Ce){setTimeout((()=>{throw Ce}),0)}}))};return V(p,ds.EventType.OPEN,(()=>{A||(O(be,`RPC '${e}' stream ${i} transport opened.`),b.o_())})),V(p,ds.EventType.CLOSE,(()=>{A||(A=!0,O(be,`RPC '${e}' stream ${i} transport closed`),b.a_(),this.E_(p))})),V(p,ds.EventType.ERROR,(N=>{A||(A=!0,Sn(be,`RPC '${e}' stream ${i} transport errored. Name:`,N.name,"Message:",N.message),b.a_(new x(S.UNAVAILABLE,"The operation could not be completed")))})),V(p,ds.EventType.MESSAGE,(N=>{if(!A){const j=N.data[0];Z(!!j,16349);const G=j,Y=G?.error||G[0]?.error;if(Y){O(be,`RPC '${e}' stream ${i} received error:`,Y);const Ce=Y.status;let Me=(function(g){const E=ue[g];if(E!==void 0)return md(E)})(Ce),Ee=Y.message;Me===void 0&&(Me=S.INTERNAL,Ee="Unknown error status: "+Ce+" with message "+Y.message),A=!0,b.a_(new x(Me,Ee)),p.close()}else O(be,`RPC '${e}' stream ${i} received:`,j),b.u_(j)}})),V(l,Vh.STAT_EVENT,(N=>{N.stat===Co.PROXY?O(be,`RPC '${e}' stream ${i} detected buffering proxy`):N.stat===Co.NOPROXY&&O(be,`RPC '${e}' stream ${i} detected no buffering proxy`)})),setTimeout((()=>{b.__()}),0),b}terminate(){this.c_.forEach((e=>e.close())),this.c_=[]}I_(e){this.c_.push(e)}E_(e){this.c_=this.c_.filter((t=>t===e))}}function lo(){return typeof document<"u"?document:null}function gr(n){return new ty(n,!0)}class Nd{constructor(e,t,s=1e3,i=1.5,r=6e4){this.Mi=e,this.timerId=t,this.d_=s,this.A_=i,this.R_=r,this.V_=0,this.m_=null,this.f_=Date.now(),this.reset()}reset(){this.V_=0}g_(){this.V_=this.R_}p_(e){this.cancel();const t=Math.floor(this.V_+this.y_()),s=Math.max(0,Date.now()-this.f_),i=Math.max(0,t-s);i>0&&O("ExponentialBackoff",`Backing off for ${i} ms (base delay: ${this.V_} ms, delay with jitter: ${t} ms, last attempt: ${s} ms ago)`),this.m_=this.Mi.enqueueAfterDelay(this.timerId,i,(()=>(this.f_=Date.now(),e()))),this.V_*=this.A_,this.V_<this.d_&&(this.V_=this.d_),this.V_>this.R_&&(this.V_=this.R_)}w_(){this.m_!==null&&(this.m_.skipDelay(),this.m_=null)}cancel(){this.m_!==null&&(this.m_.cancel(),this.m_=null)}y_(){return(Math.random()-.5)*this.V_}}const hu="PersistentStream";class Dd{constructor(e,t,s,i,r,a,l,u){this.Mi=e,this.S_=s,this.b_=i,this.connection=r,this.authCredentialsProvider=a,this.appCheckCredentialsProvider=l,this.listener=u,this.state=0,this.D_=0,this.C_=null,this.v_=null,this.stream=null,this.F_=0,this.M_=new Nd(e,t)}x_(){return this.state===1||this.state===5||this.O_()}O_(){return this.state===2||this.state===3}start(){this.F_=0,this.state!==4?this.auth():this.N_()}async stop(){this.x_()&&await this.close(0)}B_(){this.state=0,this.M_.reset()}L_(){this.O_()&&this.C_===null&&(this.C_=this.Mi.enqueueAfterDelay(this.S_,6e4,(()=>this.k_())))}q_(e){this.Q_(),this.stream.send(e)}async k_(){if(this.O_())return this.close(0)}Q_(){this.C_&&(this.C_.cancel(),this.C_=null)}U_(){this.v_&&(this.v_.cancel(),this.v_=null)}async close(e,t){this.Q_(),this.U_(),this.M_.cancel(),this.D_++,e!==4?this.M_.reset():t&&t.code===S.RESOURCE_EXHAUSTED?(ht(t.toString()),ht("Using maximum backoff delay to prevent overloading the backend."),this.M_.g_()):t&&t.code===S.UNAUTHENTICATED&&this.state!==3&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),this.stream!==null&&(this.K_(),this.stream.close(),this.stream=null),this.state=e,await this.listener.r_(t)}K_(){}auth(){this.state=1;const e=this.W_(this.D_),t=this.D_;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then((([s,i])=>{this.D_===t&&this.G_(s,i)}),(s=>{e((()=>{const i=new x(S.UNKNOWN,"Fetching auth token failed: "+s.message);return this.z_(i)}))}))}G_(e,t){const s=this.W_(this.D_);this.stream=this.j_(e,t),this.stream.Xo((()=>{s((()=>this.listener.Xo()))})),this.stream.t_((()=>{s((()=>(this.state=2,this.v_=this.Mi.enqueueAfterDelay(this.b_,1e4,(()=>(this.O_()&&(this.state=3),Promise.resolve()))),this.listener.t_())))})),this.stream.r_((i=>{s((()=>this.z_(i)))})),this.stream.onMessage((i=>{s((()=>++this.F_==1?this.J_(i):this.onNext(i)))}))}N_(){this.state=5,this.M_.p_((async()=>{this.state=0,this.start()}))}z_(e){return O(hu,`close with error: ${e}`),this.stream=null,this.close(4,e)}W_(e){return t=>{this.Mi.enqueueAndForget((()=>this.D_===e?t():(O(hu,"stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve())))}}}class Jy extends Dd{constructor(e,t,s,i,r,a){super(e,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",t,s,i,a),this.serializer=r}j_(e,t){return this.connection.T_("Listen",e,t)}J_(e){return this.onNext(e)}onNext(e){this.M_.reset();const t=iy(this.serializer,e),s=(function(r){if(!("targetChange"in r))return U.min();const a=r.targetChange;return a.targetIds&&a.targetIds.length?U.min():a.readTime?st(a.readTime):U.min()})(e);return this.listener.H_(t,s)}Y_(e){const t={};t.database=Oo(this.serializer),t.addTarget=(function(r,a){let l;const u=a.target;if(l=No(u)?{documents:ay(r,u)}:{query:ly(r,u).ft},l.targetId=a.targetId,a.resumeToken.approximateByteSize()>0){l.resumeToken=Ed(r,a.resumeToken);const h=ko(r,a.expectedCount);h!==null&&(l.expectedCount=h)}else if(a.snapshotVersion.compareTo(U.min())>0){l.readTime=Wi(r,a.snapshotVersion.toTimestamp());const h=ko(r,a.expectedCount);h!==null&&(l.expectedCount=h)}return l})(this.serializer,e);const s=uy(this.serializer,e);s&&(t.labels=s),this.q_(t)}Z_(e){const t={};t.database=Oo(this.serializer),t.removeTarget=e,this.q_(t)}}class Zy extends Dd{constructor(e,t,s,i,r,a){super(e,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",t,s,i,a),this.serializer=r}get X_(){return this.F_>0}start(){this.lastStreamToken=void 0,super.start()}K_(){this.X_&&this.ea([])}j_(e,t){return this.connection.T_("Write",e,t)}J_(e){return Z(!!e.streamToken,31322),this.lastStreamToken=e.streamToken,Z(!e.writeResults||e.writeResults.length===0,55816),this.listener.ta()}onNext(e){Z(!!e.streamToken,12678),this.lastStreamToken=e.streamToken,this.M_.reset();const t=oy(e.writeResults,e.commitTime),s=st(e.commitTime);return this.listener.na(s,t)}ra(){const e={};e.database=Oo(this.serializer),this.q_(e)}ea(e){const t={streamToken:this.lastStreamToken,writes:e.map((s=>ry(this.serializer,s)))};this.q_(t)}}class eE{}class tE extends eE{constructor(e,t,s,i){super(),this.authCredentials=e,this.appCheckCredentials=t,this.connection=s,this.serializer=i,this.ia=!1}sa(){if(this.ia)throw new x(S.FAILED_PRECONDITION,"The client has already been terminated.")}Go(e,t,s,i){return this.sa(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then((([r,a])=>this.connection.Go(e,Vo(t,s),i,r,a))).catch((r=>{throw r.name==="FirebaseError"?(r.code===S.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),r):new x(S.UNKNOWN,r.toString())}))}Ho(e,t,s,i,r){return this.sa(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then((([a,l])=>this.connection.Ho(e,Vo(t,s),i,a,l,r))).catch((a=>{throw a.name==="FirebaseError"?(a.code===S.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),a):new x(S.UNKNOWN,a.toString())}))}terminate(){this.ia=!0,this.connection.terminate()}}class nE{constructor(e,t){this.asyncQueue=e,this.onlineStateHandler=t,this.state="Unknown",this.oa=0,this._a=null,this.aa=!0}ua(){this.oa===0&&(this.ca("Unknown"),this._a=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,(()=>(this._a=null,this.la("Backend didn't respond within 10 seconds."),this.ca("Offline"),Promise.resolve()))))}ha(e){this.state==="Online"?this.ca("Unknown"):(this.oa++,this.oa>=1&&(this.Pa(),this.la(`Connection failed 1 times. Most recent error: ${e.toString()}`),this.ca("Offline")))}set(e){this.Pa(),this.oa=0,e==="Online"&&(this.aa=!1),this.ca(e)}ca(e){e!==this.state&&(this.state=e,this.onlineStateHandler(e))}la(e){const t=`Could not reach Cloud Firestore backend. ${e}
This typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.aa?(ht(t),this.aa=!1):O("OnlineStateTracker",t)}Pa(){this._a!==null&&(this._a.cancel(),this._a=null)}}const en="RemoteStore";class sE{constructor(e,t,s,i,r){this.localStore=e,this.datastore=t,this.asyncQueue=s,this.remoteSyncer={},this.Ta=[],this.Ia=new Map,this.Ea=new Set,this.da=[],this.Aa=r,this.Aa.Oo((a=>{s.enqueueAndForget((async()=>{ln(this)&&(O(en,"Restarting streams for network reachability change."),await(async function(u){const h=B(u);h.Ea.add(4),await Ks(h),h.Ra.set("Unknown"),h.Ea.delete(4),await yr(h)})(this))}))})),this.Ra=new nE(s,i)}}async function yr(n){if(ln(n))for(const e of n.da)await e(!0)}async function Ks(n){for(const e of n.da)await e(!1)}function kd(n,e){const t=B(n);t.Ia.has(e.targetId)||(t.Ia.set(e.targetId,e),Ca(t)?wa(t):Wn(t).O_()&&Ia(t,e))}function Ta(n,e){const t=B(n),s=Wn(t);t.Ia.delete(e),s.O_()&&Vd(t,e),t.Ia.size===0&&(s.O_()?s.L_():ln(t)&&t.Ra.set("Unknown"))}function Ia(n,e){if(n.Va.Ue(e.targetId),e.resumeToken.approximateByteSize()>0||e.snapshotVersion.compareTo(U.min())>0){const t=n.remoteSyncer.getRemoteKeysForTarget(e.targetId).size;e=e.withExpectedCount(t)}Wn(n).Y_(e)}function Vd(n,e){n.Va.Ue(e),Wn(n).Z_(e)}function wa(n){n.Va=new Xg({getRemoteKeysForTarget:e=>n.remoteSyncer.getRemoteKeysForTarget(e),At:e=>n.Ia.get(e)||null,ht:()=>n.datastore.serializer.databaseId}),Wn(n).start(),n.Ra.ua()}function Ca(n){return ln(n)&&!Wn(n).x_()&&n.Ia.size>0}function ln(n){return B(n).Ea.size===0}function xd(n){n.Va=void 0}async function iE(n){n.Ra.set("Online")}async function rE(n){n.Ia.forEach(((e,t)=>{Ia(n,e)}))}async function oE(n,e){xd(n),Ca(n)?(n.Ra.ha(e),wa(n)):n.Ra.set("Unknown")}async function aE(n,e,t){if(n.Ra.set("Online"),e instanceof yd&&e.state===2&&e.cause)try{await(async function(i,r){const a=r.cause;for(const l of r.targetIds)i.Ia.has(l)&&(await i.remoteSyncer.rejectListen(l,a),i.Ia.delete(l),i.Va.removeTarget(l))})(n,e)}catch(s){O(en,"Failed to remove targets %s: %s ",e.targetIds.join(","),s),await zi(n,s)}else if(e instanceof Ni?n.Va.Ze(e):e instanceof gd?n.Va.st(e):n.Va.tt(e),!t.isEqual(U.min()))try{const s=await bd(n.localStore);t.compareTo(s)>=0&&await(function(r,a){const l=r.Va.Tt(a);return l.targetChanges.forEach(((u,h)=>{if(u.resumeToken.approximateByteSize()>0){const f=r.Ia.get(h);f&&r.Ia.set(h,f.withResumeToken(u.resumeToken,a))}})),l.targetMismatches.forEach(((u,h)=>{const f=r.Ia.get(u);if(!f)return;r.Ia.set(u,f.withResumeToken(Se.EMPTY_BYTE_STRING,f.snapshotVersion)),Vd(r,u);const p=new It(f.target,u,h,f.sequenceNumber);Ia(r,p)})),r.remoteSyncer.applyRemoteEvent(l)})(n,t)}catch(s){O(en,"Failed to raise snapshot:",s),await zi(n,s)}}async function zi(n,e,t){if(!qn(e))throw e;n.Ea.add(1),await Ks(n),n.Ra.set("Offline"),t||(t=()=>bd(n.localStore)),n.asyncQueue.enqueueRetryable((async()=>{O(en,"Retrying IndexedDB access"),await t(),n.Ea.delete(1),await yr(n)}))}function Od(n,e){return e().catch((t=>zi(n,t,e)))}async function Er(n){const e=B(n),t=Mt(e);let s=e.Ta.length>0?e.Ta[e.Ta.length-1].batchId:aa;for(;lE(e);)try{const i=await Wy(e.localStore,s);if(i===null){e.Ta.length===0&&t.L_();break}s=i.batchId,cE(e,i)}catch(i){await zi(e,i)}Md(e)&&Ld(e)}function lE(n){return ln(n)&&n.Ta.length<10}function cE(n,e){n.Ta.push(e);const t=Mt(n);t.O_()&&t.X_&&t.ea(e.mutations)}function Md(n){return ln(n)&&!Mt(n).x_()&&n.Ta.length>0}function Ld(n){Mt(n).start()}async function uE(n){Mt(n).ra()}async function hE(n){const e=Mt(n);for(const t of n.Ta)e.ea(t.mutations)}async function dE(n,e,t){const s=n.Ta.shift(),i=pa.from(s,e,t);await Od(n,(()=>n.remoteSyncer.applySuccessfulWrite(i))),await Er(n)}async function fE(n,e){e&&Mt(n).X_&&await(async function(s,i){if((function(a){return Kg(a)&&a!==S.ABORTED})(i.code)){const r=s.Ta.shift();Mt(s).B_(),await Od(s,(()=>s.remoteSyncer.rejectFailedWrite(r.batchId,i))),await Er(s)}})(n,e),Md(n)&&Ld(n)}async function du(n,e){const t=B(n);t.asyncQueue.verifyOperationInProgress(),O(en,"RemoteStore received new credentials");const s=ln(t);t.Ea.add(3),await Ks(t),s&&t.Ra.set("Unknown"),await t.remoteSyncer.handleCredentialChange(e),t.Ea.delete(3),await yr(t)}async function pE(n,e){const t=B(n);e?(t.Ea.delete(2),await yr(t)):e||(t.Ea.add(2),await Ks(t),t.Ra.set("Unknown"))}function Wn(n){return n.ma||(n.ma=(function(t,s,i){const r=B(t);return r.sa(),new Jy(s,r.connection,r.authCredentials,r.appCheckCredentials,r.serializer,i)})(n.datastore,n.asyncQueue,{Xo:iE.bind(null,n),t_:rE.bind(null,n),r_:oE.bind(null,n),H_:aE.bind(null,n)}),n.da.push((async e=>{e?(n.ma.B_(),Ca(n)?wa(n):n.Ra.set("Unknown")):(await n.ma.stop(),xd(n))}))),n.ma}function Mt(n){return n.fa||(n.fa=(function(t,s,i){const r=B(t);return r.sa(),new Zy(s,r.connection,r.authCredentials,r.appCheckCredentials,r.serializer,i)})(n.datastore,n.asyncQueue,{Xo:()=>Promise.resolve(),t_:uE.bind(null,n),r_:fE.bind(null,n),ta:hE.bind(null,n),na:dE.bind(null,n)}),n.da.push((async e=>{e?(n.fa.B_(),await Er(n)):(await n.fa.stop(),n.Ta.length>0&&(O(en,`Stopping write stream with ${n.Ta.length} pending writes`),n.Ta=[]))}))),n.fa}class Aa{constructor(e,t,s,i,r){this.asyncQueue=e,this.timerId=t,this.targetTimeMs=s,this.op=i,this.removalCallback=r,this.deferred=new St,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch((a=>{}))}get promise(){return this.deferred.promise}static createAndSchedule(e,t,s,i,r){const a=Date.now()+s,l=new Aa(e,t,a,i,r);return l.start(s),l}start(e){this.timerHandle=setTimeout((()=>this.handleDelayElapsed()),e)}skipDelay(){return this.handleDelayElapsed()}cancel(e){this.timerHandle!==null&&(this.clearTimeout(),this.deferred.reject(new x(S.CANCELLED,"Operation cancelled"+(e?": "+e:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget((()=>this.timerHandle!==null?(this.clearTimeout(),this.op().then((e=>this.deferred.resolve(e)))):Promise.resolve()))}clearTimeout(){this.timerHandle!==null&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}}function Ra(n,e){if(ht("AsyncQueue",`${e}: ${n}`),qn(n))return new x(S.UNAVAILABLE,`${e}: ${n}`);throw n}class vn{static emptySet(e){return new vn(e.comparator)}constructor(e){this.comparator=e?(t,s)=>e(t,s)||M.comparator(t.key,s.key):(t,s)=>M.comparator(t.key,s.key),this.keyedMap=fs(),this.sortedSet=new fe(this.comparator)}has(e){return this.keyedMap.get(e)!=null}get(e){return this.keyedMap.get(e)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(e){const t=this.keyedMap.get(e);return t?this.sortedSet.indexOf(t):-1}get size(){return this.sortedSet.size}forEach(e){this.sortedSet.inorderTraversal(((t,s)=>(e(t),!1)))}add(e){const t=this.delete(e.key);return t.copy(t.keyedMap.insert(e.key,e),t.sortedSet.insert(e,null))}delete(e){const t=this.get(e);return t?this.copy(this.keyedMap.remove(e),this.sortedSet.remove(t)):this}isEqual(e){if(!(e instanceof vn)||this.size!==e.size)return!1;const t=this.sortedSet.getIterator(),s=e.sortedSet.getIterator();for(;t.hasNext();){const i=t.getNext().key,r=s.getNext().key;if(!i.isEqual(r))return!1}return!0}toString(){const e=[];return this.forEach((t=>{e.push(t.toString())})),e.length===0?"DocumentSet ()":`DocumentSet (
  `+e.join(`  
`)+`
)`}copy(e,t){const s=new vn;return s.comparator=this.comparator,s.keyedMap=e,s.sortedSet=t,s}}class fu{constructor(){this.ga=new fe(M.comparator)}track(e){const t=e.doc.key,s=this.ga.get(t);s?e.type!==0&&s.type===3?this.ga=this.ga.insert(t,e):e.type===3&&s.type!==1?this.ga=this.ga.insert(t,{type:s.type,doc:e.doc}):e.type===2&&s.type===2?this.ga=this.ga.insert(t,{type:2,doc:e.doc}):e.type===2&&s.type===0?this.ga=this.ga.insert(t,{type:0,doc:e.doc}):e.type===1&&s.type===0?this.ga=this.ga.remove(t):e.type===1&&s.type===2?this.ga=this.ga.insert(t,{type:1,doc:s.doc}):e.type===0&&s.type===1?this.ga=this.ga.insert(t,{type:2,doc:e.doc}):F(63341,{Rt:e,pa:s}):this.ga=this.ga.insert(t,e)}ya(){const e=[];return this.ga.inorderTraversal(((t,s)=>{e.push(s)})),e}}class Vn{constructor(e,t,s,i,r,a,l,u,h){this.query=e,this.docs=t,this.oldDocs=s,this.docChanges=i,this.mutatedKeys=r,this.fromCache=a,this.syncStateChanged=l,this.excludesMetadataChanges=u,this.hasCachedResults=h}static fromInitialDocuments(e,t,s,i,r){const a=[];return t.forEach((l=>{a.push({type:0,doc:l})})),new Vn(e,t,vn.emptySet(t),a,s,i,!0,!1,r)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(e){if(!(this.fromCache===e.fromCache&&this.hasCachedResults===e.hasCachedResults&&this.syncStateChanged===e.syncStateChanged&&this.mutatedKeys.isEqual(e.mutatedKeys)&&dr(this.query,e.query)&&this.docs.isEqual(e.docs)&&this.oldDocs.isEqual(e.oldDocs)))return!1;const t=this.docChanges,s=e.docChanges;if(t.length!==s.length)return!1;for(let i=0;i<t.length;i++)if(t[i].type!==s[i].type||!t[i].doc.isEqual(s[i].doc))return!1;return!0}}class _E{constructor(){this.wa=void 0,this.Sa=[]}ba(){return this.Sa.some((e=>e.Da()))}}class mE{constructor(){this.queries=pu(),this.onlineState="Unknown",this.Ca=new Set}terminate(){(function(t,s){const i=B(t),r=i.queries;i.queries=pu(),r.forEach(((a,l)=>{for(const u of l.Sa)u.onError(s)}))})(this,new x(S.ABORTED,"Firestore shutting down"))}}function pu(){return new on((n=>id(n)),dr)}async function gE(n,e){const t=B(n);let s=3;const i=e.query;let r=t.queries.get(i);r?!r.ba()&&e.Da()&&(s=2):(r=new _E,s=e.Da()?0:1);try{switch(s){case 0:r.wa=await t.onListen(i,!0);break;case 1:r.wa=await t.onListen(i,!1);break;case 2:await t.onFirstRemoteStoreListen(i)}}catch(a){const l=Ra(a,`Initialization of query '${_n(e.query)}' failed`);return void e.onError(l)}t.queries.set(i,r),r.Sa.push(e),e.va(t.onlineState),r.wa&&e.Fa(r.wa)&&Sa(t)}async function yE(n,e){const t=B(n),s=e.query;let i=3;const r=t.queries.get(s);if(r){const a=r.Sa.indexOf(e);a>=0&&(r.Sa.splice(a,1),r.Sa.length===0?i=e.Da()?0:1:!r.ba()&&e.Da()&&(i=2))}switch(i){case 0:return t.queries.delete(s),t.onUnlisten(s,!0);case 1:return t.queries.delete(s),t.onUnlisten(s,!1);case 2:return t.onLastRemoteStoreUnlisten(s);default:return}}function EE(n,e){const t=B(n);let s=!1;for(const i of e){const r=i.query,a=t.queries.get(r);if(a){for(const l of a.Sa)l.Fa(i)&&(s=!0);a.wa=i}}s&&Sa(t)}function vE(n,e,t){const s=B(n),i=s.queries.get(e);if(i)for(const r of i.Sa)r.onError(t);s.queries.delete(e)}function Sa(n){n.Ca.forEach((e=>{e.next()}))}var Fo,_u;(_u=Fo||(Fo={})).Ma="default",_u.Cache="cache";class TE{constructor(e,t,s){this.query=e,this.xa=t,this.Oa=!1,this.Na=null,this.onlineState="Unknown",this.options=s||{}}Fa(e){if(!this.options.includeMetadataChanges){const s=[];for(const i of e.docChanges)i.type!==3&&s.push(i);e=new Vn(e.query,e.docs,e.oldDocs,s,e.mutatedKeys,e.fromCache,e.syncStateChanged,!0,e.hasCachedResults)}let t=!1;return this.Oa?this.Ba(e)&&(this.xa.next(e),t=!0):this.La(e,this.onlineState)&&(this.ka(e),t=!0),this.Na=e,t}onError(e){this.xa.error(e)}va(e){this.onlineState=e;let t=!1;return this.Na&&!this.Oa&&this.La(this.Na,e)&&(this.ka(this.Na),t=!0),t}La(e,t){if(!e.fromCache||!this.Da())return!0;const s=t!=="Offline";return(!this.options.qa||!s)&&(!e.docs.isEmpty()||e.hasCachedResults||t==="Offline")}Ba(e){if(e.docChanges.length>0)return!0;const t=this.Na&&this.Na.hasPendingWrites!==e.hasPendingWrites;return!(!e.syncStateChanged&&!t)&&this.options.includeMetadataChanges===!0}ka(e){e=Vn.fromInitialDocuments(e.query,e.docs,e.mutatedKeys,e.fromCache,e.hasCachedResults),this.Oa=!0,this.xa.next(e)}Da(){return this.options.source!==Fo.Cache}}class Fd{constructor(e){this.key=e}}class Ud{constructor(e){this.key=e}}class IE{constructor(e,t){this.query=e,this.Ya=t,this.Za=null,this.hasCachedResults=!1,this.current=!1,this.Xa=K(),this.mutatedKeys=K(),this.eu=rd(e),this.tu=new vn(this.eu)}get nu(){return this.Ya}ru(e,t){const s=t?t.iu:new fu,i=t?t.tu:this.tu;let r=t?t.mutatedKeys:this.mutatedKeys,a=i,l=!1;const u=this.query.limitType==="F"&&i.size===this.query.limit?i.last():null,h=this.query.limitType==="L"&&i.size===this.query.limit?i.first():null;if(e.inorderTraversal(((f,p)=>{const m=i.get(f),A=fr(this.query,p)?p:null,b=!!m&&this.mutatedKeys.has(m.key),V=!!A&&(A.hasLocalMutations||this.mutatedKeys.has(A.key)&&A.hasCommittedMutations);let N=!1;m&&A?m.data.isEqual(A.data)?b!==V&&(s.track({type:3,doc:A}),N=!0):this.su(m,A)||(s.track({type:2,doc:A}),N=!0,(u&&this.eu(A,u)>0||h&&this.eu(A,h)<0)&&(l=!0)):!m&&A?(s.track({type:0,doc:A}),N=!0):m&&!A&&(s.track({type:1,doc:m}),N=!0,(u||h)&&(l=!0)),N&&(A?(a=a.add(A),r=V?r.add(f):r.delete(f)):(a=a.delete(f),r=r.delete(f)))})),this.query.limit!==null)for(;a.size>this.query.limit;){const f=this.query.limitType==="F"?a.last():a.first();a=a.delete(f.key),r=r.delete(f.key),s.track({type:1,doc:f})}return{tu:a,iu:s,Cs:l,mutatedKeys:r}}su(e,t){return e.hasLocalMutations&&t.hasCommittedMutations&&!t.hasLocalMutations}applyChanges(e,t,s,i){const r=this.tu;this.tu=e.tu,this.mutatedKeys=e.mutatedKeys;const a=e.iu.ya();a.sort(((f,p)=>(function(A,b){const V=N=>{switch(N){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return F(20277,{Rt:N})}};return V(A)-V(b)})(f.type,p.type)||this.eu(f.doc,p.doc))),this.ou(s),i=i??!1;const l=t&&!i?this._u():[],u=this.Xa.size===0&&this.current&&!i?1:0,h=u!==this.Za;return this.Za=u,a.length!==0||h?{snapshot:new Vn(this.query,e.tu,r,a,e.mutatedKeys,u===0,h,!1,!!s&&s.resumeToken.approximateByteSize()>0),au:l}:{au:l}}va(e){return this.current&&e==="Offline"?(this.current=!1,this.applyChanges({tu:this.tu,iu:new fu,mutatedKeys:this.mutatedKeys,Cs:!1},!1)):{au:[]}}uu(e){return!this.Ya.has(e)&&!!this.tu.has(e)&&!this.tu.get(e).hasLocalMutations}ou(e){e&&(e.addedDocuments.forEach((t=>this.Ya=this.Ya.add(t))),e.modifiedDocuments.forEach((t=>{})),e.removedDocuments.forEach((t=>this.Ya=this.Ya.delete(t))),this.current=e.current)}_u(){if(!this.current)return[];const e=this.Xa;this.Xa=K(),this.tu.forEach((s=>{this.uu(s.key)&&(this.Xa=this.Xa.add(s.key))}));const t=[];return e.forEach((s=>{this.Xa.has(s)||t.push(new Ud(s))})),this.Xa.forEach((s=>{e.has(s)||t.push(new Fd(s))})),t}cu(e){this.Ya=e.Qs,this.Xa=K();const t=this.ru(e.documents);return this.applyChanges(t,!0)}lu(){return Vn.fromInitialDocuments(this.query,this.tu,this.mutatedKeys,this.Za===0,this.hasCachedResults)}}const Pa="SyncEngine";class wE{constructor(e,t,s){this.query=e,this.targetId=t,this.view=s}}class CE{constructor(e){this.key=e,this.hu=!1}}class AE{constructor(e,t,s,i,r,a){this.localStore=e,this.remoteStore=t,this.eventManager=s,this.sharedClientState=i,this.currentUser=r,this.maxConcurrentLimboResolutions=a,this.Pu={},this.Tu=new on((l=>id(l)),dr),this.Iu=new Map,this.Eu=new Set,this.du=new fe(M.comparator),this.Au=new Map,this.Ru=new ga,this.Vu={},this.mu=new Map,this.fu=kn.cr(),this.onlineState="Unknown",this.gu=void 0}get isPrimaryClient(){return this.gu===!0}}async function RE(n,e,t=!0){const s=zd(n);let i;const r=s.Tu.get(e);return r?(s.sharedClientState.addLocalQueryTarget(r.targetId),i=r.view.lu()):i=await Bd(s,e,t,!0),i}async function SE(n,e){const t=zd(n);await Bd(t,e,!0,!1)}async function Bd(n,e,t,s){const i=await $y(n.localStore,tt(e)),r=i.targetId,a=n.sharedClientState.addLocalQueryTarget(r,t);let l;return s&&(l=await PE(n,e,r,a==="current",i.resumeToken)),n.isPrimaryClient&&t&&kd(n.remoteStore,i),l}async function PE(n,e,t,s,i){n.pu=(p,m,A)=>(async function(V,N,j,G){let Y=N.view.ru(j);Y.Cs&&(Y=await au(V.localStore,N.query,!1).then((({documents:T})=>N.view.ru(T,Y))));const Ce=G&&G.targetChanges.get(N.targetId),Me=G&&G.targetMismatches.get(N.targetId)!=null,Ee=N.view.applyChanges(Y,V.isPrimaryClient,Ce,Me);return gu(V,N.targetId,Ee.au),Ee.snapshot})(n,p,m,A);const r=await au(n.localStore,e,!0),a=new IE(e,r.Qs),l=a.ru(r.documents),u=Hs.createSynthesizedTargetChangeForCurrentChange(t,s&&n.onlineState!=="Offline",i),h=a.applyChanges(l,n.isPrimaryClient,u);gu(n,t,h.au);const f=new wE(e,t,a);return n.Tu.set(e,f),n.Iu.has(t)?n.Iu.get(t).push(e):n.Iu.set(t,[e]),h.snapshot}async function bE(n,e,t){const s=B(n),i=s.Tu.get(e),r=s.Iu.get(i.targetId);if(r.length>1)return s.Iu.set(i.targetId,r.filter((a=>!dr(a,e)))),void s.Tu.delete(e);s.isPrimaryClient?(s.sharedClientState.removeLocalQueryTarget(i.targetId),s.sharedClientState.isActiveQueryTarget(i.targetId)||await Mo(s.localStore,i.targetId,!1).then((()=>{s.sharedClientState.clearQueryState(i.targetId),t&&Ta(s.remoteStore,i.targetId),Uo(s,i.targetId)})).catch(Bn)):(Uo(s,i.targetId),await Mo(s.localStore,i.targetId,!0))}async function NE(n,e){const t=B(n),s=t.Tu.get(e),i=t.Iu.get(s.targetId);t.isPrimaryClient&&i.length===1&&(t.sharedClientState.removeLocalQueryTarget(s.targetId),Ta(t.remoteStore,s.targetId))}async function DE(n,e,t){const s=FE(n);try{const i=await(function(a,l){const u=B(a),h=oe.now(),f=l.reduce(((A,b)=>A.add(b.key)),K());let p,m;return u.persistence.runTransaction("Locally write mutations","readwrite",(A=>{let b=dt(),V=K();return u.Ns.getEntries(A,f).next((N=>{b=N,b.forEach(((j,G)=>{G.isValidDocument()||(V=V.add(j))}))})).next((()=>u.localDocuments.getOverlayedDocuments(A,b))).next((N=>{p=N;const j=[];for(const G of l){const Y=Wg(G,p.get(G.key).overlayedDocument);Y!=null&&j.push(new an(G.key,Y,Qh(Y.value.mapValue),nt.exists(!0)))}return u.mutationQueue.addMutationBatch(A,h,j,l)})).next((N=>{m=N;const j=N.applyToLocalDocumentSet(p,V);return u.documentOverlayCache.saveOverlays(A,N.batchId,j)}))})).then((()=>({batchId:m.batchId,changes:ad(p)})))})(s.localStore,e);s.sharedClientState.addPendingMutation(i.batchId),(function(a,l,u){let h=a.Vu[a.currentUser.toKey()];h||(h=new fe(H)),h=h.insert(l,u),a.Vu[a.currentUser.toKey()]=h})(s,i.batchId,t),await Qs(s,i.changes),await Er(s.remoteStore)}catch(i){const r=Ra(i,"Failed to persist write");t.reject(r)}}async function qd(n,e){const t=B(n);try{const s=await qy(t.localStore,e);e.targetChanges.forEach(((i,r)=>{const a=t.Au.get(r);a&&(Z(i.addedDocuments.size+i.modifiedDocuments.size+i.removedDocuments.size<=1,22616),i.addedDocuments.size>0?a.hu=!0:i.modifiedDocuments.size>0?Z(a.hu,14607):i.removedDocuments.size>0&&(Z(a.hu,42227),a.hu=!1))})),await Qs(t,s,e)}catch(s){await Bn(s)}}function mu(n,e,t){const s=B(n);if(s.isPrimaryClient&&t===0||!s.isPrimaryClient&&t===1){const i=[];s.Tu.forEach(((r,a)=>{const l=a.view.va(e);l.snapshot&&i.push(l.snapshot)})),(function(a,l){const u=B(a);u.onlineState=l;let h=!1;u.queries.forEach(((f,p)=>{for(const m of p.Sa)m.va(l)&&(h=!0)})),h&&Sa(u)})(s.eventManager,e),i.length&&s.Pu.H_(i),s.onlineState=e,s.isPrimaryClient&&s.sharedClientState.setOnlineState(e)}}async function kE(n,e,t){const s=B(n);s.sharedClientState.updateQueryState(e,"rejected",t);const i=s.Au.get(e),r=i&&i.key;if(r){let a=new fe(M.comparator);a=a.insert(r,De.newNoDocument(r,U.min()));const l=K().add(r),u=new mr(U.min(),new Map,new fe(H),a,l);await qd(s,u),s.du=s.du.remove(r),s.Au.delete(e),ba(s)}else await Mo(s.localStore,e,!1).then((()=>Uo(s,e,t))).catch(Bn)}async function VE(n,e){const t=B(n),s=e.batch.batchId;try{const i=await By(t.localStore,e);Wd(t,s,null),jd(t,s),t.sharedClientState.updateMutationState(s,"acknowledged"),await Qs(t,i)}catch(i){await Bn(i)}}async function xE(n,e,t){const s=B(n);try{const i=await(function(a,l){const u=B(a);return u.persistence.runTransaction("Reject batch","readwrite-primary",(h=>{let f;return u.mutationQueue.lookupMutationBatch(h,l).next((p=>(Z(p!==null,37113),f=p.keys(),u.mutationQueue.removeMutationBatch(h,p)))).next((()=>u.mutationQueue.performConsistencyCheck(h))).next((()=>u.documentOverlayCache.removeOverlaysForBatchId(h,f,l))).next((()=>u.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(h,f))).next((()=>u.localDocuments.getDocuments(h,f)))}))})(s.localStore,e);Wd(s,e,t),jd(s,e),s.sharedClientState.updateMutationState(e,"rejected",t),await Qs(s,i)}catch(i){await Bn(i)}}function jd(n,e){(n.mu.get(e)||[]).forEach((t=>{t.resolve()})),n.mu.delete(e)}function Wd(n,e,t){const s=B(n);let i=s.Vu[s.currentUser.toKey()];if(i){const r=i.get(e);r&&(t?r.reject(t):r.resolve(),i=i.remove(e)),s.Vu[s.currentUser.toKey()]=i}}function Uo(n,e,t=null){n.sharedClientState.removeLocalQueryTarget(e);for(const s of n.Iu.get(e))n.Tu.delete(s),t&&n.Pu.yu(s,t);n.Iu.delete(e),n.isPrimaryClient&&n.Ru.jr(e).forEach((s=>{n.Ru.containsKey(s)||$d(n,s)}))}function $d(n,e){n.Eu.delete(e.path.canonicalString());const t=n.du.get(e);t!==null&&(Ta(n.remoteStore,t),n.du=n.du.remove(e),n.Au.delete(t),ba(n))}function gu(n,e,t){for(const s of t)s instanceof Fd?(n.Ru.addReference(s.key,e),OE(n,s)):s instanceof Ud?(O(Pa,"Document no longer in limbo: "+s.key),n.Ru.removeReference(s.key,e),n.Ru.containsKey(s.key)||$d(n,s.key)):F(19791,{wu:s})}function OE(n,e){const t=e.key,s=t.path.canonicalString();n.du.get(t)||n.Eu.has(s)||(O(Pa,"New document in limbo: "+t),n.Eu.add(s),ba(n))}function ba(n){for(;n.Eu.size>0&&n.du.size<n.maxConcurrentLimboResolutions;){const e=n.Eu.values().next().value;n.Eu.delete(e);const t=new M(se.fromString(e)),s=n.fu.next();n.Au.set(s,new CE(t)),n.du=n.du.insert(t,s),kd(n.remoteStore,new It(tt(nd(t.path)),s,"TargetPurposeLimboResolution",cr.ce))}}async function Qs(n,e,t){const s=B(n),i=[],r=[],a=[];s.Tu.isEmpty()||(s.Tu.forEach(((l,u)=>{a.push(s.pu(u,e,t).then((h=>{if((h||t)&&s.isPrimaryClient){const f=h?!h.fromCache:t?.targetChanges.get(u.targetId)?.current;s.sharedClientState.updateQueryState(u.targetId,f?"current":"not-current")}if(h){i.push(h);const f=Ea.As(u.targetId,h);r.push(f)}})))})),await Promise.all(a),s.Pu.H_(i),await(async function(u,h){const f=B(u);try{await f.persistence.runTransaction("notifyLocalViewChanges","readwrite",(p=>P.forEach(h,(m=>P.forEach(m.Es,(A=>f.persistence.referenceDelegate.addReference(p,m.targetId,A))).next((()=>P.forEach(m.ds,(A=>f.persistence.referenceDelegate.removeReference(p,m.targetId,A)))))))))}catch(p){if(!qn(p))throw p;O(va,"Failed to update sequence numbers: "+p)}for(const p of h){const m=p.targetId;if(!p.fromCache){const A=f.Ms.get(m),b=A.snapshotVersion,V=A.withLastLimboFreeSnapshotVersion(b);f.Ms=f.Ms.insert(m,V)}}})(s.localStore,r))}async function ME(n,e){const t=B(n);if(!t.currentUser.isEqual(e)){O(Pa,"User change. New user:",e.toKey());const s=await Pd(t.localStore,e);t.currentUser=e,(function(r,a){r.mu.forEach((l=>{l.forEach((u=>{u.reject(new x(S.CANCELLED,a))}))})),r.mu.clear()})(t,"'waitForPendingWrites' promise is rejected due to a user change."),t.sharedClientState.handleUserChange(e,s.removedBatchIds,s.addedBatchIds),await Qs(t,s.Ls)}}function LE(n,e){const t=B(n),s=t.Au.get(e);if(s&&s.hu)return K().add(s.key);{let i=K();const r=t.Iu.get(e);if(!r)return i;for(const a of r){const l=t.Tu.get(a);i=i.unionWith(l.view.nu)}return i}}function zd(n){const e=B(n);return e.remoteStore.remoteSyncer.applyRemoteEvent=qd.bind(null,e),e.remoteStore.remoteSyncer.getRemoteKeysForTarget=LE.bind(null,e),e.remoteStore.remoteSyncer.rejectListen=kE.bind(null,e),e.Pu.H_=EE.bind(null,e.eventManager),e.Pu.yu=vE.bind(null,e.eventManager),e}function FE(n){const e=B(n);return e.remoteStore.remoteSyncer.applySuccessfulWrite=VE.bind(null,e),e.remoteStore.remoteSyncer.rejectFailedWrite=xE.bind(null,e),e}class Gi{constructor(){this.kind="memory",this.synchronizeTabs=!1}async initialize(e){this.serializer=gr(e.databaseInfo.databaseId),this.sharedClientState=this.Du(e),this.persistence=this.Cu(e),await this.persistence.start(),this.localStore=this.vu(e),this.gcScheduler=this.Fu(e,this.localStore),this.indexBackfillerScheduler=this.Mu(e,this.localStore)}Fu(e,t){return null}Mu(e,t){return null}vu(e){return Uy(this.persistence,new My,e.initialUser,this.serializer)}Cu(e){return new Sd(ya.mi,this.serializer)}Du(e){return new Gy}async terminate(){this.gcScheduler?.stop(),this.indexBackfillerScheduler?.stop(),this.sharedClientState.shutdown(),await this.persistence.shutdown()}}Gi.provider={build:()=>new Gi};class UE extends Gi{constructor(e){super(),this.cacheSizeBytes=e}Fu(e,t){Z(this.persistence.referenceDelegate instanceof $i,46915);const s=this.persistence.referenceDelegate.garbageCollector;return new Ty(s,e.asyncQueue,t)}Cu(e){const t=this.cacheSizeBytes!==void 0?Fe.withCacheSize(this.cacheSizeBytes):Fe.DEFAULT;return new Sd((s=>$i.mi(s,t)),this.serializer)}}class Bo{async initialize(e,t){this.localStore||(this.localStore=e.localStore,this.sharedClientState=e.sharedClientState,this.datastore=this.createDatastore(t),this.remoteStore=this.createRemoteStore(t),this.eventManager=this.createEventManager(t),this.syncEngine=this.createSyncEngine(t,!e.synchronizeTabs),this.sharedClientState.onlineStateHandler=s=>mu(this.syncEngine,s,1),this.remoteStore.remoteSyncer.handleCredentialChange=ME.bind(null,this.syncEngine),await pE(this.remoteStore,this.syncEngine.isPrimaryClient))}createEventManager(e){return(function(){return new mE})()}createDatastore(e){const t=gr(e.databaseInfo.databaseId),s=(function(r){return new Xy(r)})(e.databaseInfo);return(function(r,a,l,u){return new tE(r,a,l,u)})(e.authCredentials,e.appCheckCredentials,s,t)}createRemoteStore(e){return(function(s,i,r,a,l){return new sE(s,i,r,a,l)})(this.localStore,this.datastore,e.asyncQueue,(t=>mu(this.syncEngine,t,0)),(function(){return uu.v()?new uu:new Hy})())}createSyncEngine(e,t){return(function(i,r,a,l,u,h,f){const p=new AE(i,r,a,l,u,h);return f&&(p.gu=!0),p})(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,e.initialUser,e.maxConcurrentLimboResolutions,t)}async terminate(){await(async function(t){const s=B(t);O(en,"RemoteStore shutting down."),s.Ea.add(5),await Ks(s),s.Aa.shutdown(),s.Ra.set("Unknown")})(this.remoteStore),this.datastore?.terminate(),this.eventManager?.terminate()}}Bo.provider={build:()=>new Bo};class BE{constructor(e){this.observer=e,this.muted=!1}next(e){this.muted||this.observer.next&&this.Ou(this.observer.next,e)}error(e){this.muted||(this.observer.error?this.Ou(this.observer.error,e):ht("Uncaught Error in snapshot listener:",e.toString()))}Nu(){this.muted=!0}Ou(e,t){setTimeout((()=>{this.muted||e(t)}),0)}}const Lt="FirestoreClient";class qE{constructor(e,t,s,i,r){this.authCredentials=e,this.appCheckCredentials=t,this.asyncQueue=s,this.databaseInfo=i,this.user=Ne.UNAUTHENTICATED,this.clientId=oa.newId(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this._uninitializedComponentsProvider=r,this.authCredentials.start(s,(async a=>{O(Lt,"Received user=",a.uid),await this.authCredentialListener(a),this.user=a})),this.appCheckCredentials.start(s,(a=>(O(Lt,"Received new app check token=",a),this.appCheckCredentialListener(a,this.user))))}get configuration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(e){this.authCredentialListener=e}setAppCheckTokenChangeListener(e){this.appCheckCredentialListener=e}terminate(){this.asyncQueue.enterRestrictedMode();const e=new St;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted((async()=>{try{this._onlineComponents&&await this._onlineComponents.terminate(),this._offlineComponents&&await this._offlineComponents.terminate(),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),e.resolve()}catch(t){const s=Ra(t,"Failed to shutdown persistence");e.reject(s)}})),e.promise}}async function co(n,e){n.asyncQueue.verifyOperationInProgress(),O(Lt,"Initializing OfflineComponentProvider");const t=n.configuration;await e.initialize(t);let s=t.initialUser;n.setCredentialChangeListener((async i=>{s.isEqual(i)||(await Pd(e.localStore,i),s=i)})),e.persistence.setDatabaseDeletedListener((()=>n.terminate())),n._offlineComponents=e}async function yu(n,e){n.asyncQueue.verifyOperationInProgress();const t=await jE(n);O(Lt,"Initializing OnlineComponentProvider"),await e.initialize(t,n.configuration),n.setCredentialChangeListener((s=>du(e.remoteStore,s))),n.setAppCheckTokenChangeListener(((s,i)=>du(e.remoteStore,i))),n._onlineComponents=e}async function jE(n){if(!n._offlineComponents)if(n._uninitializedComponentsProvider){O(Lt,"Using user provided OfflineComponentProvider");try{await co(n,n._uninitializedComponentsProvider._offline)}catch(e){const t=e;if(!(function(i){return i.name==="FirebaseError"?i.code===S.FAILED_PRECONDITION||i.code===S.UNIMPLEMENTED:!(typeof DOMException<"u"&&i instanceof DOMException)||i.code===22||i.code===20||i.code===11})(t))throw t;Sn("Error using user provided cache. Falling back to memory cache: "+t),await co(n,new Gi)}}else O(Lt,"Using default OfflineComponentProvider"),await co(n,new UE(void 0));return n._offlineComponents}async function Gd(n){return n._onlineComponents||(n._uninitializedComponentsProvider?(O(Lt,"Using user provided OnlineComponentProvider"),await yu(n,n._uninitializedComponentsProvider._online)):(O(Lt,"Using default OnlineComponentProvider"),await yu(n,new Bo))),n._onlineComponents}function WE(n){return Gd(n).then((e=>e.syncEngine))}async function $E(n){const e=await Gd(n),t=e.eventManager;return t.onListen=RE.bind(null,e.syncEngine),t.onUnlisten=bE.bind(null,e.syncEngine),t.onFirstRemoteStoreListen=SE.bind(null,e.syncEngine),t.onLastRemoteStoreUnlisten=NE.bind(null,e.syncEngine),t}function zE(n,e,t={}){const s=new St;return n.asyncQueue.enqueueAndForget((async()=>(function(r,a,l,u,h){const f=new BE({next:m=>{f.Nu(),a.enqueueAndForget((()=>yE(r,p))),m.fromCache&&u.source==="server"?h.reject(new x(S.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):h.resolve(m)},error:m=>h.reject(m)}),p=new TE(l,f,{includeMetadataChanges:!0,qa:!0});return gE(r,p)})(await $E(n),n.asyncQueue,e,t,s))),s.promise}function Hd(n){const e={};return n.timeoutSeconds!==void 0&&(e.timeoutSeconds=n.timeoutSeconds),e}const Eu=new Map;const Kd="firestore.googleapis.com",vu=!0;class Tu{constructor(e){if(e.host===void 0){if(e.ssl!==void 0)throw new x(S.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host=Kd,this.ssl=vu}else this.host=e.host,this.ssl=e.ssl??vu;if(this.isUsingEmulator=e.emulatorOptions!==void 0,this.credentials=e.credentials,this.ignoreUndefinedProperties=!!e.ignoreUndefinedProperties,this.localCache=e.localCache,e.cacheSizeBytes===void 0)this.cacheSizeBytes=Rd;else{if(e.cacheSizeBytes!==-1&&e.cacheSizeBytes<Ey)throw new x(S.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=e.cacheSizeBytes}sg("experimentalForceLongPolling",e.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",e.experimentalAutoDetectLongPolling),this.experimentalForceLongPolling=!!e.experimentalForceLongPolling,this.experimentalForceLongPolling?this.experimentalAutoDetectLongPolling=!1:e.experimentalAutoDetectLongPolling===void 0?this.experimentalAutoDetectLongPolling=!0:this.experimentalAutoDetectLongPolling=!!e.experimentalAutoDetectLongPolling,this.experimentalLongPollingOptions=Hd(e.experimentalLongPollingOptions??{}),(function(s){if(s.timeoutSeconds!==void 0){if(isNaN(s.timeoutSeconds))throw new x(S.INVALID_ARGUMENT,`invalid long polling timeout: ${s.timeoutSeconds} (must not be NaN)`);if(s.timeoutSeconds<5)throw new x(S.INVALID_ARGUMENT,`invalid long polling timeout: ${s.timeoutSeconds} (minimum allowed value is 5)`);if(s.timeoutSeconds>30)throw new x(S.INVALID_ARGUMENT,`invalid long polling timeout: ${s.timeoutSeconds} (maximum allowed value is 30)`)}})(this.experimentalLongPollingOptions),this.useFetchStreams=!!e.useFetchStreams}isEqual(e){return this.host===e.host&&this.ssl===e.ssl&&this.credentials===e.credentials&&this.cacheSizeBytes===e.cacheSizeBytes&&this.experimentalForceLongPolling===e.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===e.experimentalAutoDetectLongPolling&&(function(s,i){return s.timeoutSeconds===i.timeoutSeconds})(this.experimentalLongPollingOptions,e.experimentalLongPollingOptions)&&this.ignoreUndefinedProperties===e.ignoreUndefinedProperties&&this.useFetchStreams===e.useFetchStreams}}class vr{constructor(e,t,s,i){this._authCredentials=e,this._appCheckCredentials=t,this._databaseId=s,this._app=i,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new Tu({}),this._settingsFrozen=!1,this._emulatorOptions={},this._terminateTask="notTerminated"}get app(){if(!this._app)throw new x(S.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return this._terminateTask!=="notTerminated"}_setSettings(e){if(this._settingsFrozen)throw new x(S.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new Tu(e),this._emulatorOptions=e.emulatorOptions||{},e.credentials!==void 0&&(this._authCredentials=(function(s){if(!s)return new Hm;switch(s.type){case"firstParty":return new Xm(s.sessionIndex||"0",s.iamToken||null,s.authTokenFactory||null);case"provider":return s.client;default:throw new x(S.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}})(e.credentials))}_getSettings(){return this._settings}_getEmulatorOptions(){return this._emulatorOptions}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return this._terminateTask==="notTerminated"&&(this._terminateTask=this._terminate()),this._terminateTask}async _restart(){this._terminateTask==="notTerminated"?await this._terminate():this._terminateTask="notTerminated"}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return(function(t){const s=Eu.get(t);s&&(O("ComponentProvider","Removing Datastore"),Eu.delete(t),s.terminate())})(this),Promise.resolve()}}function GE(n,e,t,s={}){n=bn(n,vr);const i=$s(e),r=n._getSettings(),a={...r,emulatorOptions:n._getEmulatorOptions()},l=`${e}:${t}`;i&&(fh(`https://${l}`),_h("Firestore",!0)),r.host!==Kd&&r.host!==l&&Sn("Host has been set in both settings() and connectFirestoreEmulator(), emulator host will be used.");const u={...r,host:l,ssl:i,emulatorOptions:s};if(!Rs(u,a)&&(n._setSettings(u),s.mockUserToken)){let h,f;if(typeof s.mockUserToken=="string")h=s.mockUserToken,f=Ne.MOCK_USER;else{h=ph(s.mockUserToken,n._app?.options.projectId);const p=s.mockUserToken.sub||s.mockUserToken.user_id;if(!p)throw new x(S.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");f=new Ne(p)}n._authCredentials=new Km(new Lh(h,f))}}class qt{constructor(e,t,s){this.converter=t,this._query=s,this.type="query",this.firestore=e}withConverter(e){return new qt(this.firestore,e,this._query)}}class ge{constructor(e,t,s){this.converter=t,this._key=s,this.type="document",this.firestore=e}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new bt(this.firestore,this.converter,this._key.path.popLast())}withConverter(e){return new ge(this.firestore,e,this._key)}toJSON(){return{type:ge._jsonSchemaVersion,referencePath:this._key.toString()}}static fromJSON(e,t,s){if(zs(t,ge._jsonSchema))return new ge(e,s||null,new M(se.fromString(t.referencePath)))}}ge._jsonSchemaVersion="firestore/documentReference/1.0",ge._jsonSchema={type:de("string",ge._jsonSchemaVersion),referencePath:de("string")};class bt extends qt{constructor(e,t,s){super(e,t,nd(s)),this._path=s,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){const e=this._path.popLast();return e.isEmpty()?null:new ge(this.firestore,null,new M(e))}withConverter(e){return new bt(this.firestore,e,this._path)}}function Na(n,e,...t){if(n=Ye(n),Fh("collection","path",e),n instanceof vr){const s=se.fromString(e,...t);return xc(s),new bt(n,null,s)}{if(!(n instanceof ge||n instanceof bt))throw new x(S.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const s=n._path.child(se.fromString(e,...t));return xc(s),new bt(n.firestore,null,s)}}function Qd(n,e,...t){if(n=Ye(n),arguments.length===1&&(e=oa.newId()),Fh("doc","path",e),n instanceof vr){const s=se.fromString(e,...t);return Vc(s),new ge(n,null,new M(s))}{if(!(n instanceof ge||n instanceof bt))throw new x(S.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const s=n._path.child(se.fromString(e,...t));return Vc(s),new ge(n.firestore,n instanceof bt?n.converter:null,new M(s))}}const Iu="AsyncQueue";class wu{constructor(e=Promise.resolve()){this.Xu=[],this.ec=!1,this.tc=[],this.nc=null,this.rc=!1,this.sc=!1,this.oc=[],this.M_=new Nd(this,"async_queue_retry"),this._c=()=>{const s=lo();s&&O(Iu,"Visibility state changed to "+s.visibilityState),this.M_.w_()},this.ac=e;const t=lo();t&&typeof t.addEventListener=="function"&&t.addEventListener("visibilitychange",this._c)}get isShuttingDown(){return this.ec}enqueueAndForget(e){this.enqueue(e)}enqueueAndForgetEvenWhileRestricted(e){this.uc(),this.cc(e)}enterRestrictedMode(e){if(!this.ec){this.ec=!0,this.sc=e||!1;const t=lo();t&&typeof t.removeEventListener=="function"&&t.removeEventListener("visibilitychange",this._c)}}enqueue(e){if(this.uc(),this.ec)return new Promise((()=>{}));const t=new St;return this.cc((()=>this.ec&&this.sc?Promise.resolve():(e().then(t.resolve,t.reject),t.promise))).then((()=>t.promise))}enqueueRetryable(e){this.enqueueAndForget((()=>(this.Xu.push(e),this.lc())))}async lc(){if(this.Xu.length!==0){try{await this.Xu[0](),this.Xu.shift(),this.M_.reset()}catch(e){if(!qn(e))throw e;O(Iu,"Operation failed with retryable error: "+e)}this.Xu.length>0&&this.M_.p_((()=>this.lc()))}}cc(e){const t=this.ac.then((()=>(this.rc=!0,e().catch((s=>{throw this.nc=s,this.rc=!1,ht("INTERNAL UNHANDLED ERROR: ",Cu(s)),s})).then((s=>(this.rc=!1,s))))));return this.ac=t,t}enqueueAfterDelay(e,t,s){this.uc(),this.oc.indexOf(e)>-1&&(t=0);const i=Aa.createAndSchedule(this,e,t,s,(r=>this.hc(r)));return this.tc.push(i),i}uc(){this.nc&&F(47125,{Pc:Cu(this.nc)})}verifyOperationInProgress(){}async Tc(){let e;do e=this.ac,await e;while(e!==this.ac)}Ic(e){for(const t of this.tc)if(t.timerId===e)return!0;return!1}Ec(e){return this.Tc().then((()=>{this.tc.sort(((t,s)=>t.targetTimeMs-s.targetTimeMs));for(const t of this.tc)if(t.skipDelay(),e!=="all"&&t.timerId===e)break;return this.Tc()}))}dc(e){this.oc.push(e)}hc(e){const t=this.tc.indexOf(e);this.tc.splice(t,1)}}function Cu(n){let e=n.message||"";return n.stack&&(e=n.stack.includes(n.message)?n.stack:n.message+`
`+n.stack),e}class Tr extends vr{constructor(e,t,s,i){super(e,t,s,i),this.type="firestore",this._queue=new wu,this._persistenceKey=i?.name||"[DEFAULT]"}async _terminate(){if(this._firestoreClient){const e=this._firestoreClient.terminate();this._queue=new wu(e),this._firestoreClient=void 0,await e}}}function HE(n,e){const t=typeof n=="object"?n:Sh(),s=typeof n=="string"?n:Li,i=wh(t,"firestore").getImmediate({identifier:s});if(!i._initialized){const r=hh("firestore");r&&GE(i,...r)}return i}function Yd(n){if(n._terminated)throw new x(S.FAILED_PRECONDITION,"The client has already been terminated.");return n._firestoreClient||KE(n),n._firestoreClient}function KE(n){const e=n._freezeSettings(),t=(function(i,r,a,l){return new pg(i,r,a,l.host,l.ssl,l.experimentalForceLongPolling,l.experimentalAutoDetectLongPolling,Hd(l.experimentalLongPollingOptions),l.useFetchStreams,l.isUsingEmulator)})(n._databaseId,n._app?.options.appId||"",n._persistenceKey,e);n._componentsProvider||e.localCache?._offlineComponentProvider&&e.localCache?._onlineComponentProvider&&(n._componentsProvider={_offline:e.localCache._offlineComponentProvider,_online:e.localCache._onlineComponentProvider}),n._firestoreClient=new qE(n._authCredentials,n._appCheckCredentials,n._queue,t,n._componentsProvider&&(function(i){const r=i?._online.build();return{_offline:i?._offline.build(r),_online:r}})(n._componentsProvider))}class $e{constructor(e){this._byteString=e}static fromBase64String(e){try{return new $e(Se.fromBase64String(e))}catch(t){throw new x(S.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+t)}}static fromUint8Array(e){return new $e(Se.fromUint8Array(e))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(e){return this._byteString.isEqual(e._byteString)}toJSON(){return{type:$e._jsonSchemaVersion,bytes:this.toBase64()}}static fromJSON(e){if(zs(e,$e._jsonSchema))return $e.fromBase64String(e.bytes)}}$e._jsonSchemaVersion="firestore/bytes/1.0",$e._jsonSchema={type:de("string",$e._jsonSchemaVersion),bytes:de("string")};class Da{constructor(...e){for(let t=0;t<e.length;++t)if(e[t].length===0)throw new x(S.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new Re(e)}isEqual(e){return this._internalPath.isEqual(e._internalPath)}}class Xd{constructor(e){this._methodName=e}}class it{constructor(e,t){if(!isFinite(e)||e<-90||e>90)throw new x(S.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+e);if(!isFinite(t)||t<-180||t>180)throw new x(S.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+t);this._lat=e,this._long=t}get latitude(){return this._lat}get longitude(){return this._long}isEqual(e){return this._lat===e._lat&&this._long===e._long}_compareTo(e){return H(this._lat,e._lat)||H(this._long,e._long)}toJSON(){return{latitude:this._lat,longitude:this._long,type:it._jsonSchemaVersion}}static fromJSON(e){if(zs(e,it._jsonSchema))return new it(e.latitude,e.longitude)}}it._jsonSchemaVersion="firestore/geoPoint/1.0",it._jsonSchema={type:de("string",it._jsonSchemaVersion),latitude:de("number"),longitude:de("number")};class rt{constructor(e){this._values=(e||[]).map((t=>t))}toArray(){return this._values.map((e=>e))}isEqual(e){return(function(s,i){if(s.length!==i.length)return!1;for(let r=0;r<s.length;++r)if(s[r]!==i[r])return!1;return!0})(this._values,e._values)}toJSON(){return{type:rt._jsonSchemaVersion,vectorValues:this._values}}static fromJSON(e){if(zs(e,rt._jsonSchema)){if(Array.isArray(e.vectorValues)&&e.vectorValues.every((t=>typeof t=="number")))return new rt(e.vectorValues);throw new x(S.INVALID_ARGUMENT,"Expected 'vectorValues' field to be a number array")}}}rt._jsonSchemaVersion="firestore/vectorValue/1.0",rt._jsonSchema={type:de("string",rt._jsonSchemaVersion),vectorValues:de("object")};const QE=/^__.*__$/;class YE{constructor(e,t,s){this.data=e,this.fieldMask=t,this.fieldTransforms=s}toMutation(e,t){return this.fieldMask!==null?new an(e,this.data,this.fieldMask,t,this.fieldTransforms):new Gs(e,this.data,t,this.fieldTransforms)}}function Jd(n){switch(n){case 0:case 2:case 1:return!0;case 3:case 4:return!1;default:throw F(40011,{Ac:n})}}class ka{constructor(e,t,s,i,r,a){this.settings=e,this.databaseId=t,this.serializer=s,this.ignoreUndefinedProperties=i,r===void 0&&this.Rc(),this.fieldTransforms=r||[],this.fieldMask=a||[]}get path(){return this.settings.path}get Ac(){return this.settings.Ac}Vc(e){return new ka({...this.settings,...e},this.databaseId,this.serializer,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}mc(e){const t=this.path?.child(e),s=this.Vc({path:t,fc:!1});return s.gc(e),s}yc(e){const t=this.path?.child(e),s=this.Vc({path:t,fc:!1});return s.Rc(),s}wc(e){return this.Vc({path:void 0,fc:!0})}Sc(e){return Hi(e,this.settings.methodName,this.settings.bc||!1,this.path,this.settings.Dc)}contains(e){return this.fieldMask.find((t=>e.isPrefixOf(t)))!==void 0||this.fieldTransforms.find((t=>e.isPrefixOf(t.field)))!==void 0}Rc(){if(this.path)for(let e=0;e<this.path.length;e++)this.gc(this.path.get(e))}gc(e){if(e.length===0)throw this.Sc("Document fields must not be empty");if(Jd(this.Ac)&&QE.test(e))throw this.Sc('Document fields cannot begin and end with "__"')}}class XE{constructor(e,t,s){this.databaseId=e,this.ignoreUndefinedProperties=t,this.serializer=s||gr(e)}Cc(e,t,s,i=!1){return new ka({Ac:e,methodName:t,Dc:s,path:Re.emptyPath(),fc:!1,bc:i},this.databaseId,this.serializer,this.ignoreUndefinedProperties)}}function Zd(n){const e=n._freezeSettings(),t=gr(n._databaseId);return new XE(n._databaseId,!!e.ignoreUndefinedProperties,t)}function JE(n,e,t,s,i,r={}){const a=n.Cc(r.merge||r.mergeFields?2:0,e,t,i);nf("Data must be an object, but it was:",a,s);const l=ef(s,a);let u,h;if(r.merge)u=new Ge(a.fieldMask),h=a.fieldTransforms;else if(r.mergeFields){const f=[];for(const p of r.mergeFields){const m=ev(e,p,t);if(!a.contains(m))throw new x(S.INVALID_ARGUMENT,`Field '${m}' is specified in your field mask but missing from your input data.`);nv(f,m)||f.push(m)}u=new Ge(f),h=a.fieldTransforms.filter((p=>u.covers(p.field)))}else u=null,h=a.fieldTransforms;return new YE(new We(l),u,h)}function ZE(n,e,t,s=!1){return Va(t,n.Cc(s?4:3,e))}function Va(n,e){if(tf(n=Ye(n)))return nf("Unsupported field value:",e,n),ef(n,e);if(n instanceof Xd)return(function(s,i){if(!Jd(i.Ac))throw i.Sc(`${s._methodName}() can only be used with update() and set()`);if(!i.path)throw i.Sc(`${s._methodName}() is not currently supported inside arrays`);const r=s._toFieldTransform(i);r&&i.fieldTransforms.push(r)})(n,e),null;if(n===void 0&&e.ignoreUndefinedProperties)return null;if(e.path&&e.fieldMask.push(e.path),n instanceof Array){if(e.settings.fc&&e.Ac!==4)throw e.Sc("Nested arrays are not supported");return(function(s,i){const r=[];let a=0;for(const l of s){let u=Va(l,i.wc(a));u==null&&(u={nullValue:"NULL_VALUE"}),r.push(u),a++}return{arrayValue:{values:r}}})(n,e)}return(function(s,i){if((s=Ye(s))===null)return{nullValue:"NULL_VALUE"};if(typeof s=="number")return Lg(i.serializer,s);if(typeof s=="boolean")return{booleanValue:s};if(typeof s=="string")return{stringValue:s};if(s instanceof Date){const r=oe.fromDate(s);return{timestampValue:Wi(i.serializer,r)}}if(s instanceof oe){const r=new oe(s.seconds,1e3*Math.floor(s.nanoseconds/1e3));return{timestampValue:Wi(i.serializer,r)}}if(s instanceof it)return{geoPointValue:{latitude:s.latitude,longitude:s.longitude}};if(s instanceof $e)return{bytesValue:Ed(i.serializer,s._byteString)};if(s instanceof ge){const r=i.databaseId,a=s.firestore._databaseId;if(!a.isEqual(r))throw i.Sc(`Document reference is for database ${a.projectId}/${a.database} but should be for database ${r.projectId}/${r.database}`);return{referenceValue:ma(s.firestore._databaseId||i.databaseId,s._key.path)}}if(s instanceof rt)return(function(a,l){return{mapValue:{fields:{[Hh]:{stringValue:Kh},[Fi]:{arrayValue:{values:a.toArray().map((h=>{if(typeof h!="number")throw l.Sc("VectorValues must only contain numeric values.");return da(l.serializer,h)}))}}}}}})(s,i);throw i.Sc(`Unsupported field value: ${lr(s)}`)})(n,e)}function ef(n,e){const t={};return qh(n)?e.path&&e.path.length>0&&e.fieldMask.push(e.path):rn(n,((s,i)=>{const r=Va(i,e.mc(s));r!=null&&(t[s]=r)})),{mapValue:{fields:t}}}function tf(n){return!(typeof n!="object"||n===null||n instanceof Array||n instanceof Date||n instanceof oe||n instanceof it||n instanceof $e||n instanceof ge||n instanceof Xd||n instanceof rt)}function nf(n,e,t){if(!tf(t)||!Uh(t)){const s=lr(t);throw s==="an object"?e.Sc(n+" a custom object"):e.Sc(n+" "+s)}}function ev(n,e,t){if((e=Ye(e))instanceof Da)return e._internalPath;if(typeof e=="string")return sf(n,e);throw Hi("Field path arguments must be of type string or ",n,!1,void 0,t)}const tv=new RegExp("[~\\*/\\[\\]]");function sf(n,e,t){if(e.search(tv)>=0)throw Hi(`Invalid field path (${e}). Paths must not contain '~', '*', '/', '[', or ']'`,n,!1,void 0,t);try{return new Da(...e.split("."))._internalPath}catch{throw Hi(`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,n,!1,void 0,t)}}function Hi(n,e,t,s,i){const r=s&&!s.isEmpty(),a=i!==void 0;let l=`Function ${e}() called with invalid data`;t&&(l+=" (via `toFirestore()`)"),l+=". ";let u="";return(r||a)&&(u+=" (found",r&&(u+=` in field ${s}`),a&&(u+=` in document ${i}`),u+=")"),new x(S.INVALID_ARGUMENT,l+n+u)}function nv(n,e){return n.some((t=>t.isEqual(e)))}class rf{constructor(e,t,s,i,r){this._firestore=e,this._userDataWriter=t,this._key=s,this._document=i,this._converter=r}get id(){return this._key.path.lastSegment()}get ref(){return new ge(this._firestore,this._converter,this._key)}exists(){return this._document!==null}data(){if(this._document){if(this._converter){const e=new sv(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(e)}return this._userDataWriter.convertValue(this._document.data.value)}}get(e){if(this._document){const t=this._document.data.field(xa("DocumentSnapshot.get",e));if(t!==null)return this._userDataWriter.convertValue(t)}}}class sv extends rf{data(){return super.data()}}function xa(n,e){return typeof e=="string"?sf(n,e):e instanceof Da?e._internalPath:e._delegate._internalPath}function iv(n){if(n.limitType==="L"&&n.explicitOrderBy.length===0)throw new x(S.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}class Oa{}class Ma extends Oa{}function rv(n,e,...t){let s=[];e instanceof Oa&&s.push(e),s=s.concat(t),(function(r){const a=r.filter((u=>u instanceof Fa)).length,l=r.filter((u=>u instanceof La)).length;if(a>1||a>0&&l>0)throw new x(S.INVALID_ARGUMENT,"InvalidQuery. When using composite filters, you cannot use more than one filter at the top level. Consider nesting the multiple filters within an `and(...)` statement. For example: change `query(query, where(...), or(...))` to `query(query, and(where(...), or(...)))`.")})(s);for(const i of s)n=i._apply(n);return n}class La extends Ma{constructor(e,t,s){super(),this._field=e,this._op=t,this._value=s,this.type="where"}static _create(e,t,s){return new La(e,t,s)}_apply(e){const t=this._parse(e);return of(e._query,t),new qt(e.firestore,e.converter,Do(e._query,t))}_parse(e){const t=Zd(e.firestore);return(function(r,a,l,u,h,f,p){let m;if(h.isKeyField()){if(f==="array-contains"||f==="array-contains-any")throw new x(S.INVALID_ARGUMENT,`Invalid Query. You can't perform '${f}' queries on documentId().`);if(f==="in"||f==="not-in"){Ru(p,f);const b=[];for(const V of p)b.push(Au(u,r,V));m={arrayValue:{values:b}}}else m=Au(u,r,p)}else f!=="in"&&f!=="not-in"&&f!=="array-contains-any"||Ru(p,f),m=ZE(l,a,p,f==="in"||f==="not-in");return he.create(h,f,m)})(e._query,"where",t,e.firestore._databaseId,this._field,this._op,this._value)}}class Fa extends Oa{constructor(e,t){super(),this.type=e,this._queryConstraints=t}static _create(e,t){return new Fa(e,t)}_parse(e){const t=this._queryConstraints.map((s=>s._parse(e))).filter((s=>s.getFilters().length>0));return t.length===1?t[0]:Xe.create(t,this._getOperator())}_apply(e){const t=this._parse(e);return t.getFilters().length===0?e:((function(i,r){let a=i;const l=r.getFlattenedFilters();for(const u of l)of(a,u),a=Do(a,u)})(e._query,t),new qt(e.firestore,e.converter,Do(e._query,t)))}_getQueryConstraints(){return this._queryConstraints}_getOperator(){return this.type==="and"?"and":"or"}}class Ua extends Ma{constructor(e,t){super(),this._field=e,this._direction=t,this.type="orderBy"}static _create(e,t){return new Ua(e,t)}_apply(e){const t=(function(i,r,a){if(i.startAt!==null)throw new x(S.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(i.endAt!==null)throw new x(S.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");return new Vs(r,a)})(e._query,this._field,this._direction);return new qt(e.firestore,e.converter,(function(i,r){const a=i.explicitOrderBy.concat([r]);return new jn(i.path,i.collectionGroup,a,i.filters.slice(),i.limit,i.limitType,i.startAt,i.endAt)})(e._query,t))}}function ov(n,e="asc"){const t=e,s=xa("orderBy",n);return Ua._create(s,t)}class Ba extends Ma{constructor(e,t,s){super(),this.type=e,this._limit=t,this._limitType=s}static _create(e,t,s){return new Ba(e,t,s)}_apply(e){return new qt(e.firestore,e.converter,Bi(e._query,this._limit,this._limitType))}}function av(n){return Ba._create("limit",n,"F")}function Au(n,e,t){if(typeof(t=Ye(t))=="string"){if(t==="")throw new x(S.INVALID_ARGUMENT,"Invalid query. When querying with documentId(), you must provide a valid document ID, but it was an empty string.");if(!sd(e)&&t.indexOf("/")!==-1)throw new x(S.INVALID_ARGUMENT,`Invalid query. When querying a collection by documentId(), you must provide a plain document ID, but '${t}' contains a '/' character.`);const s=e.path.child(se.fromString(t));if(!M.isDocumentKey(s))throw new x(S.INVALID_ARGUMENT,`Invalid query. When querying a collection group by documentId(), the value provided must result in a valid document path, but '${s}' is not because it has an odd number of segments (${s.length}).`);return jc(n,new M(s))}if(t instanceof ge)return jc(n,t._key);throw new x(S.INVALID_ARGUMENT,`Invalid query. When querying with documentId(), you must provide a valid string or a DocumentReference, but it was: ${lr(t)}.`)}function Ru(n,e){if(!Array.isArray(n)||n.length===0)throw new x(S.INVALID_ARGUMENT,`Invalid Query. A non-empty array is required for '${e.toString()}' filters.`)}function of(n,e){const t=(function(i,r){for(const a of i)for(const l of a.getFlattenedFilters())if(r.indexOf(l.op)>=0)return l.op;return null})(n.filters,(function(i){switch(i){case"!=":return["!=","not-in"];case"array-contains-any":case"in":return["not-in"];case"not-in":return["array-contains-any","in","not-in","!="];default:return[]}})(e.op));if(t!==null)throw t===e.op?new x(S.INVALID_ARGUMENT,`Invalid query. You cannot use more than one '${e.op.toString()}' filter.`):new x(S.INVALID_ARGUMENT,`Invalid query. You cannot use '${e.op.toString()}' filters with '${t.toString()}' filters.`)}class lv{convertValue(e,t="none"){switch(Ot(e)){case 0:return null;case 1:return e.booleanValue;case 2:return ce(e.integerValue||e.doubleValue);case 3:return this.convertTimestamp(e.timestampValue);case 4:return this.convertServerTimestamp(e,t);case 5:return e.stringValue;case 6:return this.convertBytes(xt(e.bytesValue));case 7:return this.convertReference(e.referenceValue);case 8:return this.convertGeoPoint(e.geoPointValue);case 9:return this.convertArray(e.arrayValue,t);case 11:return this.convertObject(e.mapValue,t);case 10:return this.convertVectorValue(e.mapValue);default:throw F(62114,{value:e})}}convertObject(e,t){return this.convertObjectMap(e.fields,t)}convertObjectMap(e,t="none"){const s={};return rn(e,((i,r)=>{s[i]=this.convertValue(r,t)})),s}convertVectorValue(e){const t=e.fields?.[Fi].arrayValue?.values?.map((s=>ce(s.doubleValue)));return new rt(t)}convertGeoPoint(e){return new it(ce(e.latitude),ce(e.longitude))}convertArray(e,t){return(e.values||[]).map((s=>this.convertValue(s,t)))}convertServerTimestamp(e,t){switch(t){case"previous":const s=hr(e);return s==null?null:this.convertValue(s,t);case"estimate":return this.convertTimestamp(Ns(e));default:return null}}convertTimestamp(e){const t=Vt(e);return new oe(t.seconds,t.nanos)}convertDocumentKey(e,t){const s=se.fromString(e);Z(Ad(s),9688,{name:e});const i=new Ds(s.get(1),s.get(3)),r=new M(s.popFirst(5));return i.isEqual(t)||ht(`Document ${r} contains a document reference within a different database (${i.projectId}/${i.database}) which is not supported. It will be treated as a reference in the current database (${t.projectId}/${t.database}) instead.`),r}}function cv(n,e,t){let s;return s=n?t&&(t.merge||t.mergeFields)?n.toFirestore(e,t):n.toFirestore(e):e,s}class wi{constructor(e,t){this.hasPendingWrites=e,this.fromCache=t}isEqual(e){return this.hasPendingWrites===e.hasPendingWrites&&this.fromCache===e.fromCache}}class Tn extends rf{constructor(e,t,s,i,r,a){super(e,t,s,i,a),this._firestore=e,this._firestoreImpl=e,this.metadata=r}exists(){return super.exists()}data(e={}){if(this._document){if(this._converter){const t=new Di(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(t,e)}return this._userDataWriter.convertValue(this._document.data.value,e.serverTimestamps)}}get(e,t={}){if(this._document){const s=this._document.data.field(xa("DocumentSnapshot.get",e));if(s!==null)return this._userDataWriter.convertValue(s,t.serverTimestamps)}}toJSON(){if(this.metadata.hasPendingWrites)throw new x(S.FAILED_PRECONDITION,"DocumentSnapshot.toJSON() attempted to serialize a document with pending writes. Await waitForPendingWrites() before invoking toJSON().");const e=this._document,t={};return t.type=Tn._jsonSchemaVersion,t.bundle="",t.bundleSource="DocumentSnapshot",t.bundleName=this._key.toString(),!e||!e.isValidDocument()||!e.isFoundDocument()?t:(this._userDataWriter.convertObjectMap(e.data.value.mapValue.fields,"previous"),t.bundle=(this._firestore,this.ref.path,"NOT SUPPORTED"),t)}}Tn._jsonSchemaVersion="firestore/documentSnapshot/1.0",Tn._jsonSchema={type:de("string",Tn._jsonSchemaVersion),bundleSource:de("string","DocumentSnapshot"),bundleName:de("string"),bundle:de("string")};class Di extends Tn{data(e={}){return super.data(e)}}class In{constructor(e,t,s,i){this._firestore=e,this._userDataWriter=t,this._snapshot=i,this.metadata=new wi(i.hasPendingWrites,i.fromCache),this.query=s}get docs(){const e=[];return this.forEach((t=>e.push(t))),e}get size(){return this._snapshot.docs.size}get empty(){return this.size===0}forEach(e,t){this._snapshot.docs.forEach((s=>{e.call(t,new Di(this._firestore,this._userDataWriter,s.key,s,new wi(this._snapshot.mutatedKeys.has(s.key),this._snapshot.fromCache),this.query.converter))}))}docChanges(e={}){const t=!!e.includeMetadataChanges;if(t&&this._snapshot.excludesMetadataChanges)throw new x(S.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===t||(this._cachedChanges=(function(i,r){if(i._snapshot.oldDocs.isEmpty()){let a=0;return i._snapshot.docChanges.map((l=>{const u=new Di(i._firestore,i._userDataWriter,l.doc.key,l.doc,new wi(i._snapshot.mutatedKeys.has(l.doc.key),i._snapshot.fromCache),i.query.converter);return l.doc,{type:"added",doc:u,oldIndex:-1,newIndex:a++}}))}{let a=i._snapshot.oldDocs;return i._snapshot.docChanges.filter((l=>r||l.type!==3)).map((l=>{const u=new Di(i._firestore,i._userDataWriter,l.doc.key,l.doc,new wi(i._snapshot.mutatedKeys.has(l.doc.key),i._snapshot.fromCache),i.query.converter);let h=-1,f=-1;return l.type!==0&&(h=a.indexOf(l.doc.key),a=a.delete(l.doc.key)),l.type!==1&&(a=a.add(l.doc),f=a.indexOf(l.doc.key)),{type:uv(l.type),doc:u,oldIndex:h,newIndex:f}}))}})(this,t),this._cachedChangesIncludeMetadataChanges=t),this._cachedChanges}toJSON(){if(this.metadata.hasPendingWrites)throw new x(S.FAILED_PRECONDITION,"QuerySnapshot.toJSON() attempted to serialize a document with pending writes. Await waitForPendingWrites() before invoking toJSON().");const e={};e.type=In._jsonSchemaVersion,e.bundleSource="QuerySnapshot",e.bundleName=oa.newId(),this._firestore._databaseId.database,this._firestore._databaseId.projectId;const t=[],s=[],i=[];return this.docs.forEach((r=>{r._document!==null&&(t.push(r._document),s.push(this._userDataWriter.convertObjectMap(r._document.data.value.mapValue.fields,"previous")),i.push(r.ref.path))})),e.bundle=(this._firestore,this.query._query,e.bundleName,"NOT SUPPORTED"),e}}function uv(n){switch(n){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return F(61501,{type:n})}}In._jsonSchemaVersion="firestore/querySnapshot/1.0",In._jsonSchema={type:de("string",In._jsonSchemaVersion),bundleSource:de("string","QuerySnapshot"),bundleName:de("string"),bundle:de("string")};class hv extends lv{constructor(e){super(),this.firestore=e}convertBytes(e){return new $e(e)}convertReference(e){const t=this.convertDocumentKey(e,this.firestore._databaseId);return new ge(this.firestore,null,t)}}function af(n){n=bn(n,qt);const e=bn(n.firestore,Tr),t=Yd(e),s=new hv(e);return iv(n._query),zE(t,n._query).then((i=>new In(e,s,n,i)))}function lf(n,e,t){n=bn(n,ge);const s=bn(n.firestore,Tr),i=cv(n.converter,e,t);return cf(s,[JE(Zd(s),"setDoc",n._key,i,n.converter!==null,t).toMutation(n._key,nt.none())])}function dv(n){return cf(bn(n.firestore,Tr),[new fa(n._key,nt.none())])}function cf(n,e){return(function(s,i){const r=new St;return s.asyncQueue.enqueueAndForget((async()=>DE(await WE(s),i,r))),r.promise})(Yd(n),e)}(function(e,t=!0){(function(i){Un=i})(Ah),Ss(new Rn("firestore",((s,{instanceIdentifier:i,options:r})=>{const a=s.getProvider("app").getImmediate(),l=new Tr(new Qm(s.getProvider("auth-internal")),new Jm(a,s.getProvider("app-check-internal")),(function(h,f){if(!Object.prototype.hasOwnProperty.apply(h.options,["projectId"]))throw new x(S.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new Ds(h.options.projectId,f)})(a,i),a);return r={useFetchStreams:t,...r},l._setSettings(r),l}),"PUBLIC").setMultipleInstances(!0)),At(bc,Nc,e),At(bc,Nc,"esm2020")})();var Su={};const Pu="@firebase/database",bu="1.1.0";let uf="";function fv(n){uf=n}class pv{constructor(e){this.domStorage_=e,this.prefix_="firebase:"}set(e,t){t==null?this.domStorage_.removeItem(this.prefixedName_(e)):this.domStorage_.setItem(this.prefixedName_(e),_e(t))}get(e){const t=this.domStorage_.getItem(this.prefixedName_(e));return t==null?null:As(t)}remove(e){this.domStorage_.removeItem(this.prefixedName_(e))}prefixedName_(e){return this.prefix_+e}toString(){return this.domStorage_.toString()}}class _v{constructor(){this.cache_={},this.isInMemoryStorage=!0}set(e,t){t==null?delete this.cache_[e]:this.cache_[e]=t}get(e){return pt(this.cache_,e)?this.cache_[e]:null}remove(e){delete this.cache_[e]}}const hf=function(n){try{if(typeof window<"u"&&typeof window[n]<"u"){const e=window[n];return e.setItem("firebase:sentinel","cache"),e.removeItem("firebase:sentinel"),new pv(e)}}catch{}return new _v},Jt=hf("localStorage"),mv=hf("sessionStorage");const wn=new sa("@firebase/database"),gv=(function(){let n=1;return function(){return n++}})(),df=function(n){const e=M_(n),t=new O_;t.update(e);const s=t.digest();return ea.encodeByteArray(s)},Ys=function(...n){let e="";for(let t=0;t<n.length;t++){const s=n[t];Array.isArray(s)||s&&typeof s=="object"&&typeof s.length=="number"?e+=Ys.apply(null,s):typeof s=="object"?e+=_e(s):e+=s,e+=" "}return e};let vs=null,Nu=!0;const yv=function(n,e){D(!0,"Can't turn on custom loggers persistently."),wn.logLevel=Q.VERBOSE,vs=wn.log.bind(wn)},ke=function(...n){if(Nu===!0&&(Nu=!1,vs===null&&mv.get("logging_enabled")===!0&&yv()),vs){const e=Ys.apply(null,n);vs(e)}},Xs=function(n){return function(...e){ke(n,...e)}},qo=function(...n){const e="FIREBASE INTERNAL ERROR: "+Ys(...n);wn.error(e)},ft=function(...n){const e=`FIREBASE FATAL ERROR: ${Ys(...n)}`;throw wn.error(e),new Error(e)},je=function(...n){const e="FIREBASE WARNING: "+Ys(...n);wn.warn(e)},Ev=function(){typeof window<"u"&&window.location&&window.location.protocol&&window.location.protocol.indexOf("https:")!==-1&&je("Insecure Firebase access from a secure page. Please use https in calls to new Firebase().")},ff=function(n){return typeof n=="number"&&(n!==n||n===Number.POSITIVE_INFINITY||n===Number.NEGATIVE_INFINITY)},vv=function(n){if(document.readyState==="complete")n();else{let e=!1;const t=function(){if(!document.body){setTimeout(t,Math.floor(10));return}e||(e=!0,n())};document.addEventListener?(document.addEventListener("DOMContentLoaded",t,!1),window.addEventListener("load",t,!1)):document.attachEvent&&(document.attachEvent("onreadystatechange",()=>{document.readyState==="complete"&&t()}),window.attachEvent("onload",t))}},xn="[MIN_NAME]",tn="[MAX_NAME]",$n=function(n,e){if(n===e)return 0;if(n===xn||e===tn)return-1;if(e===xn||n===tn)return 1;{const t=Du(n),s=Du(e);return t!==null?s!==null?t-s===0?n.length-e.length:t-s:-1:s!==null?1:n<e?-1:1}},Tv=function(n,e){return n===e?0:n<e?-1:1},ls=function(n,e){if(e&&n in e)return e[n];throw new Error("Missing required key ("+n+") in object: "+_e(e))},qa=function(n){if(typeof n!="object"||n===null)return _e(n);const e=[];for(const s in n)e.push(s);e.sort();let t="{";for(let s=0;s<e.length;s++)s!==0&&(t+=","),t+=_e(e[s]),t+=":",t+=qa(n[e[s]]);return t+="}",t},pf=function(n,e){const t=n.length;if(t<=e)return[n];const s=[];for(let i=0;i<t;i+=e)i+e>t?s.push(n.substring(i,t)):s.push(n.substring(i,i+e));return s};function Be(n,e){for(const t in n)n.hasOwnProperty(t)&&e(t,n[t])}const _f=function(n){D(!ff(n),"Invalid JSON number");const e=11,t=52,s=(1<<e-1)-1;let i,r,a,l,u;n===0?(r=0,a=0,i=1/n===-1/0?1:0):(i=n<0,n=Math.abs(n),n>=Math.pow(2,1-s)?(l=Math.min(Math.floor(Math.log(n)/Math.LN2),s),r=l+s,a=Math.round(n*Math.pow(2,t-l)-Math.pow(2,t))):(r=0,a=Math.round(n/Math.pow(2,1-s-t))));const h=[];for(u=t;u;u-=1)h.push(a%2?1:0),a=Math.floor(a/2);for(u=e;u;u-=1)h.push(r%2?1:0),r=Math.floor(r/2);h.push(i?1:0),h.reverse();const f=h.join("");let p="";for(u=0;u<64;u+=8){let m=parseInt(f.substr(u,8),2).toString(16);m.length===1&&(m="0"+m),p=p+m}return p.toLowerCase()},Iv=function(){return!!(typeof window=="object"&&window.chrome&&window.chrome.extension&&!/^chrome/.test(window.location.href))},wv=function(){return typeof Windows=="object"&&typeof Windows.UI=="object"};function Cv(n,e){let t="Unknown Error";n==="too_big"?t="The data requested exceeds the maximum size that can be accessed with a single request.":n==="permission_denied"?t="Client doesn't have permission to access the desired data.":n==="unavailable"&&(t="The service is unavailable");const s=new Error(n+" at "+e._path.toString()+": "+t);return s.code=n.toUpperCase(),s}const Av=new RegExp("^-?(0*)\\d{1,10}$"),Rv=-2147483648,Sv=2147483647,Du=function(n){if(Av.test(n)){const e=Number(n);if(e>=Rv&&e<=Sv)return e}return null},Js=function(n){try{n()}catch(e){setTimeout(()=>{const t=e.stack||"";throw je("Exception was thrown by user callback.",t),e},Math.floor(0))}},Pv=function(){return(typeof window=="object"&&window.navigator&&window.navigator.userAgent||"").search(/googlebot|google webmaster tools|bingbot|yahoo! slurp|baiduspider|yandexbot|duckduckbot/i)>=0},Ts=function(n,e){const t=setTimeout(n,e);return typeof t=="number"&&typeof Deno<"u"&&Deno.unrefTimer?Deno.unrefTimer(t):typeof t=="object"&&t.unref&&t.unref(),t};class bv{constructor(e,t){this.appCheckProvider=t,this.appName=e.name,Ch(e)&&e.settings.appCheckToken&&(this.serverAppAppCheckToken=e.settings.appCheckToken),this.appCheck=t?.getImmediate({optional:!0}),this.appCheck||t?.get().then(s=>this.appCheck=s)}getToken(e){if(this.serverAppAppCheckToken){if(e)throw new Error("Attempted reuse of `FirebaseServerApp.appCheckToken` after previous usage failed.");return Promise.resolve({token:this.serverAppAppCheckToken})}return this.appCheck?this.appCheck.getToken(e):new Promise((t,s)=>{setTimeout(()=>{this.appCheck?this.getToken(e).then(t,s):t(null)},0)})}addTokenChangeListener(e){this.appCheckProvider?.get().then(t=>t.addTokenListener(e))}notifyForInvalidToken(){je(`Provided AppCheck credentials for the app named "${this.appName}" are invalid. This usually indicates your app was not initialized correctly.`)}}class Nv{constructor(e,t,s){this.appName_=e,this.firebaseOptions_=t,this.authProvider_=s,this.auth_=null,this.auth_=s.getImmediate({optional:!0}),this.auth_||s.onInit(i=>this.auth_=i)}getToken(e){return this.auth_?this.auth_.getToken(e).catch(t=>t&&t.code==="auth/token-not-initialized"?(ke("Got auth/token-not-initialized error.  Treating as null token."),null):Promise.reject(t)):new Promise((t,s)=>{setTimeout(()=>{this.auth_?this.getToken(e).then(t,s):t(null)},0)})}addTokenChangeListener(e){this.auth_?this.auth_.addAuthTokenListener(e):this.authProvider_.get().then(t=>t.addAuthTokenListener(e))}removeTokenChangeListener(e){this.authProvider_.get().then(t=>t.removeAuthTokenListener(e))}notifyForInvalidToken(){let e='Provided authentication credentials for the app named "'+this.appName_+'" are invalid. This usually indicates your app was not initialized correctly. ';"credential"in this.firebaseOptions_?e+='Make sure the "credential" property provided to initializeApp() is authorized to access the specified "databaseURL" and is from the correct project.':"serviceAccount"in this.firebaseOptions_?e+='Make sure the "serviceAccount" property provided to initializeApp() is authorized to access the specified "databaseURL" and is from the correct project.':e+='Make sure the "apiKey" and "databaseURL" properties provided to initializeApp() match the values provided for your app at https://console.firebase.google.com/.',je(e)}}class ki{constructor(e){this.accessToken=e}getToken(e){return Promise.resolve({accessToken:this.accessToken})}addTokenChangeListener(e){e(this.accessToken)}removeTokenChangeListener(e){}notifyForInvalidToken(){}}ki.OWNER="owner";const ja="5",mf="v",gf="s",yf="r",Ef="f",vf=/(console\.firebase|firebase-console-\w+\.corp|firebase\.corp)\.google\.com/,Tf="ls",If="p",jo="ac",wf="websocket",Cf="long_polling";class Af{constructor(e,t,s,i,r=!1,a="",l=!1,u=!1,h=null){this.secure=t,this.namespace=s,this.webSocketOnly=i,this.nodeAdmin=r,this.persistenceKey=a,this.includeNamespaceInQueryParams=l,this.isUsingEmulator=u,this.emulatorOptions=h,this._host=e.toLowerCase(),this._domain=this._host.substr(this._host.indexOf(".")+1),this.internalHost=Jt.get("host:"+e)||this._host}isCacheableHost(){return this.internalHost.substr(0,2)==="s-"}isCustomHost(){return this._domain!=="firebaseio.com"&&this._domain!=="firebaseio-demo.com"}get host(){return this._host}set host(e){e!==this.internalHost&&(this.internalHost=e,this.isCacheableHost()&&Jt.set("host:"+this._host,this.internalHost))}toString(){let e=this.toURLString();return this.persistenceKey&&(e+="<"+this.persistenceKey+">"),e}toURLString(){const e=this.secure?"https://":"http://",t=this.includeNamespaceInQueryParams?`?ns=${this.namespace}`:"";return`${e}${this.host}/${t}`}}function Dv(n){return n.host!==n.internalHost||n.isCustomHost()||n.includeNamespaceInQueryParams}function Rf(n,e,t){D(typeof e=="string","typeof type must == string"),D(typeof t=="object","typeof params must == object");let s;if(e===wf)s=(n.secure?"wss://":"ws://")+n.internalHost+"/.ws?";else if(e===Cf)s=(n.secure?"https://":"http://")+n.internalHost+"/.lp?";else throw new Error("Unknown connection type: "+e);Dv(n)&&(t.ns=n.namespace);const i=[];return Be(t,(r,a)=>{i.push(r+"="+a)}),s+i.join("&")}class kv{constructor(){this.counters_={}}incrementCounter(e,t=1){pt(this.counters_,e)||(this.counters_[e]=0),this.counters_[e]+=t}get(){return p_(this.counters_)}}const uo={},ho={};function Wa(n){const e=n.toString();return uo[e]||(uo[e]=new kv),uo[e]}function Vv(n,e){const t=n.toString();return ho[t]||(ho[t]=e()),ho[t]}class xv{constructor(e){this.onMessage_=e,this.pendingResponses=[],this.currentResponseNum=0,this.closeAfterResponse=-1,this.onClose=null}closeAfter(e,t){this.closeAfterResponse=e,this.onClose=t,this.closeAfterResponse<this.currentResponseNum&&(this.onClose(),this.onClose=null)}handleResponse(e,t){for(this.pendingResponses[e]=t;this.pendingResponses[this.currentResponseNum];){const s=this.pendingResponses[this.currentResponseNum];delete this.pendingResponses[this.currentResponseNum];for(let i=0;i<s.length;++i)s[i]&&Js(()=>{this.onMessage_(s[i])});if(this.currentResponseNum===this.closeAfterResponse){this.onClose&&(this.onClose(),this.onClose=null);break}this.currentResponseNum++}}}const ku="start",Ov="close",Mv="pLPCommand",Lv="pRTLPCB",Sf="id",Pf="pw",bf="ser",Fv="cb",Uv="seg",Bv="ts",qv="d",jv="dframe",Nf=1870,Df=30,Wv=Nf-Df,$v=25e3,zv=3e4;class yn{constructor(e,t,s,i,r,a,l){this.connId=e,this.repoInfo=t,this.applicationId=s,this.appCheckToken=i,this.authToken=r,this.transportSessionId=a,this.lastSessionId=l,this.bytesSent=0,this.bytesReceived=0,this.everConnected_=!1,this.log_=Xs(e),this.stats_=Wa(t),this.urlFn=u=>(this.appCheckToken&&(u[jo]=this.appCheckToken),Rf(t,Cf,u))}open(e,t){this.curSegmentNum=0,this.onDisconnect_=t,this.myPacketOrderer=new xv(e),this.isClosed_=!1,this.connectTimeoutTimer_=setTimeout(()=>{this.log_("Timed out trying to connect."),this.onClosed_(),this.connectTimeoutTimer_=null},Math.floor(zv)),vv(()=>{if(this.isClosed_)return;this.scriptTagHolder=new $a((...r)=>{const[a,l,u,h,f]=r;if(this.incrementIncomingBytes_(r),!!this.scriptTagHolder)if(this.connectTimeoutTimer_&&(clearTimeout(this.connectTimeoutTimer_),this.connectTimeoutTimer_=null),this.everConnected_=!0,a===ku)this.id=l,this.password=u;else if(a===Ov)l?(this.scriptTagHolder.sendNewPolls=!1,this.myPacketOrderer.closeAfter(l,()=>{this.onClosed_()})):this.onClosed_();else throw new Error("Unrecognized command received: "+a)},(...r)=>{const[a,l]=r;this.incrementIncomingBytes_(r),this.myPacketOrderer.handleResponse(a,l)},()=>{this.onClosed_()},this.urlFn);const s={};s[ku]="t",s[bf]=Math.floor(Math.random()*1e8),this.scriptTagHolder.uniqueCallbackIdentifier&&(s[Fv]=this.scriptTagHolder.uniqueCallbackIdentifier),s[mf]=ja,this.transportSessionId&&(s[gf]=this.transportSessionId),this.lastSessionId&&(s[Tf]=this.lastSessionId),this.applicationId&&(s[If]=this.applicationId),this.appCheckToken&&(s[jo]=this.appCheckToken),typeof location<"u"&&location.hostname&&vf.test(location.hostname)&&(s[yf]=Ef);const i=this.urlFn(s);this.log_("Connecting via long-poll to "+i),this.scriptTagHolder.addTag(i,()=>{})})}start(){this.scriptTagHolder.startLongPoll(this.id,this.password),this.addDisconnectPingFrame(this.id,this.password)}static forceAllow(){yn.forceAllow_=!0}static forceDisallow(){yn.forceDisallow_=!0}static isAvailable(){return yn.forceAllow_?!0:!yn.forceDisallow_&&typeof document<"u"&&document.createElement!=null&&!Iv()&&!wv()}markConnectionHealthy(){}shutdown_(){this.isClosed_=!0,this.scriptTagHolder&&(this.scriptTagHolder.close(),this.scriptTagHolder=null),this.myDisconnFrame&&(document.body.removeChild(this.myDisconnFrame),this.myDisconnFrame=null),this.connectTimeoutTimer_&&(clearTimeout(this.connectTimeoutTimer_),this.connectTimeoutTimer_=null)}onClosed_(){this.isClosed_||(this.log_("Longpoll is closing itself"),this.shutdown_(),this.onDisconnect_&&(this.onDisconnect_(this.everConnected_),this.onDisconnect_=null))}close(){this.isClosed_||(this.log_("Longpoll is being closed."),this.shutdown_())}send(e){const t=_e(e);this.bytesSent+=t.length,this.stats_.incrementCounter("bytes_sent",t.length);const s=ch(t),i=pf(s,Wv);for(let r=0;r<i.length;r++)this.scriptTagHolder.enqueueSegment(this.curSegmentNum,i.length,i[r]),this.curSegmentNum++}addDisconnectPingFrame(e,t){this.myDisconnFrame=document.createElement("iframe");const s={};s[jv]="t",s[Sf]=e,s[Pf]=t,this.myDisconnFrame.src=this.urlFn(s),this.myDisconnFrame.style.display="none",document.body.appendChild(this.myDisconnFrame)}incrementIncomingBytes_(e){const t=_e(e).length;this.bytesReceived+=t,this.stats_.incrementCounter("bytes_received",t)}}class $a{constructor(e,t,s,i){this.onDisconnect=s,this.urlFn=i,this.outstandingRequests=new Set,this.pendingSegs=[],this.currentSerial=Math.floor(Math.random()*1e8),this.sendNewPolls=!0;{this.uniqueCallbackIdentifier=gv(),window[Mv+this.uniqueCallbackIdentifier]=e,window[Lv+this.uniqueCallbackIdentifier]=t,this.myIFrame=$a.createIFrame_();let r="";this.myIFrame.src&&this.myIFrame.src.substr(0,11)==="javascript:"&&(r='<script>document.domain="'+document.domain+'";<\/script>');const a="<html><body>"+r+"</body></html>";try{this.myIFrame.doc.open(),this.myIFrame.doc.write(a),this.myIFrame.doc.close()}catch(l){ke("frame writing exception"),l.stack&&ke(l.stack),ke(l)}}}static createIFrame_(){const e=document.createElement("iframe");if(e.style.display="none",document.body){document.body.appendChild(e);try{e.contentWindow.document||ke("No IE domain setting required")}catch{const s=document.domain;e.src="javascript:void((function(){document.open();document.domain='"+s+"';document.close();})())"}}else throw"Document body has not initialized. Wait to initialize Firebase until after the document is ready.";return e.contentDocument?e.doc=e.contentDocument:e.contentWindow?e.doc=e.contentWindow.document:e.document&&(e.doc=e.document),e}close(){this.alive=!1,this.myIFrame&&(this.myIFrame.doc.body.textContent="",setTimeout(()=>{this.myIFrame!==null&&(document.body.removeChild(this.myIFrame),this.myIFrame=null)},Math.floor(0)));const e=this.onDisconnect;e&&(this.onDisconnect=null,e())}startLongPoll(e,t){for(this.myID=e,this.myPW=t,this.alive=!0;this.newRequest_(););}newRequest_(){if(this.alive&&this.sendNewPolls&&this.outstandingRequests.size<(this.pendingSegs.length>0?2:1)){this.currentSerial++;const e={};e[Sf]=this.myID,e[Pf]=this.myPW,e[bf]=this.currentSerial;let t=this.urlFn(e),s="",i=0;for(;this.pendingSegs.length>0&&this.pendingSegs[0].d.length+Df+s.length<=Nf;){const a=this.pendingSegs.shift();s=s+"&"+Uv+i+"="+a.seg+"&"+Bv+i+"="+a.ts+"&"+qv+i+"="+a.d,i++}return t=t+s,this.addLongPollTag_(t,this.currentSerial),!0}else return!1}enqueueSegment(e,t,s){this.pendingSegs.push({seg:e,ts:t,d:s}),this.alive&&this.newRequest_()}addLongPollTag_(e,t){this.outstandingRequests.add(t);const s=()=>{this.outstandingRequests.delete(t),this.newRequest_()},i=setTimeout(s,Math.floor($v)),r=()=>{clearTimeout(i),s()};this.addTag(e,r)}addTag(e,t){setTimeout(()=>{try{if(!this.sendNewPolls)return;const s=this.myIFrame.doc.createElement("script");s.type="text/javascript",s.async=!0,s.src=e,s.onload=s.onreadystatechange=function(){const i=s.readyState;(!i||i==="loaded"||i==="complete")&&(s.onload=s.onreadystatechange=null,s.parentNode&&s.parentNode.removeChild(s),t())},s.onerror=()=>{ke("Long-poll script failed to load: "+e),this.sendNewPolls=!1,this.close()},this.myIFrame.doc.body.appendChild(s)}catch{}},Math.floor(1))}}const Gv=16384,Hv=45e3;let Ki=null;typeof MozWebSocket<"u"?Ki=MozWebSocket:typeof WebSocket<"u"&&(Ki=WebSocket);class ze{constructor(e,t,s,i,r,a,l){this.connId=e,this.applicationId=s,this.appCheckToken=i,this.authToken=r,this.keepaliveTimer=null,this.frames=null,this.totalFrames=0,this.bytesSent=0,this.bytesReceived=0,this.log_=Xs(this.connId),this.stats_=Wa(t),this.connURL=ze.connectionURL_(t,a,l,i,s),this.nodeAdmin=t.nodeAdmin}static connectionURL_(e,t,s,i,r){const a={};return a[mf]=ja,typeof location<"u"&&location.hostname&&vf.test(location.hostname)&&(a[yf]=Ef),t&&(a[gf]=t),s&&(a[Tf]=s),i&&(a[jo]=i),r&&(a[If]=r),Rf(e,wf,a)}open(e,t){this.onDisconnect=t,this.onMessage=e,this.log_("Websocket connecting to "+this.connURL),this.everConnected_=!1,Jt.set("previous_websocket_failure",!0);try{let s;A_(),this.mySock=new Ki(this.connURL,[],s)}catch(s){this.log_("Error instantiating WebSocket.");const i=s.message||s.data;i&&this.log_(i),this.onClosed_();return}this.mySock.onopen=()=>{this.log_("Websocket connected."),this.everConnected_=!0},this.mySock.onclose=()=>{this.log_("Websocket connection was disconnected."),this.mySock=null,this.onClosed_()},this.mySock.onmessage=s=>{this.handleIncomingFrame(s)},this.mySock.onerror=s=>{this.log_("WebSocket error.  Closing connection.");const i=s.message||s.data;i&&this.log_(i),this.onClosed_()}}start(){}static forceDisallow(){ze.forceDisallow_=!0}static isAvailable(){let e=!1;if(typeof navigator<"u"&&navigator.userAgent){const t=/Android ([0-9]{0,}\.[0-9]{0,})/,s=navigator.userAgent.match(t);s&&s.length>1&&parseFloat(s[1])<4.4&&(e=!0)}return!e&&Ki!==null&&!ze.forceDisallow_}static previouslyFailed(){return Jt.isInMemoryStorage||Jt.get("previous_websocket_failure")===!0}markConnectionHealthy(){Jt.remove("previous_websocket_failure")}appendFrame_(e){if(this.frames.push(e),this.frames.length===this.totalFrames){const t=this.frames.join("");this.frames=null;const s=As(t);this.onMessage(s)}}handleNewFrameCount_(e){this.totalFrames=e,this.frames=[]}extractFrameCount_(e){if(D(this.frames===null,"We already have a frame buffer"),e.length<=6){const t=Number(e);if(!isNaN(t))return this.handleNewFrameCount_(t),null}return this.handleNewFrameCount_(1),e}handleIncomingFrame(e){if(this.mySock===null)return;const t=e.data;if(this.bytesReceived+=t.length,this.stats_.incrementCounter("bytes_received",t.length),this.resetKeepAlive(),this.frames!==null)this.appendFrame_(t);else{const s=this.extractFrameCount_(t);s!==null&&this.appendFrame_(s)}}send(e){this.resetKeepAlive();const t=_e(e);this.bytesSent+=t.length,this.stats_.incrementCounter("bytes_sent",t.length);const s=pf(t,Gv);s.length>1&&this.sendString_(String(s.length));for(let i=0;i<s.length;i++)this.sendString_(s[i])}shutdown_(){this.isClosed_=!0,this.keepaliveTimer&&(clearInterval(this.keepaliveTimer),this.keepaliveTimer=null),this.mySock&&(this.mySock.close(),this.mySock=null)}onClosed_(){this.isClosed_||(this.log_("WebSocket is closing itself"),this.shutdown_(),this.onDisconnect&&(this.onDisconnect(this.everConnected_),this.onDisconnect=null))}close(){this.isClosed_||(this.log_("WebSocket is being closed"),this.shutdown_())}resetKeepAlive(){clearInterval(this.keepaliveTimer),this.keepaliveTimer=setInterval(()=>{this.mySock&&this.sendString_("0"),this.resetKeepAlive()},Math.floor(Hv))}sendString_(e){try{this.mySock.send(e)}catch(t){this.log_("Exception thrown from WebSocket.send():",t.message||t.data,"Closing connection."),setTimeout(this.onClosed_.bind(this),0)}}}ze.responsesRequiredToBeHealthy=2;ze.healthyTimeout=3e4;class Ms{static get ALL_TRANSPORTS(){return[yn,ze]}static get IS_TRANSPORT_INITIALIZED(){return this.globalTransportInitialized_}constructor(e){this.initTransports_(e)}initTransports_(e){const t=ze&&ze.isAvailable();let s=t&&!ze.previouslyFailed();if(e.webSocketOnly&&(t||je("wss:// URL used, but browser isn't known to support websockets.  Trying anyway."),s=!0),s)this.transports_=[ze];else{const i=this.transports_=[];for(const r of Ms.ALL_TRANSPORTS)r&&r.isAvailable()&&i.push(r);Ms.globalTransportInitialized_=!0}}initialTransport(){if(this.transports_.length>0)return this.transports_[0];throw new Error("No transports available")}upgradeTransport(){return this.transports_.length>1?this.transports_[1]:null}}Ms.globalTransportInitialized_=!1;const Kv=6e4,Qv=5e3,Yv=10*1024,Xv=100*1024,fo="t",Vu="d",Jv="s",xu="r",Zv="e",Ou="o",Mu="a",Lu="n",Fu="p",eT="h";class tT{constructor(e,t,s,i,r,a,l,u,h,f){this.id=e,this.repoInfo_=t,this.applicationId_=s,this.appCheckToken_=i,this.authToken_=r,this.onMessage_=a,this.onReady_=l,this.onDisconnect_=u,this.onKill_=h,this.lastSessionId=f,this.connectionCount=0,this.pendingDataMessages=[],this.state_=0,this.log_=Xs("c:"+this.id+":"),this.transportManager_=new Ms(t),this.log_("Connection created"),this.start_()}start_(){const e=this.transportManager_.initialTransport();this.conn_=new e(this.nextTransportId_(),this.repoInfo_,this.applicationId_,this.appCheckToken_,this.authToken_,null,this.lastSessionId),this.primaryResponsesRequired_=e.responsesRequiredToBeHealthy||0;const t=this.connReceiver_(this.conn_),s=this.disconnReceiver_(this.conn_);this.tx_=this.conn_,this.rx_=this.conn_,this.secondaryConn_=null,this.isHealthy_=!1,setTimeout(()=>{this.conn_&&this.conn_.open(t,s)},Math.floor(0));const i=e.healthyTimeout||0;i>0&&(this.healthyTimeout_=Ts(()=>{this.healthyTimeout_=null,this.isHealthy_||(this.conn_&&this.conn_.bytesReceived>Xv?(this.log_("Connection exceeded healthy timeout but has received "+this.conn_.bytesReceived+" bytes.  Marking connection healthy."),this.isHealthy_=!0,this.conn_.markConnectionHealthy()):this.conn_&&this.conn_.bytesSent>Yv?this.log_("Connection exceeded healthy timeout but has sent "+this.conn_.bytesSent+" bytes.  Leaving connection alive."):(this.log_("Closing unhealthy connection after timeout."),this.close()))},Math.floor(i)))}nextTransportId_(){return"c:"+this.id+":"+this.connectionCount++}disconnReceiver_(e){return t=>{e===this.conn_?this.onConnectionLost_(t):e===this.secondaryConn_?(this.log_("Secondary connection lost."),this.onSecondaryConnectionLost_()):this.log_("closing an old connection")}}connReceiver_(e){return t=>{this.state_!==2&&(e===this.rx_?this.onPrimaryMessageReceived_(t):e===this.secondaryConn_?this.onSecondaryMessageReceived_(t):this.log_("message on old connection"))}}sendRequest(e){const t={t:"d",d:e};this.sendData_(t)}tryCleanupConnection(){this.tx_===this.secondaryConn_&&this.rx_===this.secondaryConn_&&(this.log_("cleaning up and promoting a connection: "+this.secondaryConn_.connId),this.conn_=this.secondaryConn_,this.secondaryConn_=null)}onSecondaryControl_(e){if(fo in e){const t=e[fo];t===Mu?this.upgradeIfSecondaryHealthy_():t===xu?(this.log_("Got a reset on secondary, closing it"),this.secondaryConn_.close(),(this.tx_===this.secondaryConn_||this.rx_===this.secondaryConn_)&&this.close()):t===Ou&&(this.log_("got pong on secondary."),this.secondaryResponsesRequired_--,this.upgradeIfSecondaryHealthy_())}}onSecondaryMessageReceived_(e){const t=ls("t",e),s=ls("d",e);if(t==="c")this.onSecondaryControl_(s);else if(t==="d")this.pendingDataMessages.push(s);else throw new Error("Unknown protocol layer: "+t)}upgradeIfSecondaryHealthy_(){this.secondaryResponsesRequired_<=0?(this.log_("Secondary connection is healthy."),this.isHealthy_=!0,this.secondaryConn_.markConnectionHealthy(),this.proceedWithUpgrade_()):(this.log_("sending ping on secondary."),this.secondaryConn_.send({t:"c",d:{t:Fu,d:{}}}))}proceedWithUpgrade_(){this.secondaryConn_.start(),this.log_("sending client ack on secondary"),this.secondaryConn_.send({t:"c",d:{t:Mu,d:{}}}),this.log_("Ending transmission on primary"),this.conn_.send({t:"c",d:{t:Lu,d:{}}}),this.tx_=this.secondaryConn_,this.tryCleanupConnection()}onPrimaryMessageReceived_(e){const t=ls("t",e),s=ls("d",e);t==="c"?this.onControl_(s):t==="d"&&this.onDataMessage_(s)}onDataMessage_(e){this.onPrimaryResponse_(),this.onMessage_(e)}onPrimaryResponse_(){this.isHealthy_||(this.primaryResponsesRequired_--,this.primaryResponsesRequired_<=0&&(this.log_("Primary connection is healthy."),this.isHealthy_=!0,this.conn_.markConnectionHealthy()))}onControl_(e){const t=ls(fo,e);if(Vu in e){const s=e[Vu];if(t===eT){const i={...s};this.repoInfo_.isUsingEmulator&&(i.h=this.repoInfo_.host),this.onHandshake_(i)}else if(t===Lu){this.log_("recvd end transmission on primary"),this.rx_=this.secondaryConn_;for(let i=0;i<this.pendingDataMessages.length;++i)this.onDataMessage_(this.pendingDataMessages[i]);this.pendingDataMessages=[],this.tryCleanupConnection()}else t===Jv?this.onConnectionShutdown_(s):t===xu?this.onReset_(s):t===Zv?qo("Server Error: "+s):t===Ou?(this.log_("got pong on primary."),this.onPrimaryResponse_(),this.sendPingOnPrimaryIfNecessary_()):qo("Unknown control packet command: "+t)}}onHandshake_(e){const t=e.ts,s=e.v,i=e.h;this.sessionId=e.s,this.repoInfo_.host=i,this.state_===0&&(this.conn_.start(),this.onConnectionEstablished_(this.conn_,t),ja!==s&&je("Protocol version mismatch detected"),this.tryStartUpgrade_())}tryStartUpgrade_(){const e=this.transportManager_.upgradeTransport();e&&this.startUpgrade_(e)}startUpgrade_(e){this.secondaryConn_=new e(this.nextTransportId_(),this.repoInfo_,this.applicationId_,this.appCheckToken_,this.authToken_,this.sessionId),this.secondaryResponsesRequired_=e.responsesRequiredToBeHealthy||0;const t=this.connReceiver_(this.secondaryConn_),s=this.disconnReceiver_(this.secondaryConn_);this.secondaryConn_.open(t,s),Ts(()=>{this.secondaryConn_&&(this.log_("Timed out trying to upgrade."),this.secondaryConn_.close())},Math.floor(Kv))}onReset_(e){this.log_("Reset packet received.  New host: "+e),this.repoInfo_.host=e,this.state_===1?this.close():(this.closeConnections_(),this.start_())}onConnectionEstablished_(e,t){this.log_("Realtime connection established."),this.conn_=e,this.state_=1,this.onReady_&&(this.onReady_(t,this.sessionId),this.onReady_=null),this.primaryResponsesRequired_===0?(this.log_("Primary connection is healthy."),this.isHealthy_=!0):Ts(()=>{this.sendPingOnPrimaryIfNecessary_()},Math.floor(Qv))}sendPingOnPrimaryIfNecessary_(){!this.isHealthy_&&this.state_===1&&(this.log_("sending ping on primary."),this.sendData_({t:"c",d:{t:Fu,d:{}}}))}onSecondaryConnectionLost_(){const e=this.secondaryConn_;this.secondaryConn_=null,(this.tx_===e||this.rx_===e)&&this.close()}onConnectionLost_(e){this.conn_=null,!e&&this.state_===0?(this.log_("Realtime connection failed."),this.repoInfo_.isCacheableHost()&&(Jt.remove("host:"+this.repoInfo_.host),this.repoInfo_.internalHost=this.repoInfo_.host)):this.state_===1&&this.log_("Realtime connection lost."),this.close()}onConnectionShutdown_(e){this.log_("Connection shutdown command received. Shutting down..."),this.onKill_&&(this.onKill_(e),this.onKill_=null),this.onDisconnect_=null,this.close()}sendData_(e){if(this.state_!==1)throw"Connection is not connected";this.tx_.send(e)}close(){this.state_!==2&&(this.log_("Closing realtime connection."),this.state_=2,this.closeConnections_(),this.onDisconnect_&&(this.onDisconnect_(),this.onDisconnect_=null))}closeConnections_(){this.log_("Shutting down all connections"),this.conn_&&(this.conn_.close(),this.conn_=null),this.secondaryConn_&&(this.secondaryConn_.close(),this.secondaryConn_=null),this.healthyTimeout_&&(clearTimeout(this.healthyTimeout_),this.healthyTimeout_=null)}}class kf{put(e,t,s,i){}merge(e,t,s,i){}refreshAuthToken(e){}refreshAppCheckToken(e){}onDisconnectPut(e,t,s){}onDisconnectMerge(e,t,s){}onDisconnectCancel(e,t){}reportStats(e){}}class Vf{constructor(e){this.allowedEvents_=e,this.listeners_={},D(Array.isArray(e)&&e.length>0,"Requires a non-empty array")}trigger(e,...t){if(Array.isArray(this.listeners_[e])){const s=[...this.listeners_[e]];for(let i=0;i<s.length;i++)s[i].callback.apply(s[i].context,t)}}on(e,t,s){this.validateEventType_(e),this.listeners_[e]=this.listeners_[e]||[],this.listeners_[e].push({callback:t,context:s});const i=this.getInitialEvent(e);i&&t.apply(s,i)}off(e,t,s){this.validateEventType_(e);const i=this.listeners_[e]||[];for(let r=0;r<i.length;r++)if(i[r].callback===t&&(!s||s===i[r].context)){i.splice(r,1);return}}validateEventType_(e){D(this.allowedEvents_.find(t=>t===e),"Unknown event: "+e)}}class Qi extends Vf{static getInstance(){return new Qi}constructor(){super(["online"]),this.online_=!0,typeof window<"u"&&typeof window.addEventListener<"u"&&!gh()&&(window.addEventListener("online",()=>{this.online_||(this.online_=!0,this.trigger("online",!0))},!1),window.addEventListener("offline",()=>{this.online_&&(this.online_=!1,this.trigger("online",!1))},!1))}getInitialEvent(e){return D(e==="online","Unknown event type: "+e),[this.online_]}currentlyOnline(){return this.online_}}const Uu=32,Bu=768;class te{constructor(e,t){if(t===void 0){this.pieces_=e.split("/");let s=0;for(let i=0;i<this.pieces_.length;i++)this.pieces_[i].length>0&&(this.pieces_[s]=this.pieces_[i],s++);this.pieces_.length=s,this.pieceNum_=0}else this.pieces_=e,this.pieceNum_=t}toString(){let e="";for(let t=this.pieceNum_;t<this.pieces_.length;t++)this.pieces_[t]!==""&&(e+="/"+this.pieces_[t]);return e||"/"}}function J(){return new te("")}function $(n){return n.pieceNum_>=n.pieces_.length?null:n.pieces_[n.pieceNum_]}function Ft(n){return n.pieces_.length-n.pieceNum_}function ne(n){let e=n.pieceNum_;return e<n.pieces_.length&&e++,new te(n.pieces_,e)}function xf(n){return n.pieceNum_<n.pieces_.length?n.pieces_[n.pieces_.length-1]:null}function nT(n){let e="";for(let t=n.pieceNum_;t<n.pieces_.length;t++)n.pieces_[t]!==""&&(e+="/"+encodeURIComponent(String(n.pieces_[t])));return e||"/"}function Of(n,e=0){return n.pieces_.slice(n.pieceNum_+e)}function Mf(n){if(n.pieceNum_>=n.pieces_.length)return null;const e=[];for(let t=n.pieceNum_;t<n.pieces_.length-1;t++)e.push(n.pieces_[t]);return new te(e,0)}function me(n,e){const t=[];for(let s=n.pieceNum_;s<n.pieces_.length;s++)t.push(n.pieces_[s]);if(e instanceof te)for(let s=e.pieceNum_;s<e.pieces_.length;s++)t.push(e.pieces_[s]);else{const s=e.split("/");for(let i=0;i<s.length;i++)s[i].length>0&&t.push(s[i])}return new te(t,0)}function z(n){return n.pieceNum_>=n.pieces_.length}function Oe(n,e){const t=$(n),s=$(e);if(t===null)return e;if(t===s)return Oe(ne(n),ne(e));throw new Error("INTERNAL ERROR: innerPath ("+e+") is not within outerPath ("+n+")")}function za(n,e){if(Ft(n)!==Ft(e))return!1;for(let t=n.pieceNum_,s=e.pieceNum_;t<=n.pieces_.length;t++,s++)if(n.pieces_[t]!==e.pieces_[s])return!1;return!0}function He(n,e){let t=n.pieceNum_,s=e.pieceNum_;if(Ft(n)>Ft(e))return!1;for(;t<n.pieces_.length;){if(n.pieces_[t]!==e.pieces_[s])return!1;++t,++s}return!0}class sT{constructor(e,t){this.errorPrefix_=t,this.parts_=Of(e,0),this.byteLength_=Math.max(1,this.parts_.length);for(let s=0;s<this.parts_.length;s++)this.byteLength_+=ar(this.parts_[s]);Lf(this)}}function iT(n,e){n.parts_.length>0&&(n.byteLength_+=1),n.parts_.push(e),n.byteLength_+=ar(e),Lf(n)}function rT(n){const e=n.parts_.pop();n.byteLength_-=ar(e),n.parts_.length>0&&(n.byteLength_-=1)}function Lf(n){if(n.byteLength_>Bu)throw new Error(n.errorPrefix_+"has a key path longer than "+Bu+" bytes ("+n.byteLength_+").");if(n.parts_.length>Uu)throw new Error(n.errorPrefix_+"path specified exceeds the maximum depth that can be written ("+Uu+") or object contains a cycle "+Yt(n))}function Yt(n){return n.parts_.length===0?"":"in property '"+n.parts_.join(".")+"'"}class Ga extends Vf{static getInstance(){return new Ga}constructor(){super(["visible"]);let e,t;typeof document<"u"&&typeof document.addEventListener<"u"&&(typeof document.hidden<"u"?(t="visibilitychange",e="hidden"):typeof document.mozHidden<"u"?(t="mozvisibilitychange",e="mozHidden"):typeof document.msHidden<"u"?(t="msvisibilitychange",e="msHidden"):typeof document.webkitHidden<"u"&&(t="webkitvisibilitychange",e="webkitHidden")),this.visible_=!0,t&&document.addEventListener(t,()=>{const s=!document[e];s!==this.visible_&&(this.visible_=s,this.trigger("visible",s))},!1)}getInitialEvent(e){return D(e==="visible","Unknown event type: "+e),[this.visible_]}}const cs=1e3,oT=300*1e3,qu=30*1e3,aT=1.3,lT=3e4,cT="server_kill",ju=3;class ct extends kf{constructor(e,t,s,i,r,a,l,u){if(super(),this.repoInfo_=e,this.applicationId_=t,this.onDataUpdate_=s,this.onConnectStatus_=i,this.onServerInfoUpdate_=r,this.authTokenProvider_=a,this.appCheckTokenProvider_=l,this.authOverride_=u,this.id=ct.nextPersistentConnectionId_++,this.log_=Xs("p:"+this.id+":"),this.interruptReasons_={},this.listens=new Map,this.outstandingPuts_=[],this.outstandingGets_=[],this.outstandingPutCount_=0,this.outstandingGetCount_=0,this.onDisconnectRequestQueue_=[],this.connected_=!1,this.reconnectDelay_=cs,this.maxReconnectDelay_=oT,this.securityDebugCallback_=null,this.lastSessionId=null,this.establishConnectionTimer_=null,this.visible_=!1,this.requestCBHash_={},this.requestNumber_=0,this.realtime_=null,this.authToken_=null,this.appCheckToken_=null,this.forceTokenRefresh_=!1,this.invalidAuthTokenCount_=0,this.invalidAppCheckTokenCount_=0,this.firstConnection_=!0,this.lastConnectionAttemptTime_=null,this.lastConnectionEstablishedTime_=null,u)throw new Error("Auth override specified in options, but not supported on non Node.js platforms");Ga.getInstance().on("visible",this.onVisible_,this),e.host.indexOf("fblocal")===-1&&Qi.getInstance().on("online",this.onOnline_,this)}sendRequest(e,t,s){const i=++this.requestNumber_,r={r:i,a:e,b:t};this.log_(_e(r)),D(this.connected_,"sendRequest call when we're not connected not allowed."),this.realtime_.sendRequest(r),s&&(this.requestCBHash_[i]=s)}get(e){this.initConnection_();const t=new na,i={action:"g",request:{p:e._path.toString(),q:e._queryObject},onComplete:a=>{const l=a.d;a.s==="ok"?t.resolve(l):t.reject(l)}};this.outstandingGets_.push(i),this.outstandingGetCount_++;const r=this.outstandingGets_.length-1;return this.connected_&&this.sendGet_(r),t.promise}listen(e,t,s,i){this.initConnection_();const r=e._queryIdentifier,a=e._path.toString();this.log_("Listen called for "+a+" "+r),this.listens.has(a)||this.listens.set(a,new Map),D(e._queryParams.isDefault()||!e._queryParams.loadsAllData(),"listen() called for non-default but complete query"),D(!this.listens.get(a).has(r),"listen() called twice for same path/queryId.");const l={onComplete:i,hashFn:t,query:e,tag:s};this.listens.get(a).set(r,l),this.connected_&&this.sendListen_(l)}sendGet_(e){const t=this.outstandingGets_[e];this.sendRequest("g",t.request,s=>{delete this.outstandingGets_[e],this.outstandingGetCount_--,this.outstandingGetCount_===0&&(this.outstandingGets_=[]),t.onComplete&&t.onComplete(s)})}sendListen_(e){const t=e.query,s=t._path.toString(),i=t._queryIdentifier;this.log_("Listen on "+s+" for "+i);const r={p:s},a="q";e.tag&&(r.q=t._queryObject,r.t=e.tag),r.h=e.hashFn(),this.sendRequest(a,r,l=>{const u=l.d,h=l.s;ct.warnOnListenWarnings_(u,t),(this.listens.get(s)&&this.listens.get(s).get(i))===e&&(this.log_("listen response",l),h!=="ok"&&this.removeListen_(s,i),e.onComplete&&e.onComplete(h,u))})}static warnOnListenWarnings_(e,t){if(e&&typeof e=="object"&&pt(e,"w")){const s=An(e,"w");if(Array.isArray(s)&&~s.indexOf("no_index")){const i='".indexOn": "'+t._queryParams.getIndex().toString()+'"',r=t._path.toString();je(`Using an unspecified index. Your data will be downloaded and filtered on the client. Consider adding ${i} at ${r} to your security rules for better performance.`)}}}refreshAuthToken(e){this.authToken_=e,this.log_("Auth token refreshed"),this.authToken_?this.tryAuth():this.connected_&&this.sendRequest("unauth",{},()=>{}),this.reduceReconnectDelayIfAdminCredential_(e)}reduceReconnectDelayIfAdminCredential_(e){(e&&e.length===40||V_(e))&&(this.log_("Admin auth credential detected.  Reducing max reconnect time."),this.maxReconnectDelay_=qu)}refreshAppCheckToken(e){this.appCheckToken_=e,this.log_("App check token refreshed"),this.appCheckToken_?this.tryAppCheck():this.connected_&&this.sendRequest("unappeck",{},()=>{})}tryAuth(){if(this.connected_&&this.authToken_){const e=this.authToken_,t=k_(e)?"auth":"gauth",s={cred:e};this.authOverride_===null?s.noauth=!0:typeof this.authOverride_=="object"&&(s.authvar=this.authOverride_),this.sendRequest(t,s,i=>{const r=i.s,a=i.d||"error";this.authToken_===e&&(r==="ok"?this.invalidAuthTokenCount_=0:this.onAuthRevoked_(r,a))})}}tryAppCheck(){this.connected_&&this.appCheckToken_&&this.sendRequest("appcheck",{token:this.appCheckToken_},e=>{const t=e.s,s=e.d||"error";t==="ok"?this.invalidAppCheckTokenCount_=0:this.onAppCheckRevoked_(t,s)})}unlisten(e,t){const s=e._path.toString(),i=e._queryIdentifier;this.log_("Unlisten called for "+s+" "+i),D(e._queryParams.isDefault()||!e._queryParams.loadsAllData(),"unlisten() called for non-default but complete query"),this.removeListen_(s,i)&&this.connected_&&this.sendUnlisten_(s,i,e._queryObject,t)}sendUnlisten_(e,t,s,i){this.log_("Unlisten on "+e+" for "+t);const r={p:e},a="n";i&&(r.q=s,r.t=i),this.sendRequest(a,r)}onDisconnectPut(e,t,s){this.initConnection_(),this.connected_?this.sendOnDisconnect_("o",e,t,s):this.onDisconnectRequestQueue_.push({pathString:e,action:"o",data:t,onComplete:s})}onDisconnectMerge(e,t,s){this.initConnection_(),this.connected_?this.sendOnDisconnect_("om",e,t,s):this.onDisconnectRequestQueue_.push({pathString:e,action:"om",data:t,onComplete:s})}onDisconnectCancel(e,t){this.initConnection_(),this.connected_?this.sendOnDisconnect_("oc",e,null,t):this.onDisconnectRequestQueue_.push({pathString:e,action:"oc",data:null,onComplete:t})}sendOnDisconnect_(e,t,s,i){const r={p:t,d:s};this.log_("onDisconnect "+e,r),this.sendRequest(e,r,a=>{i&&setTimeout(()=>{i(a.s,a.d)},Math.floor(0))})}put(e,t,s,i){this.putInternal("p",e,t,s,i)}merge(e,t,s,i){this.putInternal("m",e,t,s,i)}putInternal(e,t,s,i,r){this.initConnection_();const a={p:t,d:s};r!==void 0&&(a.h=r),this.outstandingPuts_.push({action:e,request:a,onComplete:i}),this.outstandingPutCount_++;const l=this.outstandingPuts_.length-1;this.connected_?this.sendPut_(l):this.log_("Buffering put: "+t)}sendPut_(e){const t=this.outstandingPuts_[e].action,s=this.outstandingPuts_[e].request,i=this.outstandingPuts_[e].onComplete;this.outstandingPuts_[e].queued=this.connected_,this.sendRequest(t,s,r=>{this.log_(t+" response",r),delete this.outstandingPuts_[e],this.outstandingPutCount_--,this.outstandingPutCount_===0&&(this.outstandingPuts_=[]),i&&i(r.s,r.d)})}reportStats(e){if(this.connected_){const t={c:e};this.log_("reportStats",t),this.sendRequest("s",t,s=>{if(s.s!=="ok"){const r=s.d;this.log_("reportStats","Error sending stats: "+r)}})}}onDataMessage_(e){if("r"in e){this.log_("from server: "+_e(e));const t=e.r,s=this.requestCBHash_[t];s&&(delete this.requestCBHash_[t],s(e.b))}else{if("error"in e)throw"A server-side error has occurred: "+e.error;"a"in e&&this.onDataPush_(e.a,e.b)}}onDataPush_(e,t){this.log_("handleServerMessage",e,t),e==="d"?this.onDataUpdate_(t.p,t.d,!1,t.t):e==="m"?this.onDataUpdate_(t.p,t.d,!0,t.t):e==="c"?this.onListenRevoked_(t.p,t.q):e==="ac"?this.onAuthRevoked_(t.s,t.d):e==="apc"?this.onAppCheckRevoked_(t.s,t.d):e==="sd"?this.onSecurityDebugPacket_(t):qo("Unrecognized action received from server: "+_e(e)+`
Are you using the latest client?`)}onReady_(e,t){this.log_("connection ready"),this.connected_=!0,this.lastConnectionEstablishedTime_=new Date().getTime(),this.handleTimestamp_(e),this.lastSessionId=t,this.firstConnection_&&this.sendConnectStats_(),this.restoreState_(),this.firstConnection_=!1,this.onConnectStatus_(!0)}scheduleConnect_(e){D(!this.realtime_,"Scheduling a connect when we're already connected/ing?"),this.establishConnectionTimer_&&clearTimeout(this.establishConnectionTimer_),this.establishConnectionTimer_=setTimeout(()=>{this.establishConnectionTimer_=null,this.establishConnection_()},Math.floor(e))}initConnection_(){!this.realtime_&&this.firstConnection_&&this.scheduleConnect_(0)}onVisible_(e){e&&!this.visible_&&this.reconnectDelay_===this.maxReconnectDelay_&&(this.log_("Window became visible.  Reducing delay."),this.reconnectDelay_=cs,this.realtime_||this.scheduleConnect_(0)),this.visible_=e}onOnline_(e){e?(this.log_("Browser went online."),this.reconnectDelay_=cs,this.realtime_||this.scheduleConnect_(0)):(this.log_("Browser went offline.  Killing connection."),this.realtime_&&this.realtime_.close())}onRealtimeDisconnect_(){if(this.log_("data client disconnected"),this.connected_=!1,this.realtime_=null,this.cancelSentTransactions_(),this.requestCBHash_={},this.shouldReconnect_()){this.visible_?this.lastConnectionEstablishedTime_&&(new Date().getTime()-this.lastConnectionEstablishedTime_>lT&&(this.reconnectDelay_=cs),this.lastConnectionEstablishedTime_=null):(this.log_("Window isn't visible.  Delaying reconnect."),this.reconnectDelay_=this.maxReconnectDelay_,this.lastConnectionAttemptTime_=new Date().getTime());const e=Math.max(0,new Date().getTime()-this.lastConnectionAttemptTime_);let t=Math.max(0,this.reconnectDelay_-e);t=Math.random()*t,this.log_("Trying to reconnect in "+t+"ms"),this.scheduleConnect_(t),this.reconnectDelay_=Math.min(this.maxReconnectDelay_,this.reconnectDelay_*aT)}this.onConnectStatus_(!1)}async establishConnection_(){if(this.shouldReconnect_()){this.log_("Making a connection attempt"),this.lastConnectionAttemptTime_=new Date().getTime(),this.lastConnectionEstablishedTime_=null;const e=this.onDataMessage_.bind(this),t=this.onReady_.bind(this),s=this.onRealtimeDisconnect_.bind(this),i=this.id+":"+ct.nextConnectionId_++,r=this.lastSessionId;let a=!1,l=null;const u=function(){l?l.close():(a=!0,s())},h=function(p){D(l,"sendRequest call when we're not connected not allowed."),l.sendRequest(p)};this.realtime_={close:u,sendRequest:h};const f=this.forceTokenRefresh_;this.forceTokenRefresh_=!1;try{const[p,m]=await Promise.all([this.authTokenProvider_.getToken(f),this.appCheckTokenProvider_.getToken(f)]);a?ke("getToken() completed but was canceled"):(ke("getToken() completed. Creating connection."),this.authToken_=p&&p.accessToken,this.appCheckToken_=m&&m.token,l=new tT(i,this.repoInfo_,this.applicationId_,this.appCheckToken_,this.authToken_,e,t,s,A=>{je(A+" ("+this.repoInfo_.toString()+")"),this.interrupt(cT)},r))}catch(p){this.log_("Failed to get token: "+p),a||(this.repoInfo_.nodeAdmin&&je(p),u())}}}interrupt(e){ke("Interrupting connection for reason: "+e),this.interruptReasons_[e]=!0,this.realtime_?this.realtime_.close():(this.establishConnectionTimer_&&(clearTimeout(this.establishConnectionTimer_),this.establishConnectionTimer_=null),this.connected_&&this.onRealtimeDisconnect_())}resume(e){ke("Resuming connection for reason: "+e),delete this.interruptReasons_[e],yc(this.interruptReasons_)&&(this.reconnectDelay_=cs,this.realtime_||this.scheduleConnect_(0))}handleTimestamp_(e){const t=e-new Date().getTime();this.onServerInfoUpdate_({serverTimeOffset:t})}cancelSentTransactions_(){for(let e=0;e<this.outstandingPuts_.length;e++){const t=this.outstandingPuts_[e];t&&"h"in t.request&&t.queued&&(t.onComplete&&t.onComplete("disconnect"),delete this.outstandingPuts_[e],this.outstandingPutCount_--)}this.outstandingPutCount_===0&&(this.outstandingPuts_=[])}onListenRevoked_(e,t){let s;t?s=t.map(r=>qa(r)).join("$"):s="default";const i=this.removeListen_(e,s);i&&i.onComplete&&i.onComplete("permission_denied")}removeListen_(e,t){const s=new te(e).toString();let i;if(this.listens.has(s)){const r=this.listens.get(s);i=r.get(t),r.delete(t),r.size===0&&this.listens.delete(s)}else i=void 0;return i}onAuthRevoked_(e,t){ke("Auth token revoked: "+e+"/"+t),this.authToken_=null,this.forceTokenRefresh_=!0,this.realtime_.close(),(e==="invalid_token"||e==="permission_denied")&&(this.invalidAuthTokenCount_++,this.invalidAuthTokenCount_>=ju&&(this.reconnectDelay_=qu,this.authTokenProvider_.notifyForInvalidToken()))}onAppCheckRevoked_(e,t){ke("App check token revoked: "+e+"/"+t),this.appCheckToken_=null,this.forceTokenRefresh_=!0,(e==="invalid_token"||e==="permission_denied")&&(this.invalidAppCheckTokenCount_++,this.invalidAppCheckTokenCount_>=ju&&this.appCheckTokenProvider_.notifyForInvalidToken())}onSecurityDebugPacket_(e){this.securityDebugCallback_?this.securityDebugCallback_(e):"msg"in e}restoreState_(){this.tryAuth(),this.tryAppCheck();for(const e of this.listens.values())for(const t of e.values())this.sendListen_(t);for(let e=0;e<this.outstandingPuts_.length;e++)this.outstandingPuts_[e]&&this.sendPut_(e);for(;this.onDisconnectRequestQueue_.length;){const e=this.onDisconnectRequestQueue_.shift();this.sendOnDisconnect_(e.action,e.pathString,e.data,e.onComplete)}for(let e=0;e<this.outstandingGets_.length;e++)this.outstandingGets_[e]&&this.sendGet_(e)}sendConnectStats_(){const e={};let t="js";e["sdk."+t+"."+uf.replace(/\./g,"-")]=1,gh()?e["framework.cordova"]=1:C_()&&(e["framework.reactnative"]=1),this.reportStats(e)}shouldReconnect_(){const e=Qi.getInstance().currentlyOnline();return yc(this.interruptReasons_)&&e}}ct.nextPersistentConnectionId_=0;ct.nextConnectionId_=0;class W{constructor(e,t){this.name=e,this.node=t}static Wrap(e,t){return new W(e,t)}}class Ir{getCompare(){return this.compare.bind(this)}indexedValueChanged(e,t){const s=new W(xn,e),i=new W(xn,t);return this.compare(s,i)!==0}minPost(){return W.MIN}}let Ci;class Ff extends Ir{static get __EMPTY_NODE(){return Ci}static set __EMPTY_NODE(e){Ci=e}compare(e,t){return $n(e.name,t.name)}isDefinedOn(e){throw Ln("KeyIndex.isDefinedOn not expected to be called.")}indexedValueChanged(e,t){return!1}minPost(){return W.MIN}maxPost(){return new W(tn,Ci)}makePost(e,t){return D(typeof e=="string","KeyIndex indexValue must always be a string."),new W(e,Ci)}toString(){return".key"}}const Cn=new Ff;class Ai{constructor(e,t,s,i,r=null){this.isReverse_=i,this.resultGenerator_=r,this.nodeStack_=[];let a=1;for(;!e.isEmpty();)if(e=e,a=t?s(e.key,t):1,i&&(a*=-1),a<0)this.isReverse_?e=e.left:e=e.right;else if(a===0){this.nodeStack_.push(e);break}else this.nodeStack_.push(e),this.isReverse_?e=e.right:e=e.left}getNext(){if(this.nodeStack_.length===0)return null;let e=this.nodeStack_.pop(),t;if(this.resultGenerator_?t=this.resultGenerator_(e.key,e.value):t={key:e.key,value:e.value},this.isReverse_)for(e=e.left;!e.isEmpty();)this.nodeStack_.push(e),e=e.right;else for(e=e.right;!e.isEmpty();)this.nodeStack_.push(e),e=e.left;return t}hasNext(){return this.nodeStack_.length>0}peek(){if(this.nodeStack_.length===0)return null;const e=this.nodeStack_[this.nodeStack_.length-1];return this.resultGenerator_?this.resultGenerator_(e.key,e.value):{key:e.key,value:e.value}}}class we{constructor(e,t,s,i,r){this.key=e,this.value=t,this.color=s??we.RED,this.left=i??Ue.EMPTY_NODE,this.right=r??Ue.EMPTY_NODE}copy(e,t,s,i,r){return new we(e??this.key,t??this.value,s??this.color,i??this.left,r??this.right)}count(){return this.left.count()+1+this.right.count()}isEmpty(){return!1}inorderTraversal(e){return this.left.inorderTraversal(e)||!!e(this.key,this.value)||this.right.inorderTraversal(e)}reverseTraversal(e){return this.right.reverseTraversal(e)||e(this.key,this.value)||this.left.reverseTraversal(e)}min_(){return this.left.isEmpty()?this:this.left.min_()}minKey(){return this.min_().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(e,t,s){let i=this;const r=s(e,i.key);return r<0?i=i.copy(null,null,null,i.left.insert(e,t,s),null):r===0?i=i.copy(null,t,null,null,null):i=i.copy(null,null,null,null,i.right.insert(e,t,s)),i.fixUp_()}removeMin_(){if(this.left.isEmpty())return Ue.EMPTY_NODE;let e=this;return!e.left.isRed_()&&!e.left.left.isRed_()&&(e=e.moveRedLeft_()),e=e.copy(null,null,null,e.left.removeMin_(),null),e.fixUp_()}remove(e,t){let s,i;if(s=this,t(e,s.key)<0)!s.left.isEmpty()&&!s.left.isRed_()&&!s.left.left.isRed_()&&(s=s.moveRedLeft_()),s=s.copy(null,null,null,s.left.remove(e,t),null);else{if(s.left.isRed_()&&(s=s.rotateRight_()),!s.right.isEmpty()&&!s.right.isRed_()&&!s.right.left.isRed_()&&(s=s.moveRedRight_()),t(e,s.key)===0){if(s.right.isEmpty())return Ue.EMPTY_NODE;i=s.right.min_(),s=s.copy(i.key,i.value,null,null,s.right.removeMin_())}s=s.copy(null,null,null,null,s.right.remove(e,t))}return s.fixUp_()}isRed_(){return this.color}fixUp_(){let e=this;return e.right.isRed_()&&!e.left.isRed_()&&(e=e.rotateLeft_()),e.left.isRed_()&&e.left.left.isRed_()&&(e=e.rotateRight_()),e.left.isRed_()&&e.right.isRed_()&&(e=e.colorFlip_()),e}moveRedLeft_(){let e=this.colorFlip_();return e.right.left.isRed_()&&(e=e.copy(null,null,null,null,e.right.rotateRight_()),e=e.rotateLeft_(),e=e.colorFlip_()),e}moveRedRight_(){let e=this.colorFlip_();return e.left.left.isRed_()&&(e=e.rotateRight_(),e=e.colorFlip_()),e}rotateLeft_(){const e=this.copy(null,null,we.RED,null,this.right.left);return this.right.copy(null,null,this.color,e,null)}rotateRight_(){const e=this.copy(null,null,we.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,e)}colorFlip_(){const e=this.left.copy(null,null,!this.left.color,null,null),t=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,e,t)}checkMaxDepth_(){const e=this.check_();return Math.pow(2,e)<=this.count()+1}check_(){if(this.isRed_()&&this.left.isRed_())throw new Error("Red node has red child("+this.key+","+this.value+")");if(this.right.isRed_())throw new Error("Right child of ("+this.key+","+this.value+") is red");const e=this.left.check_();if(e!==this.right.check_())throw new Error("Black depths differ");return e+(this.isRed_()?0:1)}}we.RED=!0;we.BLACK=!1;class uT{copy(e,t,s,i,r){return this}insert(e,t,s){return new we(e,t,null)}remove(e,t){return this}count(){return 0}isEmpty(){return!0}inorderTraversal(e){return!1}reverseTraversal(e){return!1}minKey(){return null}maxKey(){return null}check_(){return 0}isRed_(){return!1}}class Ue{constructor(e,t=Ue.EMPTY_NODE){this.comparator_=e,this.root_=t}insert(e,t){return new Ue(this.comparator_,this.root_.insert(e,t,this.comparator_).copy(null,null,we.BLACK,null,null))}remove(e){return new Ue(this.comparator_,this.root_.remove(e,this.comparator_).copy(null,null,we.BLACK,null,null))}get(e){let t,s=this.root_;for(;!s.isEmpty();){if(t=this.comparator_(e,s.key),t===0)return s.value;t<0?s=s.left:t>0&&(s=s.right)}return null}getPredecessorKey(e){let t,s=this.root_,i=null;for(;!s.isEmpty();)if(t=this.comparator_(e,s.key),t===0){if(s.left.isEmpty())return i?i.key:null;for(s=s.left;!s.right.isEmpty();)s=s.right;return s.key}else t<0?s=s.left:t>0&&(i=s,s=s.right);throw new Error("Attempted to find predecessor key for a nonexistent key.  What gives?")}isEmpty(){return this.root_.isEmpty()}count(){return this.root_.count()}minKey(){return this.root_.minKey()}maxKey(){return this.root_.maxKey()}inorderTraversal(e){return this.root_.inorderTraversal(e)}reverseTraversal(e){return this.root_.reverseTraversal(e)}getIterator(e){return new Ai(this.root_,null,this.comparator_,!1,e)}getIteratorFrom(e,t){return new Ai(this.root_,e,this.comparator_,!1,t)}getReverseIteratorFrom(e,t){return new Ai(this.root_,e,this.comparator_,!0,t)}getReverseIterator(e){return new Ai(this.root_,null,this.comparator_,!0,e)}}Ue.EMPTY_NODE=new uT;function hT(n,e){return $n(n.name,e.name)}function Ha(n,e){return $n(n,e)}let Wo;function dT(n){Wo=n}const Uf=function(n){return typeof n=="number"?"number:"+_f(n):"string:"+n},Bf=function(n){if(n.isLeafNode()){const e=n.val();D(typeof e=="string"||typeof e=="number"||typeof e=="object"&&pt(e,".sv"),"Priority must be a string or number.")}else D(n===Wo||n.isEmpty(),"priority of unexpected type.");D(n===Wo||n.getPriority().isEmpty(),"Priority nodes can't have a priority of their own.")};let Wu;class Te{static set __childrenNodeConstructor(e){Wu=e}static get __childrenNodeConstructor(){return Wu}constructor(e,t=Te.__childrenNodeConstructor.EMPTY_NODE){this.value_=e,this.priorityNode_=t,this.lazyHash_=null,D(this.value_!==void 0&&this.value_!==null,"LeafNode shouldn't be created with null/undefined value."),Bf(this.priorityNode_)}isLeafNode(){return!0}getPriority(){return this.priorityNode_}updatePriority(e){return new Te(this.value_,e)}getImmediateChild(e){return e===".priority"?this.priorityNode_:Te.__childrenNodeConstructor.EMPTY_NODE}getChild(e){return z(e)?this:$(e)===".priority"?this.priorityNode_:Te.__childrenNodeConstructor.EMPTY_NODE}hasChild(){return!1}getPredecessorChildName(e,t){return null}updateImmediateChild(e,t){return e===".priority"?this.updatePriority(t):t.isEmpty()&&e!==".priority"?this:Te.__childrenNodeConstructor.EMPTY_NODE.updateImmediateChild(e,t).updatePriority(this.priorityNode_)}updateChild(e,t){const s=$(e);return s===null?t:t.isEmpty()&&s!==".priority"?this:(D(s!==".priority"||Ft(e)===1,".priority must be the last token in a path"),this.updateImmediateChild(s,Te.__childrenNodeConstructor.EMPTY_NODE.updateChild(ne(e),t)))}isEmpty(){return!1}numChildren(){return 0}forEachChild(e,t){return!1}val(e){return e&&!this.getPriority().isEmpty()?{".value":this.getValue(),".priority":this.getPriority().val()}:this.getValue()}hash(){if(this.lazyHash_===null){let e="";this.priorityNode_.isEmpty()||(e+="priority:"+Uf(this.priorityNode_.val())+":");const t=typeof this.value_;e+=t+":",t==="number"?e+=_f(this.value_):e+=this.value_,this.lazyHash_=df(e)}return this.lazyHash_}getValue(){return this.value_}compareTo(e){return e===Te.__childrenNodeConstructor.EMPTY_NODE?1:e instanceof Te.__childrenNodeConstructor?-1:(D(e.isLeafNode(),"Unknown node type"),this.compareToLeafNode_(e))}compareToLeafNode_(e){const t=typeof e.value_,s=typeof this.value_,i=Te.VALUE_TYPE_ORDER.indexOf(t),r=Te.VALUE_TYPE_ORDER.indexOf(s);return D(i>=0,"Unknown leaf type: "+t),D(r>=0,"Unknown leaf type: "+s),i===r?s==="object"?0:this.value_<e.value_?-1:this.value_===e.value_?0:1:r-i}withIndex(){return this}isIndexed(){return!0}equals(e){if(e===this)return!0;if(e.isLeafNode()){const t=e;return this.value_===t.value_&&this.priorityNode_.equals(t.priorityNode_)}else return!1}}Te.VALUE_TYPE_ORDER=["object","boolean","number","string"];let qf,jf;function fT(n){qf=n}function pT(n){jf=n}class _T extends Ir{compare(e,t){const s=e.node.getPriority(),i=t.node.getPriority(),r=s.compareTo(i);return r===0?$n(e.name,t.name):r}isDefinedOn(e){return!e.getPriority().isEmpty()}indexedValueChanged(e,t){return!e.getPriority().equals(t.getPriority())}minPost(){return W.MIN}maxPost(){return new W(tn,new Te("[PRIORITY-POST]",jf))}makePost(e,t){const s=qf(e);return new W(t,new Te("[PRIORITY-POST]",s))}toString(){return".priority"}}const le=new _T;const mT=Math.log(2);class gT{constructor(e){const t=r=>parseInt(Math.log(r)/mT,10),s=r=>parseInt(Array(r+1).join("1"),2);this.count=t(e+1),this.current_=this.count-1;const i=s(this.count);this.bits_=e+1&i}nextBitIsOne(){const e=!(this.bits_&1<<this.current_);return this.current_--,e}}const Yi=function(n,e,t,s){n.sort(e);const i=function(u,h){const f=h-u;let p,m;if(f===0)return null;if(f===1)return p=n[u],m=t?t(p):p,new we(m,p.node,we.BLACK,null,null);{const A=parseInt(f/2,10)+u,b=i(u,A),V=i(A+1,h);return p=n[A],m=t?t(p):p,new we(m,p.node,we.BLACK,b,V)}},r=function(u){let h=null,f=null,p=n.length;const m=function(b,V){const N=p-b,j=p;p-=b;const G=i(N+1,j),Y=n[N],Ce=t?t(Y):Y;A(new we(Ce,Y.node,V,null,G))},A=function(b){h?(h.left=b,h=b):(f=b,h=b)};for(let b=0;b<u.count;++b){const V=u.nextBitIsOne(),N=Math.pow(2,u.count-(b+1));V?m(N,we.BLACK):(m(N,we.BLACK),m(N,we.RED))}return f},a=new gT(n.length),l=r(a);return new Ue(s||e,l)};let po;const fn={};class lt{static get Default(){return D(fn&&le,"ChildrenNode.ts has not been loaded"),po=po||new lt({".priority":fn},{".priority":le}),po}constructor(e,t){this.indexes_=e,this.indexSet_=t}get(e){const t=An(this.indexes_,e);if(!t)throw new Error("No index defined for "+e);return t instanceof Ue?t:null}hasIndex(e){return pt(this.indexSet_,e.toString())}addIndex(e,t){D(e!==Cn,"KeyIndex always exists and isn't meant to be added to the IndexMap.");const s=[];let i=!1;const r=t.getIterator(W.Wrap);let a=r.getNext();for(;a;)i=i||e.isDefinedOn(a.node),s.push(a),a=r.getNext();let l;i?l=Yi(s,e.getCompare()):l=fn;const u=e.toString(),h={...this.indexSet_};h[u]=e;const f={...this.indexes_};return f[u]=l,new lt(f,h)}addToIndexes(e,t){const s=xi(this.indexes_,(i,r)=>{const a=An(this.indexSet_,r);if(D(a,"Missing index implementation for "+r),i===fn)if(a.isDefinedOn(e.node)){const l=[],u=t.getIterator(W.Wrap);let h=u.getNext();for(;h;)h.name!==e.name&&l.push(h),h=u.getNext();return l.push(e),Yi(l,a.getCompare())}else return fn;else{const l=t.get(e.name);let u=i;return l&&(u=u.remove(new W(e.name,l))),u.insert(e,e.node)}});return new lt(s,this.indexSet_)}removeFromIndexes(e,t){const s=xi(this.indexes_,i=>{if(i===fn)return i;{const r=t.get(e.name);return r?i.remove(new W(e.name,r)):i}});return new lt(s,this.indexSet_)}}let us;class L{static get EMPTY_NODE(){return us||(us=new L(new Ue(Ha),null,lt.Default))}constructor(e,t,s){this.children_=e,this.priorityNode_=t,this.indexMap_=s,this.lazyHash_=null,this.priorityNode_&&Bf(this.priorityNode_),this.children_.isEmpty()&&D(!this.priorityNode_||this.priorityNode_.isEmpty(),"An empty node cannot have a priority")}isLeafNode(){return!1}getPriority(){return this.priorityNode_||us}updatePriority(e){return this.children_.isEmpty()?this:new L(this.children_,e,this.indexMap_)}getImmediateChild(e){if(e===".priority")return this.getPriority();{const t=this.children_.get(e);return t===null?us:t}}getChild(e){const t=$(e);return t===null?this:this.getImmediateChild(t).getChild(ne(e))}hasChild(e){return this.children_.get(e)!==null}updateImmediateChild(e,t){if(D(t,"We should always be passing snapshot nodes"),e===".priority")return this.updatePriority(t);{const s=new W(e,t);let i,r;t.isEmpty()?(i=this.children_.remove(e),r=this.indexMap_.removeFromIndexes(s,this.children_)):(i=this.children_.insert(e,t),r=this.indexMap_.addToIndexes(s,this.children_));const a=i.isEmpty()?us:this.priorityNode_;return new L(i,a,r)}}updateChild(e,t){const s=$(e);if(s===null)return t;{D($(e)!==".priority"||Ft(e)===1,".priority must be the last token in a path");const i=this.getImmediateChild(s).updateChild(ne(e),t);return this.updateImmediateChild(s,i)}}isEmpty(){return this.children_.isEmpty()}numChildren(){return this.children_.count()}val(e){if(this.isEmpty())return null;const t={};let s=0,i=0,r=!0;if(this.forEachChild(le,(a,l)=>{t[a]=l.val(e),s++,r&&L.INTEGER_REGEXP_.test(a)?i=Math.max(i,Number(a)):r=!1}),!e&&r&&i<2*s){const a=[];for(const l in t)a[l]=t[l];return a}else return e&&!this.getPriority().isEmpty()&&(t[".priority"]=this.getPriority().val()),t}hash(){if(this.lazyHash_===null){let e="";this.getPriority().isEmpty()||(e+="priority:"+Uf(this.getPriority().val())+":"),this.forEachChild(le,(t,s)=>{const i=s.hash();i!==""&&(e+=":"+t+":"+i)}),this.lazyHash_=e===""?"":df(e)}return this.lazyHash_}getPredecessorChildName(e,t,s){const i=this.resolveIndex_(s);if(i){const r=i.getPredecessorKey(new W(e,t));return r?r.name:null}else return this.children_.getPredecessorKey(e)}getFirstChildName(e){const t=this.resolveIndex_(e);if(t){const s=t.minKey();return s&&s.name}else return this.children_.minKey()}getFirstChild(e){const t=this.getFirstChildName(e);return t?new W(t,this.children_.get(t)):null}getLastChildName(e){const t=this.resolveIndex_(e);if(t){const s=t.maxKey();return s&&s.name}else return this.children_.maxKey()}getLastChild(e){const t=this.getLastChildName(e);return t?new W(t,this.children_.get(t)):null}forEachChild(e,t){const s=this.resolveIndex_(e);return s?s.inorderTraversal(i=>t(i.name,i.node)):this.children_.inorderTraversal(t)}getIterator(e){return this.getIteratorFrom(e.minPost(),e)}getIteratorFrom(e,t){const s=this.resolveIndex_(t);if(s)return s.getIteratorFrom(e,i=>i);{const i=this.children_.getIteratorFrom(e.name,W.Wrap);let r=i.peek();for(;r!=null&&t.compare(r,e)<0;)i.getNext(),r=i.peek();return i}}getReverseIterator(e){return this.getReverseIteratorFrom(e.maxPost(),e)}getReverseIteratorFrom(e,t){const s=this.resolveIndex_(t);if(s)return s.getReverseIteratorFrom(e,i=>i);{const i=this.children_.getReverseIteratorFrom(e.name,W.Wrap);let r=i.peek();for(;r!=null&&t.compare(r,e)>0;)i.getNext(),r=i.peek();return i}}compareTo(e){return this.isEmpty()?e.isEmpty()?0:-1:e.isLeafNode()||e.isEmpty()?1:e===Zs?-1:0}withIndex(e){if(e===Cn||this.indexMap_.hasIndex(e))return this;{const t=this.indexMap_.addIndex(e,this.children_);return new L(this.children_,this.priorityNode_,t)}}isIndexed(e){return e===Cn||this.indexMap_.hasIndex(e)}equals(e){if(e===this)return!0;if(e.isLeafNode())return!1;{const t=e;if(this.getPriority().equals(t.getPriority()))if(this.children_.count()===t.children_.count()){const s=this.getIterator(le),i=t.getIterator(le);let r=s.getNext(),a=i.getNext();for(;r&&a;){if(r.name!==a.name||!r.node.equals(a.node))return!1;r=s.getNext(),a=i.getNext()}return r===null&&a===null}else return!1;else return!1}}resolveIndex_(e){return e===Cn?null:this.indexMap_.get(e.toString())}}L.INTEGER_REGEXP_=/^(0|[1-9]\d*)$/;class yT extends L{constructor(){super(new Ue(Ha),L.EMPTY_NODE,lt.Default)}compareTo(e){return e===this?0:1}equals(e){return e===this}getPriority(){return this}getImmediateChild(e){return L.EMPTY_NODE}isEmpty(){return!1}}const Zs=new yT;Object.defineProperties(W,{MIN:{value:new W(xn,L.EMPTY_NODE)},MAX:{value:new W(tn,Zs)}});Ff.__EMPTY_NODE=L.EMPTY_NODE;Te.__childrenNodeConstructor=L;dT(Zs);pT(Zs);const ET=!0;function Ae(n,e=null){if(n===null)return L.EMPTY_NODE;if(typeof n=="object"&&".priority"in n&&(e=n[".priority"]),D(e===null||typeof e=="string"||typeof e=="number"||typeof e=="object"&&".sv"in e,"Invalid priority type found: "+typeof e),typeof n=="object"&&".value"in n&&n[".value"]!==null&&(n=n[".value"]),typeof n!="object"||".sv"in n){const t=n;return new Te(t,Ae(e))}if(!(n instanceof Array)&&ET){const t=[];let s=!1;if(Be(n,(a,l)=>{if(a.substring(0,1)!=="."){const u=Ae(l);u.isEmpty()||(s=s||!u.getPriority().isEmpty(),t.push(new W(a,u)))}}),t.length===0)return L.EMPTY_NODE;const r=Yi(t,hT,a=>a.name,Ha);if(s){const a=Yi(t,le.getCompare());return new L(r,Ae(e),new lt({".priority":a},{".priority":le}))}else return new L(r,Ae(e),lt.Default)}else{let t=L.EMPTY_NODE;return Be(n,(s,i)=>{if(pt(n,s)&&s.substring(0,1)!=="."){const r=Ae(i);(r.isLeafNode()||!r.isEmpty())&&(t=t.updateImmediateChild(s,r))}}),t.updatePriority(Ae(e))}}fT(Ae);class vT extends Ir{constructor(e){super(),this.indexPath_=e,D(!z(e)&&$(e)!==".priority","Can't create PathIndex with empty path or .priority key")}extractChild(e){return e.getChild(this.indexPath_)}isDefinedOn(e){return!e.getChild(this.indexPath_).isEmpty()}compare(e,t){const s=this.extractChild(e.node),i=this.extractChild(t.node),r=s.compareTo(i);return r===0?$n(e.name,t.name):r}makePost(e,t){const s=Ae(e),i=L.EMPTY_NODE.updateChild(this.indexPath_,s);return new W(t,i)}maxPost(){const e=L.EMPTY_NODE.updateChild(this.indexPath_,Zs);return new W(tn,e)}toString(){return Of(this.indexPath_,0).join("/")}}class TT extends Ir{compare(e,t){const s=e.node.compareTo(t.node);return s===0?$n(e.name,t.name):s}isDefinedOn(e){return!0}indexedValueChanged(e,t){return!e.equals(t)}minPost(){return W.MIN}maxPost(){return W.MAX}makePost(e,t){const s=Ae(e);return new W(t,s)}toString(){return".value"}}const IT=new TT;function Wf(n){return{type:"value",snapshotNode:n}}function On(n,e){return{type:"child_added",snapshotNode:e,childName:n}}function Ls(n,e){return{type:"child_removed",snapshotNode:e,childName:n}}function Fs(n,e,t){return{type:"child_changed",snapshotNode:e,childName:n,oldSnap:t}}function wT(n,e){return{type:"child_moved",snapshotNode:e,childName:n}}class Ka{constructor(e){this.index_=e}updateChild(e,t,s,i,r,a){D(e.isIndexed(this.index_),"A node must be indexed if only a child is updated");const l=e.getImmediateChild(t);return l.getChild(i).equals(s.getChild(i))&&l.isEmpty()===s.isEmpty()||(a!=null&&(s.isEmpty()?e.hasChild(t)?a.trackChildChange(Ls(t,l)):D(e.isLeafNode(),"A child remove without an old child only makes sense on a leaf node"):l.isEmpty()?a.trackChildChange(On(t,s)):a.trackChildChange(Fs(t,s,l))),e.isLeafNode()&&s.isEmpty())?e:e.updateImmediateChild(t,s).withIndex(this.index_)}updateFullNode(e,t,s){return s!=null&&(e.isLeafNode()||e.forEachChild(le,(i,r)=>{t.hasChild(i)||s.trackChildChange(Ls(i,r))}),t.isLeafNode()||t.forEachChild(le,(i,r)=>{if(e.hasChild(i)){const a=e.getImmediateChild(i);a.equals(r)||s.trackChildChange(Fs(i,r,a))}else s.trackChildChange(On(i,r))})),t.withIndex(this.index_)}updatePriority(e,t){return e.isEmpty()?L.EMPTY_NODE:e.updatePriority(t)}filtersNodes(){return!1}getIndexedFilter(){return this}getIndex(){return this.index_}}class Us{constructor(e){this.indexedFilter_=new Ka(e.getIndex()),this.index_=e.getIndex(),this.startPost_=Us.getStartPost_(e),this.endPost_=Us.getEndPost_(e),this.startIsInclusive_=!e.startAfterSet_,this.endIsInclusive_=!e.endBeforeSet_}getStartPost(){return this.startPost_}getEndPost(){return this.endPost_}matches(e){const t=this.startIsInclusive_?this.index_.compare(this.getStartPost(),e)<=0:this.index_.compare(this.getStartPost(),e)<0,s=this.endIsInclusive_?this.index_.compare(e,this.getEndPost())<=0:this.index_.compare(e,this.getEndPost())<0;return t&&s}updateChild(e,t,s,i,r,a){return this.matches(new W(t,s))||(s=L.EMPTY_NODE),this.indexedFilter_.updateChild(e,t,s,i,r,a)}updateFullNode(e,t,s){t.isLeafNode()&&(t=L.EMPTY_NODE);let i=t.withIndex(this.index_);i=i.updatePriority(L.EMPTY_NODE);const r=this;return t.forEachChild(le,(a,l)=>{r.matches(new W(a,l))||(i=i.updateImmediateChild(a,L.EMPTY_NODE))}),this.indexedFilter_.updateFullNode(e,i,s)}updatePriority(e,t){return e}filtersNodes(){return!0}getIndexedFilter(){return this.indexedFilter_}getIndex(){return this.index_}static getStartPost_(e){if(e.hasStart()){const t=e.getIndexStartName();return e.getIndex().makePost(e.getIndexStartValue(),t)}else return e.getIndex().minPost()}static getEndPost_(e){if(e.hasEnd()){const t=e.getIndexEndName();return e.getIndex().makePost(e.getIndexEndValue(),t)}else return e.getIndex().maxPost()}}class CT{constructor(e){this.withinDirectionalStart=t=>this.reverse_?this.withinEndPost(t):this.withinStartPost(t),this.withinDirectionalEnd=t=>this.reverse_?this.withinStartPost(t):this.withinEndPost(t),this.withinStartPost=t=>{const s=this.index_.compare(this.rangedFilter_.getStartPost(),t);return this.startIsInclusive_?s<=0:s<0},this.withinEndPost=t=>{const s=this.index_.compare(t,this.rangedFilter_.getEndPost());return this.endIsInclusive_?s<=0:s<0},this.rangedFilter_=new Us(e),this.index_=e.getIndex(),this.limit_=e.getLimit(),this.reverse_=!e.isViewFromLeft(),this.startIsInclusive_=!e.startAfterSet_,this.endIsInclusive_=!e.endBeforeSet_}updateChild(e,t,s,i,r,a){return this.rangedFilter_.matches(new W(t,s))||(s=L.EMPTY_NODE),e.getImmediateChild(t).equals(s)?e:e.numChildren()<this.limit_?this.rangedFilter_.getIndexedFilter().updateChild(e,t,s,i,r,a):this.fullLimitUpdateChild_(e,t,s,r,a)}updateFullNode(e,t,s){let i;if(t.isLeafNode()||t.isEmpty())i=L.EMPTY_NODE.withIndex(this.index_);else if(this.limit_*2<t.numChildren()&&t.isIndexed(this.index_)){i=L.EMPTY_NODE.withIndex(this.index_);let r;this.reverse_?r=t.getReverseIteratorFrom(this.rangedFilter_.getEndPost(),this.index_):r=t.getIteratorFrom(this.rangedFilter_.getStartPost(),this.index_);let a=0;for(;r.hasNext()&&a<this.limit_;){const l=r.getNext();if(this.withinDirectionalStart(l))if(this.withinDirectionalEnd(l))i=i.updateImmediateChild(l.name,l.node),a++;else break;else continue}}else{i=t.withIndex(this.index_),i=i.updatePriority(L.EMPTY_NODE);let r;this.reverse_?r=i.getReverseIterator(this.index_):r=i.getIterator(this.index_);let a=0;for(;r.hasNext();){const l=r.getNext();a<this.limit_&&this.withinDirectionalStart(l)&&this.withinDirectionalEnd(l)?a++:i=i.updateImmediateChild(l.name,L.EMPTY_NODE)}}return this.rangedFilter_.getIndexedFilter().updateFullNode(e,i,s)}updatePriority(e,t){return e}filtersNodes(){return!0}getIndexedFilter(){return this.rangedFilter_.getIndexedFilter()}getIndex(){return this.index_}fullLimitUpdateChild_(e,t,s,i,r){let a;if(this.reverse_){const p=this.index_.getCompare();a=(m,A)=>p(A,m)}else a=this.index_.getCompare();const l=e;D(l.numChildren()===this.limit_,"");const u=new W(t,s),h=this.reverse_?l.getFirstChild(this.index_):l.getLastChild(this.index_),f=this.rangedFilter_.matches(u);if(l.hasChild(t)){const p=l.getImmediateChild(t);let m=i.getChildAfterChild(this.index_,h,this.reverse_);for(;m!=null&&(m.name===t||l.hasChild(m.name));)m=i.getChildAfterChild(this.index_,m,this.reverse_);const A=m==null?1:a(m,u);if(f&&!s.isEmpty()&&A>=0)return r?.trackChildChange(Fs(t,s,p)),l.updateImmediateChild(t,s);{r?.trackChildChange(Ls(t,p));const V=l.updateImmediateChild(t,L.EMPTY_NODE);return m!=null&&this.rangedFilter_.matches(m)?(r?.trackChildChange(On(m.name,m.node)),V.updateImmediateChild(m.name,m.node)):V}}else return s.isEmpty()?e:f&&a(h,u)>=0?(r!=null&&(r.trackChildChange(Ls(h.name,h.node)),r.trackChildChange(On(t,s))),l.updateImmediateChild(t,s).updateImmediateChild(h.name,L.EMPTY_NODE)):e}}class Qa{constructor(){this.limitSet_=!1,this.startSet_=!1,this.startNameSet_=!1,this.startAfterSet_=!1,this.endSet_=!1,this.endNameSet_=!1,this.endBeforeSet_=!1,this.limit_=0,this.viewFrom_="",this.indexStartValue_=null,this.indexStartName_="",this.indexEndValue_=null,this.indexEndName_="",this.index_=le}hasStart(){return this.startSet_}isViewFromLeft(){return this.viewFrom_===""?this.startSet_:this.viewFrom_==="l"}getIndexStartValue(){return D(this.startSet_,"Only valid if start has been set"),this.indexStartValue_}getIndexStartName(){return D(this.startSet_,"Only valid if start has been set"),this.startNameSet_?this.indexStartName_:xn}hasEnd(){return this.endSet_}getIndexEndValue(){return D(this.endSet_,"Only valid if end has been set"),this.indexEndValue_}getIndexEndName(){return D(this.endSet_,"Only valid if end has been set"),this.endNameSet_?this.indexEndName_:tn}hasLimit(){return this.limitSet_}hasAnchoredLimit(){return this.limitSet_&&this.viewFrom_!==""}getLimit(){return D(this.limitSet_,"Only valid if limit has been set"),this.limit_}getIndex(){return this.index_}loadsAllData(){return!(this.startSet_||this.endSet_||this.limitSet_)}isDefault(){return this.loadsAllData()&&this.index_===le}copy(){const e=new Qa;return e.limitSet_=this.limitSet_,e.limit_=this.limit_,e.startSet_=this.startSet_,e.startAfterSet_=this.startAfterSet_,e.indexStartValue_=this.indexStartValue_,e.startNameSet_=this.startNameSet_,e.indexStartName_=this.indexStartName_,e.endSet_=this.endSet_,e.endBeforeSet_=this.endBeforeSet_,e.indexEndValue_=this.indexEndValue_,e.endNameSet_=this.endNameSet_,e.indexEndName_=this.indexEndName_,e.index_=this.index_,e.viewFrom_=this.viewFrom_,e}}function AT(n){return n.loadsAllData()?new Ka(n.getIndex()):n.hasLimit()?new CT(n):new Us(n)}function $u(n){const e={};if(n.isDefault())return e;let t;if(n.index_===le?t="$priority":n.index_===IT?t="$value":n.index_===Cn?t="$key":(D(n.index_ instanceof vT,"Unrecognized index type!"),t=n.index_.toString()),e.orderBy=_e(t),n.startSet_){const s=n.startAfterSet_?"startAfter":"startAt";e[s]=_e(n.indexStartValue_),n.startNameSet_&&(e[s]+=","+_e(n.indexStartName_))}if(n.endSet_){const s=n.endBeforeSet_?"endBefore":"endAt";e[s]=_e(n.indexEndValue_),n.endNameSet_&&(e[s]+=","+_e(n.indexEndName_))}return n.limitSet_&&(n.isViewFromLeft()?e.limitToFirst=n.limit_:e.limitToLast=n.limit_),e}function zu(n){const e={};if(n.startSet_&&(e.sp=n.indexStartValue_,n.startNameSet_&&(e.sn=n.indexStartName_),e.sin=!n.startAfterSet_),n.endSet_&&(e.ep=n.indexEndValue_,n.endNameSet_&&(e.en=n.indexEndName_),e.ein=!n.endBeforeSet_),n.limitSet_){e.l=n.limit_;let t=n.viewFrom_;t===""&&(n.isViewFromLeft()?t="l":t="r"),e.vf=t}return n.index_!==le&&(e.i=n.index_.toString()),e}class Xi extends kf{reportStats(e){throw new Error("Method not implemented.")}static getListenId_(e,t){return t!==void 0?"tag$"+t:(D(e._queryParams.isDefault(),"should have a tag if it's not a default query."),e._path.toString())}constructor(e,t,s,i){super(),this.repoInfo_=e,this.onDataUpdate_=t,this.authTokenProvider_=s,this.appCheckTokenProvider_=i,this.log_=Xs("p:rest:"),this.listens_={}}listen(e,t,s,i){const r=e._path.toString();this.log_("Listen called for "+r+" "+e._queryIdentifier);const a=Xi.getListenId_(e,s),l={};this.listens_[a]=l;const u=$u(e._queryParams);this.restRequest_(r+".json",u,(h,f)=>{let p=f;if(h===404&&(p=null,h=null),h===null&&this.onDataUpdate_(r,p,!1,s),An(this.listens_,a)===l){let m;h?h===401?m="permission_denied":m="rest_error:"+h:m="ok",i(m,null)}})}unlisten(e,t){const s=Xi.getListenId_(e,t);delete this.listens_[s]}get(e){const t=$u(e._queryParams),s=e._path.toString(),i=new na;return this.restRequest_(s+".json",t,(r,a)=>{let l=a;r===404&&(l=null,r=null),r===null?(this.onDataUpdate_(s,l,!1,null),i.resolve(l)):i.reject(new Error(l))}),i.promise}refreshAuthToken(e){}restRequest_(e,t={},s){return t.format="export",Promise.all([this.authTokenProvider_.getToken(!1),this.appCheckTokenProvider_.getToken(!1)]).then(([i,r])=>{i&&i.accessToken&&(t.auth=i.accessToken),r&&r.token&&(t.ac=r.token);const a=(this.repoInfo_.secure?"https://":"http://")+this.repoInfo_.host+e+"?ns="+this.repoInfo_.namespace+x_(t);this.log_("Sending REST request for "+a);const l=new XMLHttpRequest;l.onreadystatechange=()=>{if(s&&l.readyState===4){this.log_("REST Response for "+a+" received. status:",l.status,"response:",l.responseText);let u=null;if(l.status>=200&&l.status<300){try{u=As(l.responseText)}catch{je("Failed to parse JSON response for "+a+": "+l.responseText)}s(null,u)}else l.status!==401&&l.status!==404&&je("Got unsuccessful REST response for "+a+" Status: "+l.status),s(l.status);s=null}},l.open("GET",a,!0),l.send()})}}class RT{constructor(){this.rootNode_=L.EMPTY_NODE}getNode(e){return this.rootNode_.getChild(e)}updateSnapshot(e,t){this.rootNode_=this.rootNode_.updateChild(e,t)}}function Ji(){return{value:null,children:new Map}}function $f(n,e,t){if(z(e))n.value=t,n.children.clear();else if(n.value!==null)n.value=n.value.updateChild(e,t);else{const s=$(e);n.children.has(s)||n.children.set(s,Ji());const i=n.children.get(s);e=ne(e),$f(i,e,t)}}function $o(n,e,t){n.value!==null?t(e,n.value):ST(n,(s,i)=>{const r=new te(e.toString()+"/"+s);$o(i,r,t)})}function ST(n,e){n.children.forEach((t,s)=>{e(s,t)})}class PT{constructor(e){this.collection_=e,this.last_=null}get(){const e=this.collection_.get(),t={...e};return this.last_&&Be(this.last_,(s,i)=>{t[s]=t[s]-i}),this.last_=e,t}}const Gu=10*1e3,bT=30*1e3,NT=300*1e3;class DT{constructor(e,t){this.server_=t,this.statsToReport_={},this.statsListener_=new PT(e);const s=Gu+(bT-Gu)*Math.random();Ts(this.reportStats_.bind(this),Math.floor(s))}reportStats_(){const e=this.statsListener_.get(),t={};let s=!1;Be(e,(i,r)=>{r>0&&pt(this.statsToReport_,i)&&(t[i]=r,s=!0)}),s&&this.server_.reportStats(t),Ts(this.reportStats_.bind(this),Math.floor(Math.random()*2*NT))}}var Ke;(function(n){n[n.OVERWRITE=0]="OVERWRITE",n[n.MERGE=1]="MERGE",n[n.ACK_USER_WRITE=2]="ACK_USER_WRITE",n[n.LISTEN_COMPLETE=3]="LISTEN_COMPLETE"})(Ke||(Ke={}));function zf(){return{fromUser:!0,fromServer:!1,queryId:null,tagged:!1}}function Ya(){return{fromUser:!1,fromServer:!0,queryId:null,tagged:!1}}function Xa(n){return{fromUser:!1,fromServer:!0,queryId:n,tagged:!0}}class Zi{constructor(e,t,s){this.path=e,this.affectedTree=t,this.revert=s,this.type=Ke.ACK_USER_WRITE,this.source=zf()}operationForChild(e){if(z(this.path)){if(this.affectedTree.value!=null)return D(this.affectedTree.children.isEmpty(),"affectedTree should not have overlapping affected paths."),this;{const t=this.affectedTree.subtree(new te(e));return new Zi(J(),t,this.revert)}}else return D($(this.path)===e,"operationForChild called for unrelated child."),new Zi(ne(this.path),this.affectedTree,this.revert)}}class Bs{constructor(e,t){this.source=e,this.path=t,this.type=Ke.LISTEN_COMPLETE}operationForChild(e){return z(this.path)?new Bs(this.source,J()):new Bs(this.source,ne(this.path))}}class nn{constructor(e,t,s){this.source=e,this.path=t,this.snap=s,this.type=Ke.OVERWRITE}operationForChild(e){return z(this.path)?new nn(this.source,J(),this.snap.getImmediateChild(e)):new nn(this.source,ne(this.path),this.snap)}}class qs{constructor(e,t,s){this.source=e,this.path=t,this.children=s,this.type=Ke.MERGE}operationForChild(e){if(z(this.path)){const t=this.children.subtree(new te(e));return t.isEmpty()?null:t.value?new nn(this.source,J(),t.value):new qs(this.source,J(),t)}else return D($(this.path)===e,"Can't get a merge for a child not on the path of the operation"),new qs(this.source,ne(this.path),this.children)}toString(){return"Operation("+this.path+": "+this.source.toString()+" merge: "+this.children.toString()+")"}}class Ut{constructor(e,t,s){this.node_=e,this.fullyInitialized_=t,this.filtered_=s}isFullyInitialized(){return this.fullyInitialized_}isFiltered(){return this.filtered_}isCompleteForPath(e){if(z(e))return this.isFullyInitialized()&&!this.filtered_;const t=$(e);return this.isCompleteForChild(t)}isCompleteForChild(e){return this.isFullyInitialized()&&!this.filtered_||this.node_.hasChild(e)}getNode(){return this.node_}}class kT{constructor(e){this.query_=e,this.index_=this.query_._queryParams.getIndex()}}function VT(n,e,t,s){const i=[],r=[];return e.forEach(a=>{a.type==="child_changed"&&n.index_.indexedValueChanged(a.oldSnap,a.snapshotNode)&&r.push(wT(a.childName,a.snapshotNode))}),hs(n,i,"child_removed",e,s,t),hs(n,i,"child_added",e,s,t),hs(n,i,"child_moved",r,s,t),hs(n,i,"child_changed",e,s,t),hs(n,i,"value",e,s,t),i}function hs(n,e,t,s,i,r){const a=s.filter(l=>l.type===t);a.sort((l,u)=>OT(n,l,u)),a.forEach(l=>{const u=xT(n,l,r);i.forEach(h=>{h.respondsTo(l.type)&&e.push(h.createEvent(u,n.query_))})})}function xT(n,e,t){return e.type==="value"||e.type==="child_removed"||(e.prevName=t.getPredecessorChildName(e.childName,e.snapshotNode,n.index_)),e}function OT(n,e,t){if(e.childName==null||t.childName==null)throw Ln("Should only compare child_ events.");const s=new W(e.childName,e.snapshotNode),i=new W(t.childName,t.snapshotNode);return n.index_.compare(s,i)}function wr(n,e){return{eventCache:n,serverCache:e}}function Is(n,e,t,s){return wr(new Ut(e,t,s),n.serverCache)}function Gf(n,e,t,s){return wr(n.eventCache,new Ut(e,t,s))}function er(n){return n.eventCache.isFullyInitialized()?n.eventCache.getNode():null}function sn(n){return n.serverCache.isFullyInitialized()?n.serverCache.getNode():null}let _o;const MT=()=>(_o||(_o=new Ue(Tv)),_o);class re{static fromObject(e){let t=new re(null);return Be(e,(s,i)=>{t=t.set(new te(s),i)}),t}constructor(e,t=MT()){this.value=e,this.children=t}isEmpty(){return this.value===null&&this.children.isEmpty()}findRootMostMatchingPathAndValue(e,t){if(this.value!=null&&t(this.value))return{path:J(),value:this.value};if(z(e))return null;{const s=$(e),i=this.children.get(s);if(i!==null){const r=i.findRootMostMatchingPathAndValue(ne(e),t);return r!=null?{path:me(new te(s),r.path),value:r.value}:null}else return null}}findRootMostValueAndPath(e){return this.findRootMostMatchingPathAndValue(e,()=>!0)}subtree(e){if(z(e))return this;{const t=$(e),s=this.children.get(t);return s!==null?s.subtree(ne(e)):new re(null)}}set(e,t){if(z(e))return new re(t,this.children);{const s=$(e),r=(this.children.get(s)||new re(null)).set(ne(e),t),a=this.children.insert(s,r);return new re(this.value,a)}}remove(e){if(z(e))return this.children.isEmpty()?new re(null):new re(null,this.children);{const t=$(e),s=this.children.get(t);if(s){const i=s.remove(ne(e));let r;return i.isEmpty()?r=this.children.remove(t):r=this.children.insert(t,i),this.value===null&&r.isEmpty()?new re(null):new re(this.value,r)}else return this}}get(e){if(z(e))return this.value;{const t=$(e),s=this.children.get(t);return s?s.get(ne(e)):null}}setTree(e,t){if(z(e))return t;{const s=$(e),r=(this.children.get(s)||new re(null)).setTree(ne(e),t);let a;return r.isEmpty()?a=this.children.remove(s):a=this.children.insert(s,r),new re(this.value,a)}}fold(e){return this.fold_(J(),e)}fold_(e,t){const s={};return this.children.inorderTraversal((i,r)=>{s[i]=r.fold_(me(e,i),t)}),t(e,this.value,s)}findOnPath(e,t){return this.findOnPath_(e,J(),t)}findOnPath_(e,t,s){const i=this.value?s(t,this.value):!1;if(i)return i;if(z(e))return null;{const r=$(e),a=this.children.get(r);return a?a.findOnPath_(ne(e),me(t,r),s):null}}foreachOnPath(e,t){return this.foreachOnPath_(e,J(),t)}foreachOnPath_(e,t,s){if(z(e))return this;{this.value&&s(t,this.value);const i=$(e),r=this.children.get(i);return r?r.foreachOnPath_(ne(e),me(t,i),s):new re(null)}}foreach(e){this.foreach_(J(),e)}foreach_(e,t){this.children.inorderTraversal((s,i)=>{i.foreach_(me(e,s),t)}),this.value&&t(e,this.value)}foreachChild(e){this.children.inorderTraversal((t,s)=>{s.value&&e(t,s.value)})}}class Qe{constructor(e){this.writeTree_=e}static empty(){return new Qe(new re(null))}}function ws(n,e,t){if(z(e))return new Qe(new re(t));{const s=n.writeTree_.findRootMostValueAndPath(e);if(s!=null){const i=s.path;let r=s.value;const a=Oe(i,e);return r=r.updateChild(a,t),new Qe(n.writeTree_.set(i,r))}else{const i=new re(t),r=n.writeTree_.setTree(e,i);return new Qe(r)}}}function Hu(n,e,t){let s=n;return Be(t,(i,r)=>{s=ws(s,me(e,i),r)}),s}function Ku(n,e){if(z(e))return Qe.empty();{const t=n.writeTree_.setTree(e,new re(null));return new Qe(t)}}function zo(n,e){return cn(n,e)!=null}function cn(n,e){const t=n.writeTree_.findRootMostValueAndPath(e);return t!=null?n.writeTree_.get(t.path).getChild(Oe(t.path,e)):null}function Qu(n){const e=[],t=n.writeTree_.value;return t!=null?t.isLeafNode()||t.forEachChild(le,(s,i)=>{e.push(new W(s,i))}):n.writeTree_.children.inorderTraversal((s,i)=>{i.value!=null&&e.push(new W(s,i.value))}),e}function Nt(n,e){if(z(e))return n;{const t=cn(n,e);return t!=null?new Qe(new re(t)):new Qe(n.writeTree_.subtree(e))}}function Go(n){return n.writeTree_.isEmpty()}function Mn(n,e){return Hf(J(),n.writeTree_,e)}function Hf(n,e,t){if(e.value!=null)return t.updateChild(n,e.value);{let s=null;return e.children.inorderTraversal((i,r)=>{i===".priority"?(D(r.value!==null,"Priority writes must always be leaf nodes"),s=r.value):t=Hf(me(n,i),r,t)}),!t.getChild(n).isEmpty()&&s!==null&&(t=t.updateChild(me(n,".priority"),s)),t}}function Cr(n,e){return Xf(e,n)}function LT(n,e,t,s,i){D(s>n.lastWriteId,"Stacking an older write on top of newer ones"),i===void 0&&(i=!0),n.allWrites.push({path:e,snap:t,writeId:s,visible:i}),i&&(n.visibleWrites=ws(n.visibleWrites,e,t)),n.lastWriteId=s}function FT(n,e){for(let t=0;t<n.allWrites.length;t++){const s=n.allWrites[t];if(s.writeId===e)return s}return null}function UT(n,e){const t=n.allWrites.findIndex(l=>l.writeId===e);D(t>=0,"removeWrite called with nonexistent writeId.");const s=n.allWrites[t];n.allWrites.splice(t,1);let i=s.visible,r=!1,a=n.allWrites.length-1;for(;i&&a>=0;){const l=n.allWrites[a];l.visible&&(a>=t&&BT(l,s.path)?i=!1:He(s.path,l.path)&&(r=!0)),a--}if(i){if(r)return qT(n),!0;if(s.snap)n.visibleWrites=Ku(n.visibleWrites,s.path);else{const l=s.children;Be(l,u=>{n.visibleWrites=Ku(n.visibleWrites,me(s.path,u))})}return!0}else return!1}function BT(n,e){if(n.snap)return He(n.path,e);for(const t in n.children)if(n.children.hasOwnProperty(t)&&He(me(n.path,t),e))return!0;return!1}function qT(n){n.visibleWrites=Kf(n.allWrites,jT,J()),n.allWrites.length>0?n.lastWriteId=n.allWrites[n.allWrites.length-1].writeId:n.lastWriteId=-1}function jT(n){return n.visible}function Kf(n,e,t){let s=Qe.empty();for(let i=0;i<n.length;++i){const r=n[i];if(e(r)){const a=r.path;let l;if(r.snap)He(t,a)?(l=Oe(t,a),s=ws(s,l,r.snap)):He(a,t)&&(l=Oe(a,t),s=ws(s,J(),r.snap.getChild(l)));else if(r.children){if(He(t,a))l=Oe(t,a),s=Hu(s,l,r.children);else if(He(a,t))if(l=Oe(a,t),z(l))s=Hu(s,J(),r.children);else{const u=An(r.children,$(l));if(u){const h=u.getChild(ne(l));s=ws(s,J(),h)}}}else throw Ln("WriteRecord should have .snap or .children")}}return s}function Qf(n,e,t,s,i){if(!s&&!i){const r=cn(n.visibleWrites,e);if(r!=null)return r;{const a=Nt(n.visibleWrites,e);if(Go(a))return t;if(t==null&&!zo(a,J()))return null;{const l=t||L.EMPTY_NODE;return Mn(a,l)}}}else{const r=Nt(n.visibleWrites,e);if(!i&&Go(r))return t;if(!i&&t==null&&!zo(r,J()))return null;{const a=function(h){return(h.visible||i)&&(!s||!~s.indexOf(h.writeId))&&(He(h.path,e)||He(e,h.path))},l=Kf(n.allWrites,a,e),u=t||L.EMPTY_NODE;return Mn(l,u)}}}function WT(n,e,t){let s=L.EMPTY_NODE;const i=cn(n.visibleWrites,e);if(i)return i.isLeafNode()||i.forEachChild(le,(r,a)=>{s=s.updateImmediateChild(r,a)}),s;if(t){const r=Nt(n.visibleWrites,e);return t.forEachChild(le,(a,l)=>{const u=Mn(Nt(r,new te(a)),l);s=s.updateImmediateChild(a,u)}),Qu(r).forEach(a=>{s=s.updateImmediateChild(a.name,a.node)}),s}else{const r=Nt(n.visibleWrites,e);return Qu(r).forEach(a=>{s=s.updateImmediateChild(a.name,a.node)}),s}}function $T(n,e,t,s,i){D(s||i,"Either existingEventSnap or existingServerSnap must exist");const r=me(e,t);if(zo(n.visibleWrites,r))return null;{const a=Nt(n.visibleWrites,r);return Go(a)?i.getChild(t):Mn(a,i.getChild(t))}}function zT(n,e,t,s){const i=me(e,t),r=cn(n.visibleWrites,i);if(r!=null)return r;if(s.isCompleteForChild(t)){const a=Nt(n.visibleWrites,i);return Mn(a,s.getNode().getImmediateChild(t))}else return null}function GT(n,e){return cn(n.visibleWrites,e)}function HT(n,e,t,s,i,r,a){let l;const u=Nt(n.visibleWrites,e),h=cn(u,J());if(h!=null)l=h;else if(t!=null)l=Mn(u,t);else return[];if(l=l.withIndex(a),!l.isEmpty()&&!l.isLeafNode()){const f=[],p=a.getCompare(),m=r?l.getReverseIteratorFrom(s,a):l.getIteratorFrom(s,a);let A=m.getNext();for(;A&&f.length<i;)p(A,s)!==0&&f.push(A),A=m.getNext();return f}else return[]}function KT(){return{visibleWrites:Qe.empty(),allWrites:[],lastWriteId:-1}}function tr(n,e,t,s){return Qf(n.writeTree,n.treePath,e,t,s)}function Ja(n,e){return WT(n.writeTree,n.treePath,e)}function Yu(n,e,t,s){return $T(n.writeTree,n.treePath,e,t,s)}function nr(n,e){return GT(n.writeTree,me(n.treePath,e))}function QT(n,e,t,s,i,r){return HT(n.writeTree,n.treePath,e,t,s,i,r)}function Za(n,e,t){return zT(n.writeTree,n.treePath,e,t)}function Yf(n,e){return Xf(me(n.treePath,e),n.writeTree)}function Xf(n,e){return{treePath:n,writeTree:e}}class YT{constructor(){this.changeMap=new Map}trackChildChange(e){const t=e.type,s=e.childName;D(t==="child_added"||t==="child_changed"||t==="child_removed","Only child changes supported for tracking"),D(s!==".priority","Only non-priority child changes can be tracked.");const i=this.changeMap.get(s);if(i){const r=i.type;if(t==="child_added"&&r==="child_removed")this.changeMap.set(s,Fs(s,e.snapshotNode,i.snapshotNode));else if(t==="child_removed"&&r==="child_added")this.changeMap.delete(s);else if(t==="child_removed"&&r==="child_changed")this.changeMap.set(s,Ls(s,i.oldSnap));else if(t==="child_changed"&&r==="child_added")this.changeMap.set(s,On(s,e.snapshotNode));else if(t==="child_changed"&&r==="child_changed")this.changeMap.set(s,Fs(s,e.snapshotNode,i.oldSnap));else throw Ln("Illegal combination of changes: "+e+" occurred after "+i)}else this.changeMap.set(s,e)}getChanges(){return Array.from(this.changeMap.values())}}class XT{getCompleteChild(e){return null}getChildAfterChild(e,t,s){return null}}const Jf=new XT;class el{constructor(e,t,s=null){this.writes_=e,this.viewCache_=t,this.optCompleteServerCache_=s}getCompleteChild(e){const t=this.viewCache_.eventCache;if(t.isCompleteForChild(e))return t.getNode().getImmediateChild(e);{const s=this.optCompleteServerCache_!=null?new Ut(this.optCompleteServerCache_,!0,!1):this.viewCache_.serverCache;return Za(this.writes_,e,s)}}getChildAfterChild(e,t,s){const i=this.optCompleteServerCache_!=null?this.optCompleteServerCache_:sn(this.viewCache_),r=QT(this.writes_,i,t,1,s,e);return r.length===0?null:r[0]}}function JT(n){return{filter:n}}function ZT(n,e){D(e.eventCache.getNode().isIndexed(n.filter.getIndex()),"Event snap not indexed"),D(e.serverCache.getNode().isIndexed(n.filter.getIndex()),"Server snap not indexed")}function eI(n,e,t,s,i){const r=new YT;let a,l;if(t.type===Ke.OVERWRITE){const h=t;h.source.fromUser?a=Ho(n,e,h.path,h.snap,s,i,r):(D(h.source.fromServer,"Unknown source."),l=h.source.tagged||e.serverCache.isFiltered()&&!z(h.path),a=sr(n,e,h.path,h.snap,s,i,l,r))}else if(t.type===Ke.MERGE){const h=t;h.source.fromUser?a=nI(n,e,h.path,h.children,s,i,r):(D(h.source.fromServer,"Unknown source."),l=h.source.tagged||e.serverCache.isFiltered(),a=Ko(n,e,h.path,h.children,s,i,l,r))}else if(t.type===Ke.ACK_USER_WRITE){const h=t;h.revert?a=rI(n,e,h.path,s,i,r):a=sI(n,e,h.path,h.affectedTree,s,i,r)}else if(t.type===Ke.LISTEN_COMPLETE)a=iI(n,e,t.path,s,r);else throw Ln("Unknown operation type: "+t.type);const u=r.getChanges();return tI(e,a,u),{viewCache:a,changes:u}}function tI(n,e,t){const s=e.eventCache;if(s.isFullyInitialized()){const i=s.getNode().isLeafNode()||s.getNode().isEmpty(),r=er(n);(t.length>0||!n.eventCache.isFullyInitialized()||i&&!s.getNode().equals(r)||!s.getNode().getPriority().equals(r.getPriority()))&&t.push(Wf(er(e)))}}function Zf(n,e,t,s,i,r){const a=e.eventCache;if(nr(s,t)!=null)return e;{let l,u;if(z(t))if(D(e.serverCache.isFullyInitialized(),"If change path is empty, we must have complete server data"),e.serverCache.isFiltered()){const h=sn(e),f=h instanceof L?h:L.EMPTY_NODE,p=Ja(s,f);l=n.filter.updateFullNode(e.eventCache.getNode(),p,r)}else{const h=tr(s,sn(e));l=n.filter.updateFullNode(e.eventCache.getNode(),h,r)}else{const h=$(t);if(h===".priority"){D(Ft(t)===1,"Can't have a priority with additional path components");const f=a.getNode();u=e.serverCache.getNode();const p=Yu(s,t,f,u);p!=null?l=n.filter.updatePriority(f,p):l=a.getNode()}else{const f=ne(t);let p;if(a.isCompleteForChild(h)){u=e.serverCache.getNode();const m=Yu(s,t,a.getNode(),u);m!=null?p=a.getNode().getImmediateChild(h).updateChild(f,m):p=a.getNode().getImmediateChild(h)}else p=Za(s,h,e.serverCache);p!=null?l=n.filter.updateChild(a.getNode(),h,p,f,i,r):l=a.getNode()}}return Is(e,l,a.isFullyInitialized()||z(t),n.filter.filtersNodes())}}function sr(n,e,t,s,i,r,a,l){const u=e.serverCache;let h;const f=a?n.filter:n.filter.getIndexedFilter();if(z(t))h=f.updateFullNode(u.getNode(),s,null);else if(f.filtersNodes()&&!u.isFiltered()){const A=u.getNode().updateChild(t,s);h=f.updateFullNode(u.getNode(),A,null)}else{const A=$(t);if(!u.isCompleteForPath(t)&&Ft(t)>1)return e;const b=ne(t),N=u.getNode().getImmediateChild(A).updateChild(b,s);A===".priority"?h=f.updatePriority(u.getNode(),N):h=f.updateChild(u.getNode(),A,N,b,Jf,null)}const p=Gf(e,h,u.isFullyInitialized()||z(t),f.filtersNodes()),m=new el(i,p,r);return Zf(n,p,t,i,m,l)}function Ho(n,e,t,s,i,r,a){const l=e.eventCache;let u,h;const f=new el(i,e,r);if(z(t))h=n.filter.updateFullNode(e.eventCache.getNode(),s,a),u=Is(e,h,!0,n.filter.filtersNodes());else{const p=$(t);if(p===".priority")h=n.filter.updatePriority(e.eventCache.getNode(),s),u=Is(e,h,l.isFullyInitialized(),l.isFiltered());else{const m=ne(t),A=l.getNode().getImmediateChild(p);let b;if(z(m))b=s;else{const V=f.getCompleteChild(p);V!=null?xf(m)===".priority"&&V.getChild(Mf(m)).isEmpty()?b=V:b=V.updateChild(m,s):b=L.EMPTY_NODE}if(A.equals(b))u=e;else{const V=n.filter.updateChild(l.getNode(),p,b,m,f,a);u=Is(e,V,l.isFullyInitialized(),n.filter.filtersNodes())}}}return u}function Xu(n,e){return n.eventCache.isCompleteForChild(e)}function nI(n,e,t,s,i,r,a){let l=e;return s.foreach((u,h)=>{const f=me(t,u);Xu(e,$(f))&&(l=Ho(n,l,f,h,i,r,a))}),s.foreach((u,h)=>{const f=me(t,u);Xu(e,$(f))||(l=Ho(n,l,f,h,i,r,a))}),l}function Ju(n,e,t){return t.foreach((s,i)=>{e=e.updateChild(s,i)}),e}function Ko(n,e,t,s,i,r,a,l){if(e.serverCache.getNode().isEmpty()&&!e.serverCache.isFullyInitialized())return e;let u=e,h;z(t)?h=s:h=new re(null).setTree(t,s);const f=e.serverCache.getNode();return h.children.inorderTraversal((p,m)=>{if(f.hasChild(p)){const A=e.serverCache.getNode().getImmediateChild(p),b=Ju(n,A,m);u=sr(n,u,new te(p),b,i,r,a,l)}}),h.children.inorderTraversal((p,m)=>{const A=!e.serverCache.isCompleteForChild(p)&&m.value===null;if(!f.hasChild(p)&&!A){const b=e.serverCache.getNode().getImmediateChild(p),V=Ju(n,b,m);u=sr(n,u,new te(p),V,i,r,a,l)}}),u}function sI(n,e,t,s,i,r,a){if(nr(i,t)!=null)return e;const l=e.serverCache.isFiltered(),u=e.serverCache;if(s.value!=null){if(z(t)&&u.isFullyInitialized()||u.isCompleteForPath(t))return sr(n,e,t,u.getNode().getChild(t),i,r,l,a);if(z(t)){let h=new re(null);return u.getNode().forEachChild(Cn,(f,p)=>{h=h.set(new te(f),p)}),Ko(n,e,t,h,i,r,l,a)}else return e}else{let h=new re(null);return s.foreach((f,p)=>{const m=me(t,f);u.isCompleteForPath(m)&&(h=h.set(f,u.getNode().getChild(m)))}),Ko(n,e,t,h,i,r,l,a)}}function iI(n,e,t,s,i){const r=e.serverCache,a=Gf(e,r.getNode(),r.isFullyInitialized()||z(t),r.isFiltered());return Zf(n,a,t,s,Jf,i)}function rI(n,e,t,s,i,r){let a;if(nr(s,t)!=null)return e;{const l=new el(s,e,i),u=e.eventCache.getNode();let h;if(z(t)||$(t)===".priority"){let f;if(e.serverCache.isFullyInitialized())f=tr(s,sn(e));else{const p=e.serverCache.getNode();D(p instanceof L,"serverChildren would be complete if leaf node"),f=Ja(s,p)}f=f,h=n.filter.updateFullNode(u,f,r)}else{const f=$(t);let p=Za(s,f,e.serverCache);p==null&&e.serverCache.isCompleteForChild(f)&&(p=u.getImmediateChild(f)),p!=null?h=n.filter.updateChild(u,f,p,ne(t),l,r):e.eventCache.getNode().hasChild(f)?h=n.filter.updateChild(u,f,L.EMPTY_NODE,ne(t),l,r):h=u,h.isEmpty()&&e.serverCache.isFullyInitialized()&&(a=tr(s,sn(e)),a.isLeafNode()&&(h=n.filter.updateFullNode(h,a,r)))}return a=e.serverCache.isFullyInitialized()||nr(s,J())!=null,Is(e,h,a,n.filter.filtersNodes())}}class oI{constructor(e,t){this.query_=e,this.eventRegistrations_=[];const s=this.query_._queryParams,i=new Ka(s.getIndex()),r=AT(s);this.processor_=JT(r);const a=t.serverCache,l=t.eventCache,u=i.updateFullNode(L.EMPTY_NODE,a.getNode(),null),h=r.updateFullNode(L.EMPTY_NODE,l.getNode(),null),f=new Ut(u,a.isFullyInitialized(),i.filtersNodes()),p=new Ut(h,l.isFullyInitialized(),r.filtersNodes());this.viewCache_=wr(p,f),this.eventGenerator_=new kT(this.query_)}get query(){return this.query_}}function aI(n){return n.viewCache_.serverCache.getNode()}function lI(n){return er(n.viewCache_)}function cI(n,e){const t=sn(n.viewCache_);return t&&(n.query._queryParams.loadsAllData()||!z(e)&&!t.getImmediateChild($(e)).isEmpty())?t.getChild(e):null}function Zu(n){return n.eventRegistrations_.length===0}function uI(n,e){n.eventRegistrations_.push(e)}function eh(n,e,t){const s=[];if(t){D(e==null,"A cancel should cancel all event registrations.");const i=n.query._path;n.eventRegistrations_.forEach(r=>{const a=r.createCancelEvent(t,i);a&&s.push(a)})}if(e){let i=[];for(let r=0;r<n.eventRegistrations_.length;++r){const a=n.eventRegistrations_[r];if(!a.matches(e))i.push(a);else if(e.hasAnyCallback()){i=i.concat(n.eventRegistrations_.slice(r+1));break}}n.eventRegistrations_=i}else n.eventRegistrations_=[];return s}function th(n,e,t,s){e.type===Ke.MERGE&&e.source.queryId!==null&&(D(sn(n.viewCache_),"We should always have a full cache before handling merges"),D(er(n.viewCache_),"Missing event cache, even though we have a server cache"));const i=n.viewCache_,r=eI(n.processor_,i,e,t,s);return ZT(n.processor_,r.viewCache),D(r.viewCache.serverCache.isFullyInitialized()||!i.serverCache.isFullyInitialized(),"Once a server snap is complete, it should never go back"),n.viewCache_=r.viewCache,ep(n,r.changes,r.viewCache.eventCache.getNode(),null)}function hI(n,e){const t=n.viewCache_.eventCache,s=[];return t.getNode().isLeafNode()||t.getNode().forEachChild(le,(r,a)=>{s.push(On(r,a))}),t.isFullyInitialized()&&s.push(Wf(t.getNode())),ep(n,s,t.getNode(),e)}function ep(n,e,t,s){const i=s?[s]:n.eventRegistrations_;return VT(n.eventGenerator_,e,t,i)}let ir;class tp{constructor(){this.views=new Map}}function dI(n){D(!ir,"__referenceConstructor has already been defined"),ir=n}function fI(){return D(ir,"Reference.ts has not been loaded"),ir}function pI(n){return n.views.size===0}function tl(n,e,t,s){const i=e.source.queryId;if(i!==null){const r=n.views.get(i);return D(r!=null,"SyncTree gave us an op for an invalid query."),th(r,e,t,s)}else{let r=[];for(const a of n.views.values())r=r.concat(th(a,e,t,s));return r}}function np(n,e,t,s,i){const r=e._queryIdentifier,a=n.views.get(r);if(!a){let l=tr(t,i?s:null),u=!1;l?u=!0:s instanceof L?(l=Ja(t,s),u=!1):(l=L.EMPTY_NODE,u=!1);const h=wr(new Ut(l,u,!1),new Ut(s,i,!1));return new oI(e,h)}return a}function _I(n,e,t,s,i,r){const a=np(n,e,s,i,r);return n.views.has(e._queryIdentifier)||n.views.set(e._queryIdentifier,a),uI(a,t),hI(a,t)}function mI(n,e,t,s){const i=e._queryIdentifier,r=[];let a=[];const l=Bt(n);if(i==="default")for(const[u,h]of n.views.entries())a=a.concat(eh(h,t,s)),Zu(h)&&(n.views.delete(u),h.query._queryParams.loadsAllData()||r.push(h.query));else{const u=n.views.get(i);u&&(a=a.concat(eh(u,t,s)),Zu(u)&&(n.views.delete(i),u.query._queryParams.loadsAllData()||r.push(u.query)))}return l&&!Bt(n)&&r.push(new(fI())(e._repo,e._path)),{removed:r,events:a}}function sp(n){const e=[];for(const t of n.views.values())t.query._queryParams.loadsAllData()||e.push(t);return e}function Dt(n,e){let t=null;for(const s of n.views.values())t=t||cI(s,e);return t}function ip(n,e){if(e._queryParams.loadsAllData())return Ar(n);{const s=e._queryIdentifier;return n.views.get(s)}}function rp(n,e){return ip(n,e)!=null}function Bt(n){return Ar(n)!=null}function Ar(n){for(const e of n.views.values())if(e.query._queryParams.loadsAllData())return e;return null}let rr;function gI(n){D(!rr,"__referenceConstructor has already been defined"),rr=n}function yI(){return D(rr,"Reference.ts has not been loaded"),rr}let EI=1;class nh{constructor(e){this.listenProvider_=e,this.syncPointTree_=new re(null),this.pendingWriteTree_=KT(),this.tagToQueryMap=new Map,this.queryToTagMap=new Map}}function vI(n,e,t,s,i){return LT(n.pendingWriteTree_,e,t,s,i),i?ti(n,new nn(zf(),e,t)):[]}function En(n,e,t=!1){const s=FT(n.pendingWriteTree_,e);if(UT(n.pendingWriteTree_,e)){let r=new re(null);return s.snap!=null?r=r.set(J(),!0):Be(s.children,a=>{r=r.set(new te(a),!0)}),ti(n,new Zi(s.path,r,t))}else return[]}function ei(n,e,t){return ti(n,new nn(Ya(),e,t))}function TI(n,e,t){const s=re.fromObject(t);return ti(n,new qs(Ya(),e,s))}function II(n,e){return ti(n,new Bs(Ya(),e))}function wI(n,e,t){const s=nl(n,t);if(s){const i=sl(s),r=i.path,a=i.queryId,l=Oe(r,e),u=new Bs(Xa(a),l);return il(n,r,u)}else return[]}function or(n,e,t,s,i=!1){const r=e._path,a=n.syncPointTree_.get(r);let l=[];if(a&&(e._queryIdentifier==="default"||rp(a,e))){const u=mI(a,e,t,s);pI(a)&&(n.syncPointTree_=n.syncPointTree_.remove(r));const h=u.removed;if(l=u.events,!i){const f=h.findIndex(m=>m._queryParams.loadsAllData())!==-1,p=n.syncPointTree_.findOnPath(r,(m,A)=>Bt(A));if(f&&!p){const m=n.syncPointTree_.subtree(r);if(!m.isEmpty()){const A=RI(m);for(let b=0;b<A.length;++b){const V=A[b],N=V.query,j=up(n,V);n.listenProvider_.startListening(Cs(N),js(n,N),j.hashFn,j.onComplete)}}}!p&&h.length>0&&!s&&(f?n.listenProvider_.stopListening(Cs(e),null):h.forEach(m=>{const A=n.queryToTagMap.get(Rr(m));n.listenProvider_.stopListening(Cs(m),A)}))}SI(n,h)}return l}function op(n,e,t,s){const i=nl(n,s);if(i!=null){const r=sl(i),a=r.path,l=r.queryId,u=Oe(a,e),h=new nn(Xa(l),u,t);return il(n,a,h)}else return[]}function CI(n,e,t,s){const i=nl(n,s);if(i){const r=sl(i),a=r.path,l=r.queryId,u=Oe(a,e),h=re.fromObject(t),f=new qs(Xa(l),u,h);return il(n,a,f)}else return[]}function Qo(n,e,t,s=!1){const i=e._path;let r=null,a=!1;n.syncPointTree_.foreachOnPath(i,(m,A)=>{const b=Oe(m,i);r=r||Dt(A,b),a=a||Bt(A)});let l=n.syncPointTree_.get(i);l?(a=a||Bt(l),r=r||Dt(l,J())):(l=new tp,n.syncPointTree_=n.syncPointTree_.set(i,l));let u;r!=null?u=!0:(u=!1,r=L.EMPTY_NODE,n.syncPointTree_.subtree(i).foreachChild((A,b)=>{const V=Dt(b,J());V&&(r=r.updateImmediateChild(A,V))}));const h=rp(l,e);if(!h&&!e._queryParams.loadsAllData()){const m=Rr(e);D(!n.queryToTagMap.has(m),"View does not exist, but we have a tag");const A=PI();n.queryToTagMap.set(m,A),n.tagToQueryMap.set(A,m)}const f=Cr(n.pendingWriteTree_,i);let p=_I(l,e,t,f,r,u);if(!h&&!a&&!s){const m=ip(l,e);p=p.concat(bI(n,e,m))}return p}function ap(n,e,t){const i=n.pendingWriteTree_,r=n.syncPointTree_.findOnPath(e,(a,l)=>{const u=Oe(a,e),h=Dt(l,u);if(h)return h});return Qf(i,e,r,t,!0)}function AI(n,e){const t=e._path;let s=null;n.syncPointTree_.foreachOnPath(t,(h,f)=>{const p=Oe(h,t);s=s||Dt(f,p)});let i=n.syncPointTree_.get(t);i?s=s||Dt(i,J()):(i=new tp,n.syncPointTree_=n.syncPointTree_.set(t,i));const r=s!=null,a=r?new Ut(s,!0,!1):null,l=Cr(n.pendingWriteTree_,e._path),u=np(i,e,l,r?a.getNode():L.EMPTY_NODE,r);return lI(u)}function ti(n,e){return lp(e,n.syncPointTree_,null,Cr(n.pendingWriteTree_,J()))}function lp(n,e,t,s){if(z(n.path))return cp(n,e,t,s);{const i=e.get(J());t==null&&i!=null&&(t=Dt(i,J()));let r=[];const a=$(n.path),l=n.operationForChild(a),u=e.children.get(a);if(u&&l){const h=t?t.getImmediateChild(a):null,f=Yf(s,a);r=r.concat(lp(l,u,h,f))}return i&&(r=r.concat(tl(i,n,s,t))),r}}function cp(n,e,t,s){const i=e.get(J());t==null&&i!=null&&(t=Dt(i,J()));let r=[];return e.children.inorderTraversal((a,l)=>{const u=t?t.getImmediateChild(a):null,h=Yf(s,a),f=n.operationForChild(a);f&&(r=r.concat(cp(f,l,u,h)))}),i&&(r=r.concat(tl(i,n,s,t))),r}function up(n,e){const t=e.query,s=js(n,t);return{hashFn:()=>(aI(e)||L.EMPTY_NODE).hash(),onComplete:i=>{if(i==="ok")return s?wI(n,t._path,s):II(n,t._path);{const r=Cv(i,t);return or(n,t,null,r)}}}}function js(n,e){const t=Rr(e);return n.queryToTagMap.get(t)}function Rr(n){return n._path.toString()+"$"+n._queryIdentifier}function nl(n,e){return n.tagToQueryMap.get(e)}function sl(n){const e=n.indexOf("$");return D(e!==-1&&e<n.length-1,"Bad queryKey."),{queryId:n.substr(e+1),path:new te(n.substr(0,e))}}function il(n,e,t){const s=n.syncPointTree_.get(e);D(s,"Missing sync point for query tag that we're tracking");const i=Cr(n.pendingWriteTree_,e);return tl(s,t,i,null)}function RI(n){return n.fold((e,t,s)=>{if(t&&Bt(t))return[Ar(t)];{let i=[];return t&&(i=sp(t)),Be(s,(r,a)=>{i=i.concat(a)}),i}})}function Cs(n){return n._queryParams.loadsAllData()&&!n._queryParams.isDefault()?new(yI())(n._repo,n._path):n}function SI(n,e){for(let t=0;t<e.length;++t){const s=e[t];if(!s._queryParams.loadsAllData()){const i=Rr(s),r=n.queryToTagMap.get(i);n.queryToTagMap.delete(i),n.tagToQueryMap.delete(r)}}}function PI(){return EI++}function bI(n,e,t){const s=e._path,i=js(n,e),r=up(n,t),a=n.listenProvider_.startListening(Cs(e),i,r.hashFn,r.onComplete),l=n.syncPointTree_.subtree(s);if(i)D(!Bt(l.value),"If we're adding a query, it shouldn't be shadowed");else{const u=l.fold((h,f,p)=>{if(!z(h)&&f&&Bt(f))return[Ar(f).query];{let m=[];return f&&(m=m.concat(sp(f).map(A=>A.query))),Be(p,(A,b)=>{m=m.concat(b)}),m}});for(let h=0;h<u.length;++h){const f=u[h];n.listenProvider_.stopListening(Cs(f),js(n,f))}}return a}class rl{constructor(e){this.node_=e}getImmediateChild(e){const t=this.node_.getImmediateChild(e);return new rl(t)}node(){return this.node_}}class ol{constructor(e,t){this.syncTree_=e,this.path_=t}getImmediateChild(e){const t=me(this.path_,e);return new ol(this.syncTree_,t)}node(){return ap(this.syncTree_,this.path_)}}const NI=function(n){return n=n||{},n.timestamp=n.timestamp||new Date().getTime(),n},sh=function(n,e,t){if(!n||typeof n!="object")return n;if(D(".sv"in n,"Unexpected leaf node or priority contents"),typeof n[".sv"]=="string")return DI(n[".sv"],e,t);if(typeof n[".sv"]=="object")return kI(n[".sv"],e);D(!1,"Unexpected server value: "+JSON.stringify(n,null,2))},DI=function(n,e,t){switch(n){case"timestamp":return t.timestamp;default:D(!1,"Unexpected server value: "+n)}},kI=function(n,e,t){n.hasOwnProperty("increment")||D(!1,"Unexpected server value: "+JSON.stringify(n,null,2));const s=n.increment;typeof s!="number"&&D(!1,"Unexpected increment value: "+s);const i=e.node();if(D(i!==null&&typeof i<"u","Expected ChildrenNode.EMPTY_NODE for nulls"),!i.isLeafNode())return s;const a=i.getValue();return typeof a!="number"?s:a+s},VI=function(n,e,t,s){return al(e,new ol(t,n),s)},xI=function(n,e,t){return al(n,new rl(e),t)};function al(n,e,t){const s=n.getPriority().val(),i=sh(s,e.getImmediateChild(".priority"),t);let r;if(n.isLeafNode()){const a=n,l=sh(a.getValue(),e,t);return l!==a.getValue()||i!==a.getPriority().val()?new Te(l,Ae(i)):n}else{const a=n;return r=a,i!==a.getPriority().val()&&(r=r.updatePriority(new Te(i))),a.forEachChild(le,(l,u)=>{const h=al(u,e.getImmediateChild(l),t);h!==u&&(r=r.updateImmediateChild(l,h))}),r}}class ll{constructor(e="",t=null,s={children:{},childCount:0}){this.name=e,this.parent=t,this.node=s}}function cl(n,e){let t=e instanceof te?e:new te(e),s=n,i=$(t);for(;i!==null;){const r=An(s.node.children,i)||{children:{},childCount:0};s=new ll(i,s,r),t=ne(t),i=$(t)}return s}function zn(n){return n.node.value}function hp(n,e){n.node.value=e,Yo(n)}function dp(n){return n.node.childCount>0}function OI(n){return zn(n)===void 0&&!dp(n)}function Sr(n,e){Be(n.node.children,(t,s)=>{e(new ll(t,n,s))})}function fp(n,e,t,s){t&&e(n),Sr(n,i=>{fp(i,e,!0)})}function MI(n,e,t){let s=n.parent;for(;s!==null;){if(e(s))return!0;s=s.parent}return!1}function ni(n){return new te(n.parent===null?n.name:ni(n.parent)+"/"+n.name)}function Yo(n){n.parent!==null&&LI(n.parent,n.name,n)}function LI(n,e,t){const s=OI(t),i=pt(n.node.children,e);s&&i?(delete n.node.children[e],n.node.childCount--,Yo(n)):!s&&!i&&(n.node.children[e]=t.node,n.node.childCount++,Yo(n))}const FI=/[\[\].#$\/\u0000-\u001F\u007F]/,UI=/[\[\].#$\u0000-\u001F\u007F]/,mo=10*1024*1024,pp=function(n){return typeof n=="string"&&n.length!==0&&!FI.test(n)},_p=function(n){return typeof n=="string"&&n.length!==0&&!UI.test(n)},BI=function(n){return n&&(n=n.replace(/^\/*\.info(\/|$)/,"/")),_p(n)},mp=function(n,e,t){const s=t instanceof te?new sT(t,n):t;if(e===void 0)throw new Error(n+"contains undefined "+Yt(s));if(typeof e=="function")throw new Error(n+"contains a function "+Yt(s)+" with contents = "+e.toString());if(ff(e))throw new Error(n+"contains "+e.toString()+" "+Yt(s));if(typeof e=="string"&&e.length>mo/3&&ar(e)>mo)throw new Error(n+"contains a string greater than "+mo+" utf8 bytes "+Yt(s)+" ('"+e.substring(0,50)+"...')");if(e&&typeof e=="object"){let i=!1,r=!1;if(Be(e,(a,l)=>{if(a===".value")i=!0;else if(a!==".priority"&&a!==".sv"&&(r=!0,!pp(a)))throw new Error(n+" contains an invalid key ("+a+") "+Yt(s)+`.  Keys must be non-empty strings and can't contain ".", "#", "$", "/", "[", or "]"`);iT(s,a),mp(n,l,s),rT(s)}),i&&r)throw new Error(n+' contains ".value" child '+Yt(s)+" in addition to actual children.")}},gp=function(n,e,t,s){if(!_p(t))throw new Error(vh(n,e)+'was an invalid path = "'+t+`". Paths must be non-empty strings and can't contain ".", "#", "$", "[", or "]"`)},qI=function(n,e,t,s){t&&(t=t.replace(/^\/*\.info(\/|$)/,"/")),gp(n,e,t)},jI=function(n,e){const t=e.path.toString();if(typeof e.repoInfo.host!="string"||e.repoInfo.host.length===0||!pp(e.repoInfo.namespace)&&e.repoInfo.host.split(":")[0]!=="localhost"||t.length!==0&&!BI(t))throw new Error(vh(n,"url")+`must be a valid firebase URL and the path can't contain ".", "#", "$", "[", or "]".`)};class WI{constructor(){this.eventLists_=[],this.recursionDepth_=0}}function yp(n,e){let t=null;for(let s=0;s<e.length;s++){const i=e[s],r=i.getPath();t!==null&&!za(r,t.path)&&(n.eventLists_.push(t),t=null),t===null&&(t={events:[],path:r}),t.events.push(i)}t&&n.eventLists_.push(t)}function Ep(n,e,t){yp(n,t),vp(n,s=>za(s,e))}function jt(n,e,t){yp(n,t),vp(n,s=>He(s,e)||He(e,s))}function vp(n,e){n.recursionDepth_++;let t=!0;for(let s=0;s<n.eventLists_.length;s++){const i=n.eventLists_[s];if(i){const r=i.path;e(r)?($I(n.eventLists_[s]),n.eventLists_[s]=null):t=!1}}t&&(n.eventLists_=[]),n.recursionDepth_--}function $I(n){for(let e=0;e<n.events.length;e++){const t=n.events[e];if(t!==null){n.events[e]=null;const s=t.getEventRunner();vs&&ke("event: "+t.toString()),Js(s)}}}const zI="repo_interrupt",GI=25;class HI{constructor(e,t,s,i){this.repoInfo_=e,this.forceRestClient_=t,this.authTokenProvider_=s,this.appCheckProvider_=i,this.dataUpdateCount=0,this.statsListener_=null,this.eventQueue_=new WI,this.nextWriteId_=1,this.interceptServerDataCallback_=null,this.onDisconnect_=Ji(),this.transactionQueueTree_=new ll,this.persistentConnection_=null,this.key=this.repoInfo_.toURLString()}toString(){return(this.repoInfo_.secure?"https://":"http://")+this.repoInfo_.host}}function KI(n,e,t){if(n.stats_=Wa(n.repoInfo_),n.forceRestClient_||Pv())n.server_=new Xi(n.repoInfo_,(s,i,r,a)=>{ih(n,s,i,r,a)},n.authTokenProvider_,n.appCheckProvider_),setTimeout(()=>rh(n,!0),0);else{if(typeof t<"u"&&t!==null){if(typeof t!="object")throw new Error("Only objects are supported for option databaseAuthVariableOverride");try{_e(t)}catch(s){throw new Error("Invalid authOverride provided: "+s)}}n.persistentConnection_=new ct(n.repoInfo_,e,(s,i,r,a)=>{ih(n,s,i,r,a)},s=>{rh(n,s)},s=>{YI(n,s)},n.authTokenProvider_,n.appCheckProvider_,t),n.server_=n.persistentConnection_}n.authTokenProvider_.addTokenChangeListener(s=>{n.server_.refreshAuthToken(s)}),n.appCheckProvider_.addTokenChangeListener(s=>{n.server_.refreshAppCheckToken(s.token)}),n.statsReporter_=Vv(n.repoInfo_,()=>new DT(n.stats_,n.server_)),n.infoData_=new RT,n.infoSyncTree_=new nh({startListening:(s,i,r,a)=>{let l=[];const u=n.infoData_.getNode(s._path);return u.isEmpty()||(l=ei(n.infoSyncTree_,s._path,u),setTimeout(()=>{a("ok")},0)),l},stopListening:()=>{}}),ul(n,"connected",!1),n.serverSyncTree_=new nh({startListening:(s,i,r,a)=>(n.server_.listen(s,r,i,(l,u)=>{const h=a(l,u);jt(n.eventQueue_,s._path,h)}),[]),stopListening:(s,i)=>{n.server_.unlisten(s,i)}})}function QI(n){const t=n.infoData_.getNode(new te(".info/serverTimeOffset")).val()||0;return new Date().getTime()+t}function Tp(n){return NI({timestamp:QI(n)})}function ih(n,e,t,s,i){n.dataUpdateCount++;const r=new te(e);t=n.interceptServerDataCallback_?n.interceptServerDataCallback_(e,t):t;let a=[];if(i)if(s){const u=xi(t,h=>Ae(h));a=CI(n.serverSyncTree_,r,u,i)}else{const u=Ae(t);a=op(n.serverSyncTree_,r,u,i)}else if(s){const u=xi(t,h=>Ae(h));a=TI(n.serverSyncTree_,r,u)}else{const u=Ae(t);a=ei(n.serverSyncTree_,r,u)}let l=r;a.length>0&&(l=fl(n,r)),jt(n.eventQueue_,l,a)}function rh(n,e){ul(n,"connected",e),e===!1&&ZI(n)}function YI(n,e){Be(e,(t,s)=>{ul(n,t,s)})}function ul(n,e,t){const s=new te("/.info/"+e),i=Ae(t);n.infoData_.updateSnapshot(s,i);const r=ei(n.infoSyncTree_,s,i);jt(n.eventQueue_,s,r)}function XI(n){return n.nextWriteId_++}function JI(n,e,t){const s=AI(n.serverSyncTree_,e);return s!=null?Promise.resolve(s):n.server_.get(e).then(i=>{const r=Ae(i).withIndex(e._queryParams.getIndex());Qo(n.serverSyncTree_,e,t,!0);let a;if(e._queryParams.loadsAllData())a=ei(n.serverSyncTree_,e._path,r);else{const l=js(n.serverSyncTree_,e);a=op(n.serverSyncTree_,e._path,r,l)}return jt(n.eventQueue_,e._path,a),or(n.serverSyncTree_,e,t,null,!0),r},i=>(hl(n,"get for query "+_e(e)+" failed: "+i),Promise.reject(new Error(i))))}function ZI(n){hl(n,"onDisconnectEvents");const e=Tp(n),t=Ji();$o(n.onDisconnect_,J(),(i,r)=>{const a=VI(i,r,n.serverSyncTree_,e);$f(t,i,a)});let s=[];$o(t,J(),(i,r)=>{s=s.concat(ei(n.serverSyncTree_,i,r));const a=rw(n,i);fl(n,a)}),n.onDisconnect_=Ji(),jt(n.eventQueue_,J(),s)}function ew(n,e,t){let s;$(e._path)===".info"?s=Qo(n.infoSyncTree_,e,t):s=Qo(n.serverSyncTree_,e,t),Ep(n.eventQueue_,e._path,s)}function tw(n,e,t){let s;$(e._path)===".info"?s=or(n.infoSyncTree_,e,t):s=or(n.serverSyncTree_,e,t),Ep(n.eventQueue_,e._path,s)}function nw(n){n.persistentConnection_&&n.persistentConnection_.interrupt(zI)}function hl(n,...e){let t="";n.persistentConnection_&&(t=n.persistentConnection_.id+":"),ke(t,...e)}function Ip(n,e,t){return ap(n.serverSyncTree_,e,t)||L.EMPTY_NODE}function dl(n,e=n.transactionQueueTree_){if(e||Pr(n,e),zn(e)){const t=Cp(n,e);D(t.length>0,"Sending zero length transaction queue"),t.every(i=>i.status===0)&&sw(n,ni(e),t)}else dp(e)&&Sr(e,t=>{dl(n,t)})}function sw(n,e,t){const s=t.map(h=>h.currentWriteId),i=Ip(n,e,s);let r=i;const a=i.hash();for(let h=0;h<t.length;h++){const f=t[h];D(f.status===0,"tryToSendTransactionQueue_: items in queue should all be run."),f.status=1,f.retryCount++;const p=Oe(e,f.path);r=r.updateChild(p,f.currentOutputSnapshotRaw)}const l=r.val(!0),u=e;n.server_.put(u.toString(),l,h=>{hl(n,"transaction put response",{path:u.toString(),status:h});let f=[];if(h==="ok"){const p=[];for(let m=0;m<t.length;m++)t[m].status=2,f=f.concat(En(n.serverSyncTree_,t[m].currentWriteId)),t[m].onComplete&&p.push(()=>t[m].onComplete(null,!0,t[m].currentOutputSnapshotResolved)),t[m].unwatcher();Pr(n,cl(n.transactionQueueTree_,e)),dl(n,n.transactionQueueTree_),jt(n.eventQueue_,e,f);for(let m=0;m<p.length;m++)Js(p[m])}else{if(h==="datastale")for(let p=0;p<t.length;p++)t[p].status===3?t[p].status=4:t[p].status=0;else{je("transaction at "+u.toString()+" failed: "+h);for(let p=0;p<t.length;p++)t[p].status=4,t[p].abortReason=h}fl(n,e)}},a)}function fl(n,e){const t=wp(n,e),s=ni(t),i=Cp(n,t);return iw(n,i,s),s}function iw(n,e,t){if(e.length===0)return;const s=[];let i=[];const a=e.filter(l=>l.status===0).map(l=>l.currentWriteId);for(let l=0;l<e.length;l++){const u=e[l],h=Oe(t,u.path);let f=!1,p;if(D(h!==null,"rerunTransactionsUnderNode_: relativePath should not be null."),u.status===4)f=!0,p=u.abortReason,i=i.concat(En(n.serverSyncTree_,u.currentWriteId,!0));else if(u.status===0)if(u.retryCount>=GI)f=!0,p="maxretry",i=i.concat(En(n.serverSyncTree_,u.currentWriteId,!0));else{const m=Ip(n,u.path,a);u.currentInputSnapshot=m;const A=e[l].update(m.val());if(A!==void 0){mp("transaction failed: Data returned ",A,u.path);let b=Ae(A);typeof A=="object"&&A!=null&&pt(A,".priority")||(b=b.updatePriority(m.getPriority()));const N=u.currentWriteId,j=Tp(n),G=xI(b,m,j);u.currentOutputSnapshotRaw=b,u.currentOutputSnapshotResolved=G,u.currentWriteId=XI(n),a.splice(a.indexOf(N),1),i=i.concat(vI(n.serverSyncTree_,u.path,G,u.currentWriteId,u.applyLocally)),i=i.concat(En(n.serverSyncTree_,N,!0))}else f=!0,p="nodata",i=i.concat(En(n.serverSyncTree_,u.currentWriteId,!0))}jt(n.eventQueue_,t,i),i=[],f&&(e[l].status=2,(function(m){setTimeout(m,Math.floor(0))})(e[l].unwatcher),e[l].onComplete&&(p==="nodata"?s.push(()=>e[l].onComplete(null,!1,e[l].currentInputSnapshot)):s.push(()=>e[l].onComplete(new Error(p),!1,null))))}Pr(n,n.transactionQueueTree_);for(let l=0;l<s.length;l++)Js(s[l]);dl(n,n.transactionQueueTree_)}function wp(n,e){let t,s=n.transactionQueueTree_;for(t=$(e);t!==null&&zn(s)===void 0;)s=cl(s,t),e=ne(e),t=$(e);return s}function Cp(n,e){const t=[];return Ap(n,e,t),t.sort((s,i)=>s.order-i.order),t}function Ap(n,e,t){const s=zn(e);if(s)for(let i=0;i<s.length;i++)t.push(s[i]);Sr(e,i=>{Ap(n,i,t)})}function Pr(n,e){const t=zn(e);if(t){let s=0;for(let i=0;i<t.length;i++)t[i].status!==2&&(t[s]=t[i],s++);t.length=s,hp(e,t.length>0?t:void 0)}Sr(e,s=>{Pr(n,s)})}function rw(n,e){const t=ni(wp(n,e)),s=cl(n.transactionQueueTree_,e);return MI(s,i=>{go(n,i)}),go(n,s),fp(s,i=>{go(n,i)}),t}function go(n,e){const t=zn(e);if(t){const s=[];let i=[],r=-1;for(let a=0;a<t.length;a++)t[a].status===3||(t[a].status===1?(D(r===a-1,"All SENT items should be at beginning of queue."),r=a,t[a].status=3,t[a].abortReason="set"):(D(t[a].status===0,"Unexpected transaction status in abort"),t[a].unwatcher(),i=i.concat(En(n.serverSyncTree_,t[a].currentWriteId,!0)),t[a].onComplete&&s.push(t[a].onComplete.bind(null,new Error("set"),!1,null))));r===-1?hp(e,void 0):t.length=r+1,jt(n.eventQueue_,ni(e),i);for(let a=0;a<s.length;a++)Js(s[a])}}function ow(n){let e="";const t=n.split("/");for(let s=0;s<t.length;s++)if(t[s].length>0){let i=t[s];try{i=decodeURIComponent(i.replace(/\+/g," "))}catch{}e+="/"+i}return e}function aw(n){const e={};n.charAt(0)==="?"&&(n=n.substring(1));for(const t of n.split("&")){if(t.length===0)continue;const s=t.split("=");s.length===2?e[decodeURIComponent(s[0])]=decodeURIComponent(s[1]):je(`Invalid query segment '${t}' in query '${n}'`)}return e}const oh=function(n,e){const t=lw(n),s=t.namespace;t.domain==="firebase.com"&&ft(t.host+" is no longer supported. Please use <YOUR FIREBASE>.firebaseio.com instead"),(!s||s==="undefined")&&t.domain!=="localhost"&&ft("Cannot parse Firebase url. Please use https://<YOUR FIREBASE>.firebaseio.com"),t.secure||Ev();const i=t.scheme==="ws"||t.scheme==="wss";return{repoInfo:new Af(t.host,t.secure,s,i,e,"",s!==t.subdomain),path:new te(t.pathString)}},lw=function(n){let e="",t="",s="",i="",r="",a=!0,l="https",u=443;if(typeof n=="string"){let h=n.indexOf("//");h>=0&&(l=n.substring(0,h-1),n=n.substring(h+2));let f=n.indexOf("/");f===-1&&(f=n.length);let p=n.indexOf("?");p===-1&&(p=n.length),e=n.substring(0,Math.min(f,p)),f<p&&(i=ow(n.substring(f,p)));const m=aw(n.substring(Math.min(n.length,p)));h=e.indexOf(":"),h>=0?(a=l==="https"||l==="wss",u=parseInt(e.substring(h+1),10)):h=e.length;const A=e.slice(0,h);if(A.toLowerCase()==="localhost")t="localhost";else if(A.split(".").length<=2)t=A;else{const b=e.indexOf(".");s=e.substring(0,b).toLowerCase(),t=e.substring(b+1),r=s}"ns"in m&&(r=m.ns)}return{host:e,port:u,domain:t,subdomain:s,secure:a,scheme:l,pathString:i,namespace:r}};class cw{constructor(e,t,s,i){this.eventType=e,this.eventRegistration=t,this.snapshot=s,this.prevName=i}getPath(){const e=this.snapshot.ref;return this.eventType==="value"?e._path:e.parent._path}getEventType(){return this.eventType}getEventRunner(){return this.eventRegistration.getEventRunner(this)}toString(){return this.getPath().toString()+":"+this.eventType+":"+_e(this.snapshot.exportVal())}}class uw{constructor(e,t,s){this.eventRegistration=e,this.error=t,this.path=s}getPath(){return this.path}getEventType(){return"cancel"}getEventRunner(){return this.eventRegistration.getEventRunner(this)}toString(){return this.path.toString()+":cancel"}}class Rp{constructor(e,t){this.snapshotCallback=e,this.cancelCallback=t}onValue(e,t){this.snapshotCallback.call(null,e,t)}onCancel(e){return D(this.hasCancelCallback,"Raising a cancel event on a listener with no cancel callback"),this.cancelCallback.call(null,e)}get hasCancelCallback(){return!!this.cancelCallback}matches(e){return this.snapshotCallback===e.snapshotCallback||this.snapshotCallback.userCallback!==void 0&&this.snapshotCallback.userCallback===e.snapshotCallback.userCallback&&this.snapshotCallback.context===e.snapshotCallback.context}}class pl{constructor(e,t,s,i){this._repo=e,this._path=t,this._queryParams=s,this._orderByCalled=i}get key(){return z(this._path)?null:xf(this._path)}get ref(){return new _t(this._repo,this._path)}get _queryIdentifier(){const e=zu(this._queryParams),t=qa(e);return t==="{}"?"default":t}get _queryObject(){return zu(this._queryParams)}isEqual(e){if(e=Ye(e),!(e instanceof pl))return!1;const t=this._repo===e._repo,s=za(this._path,e._path),i=this._queryIdentifier===e._queryIdentifier;return t&&s&&i}toJSON(){return this.toString()}toString(){return this._repo.toString()+nT(this._path)}}class _t extends pl{constructor(e,t){super(e,t,new Qa,!1)}get parent(){const e=Mf(this._path);return e===null?null:new _t(this._repo,e)}get root(){let e=this;for(;e.parent!==null;)e=e.parent;return e}}class Ws{constructor(e,t,s){this._node=e,this.ref=t,this._index=s}get priority(){return this._node.getPriority().val()}get key(){return this.ref.key}get size(){return this._node.numChildren()}child(e){const t=new te(e),s=Xo(this.ref,e);return new Ws(this._node.getChild(t),s,le)}exists(){return!this._node.isEmpty()}exportVal(){return this._node.val(!0)}forEach(e){return this._node.isLeafNode()?!1:!!this._node.forEachChild(this._index,(s,i)=>e(new Ws(i,Xo(this.ref,s),le)))}hasChild(e){const t=new te(e);return!this._node.getChild(t).isEmpty()}hasChildren(){return this._node.isLeafNode()?!1:!this._node.isEmpty()}toJSON(){return this.exportVal()}val(){return this._node.val()}}function Sp(n,e){return n=Ye(n),n._checkNotDeleted("ref"),e!==void 0?Xo(n._root,e):n._root}function Xo(n,e){return n=Ye(n),$(n._path)===null?qI("child","path",e):gp("child","path",e),new _t(n._repo,me(n._path,e))}function hw(n){n=Ye(n);const e=new Rp(()=>{}),t=new br(e);return JI(n._repo,n,t).then(s=>new Ws(s,new _t(n._repo,n._path),n._queryParams.getIndex()))}class br{constructor(e){this.callbackContext=e}respondsTo(e){return e==="value"}createEvent(e,t){const s=t._queryParams.getIndex();return new cw("value",this,new Ws(e.snapshotNode,new _t(t._repo,t._path),s))}getEventRunner(e){return e.getEventType()==="cancel"?()=>this.callbackContext.onCancel(e.error):()=>this.callbackContext.onValue(e.snapshot,null)}createCancelEvent(e,t){return this.callbackContext.hasCancelCallback?new uw(this,e,t):null}matches(e){return e instanceof br?!e.callbackContext||!this.callbackContext?!0:e.callbackContext.matches(this.callbackContext):!1}hasAnyCallback(){return this.callbackContext!==null}}function dw(n,e,t,s,i){const r=new Rp(t,void 0),a=new br(r);return ew(n._repo,n,a),()=>tw(n._repo,n,a)}function fw(n,e,t,s){return dw(n,"value",e)}dI(_t);gI(_t);const pw="FIREBASE_DATABASE_EMULATOR_HOST",Jo={};let _w=!1;function mw(n,e,t,s){const i=e.lastIndexOf(":"),r=e.substring(0,i),a=$s(r);n.repoInfo_=new Af(e,a,n.repoInfo_.namespace,n.repoInfo_.webSocketOnly,n.repoInfo_.nodeAdmin,n.repoInfo_.persistenceKey,n.repoInfo_.includeNamespaceInQueryParams,!0,t),s&&(n.authTokenProvider_=s)}function gw(n,e,t,s,i){let r=s||n.options.databaseURL;r===void 0&&(n.options.projectId||ft("Can't determine Firebase Database URL. Be sure to include  a Project ID when calling firebase.initializeApp()."),ke("Using default host for project ",n.options.projectId),r=`${n.options.projectId}-default-rtdb.firebaseio.com`);let a=oh(r,i),l=a.repoInfo,u;typeof process<"u"&&Su&&(u=Su[pw]),u?(r=`http://${u}?ns=${l.namespace}`,a=oh(r,i),l=a.repoInfo):a.repoInfo.secure;const h=new Nv(n.name,n.options,e);jI("Invalid Firebase Database URL",a),z(a.path)||ft("Database URL must point to the root of a Firebase Database (not including a child path).");const f=Ew(l,n,h,new bv(n,t));return new vw(f,n)}function yw(n,e){const t=Jo[e];(!t||t[n.key]!==n)&&ft(`Database ${e}(${n.repoInfo_}) has already been deleted.`),nw(n),delete t[n.key]}function Ew(n,e,t,s){let i=Jo[e.name];i||(i={},Jo[e.name]=i);let r=i[n.toURLString()];return r&&ft("Database initialized multiple times. Please make sure the format of the database URL matches with each database() call."),r=new HI(n,_w,t,s),i[n.toURLString()]=r,r}class vw{constructor(e,t){this._repoInternal=e,this.app=t,this.type="database",this._instanceStarted=!1}get _repo(){return this._instanceStarted||(KI(this._repoInternal,this.app.options.appId,this.app.options.databaseAuthVariableOverride),this._instanceStarted=!0),this._repoInternal}get _root(){return this._rootInternal||(this._rootInternal=new _t(this._repo,J())),this._rootInternal}_delete(){return this._rootInternal!==null&&(yw(this._repo,this.app.name),this._repoInternal=null,this._rootInternal=null),Promise.resolve()}_checkNotDeleted(e){this._rootInternal===null&&ft("Cannot call "+e+" on a deleted database.")}}function Tw(n=Sh(),e){const t=wh(n,"database").getImmediate({identifier:e});if(!t._instanceStarted){const s=hh("database");s&&Iw(t,...s)}return t}function Iw(n,e,t,s={}){n=Ye(n),n._checkNotDeleted("useEmulator");const i=`${e}:${t}`,r=n._repoInternal;if(n._instanceStarted){if(i===n._repoInternal.repoInfo_.host&&Rs(s,r.repoInfo_.emulatorOptions))return;ft("connectDatabaseEmulator() cannot initialize or alter the emulator configuration after the database instance has started.")}let a;if(r.repoInfo_.nodeAdmin)s.mockUserToken&&ft('mockUserToken is not supported by the Admin SDK. For client access with mock users, please use the "firebase" package instead of "firebase-admin".'),a=new ki(ki.OWNER);else if(s.mockUserToken){const l=typeof s.mockUserToken=="string"?s.mockUserToken:ph(s.mockUserToken,n.app.options.projectId);a=new ki(l)}$s(e)&&(fh(e),_h("Database",!0)),mw(r,i,s,a)}function ww(n){fv(Ah),Ss(new Rn("database",(e,{instanceIdentifier:t})=>{const s=e.getProvider("app").getImmediate(),i=e.getProvider("auth-internal"),r=e.getProvider("app-check-internal");return gw(s,i,r,t)},"PUBLIC").setMultipleInstances(!0)),At(Pu,bu,n),At(Pu,bu,"esm2020")}ct.prototype.simpleListen=function(n,e){this.sendRequest("q",{p:n},e)};ct.prototype.echo=function(n,e){this.sendRequest("echo",{d:n},e)};ww();const Cw={apiKey:"AIzaSyCub0XtA27wJfA8QzLWTRcVvsn4Wiz84H0",authDomain:"tiger-superextension-09.firebaseapp.com",projectId:"tiger-superextension-09",storageBucket:"tiger-superextension-09.firebasestorage.app",messagingSenderId:"523127017746",appId:"1:523127017746:web:c58418b3ad5009509823cb",measurementId:"G-53CSV68T7D"},Pp=Rh(Cw,"extension-app"),Nr=HE(Pp),bp=Tw(Pp),Dw=async(n,e,t)=>{try{const s=Qd(Na(Nr,`users/${n}/history`));await lf(s,{summary:e,url:t,timestamp:new Date().toISOString()})}catch{}},kw=async n=>{try{const e=Na(Nr,`users/${n}/history`),t=rv(e,ov("timestamp","desc"),av(50));return(await af(t)).docs.map(i=>({id:i.id,...i.data()}))}catch{return[]}},Vw=async n=>{try{const e=Na(Nr,`users/${n}/history`),s=(await af(e)).docs.map(i=>dv(i.ref));await Promise.all(s)}catch(e){throw e}},xw=async n=>{try{const e=Qd(Nr,"users",n.id);await lf(e,{email:n.email,name:n.name,picture:n.picture,lastLogin:new Date().toISOString()},{merge:!0})}catch(e){throw e}},Ow=async n=>{try{const e=n.replace(/\./g,"_"),t=Sp(bp,`admin/users/${e}`);return(await hw(t)).val()?.isPro||!1}catch{return!1}},Mw=n=>{const e=Sp(bp,"admin/features");return fw(e,t=>{const s=t.val()||{imageAnalysis:!0,creativeTone:!0,professionalTone:!0,jsonFormat:!0,xmlFormat:!0};n(s)})};export{Rw as A,Sw as M,Pw as R,xw as a,Dw as b,Ow as c,Vw as d,kw as g,Mw as s};
