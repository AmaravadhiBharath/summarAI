chrome.runtime.onMessage.addListener((d,a,g)=>{if(d.action==="ping")return g({pong:!0}),!0;if(d.action==="getPageContent")try{const u=x(d.includeImages);g(u)}catch(u){g({error:u.message})}return!0});let h=null;chrome.storage.local.get("scraping_config",d=>{d.scraping_config&&(h=d.scraping_config)});function x(d=!1){const a=window.location.href,g=document.title;if(!a.startsWith("http://")&&!a.startsWith("https://"))throw new Error("Cannot summarize this page. Please use a valid website (http/https).");let u="generic",c=[],m=[];const E=r=>{if(!d)return;r.querySelectorAll("img").forEach(e=>{e.width>50&&e.height>50&&e.src&&(m.includes(e.src)||m.push(e.src))})};if(h){let r=null;if(a.includes("chatgpt.com")?r=h["chatgpt.com"]:a.includes("gemini.google.com")?r=h["gemini.google.com"]:a.includes("claude.ai")&&(r=h["claude.ai"]),r&&(u=r.platform,u==="chatgpt"&&r.selectors))for(const s of r.selectors){const e=document.querySelectorAll(s);if(e.length>0&&(e.forEach(t=>{let i="assistant";r.roleAttribute&&t.getAttribute(r.roleAttribute)===r.userRoleValue&&(i="user");const l=t.innerText;l&&c.push({role:i,text:l}),E(t)}),c.length>0))return{url:a,title:g,platform:u,conversation:c,rawText:c.map(t=>t.text).join(`

`),images:m}}}if(a.includes("chatgpt.com")){u="chatgpt";const r=["[data-message-author-role]",".text-message",".markdown"];let s=null;for(const e of r){const t=document.querySelectorAll(e);if(t.length>0){s=t;break}}s&&s.forEach(e=>{const t=e.getAttribute("data-message-author-role")||"assistant",i=e.innerText;i&&c.push({role:t,text:i}),E(e)})}else if(a.includes("gemini.google.com")){u="gemini";const s=document.querySelectorAll(".user-query, .model-response-text, [data-message-id], .query-text, .message-content");if(s.length>0&&s.forEach(e=>{const t=e.innerText;if(!t||t.length<2)return;let i="assistant";if(e.classList.contains("user-query")||e.closest(".user-query")||e.closest(".user-query-container")||e.classList.contains("query-text")||e.getAttribute("data-test-id")==="user-query")i="user";else{const n=e.closest("[data-message-id]")||e.parentElement;n&&n.querySelector('[aria-label*="Edit"], mat-icon[data-mat-icon-name="edit"], .edit-button')&&(i="user")}const l=c[c.length-1];l&&l.text===t||c.push({role:i,text:t})}),c.length===0){let t=Array.from(document.querySelectorAll('[class*="scroll"], [style*="overflow"]')).sort((n,o)=>{const f=n.getBoundingClientRect(),p=o.getBoundingClientRect();return p.width*p.height-f.width*f.height})[0];t||(t=document.body);const i=document.createTreeWalker(t,NodeFilter.SHOW_TEXT,{acceptNode:n=>{const o=n.parentElement;if(!o||o.offsetParent===null||o.isContentEditable||o.getAttribute("role")==="textbox"||o.closest('[contenteditable="true"]'))return NodeFilter.FILTER_REJECT;const f=o.tagName.toLowerCase();return["script","style","noscript","button","nav","header","footer","input","textarea","select","option"].includes(f)?NodeFilter.FILTER_REJECT:NodeFilter.FILTER_ACCEPT}});let l;for(;l=i.nextNode();){const n=l.textContent?.trim();n&&n.length>10&&(["submit","cancel","regenerate","share","more_vert","edit","enter a prompt here"].includes(n.toLowerCase())||c.push({role:"assistant",text:n}))}}E(document.body)}else a.includes("claude.ai")&&(u="claude",document.querySelectorAll(".font-user-message, .font-claude-message").forEach(s=>{const e=s.classList.contains("font-user-message");c.push({role:e?"user":"assistant",text:s.innerText}),E(s)}));if(c.length===0){const s=["chatgpt.com","openai.com","gemini.google.com","labs.google.com","figma.com","visily.ai","uizard.io","uxmagic.ai","banani.co","app.emergent.sh","rocket.new","lovable.dev","bolt.new","base44.com","create.xyz","memex.tech","buildfire.com","glideapps.com","flatlogic.com","retool.com","uibakery.io","zoho.com","appypie.com","meta.ai"].some(i=>a.includes(i));let e="";const t=s?50:30;if(s){const i=document.createTreeWalker(document.body,NodeFilter.SHOW_TEXT,{acceptNode:n=>{const o=n.parentElement;if(!o||o.offsetParent===null||o.isContentEditable||o.getAttribute("role")==="textbox"||o.closest('[contenteditable="true"]'))return NodeFilter.FILTER_REJECT;const f=o.tagName.toLowerCase();return["script","style","noscript","iframe","svg","path","button","nav","footer","header","input","textarea","select"].includes(f)?NodeFilter.FILTER_REJECT:NodeFilter.FILTER_ACCEPT}});let l;for(;l=i.nextNode();){const n=l.textContent?.trim();n&&n.length>5&&(e+=n+`

`)}}else document.querySelectorAll("p, h1, h2, h3, h4, h5, li, span, div").forEach(n=>{if(["P","H1","H2","H3","H4","H5","LI"].includes(n.tagName)){const o=n.innerText;o&&o.length>20&&(e+=o+`

`)}});if(!e.trim()&&!s){const i=document.createTreeWalker(document.body,NodeFilter.SHOW_TEXT,{acceptNode:n=>{const o=n.parentElement;if(!o||o.isContentEditable||o.getAttribute("role")==="textbox"||o.closest('[contenteditable="true"]'))return NodeFilter.FILTER_REJECT;const f=o.tagName.toLowerCase();return["script","style","noscript","input","textarea","select","button"].includes(f)?NodeFilter.FILTER_REJECT:NodeFilter.FILTER_ACCEPT}});let l;for(;l=i.nextNode();){const n=l.textContent?.trim();n&&n.length>20&&(e+=n+`
`)}}if(!e||e.trim().length<t,E(document),e&&e.length>t)return{url:a,title:g,platform:u==="generic"&&s?"generic":u,conversation:[],rawText:e,images:m.slice(0,10)}}const T=c.length>0,F=c.map(r=>r.text).join("").length>20;if(!T||!F){let r="";const s=document.createTreeWalker(document.body,NodeFilter.SHOW_TEXT,{acceptNode:t=>{const i=t.parentElement;if(!i||i.isContentEditable||i.getAttribute("role")==="textbox"||i.closest('[contenteditable="true"]'))return NodeFilter.FILTER_REJECT;const l=i.tagName.toLowerCase();return["script","style","noscript","input","textarea","select","button"].includes(l)?NodeFilter.FILTER_REJECT:NodeFilter.FILTER_ACCEPT}});let e;for(;e=s.nextNode();){const t=e.textContent?.trim();t&&t.length>20&&(r+=t+`

`)}if(r.length>50)return{url:a,title:g,platform:u,conversation:[{role:"assistant",text:r}],rawText:r,images:m.slice(0,10)};throw new Error("No conversation found on this page. Start a chat first, then generate a summary.")}return{url:a,title:g,platform:u,conversation:c,rawText:c.map(r=>`${r.role.toUpperCase()}: ${r.text}`).join(`

`),images:m.slice(0,10)}}
